<!DOCTYPE html>
<html lang="vi" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Trận Tử Chiến: Ghép Cặp Hoàn Hảo</title>
    
    <meta name="theme-color" content="#3b82f6"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script>
        // TailwindCSS Dark Mode Setup
        tailwind.config = {
          darkMode: 'class',
        }
    </script>
    <style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            touch-action: manipulation;
            overscroll-behavior-y: contain;
            -webkit-user-select: none; user-select: none;
            transition: background-color 0.3s ease;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
        }
        
        @keyframes deal {
            from { opacity: 0; transform: translateY(20px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        @keyframes pop {
            0%, 100% { transform: scale(1.05); }
            50% { transform: scale(1.15); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes timeBonus {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        @keyframes pulse {
           50% { box-shadow: 0 0 0 5px rgba(22, 163, 74, 0.5); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes highlight {
            0% { box-shadow: 0 0 0 0px rgba(253, 224, 71, 0.7); }
            50% { box-shadow: 0 0 0 6px rgba(253, 224, 71, 0.7); }
            100% { box-shadow: 0 0 0 0px rgba(253, 224, 71, 0.7); }
        }
        @keyframes pop-fade {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        @keyframes countdown-circle { from { stroke-dashoffset: 283; } to { stroke-dashoffset: 0; } }

        .card {
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card.hiding-mode {
            cursor: pointer;
            animation: pulse 1.5s infinite;
        }
        .card.hidden-card {
            opacity: 0 !important;
            pointer-events: none !important;
        }
        .card.selected, .card.tut-correct {
            transform: scale(1.08);
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.5), 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        .card.dimmed { 
            filter: blur(4px) brightness(0.8);
            opacity: 0.5;
            transform: scale(0.95);
        }
        .dark .card.dimmed {
             filter: blur(4px) brightness(0.6);
             opacity: 0.4;
        }
        .card.highlighted {
            animation: highlight 1.5s ease-in-out;
        }
        .card.correct {
            animation: pulse 0.5s ease-out;
        }
        .card svg { width: 70%; height: 70%; }
        #game-board, #demo-board {
            display: grid;
            gap: 0.75rem;
            width: 100%;
            max-width: 600px;
            margin: auto;
            position: relative;
        }
        .feedback-icon-container {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 5rem;
            font-weight: bold;
            pointer-events: none;
            z-index: 10;
            animation: pop-fade 0.8s ease-out forwards;
        }
        
        #game-board.level-1, #demo-board.size-3 { grid-template-columns: repeat(3, minmax(0, 1fr)); }
        #game-board.level-2 { grid-template-columns: repeat(4, minmax(0, 1fr)); }
        #game-board.level-3 { grid-template-columns: repeat(5, minmax(0, 1fr)); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .history-list { display: flex; flex-direction: column; gap: 8px; overscroll-behavior: contain; }
        .history-item { 
            display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem; 
            border-radius: 0.5rem; cursor: pointer;
            transition: background-color 0.2s;
        }
        .dark .history-item { background-color: rgba(255, 255, 255, 0.1); }
        .dark .history-item:hover { background-color: rgba(255, 255, 255, 0.2); }

        #missed-sets-summary .history-item { background-color: rgba(255, 255, 255, 0.1); color: white; }
        #missed-sets-summary .history-item .text-gray-500 { color: #d1d5db; }
        .history-item .card-container { display: flex; flex-grow: 1; justify-content: center; gap: 0.375rem; }
        .history-item .card { width: 24px; height: 24px; border-width: 1px; box-shadow: none; border-radius: 4px; }
        .history-item .card svg { width: 80%; height: 80%; }
        
        .mode-btn.active, .assist-btn.active { background-color: #3b82f6; color: white; }
        .dark .mode-btn.active, .dark .assist-btn.active {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-color: #60a5fa; /* Blue 400 */
        }

        .assist-btn { transition: all 0.2s; position: relative; }
        .item-count {
            position: absolute; bottom: -5px; right: -5px;
            background-color: #ef4444; color: white;
            border-radius: 9999px; font-size: 10px; font-weight: bold;
            width: 18px; height: 18px; line-height: 18px; text-align: center;
            box-shadow: 0 0 0 2px var(--panel-bg);
        }
        html.dark .item-count { box-shadow: 0 0 0 2px var(--panel-bg-dark); }


        #missed-sets-summary::-webkit-scrollbar, #achievements-list::-webkit-scrollbar, #history-content-area::-webkit-scrollbar { height: 8px; width: 8px; }
        #missed-sets-summary::-webkit-scrollbar-track, #achievements-list::-webkit-scrollbar-track, #history-content-area::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.1); border-radius: 4px; }
        #missed-sets-summary::-webkit-scrollbar-thumb, #achievements-list::-webkit-scrollbar-thumb, #history-content-area::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.3); border-radius: 4px; }
        #missed-sets-summary::-webkit-scrollbar-thumb:hover, #achievements-list::-webkit-scrollbar-thumb:hover, #history-content-area::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.5); }
        
        :root {
            --panel-bg: rgba(255, 255, 255, 0.85);
            --panel-bg-dark: rgba(30, 41, 59, 0.75);
        }
        .panel {
            background-color: var(--panel-bg);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .dark .panel {
            background-color: var(--panel-bg-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        #ingame-notification.show {
            display: flex;
            animation: fadeIn 0.3s ease-out forwards;
        }
        #ingame-notification.hide {
            animation: fadeOut 0.3s ease-in forwards;
        }
        .achievement-notification {
            animation: slideInUp 0.5s ease-out forwards, slideOutDown 0.5s ease-in 4s forwards;
        }
        @keyframes slideInUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes slideOutDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(100%); opacity: 0; } }

    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200">

    <div id="app-container" class="w-full max-w-7xl h-full mx-auto relative">
        <!-- Main Menu (New Layout) -->
        <div id="main-menu" class="h-full w-full flex flex-col p-4 sm:p-6 lg:p-8">
            <!-- Header -->
            <header class="w-full flex justify-between items-center pb-4 flex-shrink-0">
                <div class="flex items-center gap-3">
                    <h2 class="text-xl font-bold text-slate-700 dark:text-slate-300">Trận Tử Chiến</h2>
                    <span id="version-number" class="text-xs font-mono bg-slate-200 dark:bg-slate-700 text-slate-500 dark:text-slate-400 px-2 py-1 rounded-md cursor-pointer"></span>
                </div>
                <div class="flex items-center gap-4">
                    <div id="player-coins-menu" class="flex items-center gap-2 font-bold text-lg bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        <span id="player-coins-menu-value">0</span>
                    </div>
                    <button id="dark-mode-toggle" class="p-2 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300">
                        <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>
                        <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                    </button>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-grow flex items-center justify-center overflow-y-auto">
                <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-8 lg:gap-12 items-center py-6">
                    <!-- Left Column (Title & Art) -->
                    <div class="text-center lg:text-left">
                        <!-- FIX #6: Bố cục hợp lý hơn -->
                        <h1 class="text-5xl lg:text-6xl font-extrabold text-slate-900 dark:text-white mb-4 leading-tight">Ghép Cặp Hoàn Hảo</h1>
                        <p class="text-slate-600 dark:text-slate-400 text-lg mb-8">Thử thách đỉnh cao về khả năng quan sát và tốc độ. Tìm các bộ ba hợp lệ để ghi điểm và chinh phục các cấp độ!</p>
                        <div class="flex flex-wrap gap-4 justify-center lg:justify-start">
                           <button id="shop-btn-main" class="w-auto bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-base hover:bg-green-700 transition-transform hover:scale-105 shadow-lg">Cửa hàng</button>
                           <button id="achievements-btn-main" class="w-auto bg-amber-500 text-white font-bold py-3 px-6 rounded-lg text-base hover:bg-amber-600 transition-transform hover:scale-105 shadow-lg">Thành tựu</button>
                           <button id="history-btn-main" class="w-auto bg-gray-600 text-white font-bold py-3 px-6 rounded-lg text-base hover:bg-gray-700 transition-transform hover:scale-105 shadow-lg">Lịch sử</button>
                           <button class="start-tutorial-btn w-auto bg-white dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-3 px-6 rounded-lg text-base hover:bg-slate-100 dark:hover:bg-slate-600 transition-transform hover:scale-105 shadow-lg">Hướng dẫn</button>
                        </div>
                    </div>

                    <!-- Right Column (Settings & Actions) -->
                    <div class="panel p-6 sm:p-8 rounded-2xl shadow-2xl w-full">
                        <!-- Mode Selection -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-3 text-center">Chế độ chơi</h3>
                            <div class="flex justify-center rounded-lg shadow-sm" role="group">
                                <button id="mode-classic-btn" type="button" class="mode-btn px-6 py-3 text-sm font-medium text-slate-900 dark:text-slate-100 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-l-lg hover:bg-slate-100 dark:hover:bg-slate-600 focus:z-10 focus:ring-2 focus:ring-blue-500">Cổ điển</button>
                                <button id="mode-dual-btn" type="button" class="mode-btn px-6 py-3 text-sm font-medium text-slate-900 dark:text-slate-100 bg-white dark:bg-slate-700 border-t border-b border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 focus:z-10 focus:ring-2 focus:ring-blue-500 active">Nền Kép</button>
                            </div>
                        </div>
                        <!-- Assist Selection -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold text-slate-800 dark:text-slate-200 mb-3 text-center">Kích hoạt Hỗ trợ <span class="text-sm font-normal text-slate-500 dark:text-slate-400">(tiêu hao)</span></h3>
                             <div class="grid grid-cols-2 gap-2 text-center">
                                <button id="assist-useless-btn" data-assist-type="useless" class="assist-btn p-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 flex flex-col items-center justify-center gap-1">
                                   <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59" /></svg>
                                   <span class="text-xs font-semibold">Mờ ô vô dụng</span>
                                   <span class="item-count" data-item="assistUseless">0</span>
                                </button>
                                <button id="assist-shape-btn" data-assist-type="shape" class="assist-btn p-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 flex flex-col items-center justify-center gap-1">
                                    <svg class="w-7 h-7" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>
                                    <span class="text-xs font-semibold">Ẩn hình đã chọn</span>
                                    <span class="item-count" data-item="assistShape">0</span>
                                </button>
                            </div>
                        </div>
                        <!-- Action Buttons -->
                        <div class="mt-8 flex flex-col gap-4">
                             <!-- FIX #6: Làm nổi bật nút bắt đầu -->
                             <button id="start-game-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-4 rounded-lg text-lg hover:bg-blue-700 transition-transform hover:scale-105 shadow-lg">Bắt đầu chơi</button>
                             <!-- FIX #1: Loại bỏ các nút lặp lại trên điện thoại -->
                             <!-- Đoạn mã cho các nút mobile đã bị xóa khỏi đây -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

        
        <!-- Shop Container (New Design) -->
        <div id="shop-container" class="hidden h-full flex flex-col panel p-4 sm:p-6" style="animation: fadeInUp 0.5s ease-out;">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                 <h2 class="text-2xl font-bold text-center text-slate-900 dark:text-white">Cửa hàng Vật phẩm</h2>
                 <button id="close-shop-btn" class="text-slate-500 hover:text-slate-800 dark:hover:text-slate-200 p-2 rounded-full">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
            </div>
             <div class="flex justify-center mb-6 flex-shrink-0">
                <div id="player-coins-shop" class="flex items-center gap-2 font-bold text-lg bg-yellow-400 text-yellow-900 px-4 py-2 rounded-full shadow-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                    <span id="player-coins-shop-value">0</span>
                </div>
            </div>
            <div id="shop-items-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 overflow-y-auto flex-grow pr-2">
                 <!-- Shop items will be injected here -->
            </div>
        </div>

        <!-- History View -->
        <div id="history-view" class="hidden h-full flex flex-col panel p-4 sm:p-6" style="animation: fadeInUp 0.5s ease-out;">
            <div class="flex justify-between items-center mb-6 flex-shrink-0">
                 <h2 class="text-2xl font-bold">Lịch Sử & Thống Kê</h2>
                 <button id="close-history-btn" class="p-2 rounded-full hover:bg-white/20">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                 </button>
            </div>
            <div id="history-content-area" class="flex-grow overflow-y-auto space-y-8 pr-2">
                 <!-- Overall Stats Section -->
                 <div id="overall-stats-section"></div>
                 <!-- High Score Section -->
                 <div id="high-scores-section"></div>
                 <!-- Game Log Section -->
                 <div id="game-log-section"></div>
            </div>
            <!-- FIX #5: Thêm chức năng Reset Game -->
            <div class="flex-shrink-0 pt-4 mt-4 border-t border-slate-300 dark:border-slate-600">
                <button id="reset-game-btn" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg text-base hover:bg-red-700 shadow-md">Xóa Toàn Bộ Dữ Liệu</button>
                <p class="text-xs text-center text-slate-500 mt-2">Hành động này không thể hoàn tác. Tất cả xu, vật phẩm, và thành tựu sẽ bị xóa vĩnh viễn.</p>
            </div>
        </div>

        <!-- Achievements Modal -->
        <div id="achievements-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
             <div class="panel w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-white/10 dark:border-slate-700">
                    <h2 class="text-xl font-bold">Thành Tựu</h2>
                    <button id="close-achievements-btn" class="text-slate-500 hover:text-slate-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div id="achievements-list" class="flex-grow p-4 sm:p-6 space-y-3 overflow-y-auto">
                    <!-- Achievements will be injected here -->
                </div>
             </div>
        </div>


        <!-- Tutorial Modal -->
        <div id="tutorial-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
             <div class="panel w-full max-w-2xl max-h-[90vh] flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-white/10 dark:border-slate-700">
                    <h2 class="text-xl font-bold">Hướng Dẫn Chơi</h2>
                    <button id="close-tutorial-btn" class="text-slate-500 hover:text-slate-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div id="tutorial-content-area" class="flex-grow p-6 overflow-y-auto">
                    <!-- Tutorial content will be injected here -->
                </div>
                <div class="flex-shrink-0 flex justify-between items-center p-4 border-t border-white/10 dark:border-slate-700">
                    <div class="w-1/3">
                        <button id="tutorial-prev-btn" class="bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg">‹ Quay lại</button>
                    </div>
                    <div id="tutorial-progress" class="w-1/3 flex justify-center items-center gap-2"></div>
                    <div class="w-1/3 text-right">
                        <button id="tutorial-next-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Tiếp theo ›</button>
                    </div>
                </div>
             </div>
        </div>

        <!-- Changelog Modal -->
        <div id="changelog-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
             <div class="panel w-full max-w-lg max-h-[90vh] flex flex-col">
                <div class="flex-shrink-0 flex justify-between items-center p-4 border-b border-white/10 dark:border-slate-700">
                    <h2 class="text-xl font-bold">Nhật ký thay đổi</h2>
                    <button id="close-changelog-btn" class="text-slate-500 hover:text-slate-200">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="flex-grow p-6 overflow-y-auto space-y-6">
                    <div>
                        <h3 class="text-lg font-bold mb-2"><span class="bg-blue-100 text-blue-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">v1.2.0</span> - 12/06/2025</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 dark:text-slate-300">
                            <li><strong>Cải tiến:</strong> Bố cục trang chính được sắp xếp lại.</li>
                            <li><strong>Cải tiến:</strong> Tặng 5 vật phẩm mỗi loại cho người chơi mới.</li>
                            <li><strong>Cải tiến:</strong> Hiển thị rõ phần thưởng trong giao diện Thành tựu.</li>
                            <li><strong>Cải tiến:</strong> Giao diện lịch sử trên điện thoại được nâng cao.</li>
                            <li><strong>Mới:</strong> Thêm chức năng xóa toàn bộ dữ liệu (Reset Game) trong Lịch sử.</li>
                            <li><strong>Sửa lỗi:</strong> Loại bỏ các nút bị lặp lại ở trang chính trên điện thoại.</li>
                            <li><strong>Sửa lỗi:</strong> Nền và hình không còn bị trùng màu ở chế độ Cổ điển.</li>
                            <li><strong>Sửa lỗi:</strong> Dừng đồng hồ đếm ngược cứu hộ ngay sau khi người chơi đồng ý.</li>
                            <li><strong>Sửa lỗi:</strong> Các ô đã thuộc bộ cũ sẽ bị làm mờ đúng cách khi chọn 2/3 ô.</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold mb-2"><span class="bg-blue-100 text-blue-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded dark:bg-blue-200 dark:text-blue-800">v1.1.0</span> - 13/06/2025</h3>
                        <ul class="list-disc list-inside space-y-1 text-slate-700 dark:text-slate-300">
                            <li><strong>Mới:</strong> Trợ giúp "Ẩn 1 ô" cho phép ẩn một thẻ bài trong một cấp độ.</li>
                            <li><strong>Mới:</strong> Hệ thống Thành tựu với nhiều phần thưởng hấp dẫn.</li>
                            <li><strong>Cập nhật:</strong> Có thể mua "Gợi ý" và "Ẩn 1 ô" ngay trong trận đấu.</li>
                            <li><strong>Cập nhật:</strong> Giao diện Cứu hộ được làm mới với đồng hồ đếm ngược.</li>
                            <li><strong>Sửa lỗi:</strong> Lịch sử ván chơi có thể cuộn trên điện thoại.</li>
                            <li><strong>Tinh gọn:</strong> Loại bỏ hỗ trợ "Mờ nền khác".</li>
                        </ul>
                    </div>
                </div>
             </div>
        </div>

        <!-- Game Container -->
        <div id="game-container" class="hidden h-full relative flex flex-col panel">
            <!-- Main Content -->
            <div class="flex-grow flex flex-col lg:flex-row gap-4 p-4 lg:p-6 overflow-hidden">
                
                <!-- Left Panel -->
                <div class="w-full lg:w-60 flex-shrink-0 flex flex-col gap-4">
                    <div class="flex justify-between items-center">
                        <button id="back-to-menu-btn" class="text-sm font-semibold text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300">‹ Trang chính</button>
                        <div class="flex items-center gap-2 lg:hidden">
                            <button id="early-finish-icon-btn" class="hidden p-2 rounded-full bg-indigo-500 text-white hover:bg-indigo-600 shadow-md">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fill-rule="evenodd" d="M10.293 15.707a1 1 0 010-1.414L14.586 10l-4.293-4.293a1 1 0 111.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                  <path fill-rule="evenodd" d="M4.293 15.707a1 1 0 010-1.414L8.586 10 4.293 5.707a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                                </svg>
                            </button>
                            <button id="pause-btn" class="p-2 rounded-full bg-white/50 hover:bg-white/80 dark:bg-slate-700/50 dark:hover:bg-slate-600/80">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1zm8 0a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1z"></path></svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-white/50 dark:bg-slate-800/30 border border-white/30 dark:border-slate-700/50 rounded-xl p-3 text-sm">
                        <div class="flex justify-between items-baseline mb-2">
                            <div class="flex items-baseline gap-2">
                                <span class="font-semibold text-slate-600 dark:text-slate-400">Cấp:</span>
                                <span id="level-stat" class="font-bold text-base">1</span>
                            </div>
                            <div class="flex items-center gap-2 font-bold text-base">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                <span id="score-stat">0</span>
                            </div>
                        </div>
                        <div class="flex justify-between items-center">
                            <div id="total-time-stat" class="font-bold text-base w-14">00:00</div>
                            <div id="penalty-tracker" class="flex items-center justify-center gap-1.5 flex-grow"></div>
                            <div id="lives-stat" class="flex items-center justify-end gap-1 text-xl tracking-wide"></div>
                        </div>
                    </div>
                    
                    <!-- In-game Hint Button -->
                    <div id="ingame-assists" class="mt-2 p-2 bg-white/50 dark:bg-slate-800/30 border border-white/30 dark:border-slate-700/50 rounded-xl">
                        <div class="grid grid-cols-2 gap-2 text-center">
                             <button id="assist-hint-btn" class="assist-btn p-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 flex flex-col items-center justify-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>
                                <span class="text-xs font-semibold">Gợi ý</span>
                                <span class="item-count" data-item="hints">0</span>
                            </button>
                            <button id="assist-hide-card-btn" class="assist-btn p-2 rounded-lg bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 hover:bg-slate-100 dark:hover:bg-slate-600 flex flex-col items-center justify-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                                <span class="text-xs font-semibold">Ẩn 1 ô</span>
                                <span class="item-count" data-item="hideCard">0</span>
                             </button>
                        </div>
                    </div>
                    
                    <div class="hidden lg:flex flex-col gap-3 mt-auto">
                        <div id="early-finish-container" class="w-full hidden"></div>
                        <button id="pause-btn-desktop" class="w-full flex items-center justify-center gap-2 bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 shadow-md">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1zm8 0a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1z" /></svg>
                           Tạm dừng
                        </button>
                    </div>
                </div>

                <!-- Center Panel -->
                <div class="flex-grow flex flex-col min-w-0 relative game-board-container">
                    <!-- In-game notification bar -->
                    <div id="ingame-notification" class="hidden items-center gap-2 rounded-lg shadow-md p-2 font-semibold z-10 mb-2 w-full h-[34px]">
                        <div id="ingame-notification-icon" class="flex-shrink-0"></div>
                        <p id="ingame-notification-text" class="flex-grow text-center text-sm"></p>
                    </div>
                    <!-- Original Game Info Bar -->
                    <div id="game-info-bar" class="flex items-center gap-4 mb-2 w-full h-[34px]">
                         <div id="ingame-active-assists-display" class="flex-shrink-0 flex items-center gap-1"></div>
                         <div class="flex-grow flex items-center gap-2">
                            <div class="w-full bg-slate-200/70 dark:bg-slate-700/70 rounded-full h-2.5">
                                <div id="completion-bar" class="bg-green-500 h-2.5 rounded-full transition-all" style="width: 0%"></div>
                            </div>
                            <span id="completion-stat" class="font-semibold text-sm text-slate-600 dark:text-slate-400 w-12 text-right">0%</span>
                        </div>
                        <div class="flex items-center gap-2 text-blue-600 dark:text-blue-400 font-semibold text-sm flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8 7a1 1 0 00-1 1v4a1 1 0 001 1h4a1 1 0 100-2H9V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                            <p id="selection-time-stat" class="w-6 text-center">00</p>
                        </div>
                    </div>
                    <div class="flex-grow flex flex-col items-center justify-center min-h-0 relative">
                        <div id="game-board" class="aspect-square"></div>
                        <div id="board-pause-overlay" class="hidden absolute inset-0 bg-white/60 dark:bg-slate-900/70 backdrop-blur-sm flex flex-col items-center justify-center gap-8 rounded-lg z-20">
                            <h3 class="text-2xl font-bold text-slate-800 dark:text-slate-200">Đã tạm dừng</h3>
                            <button id="surrender-btn-pause" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg hover:bg-red-700 shadow-md">Bỏ cuộc</button>
                        </div>
                    </div>
                </div>

                <!-- Right Panel -->
                <!-- FIX #4: Tăng chiều cao của bảng lịch sử trên điện thoại -->
                <div class="w-full lg:w-72 flex-shrink-0 flex flex-col h-48 lg:h-auto min-h-0">
                    <div id="history-panel" class="history-list h-full bg-white/50 dark:bg-slate-800/30 border border-white/30 dark:border-slate-700/50 rounded-xl p-2 overflow-y-auto">
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODALS & POPUPS - Moved outside of main container for correct positioning -->
    <div id="game-modal-container"></div>
    <div id="achievement-unlocked-container" class="fixed bottom-4 right-4 z-[9999] pointer-events-none"></div>
    
    <script type="module">
        // --- CONSTANTS & CONFIG ---
        const CURRENT_VERSION = 'v1.2.0';
        const ALL_SHAPES = ['square', 'circle', 'triangle', 'diamond'];
        const DUAL_SHAPE_COLORS = ['#ef4444', '#f59e0b', '#3b82f6', '#22c55e']; 
        const DUAL_BACKGROUNDS = ['#FFFFFF', '#27272a'];
        const CLASSIC_BACKGROUNDS = ['#9CA3AF', '#FFFFFF', '#1F2937'];
        const CLASSIC_SHAPE_COLORS = ['#ef4444', '#3b82f6', '#22c55e', '#FFFFFF', '#111827'];
        const LEVEL_CONFIG = {
            1: { size: 3, totalTime: 90, baseLives: 3 },
            2: { size: 4, totalTime: 180, baseLives: 4 },
            3: { size: 5, totalTime: 300, baseLives: 5 },
        };
        const SVGS = {
            square: c => `<svg viewBox="0 0 100 100" fill="${c}"><rect x="10" y="10" width="80" height="80" rx="8"></rect></svg>`,
            circle: c => `<svg viewBox="0 0 100 100" fill="${c}"><circle cx="50" cy="50" r="45"></circle></svg>`,
            triangle: c => `<svg viewBox="0 0 100 100" fill="${c}"><polygon points="50,5 95,95 5,95"></polygon></svg>`,
            diamond: c => `<svg viewBox="0 0 100 100" fill="${c}"><polygon points="50,5 95,50 50,95 5,50"></polygon></svg>`,
        };
        const SHOP_ITEMS = {
            'hints': { name: 'Gợi ý', price: 5000, description: 'Sử dụng trong trận để làm nổi bật một bộ ba hợp lệ.', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" /></svg>`},
            'hideCard': { name: 'Ẩn 1 ô', price: 10000, description: 'Sử dụng trong trận để ẩn đi 1 thẻ bài bạn chọn.', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`},
            'assistUseless': { name: 'Mờ ô vô dụng', price: 4000, description: 'Kích hoạt trước trận để làm mờ các ô không thuộc bộ nào.', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59" /></svg>` },
            'assistShape': { name: 'Ẩn hình đã chọn', price: 3000, description: 'Khi chọn 1 ô, các ô khác có cùng hình dạng sẽ bị ẩn.', icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>` },
        };
        const ASSIST_ICONS = {
            useless: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59" /></svg>`,
            shape: `<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.196-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.783-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" /></svg>`
        };
        const NOTIFICATION_ICONS = {
            success: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            error: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            info: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            achievement: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>`
        };
        const FIXED_SELECTION_TIME = 10;
        const TIME_BONUS_ON_CORRECT = 5;
        const PENALTY_TIMES = [3, 5, 7, 10, 15];
        const COMBO_TIME_BONUS = 30;
        const MAX_PENALTY_COUNT = 5;
        const AUTO_REDIRECT_DELAY = 5;
        const GAMEOVER_REVEAL_INTERVAL = 1800;
        const TIME_RESCUE_COST = 5000;
        const TIME_RESCUE_AMOUNT = 60; // seconds
        const TIME_RESCUE_COUNTDOWN = 10;

        // --- GAME STATE & UI ELEMENTS ---
        let state = {}; let tutorialState = {}; let selectedGameMode = 'dual';
        let playerData = {};
        let gameHistory = [];
        let settings = {
            isUselessDimEnabled: false,
            isShapeDimEnabled: false,
        };

        const ui = {
            views: { mainMenu: document.getElementById('main-menu'), shop: document.getElementById('shop-container'), tutorial: document.getElementById('tutorial-modal'), game: document.getElementById('game-container'), history: document.getElementById('history-view'), changelog: document.getElementById('changelog-modal'), achievements: document.getElementById('achievements-modal') },
            gameBoard: document.getElementById('game-board'),
            gameBoardContainer: document.querySelector('.game-board-container'),
            gameInfoBar: document.getElementById('game-info-bar'),
            pauseBtns: [document.getElementById('pause-btn'), document.getElementById('pause-btn-desktop')],
            surrenderBtnPause: document.getElementById('surrender-btn-pause'),
            boardPauseOverlay: document.getElementById('board-pause-overlay'),
            historyPanel: document.getElementById('history-panel'),
            notification: {
                banner: document.getElementById('ingame-notification'),
                icon: document.getElementById('ingame-notification-icon'),
                text: document.getElementById('ingame-notification-text'),
            },
            gameModalContainer: document.getElementById('game-modal-container'),
            achievementUnlockedContainer: document.getElementById('achievement-unlocked-container'),
            earlyFinishContainer: document.getElementById('early-finish-container'),
            earlyFinishIconBtn: document.getElementById('early-finish-icon-btn'),
            ingameActiveAssistsDisplay: document.getElementById('ingame-active-assists-display'),
            historyView: {
                openBtns: [document.getElementById('history-btn-main') /*, document.getElementById('history-btn-mobile') - REMOVED */],
                closeBtn: document.getElementById('close-history-btn'),
                overallStats: document.getElementById('overall-stats-section'),
                highScores: document.getElementById('high-scores-section'),
                gameLog: document.getElementById('game-log-section'),
                resetBtn: document.getElementById('reset-game-btn'),
            },
            achievementsView: {
                openBtns: [document.getElementById('achievements-btn-main') /*, document.getElementById('achievements-btn-mobile') - REMOVED */],
                closeBtn: document.getElementById('close-achievements-btn'),
                list: document.getElementById('achievements-list'),
            },
            shop: {
                openBtns: [document.getElementById('shop-btn-main') /*, document.getElementById('shop-btn-mobile') - REMOVED */],
                closeBtn: document.getElementById('close-shop-btn'),
                coinsMenu: document.getElementById('player-coins-menu-value'),
                coinsShop: document.getElementById('player-coins-shop-value'),
                itemsGrid: document.getElementById('shop-items-grid'),
            },
            stats: { 
                level: document.getElementById('level-stat'), 
                score: document.getElementById('score-stat'), 
                lives: document.getElementById('lives-stat'), 
                completion: document.getElementById('completion-stat'), 
                completionBar: document.getElementById('completion-bar'),
                totalTime: document.getElementById('total-time-stat'),
                selectionTime: document.getElementById('selection-time-stat'),
                penaltyTracker: document.getElementById('penalty-tracker'),
            },
            tutorial: { 
                modal: document.getElementById('tutorial-modal'),
                contentArea: document.getElementById('tutorial-content-area'),
                progress: document.getElementById('tutorial-progress'),
                prevBtn: document.getElementById('tutorial-prev-btn'),
                nextBtn: document.getElementById('tutorial-next-btn'),
                closeBtn: document.getElementById('close-tutorial-btn')
            },
            changelog: {
                modal: document.getElementById('changelog-modal'),
                openBtn: document.getElementById('version-number'),
                closeBtn: document.getElementById('close-changelog-btn'),
            },
            modeButtons: { classic: document.getElementById('mode-classic-btn'), dual: document.getElementById('mode-dual-btn') },
            assistBtns: {
                hint: document.getElementById('assist-hint-btn'),
                hideCard: document.getElementById('assist-hide-card-btn'),
                useless: document.getElementById('assist-useless-btn'),
                shape: document.getElementById('assist-shape-btn')
            },
            itemCounts: document.querySelectorAll('.item-count'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            lightThemeIcon: document.getElementById('theme-icon-light'),
            darkThemeIcon: document.getElementById('theme-icon-dark'),
        };
        
        function renderCard(card, index = 0) {
            const cardEl = document.createElement('div');
            cardEl.className = 'card aspect-square rounded-xl flex items-center justify-center cursor-pointer border-4 border-transparent';
            cardEl.dataset.id = card.id;
            cardEl.style.backgroundColor = card.background;
            if (card.background === DUAL_BACKGROUNDS[1]) cardEl.classList.add('border-gray-700');
            cardEl.innerHTML = SVGS[card.shape](card.shapeColor);
            cardEl.style.animation = `deal 0.5s ease-out ${index * 0.04}s both`;
            cardEl.addEventListener('animationend', (e) => {
                if (e.animationName === 'deal') cardEl.style.animation = '';
            }, { once: true });
            return cardEl;
        }

        const TUTORIAL_STEPS = [
            {
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Chào mừng đến với Trận Tử Chiến!</h3>
                    <p class="mb-4">Mục tiêu của bạn là tìm những bộ ba lá bài hợp lệ, được gọi là một <strong>"SET"</strong>, nhanh nhất có thể.</p>
                    <p>Có hai chế độ chơi với các quy tắc tìm SET khác nhau. Hãy cùng tìm hiểu nhé!</p>
                `
            },
            {
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Luật 1: Chế độ Nền Kép (Mặc định)</h3>
                    <p class="mb-4">Một SET hợp lệ phải thỏa mãn **TẤT CẢ** các điều kiện sau:</p>
                    <ul class="list-disc list-inside space-y-2 text-left mb-4">
                        <li>Tất cả các lá bài có <strong>CÙNG MÀU NỀN</strong> (cùng trắng hoặc cùng đen).</li>
                        <li>3 lá bài có <strong>3 HÌNH DẠNG KHÁC NHAU</strong>.</li>
                        <li>3 lá bài có <strong>3 MÀU SẮC HÌNH DẠNG KHÁC NHAU</strong>.</li>
                    </ul>
                    <p class="font-semibold mb-2">Ví dụ về một SET hợp lệ:</p>
                    <div class="flex justify-center gap-2">${renderCard({id: -1, background: '#FFFFFF', shape: 'square', shapeColor: '#ef4444'}, 0).outerHTML} ${renderCard({id: -2, background: '#FFFFFF', shape: 'circle', shapeColor: '#3b82f6'}, 0).outerHTML} ${renderCard({id: -3, background: '#FFFFFF', shape: 'triangle', shapeColor: '#22c55e'}, 0).outerHTML}</div>
                `
            },
            {
                 content: `
                    <h3 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Luật 2: Chế độ Cổ Điển</h3>
                    <p class="mb-4">Một SET hợp lệ phải thỏa mãn **TẤT CẢ** các điều kiện sau:</p>
                    <ul class="list-disc list-inside space-y-2 text-left mb-4">
                        <li>3 lá bài có <strong>3 MÀU NỀN KHÁC NHAU</strong>.</li>
                        <li>3 lá bài có <strong>3 HÌNH DẠNG KHÁC NHAU</strong>.</li>
                        <li>3 lá bài có <strong>3 MÀU SẮC HÌNH DẠNG KHÁC NHAU</strong>.</li>
                    </ul>
                     <p class="font-semibold mb-2">Ví dụ về một SET hợp lệ:</p>
                    <div class="flex justify-center gap-2">${renderCard({id: -4, background: '#9CA3AF', shape: 'square', shapeColor: '#FFFFFF'}, 0).outerHTML} ${renderCard({id: -5, background: '#FFFFFF', shape: 'circle', shapeColor: '#ef4444'}, 0).outerHTML} ${renderCard({id: -6, background: '#1F2937', shape: 'triangle', shapeColor: '#22c55e'}, 0).outerHTML}</div>
                `
            },
            {
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Cách Chơi & Tính Điểm</h3>
                    <p class="mb-4">Nhấn vào 3 lá bài bạn cho là một SET. Nếu đúng, bạn sẽ nhận được **Xu** thưởng. Tìm càng nhanh, thưởng càng nhiều!</p>
                    <ul class="list-disc list-inside space-y-2 text-left mb-4">
                        <li><strong>Phạt:</strong> Chọn sai sẽ bị trừ thời gian. 5 lần phạt liên tiếp sẽ mất 1 mạng.</li>
                        <li><strong>Combo:</strong> Tìm đúng liên tiếp để nhận thưởng thời gian lớn.</li>
                        <li><strong>Mạng:</strong> Bạn sẽ thua khi hết mạng hoặc hết giờ.</li>
                        <li><strong>Cứu viện:</strong> Khi hết giờ, bạn có thể dùng **5000 xu** để được cộng thêm thời gian.</li>
                    </ul>
                `
            },
            {
                content: `
                    <h3 class="text-2xl font-bold mb-4 text-slate-800 dark:text-white">Cửa Hàng & Vật Phẩm</h3>
                    <p class="mb-4">Dùng Xu kiếm được để mua các vật phẩm trong <strong>Cửa hàng</strong>.</p>
                    <ul class="list-disc list-inside space-y-2 text-left">
                        <li><strong>Gợi ý:</strong> Sử dụng trong trận để làm nổi bật một SET. Rất hữu ích khi bị bí!</li>
                        <li><strong>Ẩn 1 ô:</strong> Sử dụng trong trận để loại bỏ 1 ô bài khó chịu.</li>
                        <li><strong>Hỗ trợ (Mờ ô, Ẩn hình):</strong> Kích hoạt tại màn hình chính <strong>trước khi bắt đầu</strong>. Vật phẩm sẽ bị tiêu hao và có hiệu lực trong suốt 3 vòng chơi.</li>
                    </ul>
                    <p class="mt-4">Chúc bạn chơi game vui vẻ!</p>
                `
            }
        ];
        
        const ACHIEVEMENTS = {
            'score_1': { name: "Triệu phú Tập sự", description: "Đạt tổng cộng 10,000 xu.", icon: '💰', condition: (p) => p.coins >= 10000, reward: { type: 'coins', amount: 2500 } },
            'score_2': { name: "Đại gia", description: "Đạt tổng cộng 100,000 xu.", icon: '🤑', condition: (p) => p.coins >= 100000, reward: { type: 'hints', amount: 5 } },
            'sets_1': { name: "Thợ săn SET", description: "Tìm thấy 50 bộ hợp lệ.", icon: '🎯', condition: (p) => (p.stats.totalSetsFound || 0) >= 50, reward: { type: 'coins', amount: 5000 } },
            'sets_2': { name: "Bậc thầy SET", description: "Tìm thấy 250 bộ hợp lệ.", icon: '👑', condition: (p) => (p.stats.totalSetsFound || 0) >= 250, reward: { type: 'hideCard', amount: 3 } },
            'streak_1': { name: "Phong độ đỉnh cao", description: "Đạt chuỗi 10 bộ đúng liên tiếp trong một ván.", icon: '🔥', condition: (s) => s.maxCorrectStreak >= 10, reward: { type: 'coins', amount: 7500 } },
            'level_3_finish': { name: "Phá đảo", description: "Hoàn thành cấp độ 3.", icon: '🏆', condition: (s) => s.highestLevel > 3 || (s.highestLevel === 3 && s.isWin), reward: { type: 'assistUseless', amount: 2 } },
            'no_hints_win': { name: "Tự lực cánh sinh", description: "Thắng một ván (hoàn thành 3 cấp) mà không dùng Gợi ý hay Ẩn ô.", icon: '💪', condition: (s) => (s.highestLevel > 3 || (s.highestLevel === 3 && s.isWin)) && s.hintsUsed === 0 && s.hidesUsed === 0, reward: { type: 'coins', amount: 10000 } }
        };

        // --- DATA PERSISTENCE ---
        function loadPlayerData() {
            const savedData = localStorage.getItem('tripleZonePlayerData');
            if (savedData) {
                playerData = JSON.parse(savedData);
            } else {
                 // FIX #3: Tặng 5 vật phẩm mỗi loại khi bắt đầu
                playerData = { 
                    coins: 0, 
                    inventory: { hints: 5, hideCard: 5, assistUseless: 5, assistShape: 5 },
                    achievements: {},
                    stats: { totalSetsFound: 0 }
                };
            }
            // Migration for new data structures
            if (!playerData.inventory) playerData.inventory = { hints: 5, hideCard: 5, assistUseless: 5, assistShape: 5 };
            if (!playerData.inventory.hideCard) playerData.inventory.hideCard = 5;
            if (playerData.inventory.assistBg) delete playerData.inventory.assistBg;
            if (!playerData.achievements) playerData.achievements = {};
            if (!playerData.stats) playerData.stats = { totalSetsFound: 0 };

            Object.keys(ACHIEVEMENTS).forEach(id => {
                if (!playerData.achievements[id]) {
                    playerData.achievements[id] = { unlocked: false, claimed: false };
                }
            });
            
            updateCoinDisplay();
            updateInventoryDisplay();
        }

        function savePlayerData() {
            localStorage.setItem('tripleZonePlayerData', JSON.stringify(playerData));
        }

        function loadGameHistory() {
            const saved = localStorage.getItem('tripleZoneGameHistory');
            gameHistory = saved ? JSON.parse(saved) : [];
        }

        function saveGameHistory() {
            if (gameHistory.length > 50) {
                gameHistory = gameHistory.slice(gameHistory.length - 50);
            }
            localStorage.setItem('tripleZoneGameHistory', JSON.stringify(gameHistory));
        }

        // --- UTILITY & CORE LOGIC ---
        const formatTime = s => `${String(Math.floor(s/60)).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
        const getSetId = cs => cs.map(c => c.id).sort((a,b) => a-b).join('-');
        const parseMarkdown = (text) => text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold text-blue-600 dark:text-blue-400">$1</strong>');
        
        // FIX #2: Ngăn màu nền và hình trùng nhau trong chế độ Cổ điển
        function getCardPool(mode) {
            let cs = [], id = 0;
            const bgs = mode === 'classic' ? CLASSIC_BACKGROUNDS : DUAL_BACKGROUNDS;
            const allColors = mode === 'classic' ? CLASSIC_SHAPE_COLORS : DUAL_SHAPE_COLORS;
            
            bgs.forEach(bg => {
                let availableColors = allColors;
                if (mode === 'classic') {
                    // Luật đặc biệt cho nền xám: chỉ có hình trắng hoặc đen
                    if (bg === '#9CA3AF') {
                        availableColors = ['#FFFFFF', '#111827'];
                    } else {
                        // Lọc tất cả các màu hình trùng với màu nền
                        availableColors = allColors.filter(c => {
                            if (bg === '#FFFFFF') return c !== '#FFFFFF';
                            // Nếu nền gần đen (#1F2937), loại bỏ hình màu đen (#111827) để tránh nhầm lẫn
                            if (bg === '#1F2937') return c !== '#1F2937' && c !== '#111827';
                            return c !== bg;
                        });
                    }
                }

                ALL_SHAPES.forEach(s => {
                    availableColors.forEach(sc => {
                        cs.push({ id: id++, background: bg, shape: s, shapeColor: sc });
                    });
                });
            });
            return cs;
        }

        function checkSet(cards, mode) {
            if (cards.length !== 3) return false;
            const gameMode = mode || state.gameMode;
            
            const backgrounds = new Set(cards.map(c => c.background));
            const shapes = new Set(cards.map(c => c.shape));
            const shapeColors = new Set(cards.map(c => c.shapeColor));

            if (gameMode === 'classic') {
                return backgrounds.size === 3 && shapes.size === 3 && shapeColors.size === 3;
            } else { // 'dual' mode
                return backgrounds.size === 1 && shapes.size === 3 && shapeColors.size === 3;
            }
        }

        function findAllSets(board, mode) {
            const sets = [];
            const n = board.length;
            if (n < 3) return sets;

            for (let i = 0; i < n; i++) {
                for (let j = i + 1; j < n; j++) {
                    for (let k = j + 1; k < n; k++) {
                        const candidateSet = [board[i], board[j], board[k]];
                        if (checkSet(candidateSet, mode)) {
                            sets.push(candidateSet);
                        }
                    }
                }
            }
            return sets;
        }


        function generateBoard(level, mode) {
            const boardSize = LEVEL_CONFIG[level].size ** 2;
            const cardPool = getCardPool(mode);
            while (true) {
                let currentPool = [...cardPool];
                // Fisher-Yates shuffle
                for(let i=currentPool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[currentPool[i],currentPool[j]]=[currentPool[j],currentPool[i]];}
                const candidateBoard=currentPool.slice(0,boardSize);
                if (findAllSets(candidateBoard, mode).length > 0) return candidateBoard;
            }
        }
        
        // --- RENDER & UI ---
        function showView(viewName) { 
            Object.values(ui.views).forEach(v => v.classList.add('hidden')); 
            ui.views[viewName].classList.remove('hidden'); 
        }
        
        function showNotification(message, type = 'info') {
            if (state.isGameOver && type !== 'achievement') return; 

            if (type === 'achievement') {
                 const notifEl = document.createElement('div');
                 notifEl.className = 'achievement-notification panel flex items-center gap-3 p-4 rounded-lg shadow-lg w-72';
                 notifEl.innerHTML = `
                    <div class="flex-shrink-0 text-2xl">${NOTIFICATION_ICONS.achievement}</div>
                    <div>
                        <h4 class="font-bold">Mở khóa thành tựu!</h4>
                        <p class="text-sm text-slate-600 dark:text-slate-400">${message}</p>
                    </div>
                 `;
                 ui.achievementUnlockedContainer.appendChild(notifEl);
                 setTimeout(() => notifEl.remove(), 4500);
                 return;
            }

            if (state.notificationTimer) {
                clearTimeout(state.notificationTimer);
            }

            ui.gameInfoBar.classList.add('hidden');

            const banner = ui.notification.banner;
            const icon = ui.notification.icon;
            const text = ui.notification.text;

            text.textContent = message;
            
            const typeClasses = {
                success: 'bg-green-500 text-white',
                error: 'bg-red-500 text-white',
                info: 'bg-yellow-400 text-yellow-900'
            };
            
            banner.className = 'flex items-center gap-2 rounded-lg shadow-md p-2 font-semibold z-10 mb-2 w-full h-[34px]'; // Reset
            
            const classesToAdd = typeClasses[type].split(' ');
            banner.classList.add(...classesToAdd);

            icon.innerHTML = NOTIFICATION_ICONS[type];
            
            banner.classList.remove('hidden', 'hide');
            banner.classList.add('show');
            
            const hideBanner = () => {
                const onFadeOutEnd = (event) => {
                    if (event.animationName === 'fadeOut') {
                        banner.classList.add('hidden');
                        if (!state.isGameOver) {
                            ui.gameInfoBar.classList.remove('hidden');
                        }
                        state.notificationTimer = null;
                        banner.removeEventListener('animationend', onFadeOutEnd);
                    }
                };
                
                banner.addEventListener('animationend', onFadeOutEnd);
                banner.classList.remove('show');
                banner.classList.add('hide');
            };

            state.notificationTimer = setTimeout(hideBanner, 2000);
        }

        function showSetFeedback(isCorrect) {
             const feedbackContainer = document.createElement('div');
             feedbackContainer.className = 'feedback-icon-container';
             if (isCorrect) {
                 feedbackContainer.innerHTML = '✓';
                 feedbackContainer.className += ' text-green-500';
             }
             
             ui.gameBoard.appendChild(feedbackContainer);
             setTimeout(() => feedbackContainer.remove(), 800);
        }

        function updateCoinDisplay() {
            ui.shop.coinsMenu.textContent = playerData.coins.toLocaleString();
            ui.shop.coinsShop.textContent = playerData.coins.toLocaleString();
        }
        function updateInventoryDisplay() {
            ui.itemCounts.forEach(el => {
                const itemKey = el.dataset.item;
                if(playerData.inventory) {
                   el.textContent = playerData.inventory[itemKey] || 0;
                }
            });
            if (!ui.views.shop.classList.contains('hidden')) {
                renderShop();
            }
        }

        function renderBoard(container, cards) {
            container.innerHTML = '';
            if (container.id === 'game-board' && state.level) { 
                container.classList.remove('level-1', 'level-2', 'level-3');
                container.classList.add(`level-${state.level}`);
            }
            cards.forEach((card, index) => {
                const cardEl = renderCard(card, index);
                // Mouseover for assist preview is still useful
                cardEl.addEventListener('mouseover', () => {
                    if (state.isGameOver || state.isPaused || state.isChecking || state.isHidingCard || document.getElementById('post-game-overlay')) return;
                    state.hoveredShape = card.shape;
                    updateBoardAppearance();
                });
                cardEl.addEventListener('mouseout', () => {
                    if (state.isGameOver || state.isPaused || state.isChecking || state.isHidingCard) return;
                    state.hoveredShape = null;
                    updateBoardAppearance();
                });
                container.appendChild(cardEl);
            });
        }
        
        function createHistoryItem(cards, itemNumber) {
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item bg-white/70 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700';
            
            historyItem.addEventListener('mouseover', () => {
                if (state.isGameOver) return;
                state.historyHoverSet = cards;
                updateBoardAppearance();
            });

            historyItem.addEventListener('mouseout', () => {
                if (state.isGameOver) return;
                state.historyHoverSet = null;
                updateBoardAppearance();
            });

            const numberEl = document.createElement('span');
            numberEl.className = 'text-sm font-bold text-slate-500 dark:text-slate-400 w-5 text-center';
            numberEl.textContent = `${itemNumber}.`;
            historyItem.appendChild(numberEl);

            const cardContainer = document.createElement('div');
            cardContainer.className = 'card-container';
            cards.sort((a, b) => a.id - b.id).forEach(card => {
                const cardEl = renderCard(card);
                cardEl.classList.remove('cursor-pointer', 'aspect-square');
                cardEl.style.animation = 'none';
                cardContainer.appendChild(cardEl);
            });
            historyItem.appendChild(cardContainer);
            return historyItem;
        }

        function renderStats() {
             ui.stats.level.textContent = state.level;
             ui.stats.score.textContent = (state.sessionScore || 0).toLocaleString();
             const livesCount = state.lives > 0 ? state.lives : 0;
             ui.stats.lives.innerHTML = `<span class="text-red-500 text-xl mr-1">❤️</span> <span class="font-bold text-lg align-middle">${livesCount}</span>`;
             
             const percentage = state.totalSetsInRound > 0 ? Math.round((state.foundSets.size / state.totalSetsInRound) * 100) : 0;
             ui.stats.completion.textContent = `${percentage}%`;
             ui.stats.completionBar.style.width = `${percentage}%`;
             ui.stats.totalTime.textContent = formatTime(state.totalTimeLeft || 0);
             ui.stats.selectionTime.textContent = String(state.selectionTimeLeft || 0).padStart(2, '0');
             ui.stats.penaltyTracker.innerHTML = '';
             for (let i = 0; i < MAX_PENALTY_COUNT; i++) {
                const dot = document.createElement('div');
                dot.className = 'w-2 h-2 rounded-full transition-colors duration-300';
                if (state.comboCount > 0 && i < state.comboCount) {
                    dot.classList.add('bg-green-500');
                } else if (state.penaltyCount > 0 && i < state.penaltyCount) {
                    dot.classList.add('bg-red-500');
                } else {
                    dot.classList.add('bg-slate-300', 'dark:bg-slate-600');
                }
                ui.stats.penaltyTracker.appendChild(dot);
            }
        }
        
        function renderActiveAssists() {
            ui.ingameActiveAssistsDisplay.innerHTML = '';
            
            const createIcon = (type, title) => {
                const iconContainer = document.createElement('div');
                iconContainer.className = 'p-1 rounded-full bg-blue-100 dark:bg-blue-900/50 text-blue-600 dark:text-blue-300';
                iconContainer.title = title;
                iconContainer.innerHTML = ASSIST_ICONS[type];
                return iconContainer.outerHTML;
            }

            if (settings.isUselessDimEnabled) ui.ingameActiveAssistsDisplay.innerHTML += createIcon('useless', 'Mờ ô vô dụng');
            if (settings.isShapeDimEnabled) ui.ingameActiveAssistsDisplay.innerHTML += createIcon('shape', 'Ẩn hình đã chọn');
        }

        // --- SHOP LOGIC ---
        function renderShop() {
            ui.shop.itemsGrid.innerHTML = '';
            Object.entries(SHOP_ITEMS).forEach(([id, item]) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'panel p-4 rounded-xl flex items-center gap-4';
                const ownedCount = playerData.inventory[id] || 0;

                itemEl.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-blue-100 dark:bg-slate-700 rounded-lg text-blue-600 dark:text-blue-300">
                        ${item.icon}
                    </div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800 dark:text-slate-100">${item.name}</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mb-2">${item.description}</p>
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-1 font-semibold text-yellow-500">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                                <span>${item.price.toLocaleString()}</span>
                            </div>
                            <span class="text-sm font-semibold bg-slate-200 dark:bg-slate-600 px-2 py-1 rounded-md">Sở hữu: ${ownedCount}</span>
                        </div>
                    </div>
                    <button data-item-id="${id}" class="buy-btn flex-shrink-0 bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 disabled:bg-blue-400 dark:disabled:bg-blue-800 text-sm transition-colors">Mua</button>
                `;
                ui.shop.itemsGrid.appendChild(itemEl);
            });
            document.querySelectorAll('.buy-btn').forEach(btn => btn.addEventListener('click', (e) => buyItem(e.target.dataset.itemId)));
        }

        function buyItem(itemId, fromGame = false) {
            const item = SHOP_ITEMS[itemId];
            if (!item) return;

            if (playerData.coins >= item.price) {
                playerData.coins -= item.price;
                playerData.inventory[itemId] = (playerData.inventory[itemId] || 0) + 1;
                savePlayerData();
                updateCoinDisplay();
                updateInventoryDisplay(); 
                if (!fromGame) {
                    showGameModal('Mua thành công!', `Bạn đã mua ${item.name}.`, 'OK', () => ui.gameModalContainer.innerHTML = '');
                } else {
                    showNotification(`${item.name} đã được thêm vào!`, 'success');
                }
                return true;
            } else {
                 if (!fromGame) {
                    showGameModal('Không đủ xu', 'Bạn không có đủ xu để mua vật phẩm này. Hãy chơi game để kiếm thêm!', 'OK', () => { ui.gameModalContainer.innerHTML = '' });
                } else {
                    showNotification('Không đủ xu!', 'error');
                }
                return false;
            }
        }
        
        function promptInGamePurchase(itemId) {
            stopAllTimers();
            const item = SHOP_ITEMS[itemId];
            if (!item) return;

            const canAfford = playerData.coins >= item.price;

            showGameModal(
                `Mua ${item.name}?`,
                `Bạn đã hết ${item.name.toLowerCase()}. Bạn có muốn mua 1 cái với giá ${item.price.toLocaleString()} xu không?<br><br><strong>Số dư: ${playerData.coins.toLocaleString()} xu</strong>`,
                null,
                null, {
                    buttons: [
                         { id: 'ingame-buy-yes', text: 'Mua', classes: `w-full font-bold py-2 px-4 rounded-lg ${canAfford ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}`,
                            callback: () => {
                                ui.gameModalContainer.innerHTML = ''; 
                                if (canAfford) {
                                    if (buyItem(itemId, true)) {
                                       if(itemId === 'hints') useHint(true);
                                       if(itemId === 'hideCard') useHideCard(true);
                                    }
                                }
                                startAllTimers();
                            }
                        },
                         { id: 'ingame-buy-no', text: 'Không', classes: 'w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg',
                            callback: () => { 
                                ui.gameModalContainer.innerHTML = ''; 
                                startAllTimers();
                            } 
                        }
                    ]
                }
            );
            document.getElementById('ingame-buy-yes').disabled = !canAfford;
        }

        // --- ASSIST LOGIC ---
        function useHint(justPurchased = false) {
            if (!justPurchased && playerData.inventory.hints <= 0) {
                promptInGamePurchase('hints');
                return;
            }
            
            const boardCards = state.boardCards.filter(c => c.id !== state.hiddenCardId);
            const undiscoveredSets = findAllSets(boardCards, state.gameMode).filter(set => !state.foundSets.has(getSetId(set)));

            if (undiscoveredSets.length > 0) {
                if(!justPurchased) {
                   if(state.currentSessionStats) state.currentSessionStats.hintsUsed++;
                   playerData.inventory.hints--;
                   savePlayerData();
                   updateInventoryDisplay();
                }

                const setToReveal = undiscoveredSets[0];
                setToReveal.forEach(card => {
                    const cardEl = ui.gameBoard.querySelector(`[data-id='${card.id}']`);
                    if (cardEl) cardEl.classList.add('highlighted');
                });

                setTimeout(() => {
                     setToReveal.forEach(card => {
                        const cardEl = ui.gameBoard.querySelector(`[data-id='${card.id}']`);
                        if (cardEl) cardEl.classList.remove('highlighted');
                    });
                }, 2000);
            } else {
                 showNotification('Không còn bộ nào để tìm!', 'info');
            }
        }
        
        function useHideCard(justPurchased = false) {
             if (!justPurchased && playerData.inventory.hideCard <= 0) {
                promptInGamePurchase('hideCard');
                return;
            }
            if(state.hiddenCardId !== null) {
                showNotification('Bạn chỉ có thể ẩn 1 ô mỗi cấp!', 'info');
                return;
            }
            
            if(!justPurchased) {
               stopAllTimers();
            }

            state.isHidingCard = true;
            ui.gameBoard.classList.add('hiding-mode');
            showNotification('Chọn một thẻ bài để ẩn đi', 'info');
            ui.gameBoard.querySelectorAll('.card').forEach(c => c.classList.add('hiding-mode'));
        }
        
        // --- GAME FLOW (Updates) ---

        function processCorrectSet() {
            const currentSetId = getSetId(state.selectedCards);
            if (state.foundSets.has(currentSetId)) {
                showNotification('Đã tìm thấy!', 'info');
                return; 
            }
            
            state.foundSets.add(currentSetId);
            playerData.stats.totalSetsFound = (playerData.stats.totalSetsFound || 0) + 1;
            
            const timeTaken = (Date.now() - state.lastSetFoundTimestamp) / 1000;
            const pointsEarned = Math.round(Math.max(10, 500 / timeTaken) * (state.gameMode === 'classic' ? 1.5 : 1));
            
            playerData.coins += pointsEarned;
            state.sessionScore += pointsEarned;

            state.totalTimeLeft += TIME_BONUS_ON_CORRECT;
            showSetFeedback(true);
            ui.historyPanel.prepend(createHistoryItem(state.selectedCards, state.foundSets.size));
            ui.historyPanel.scrollTop = 0;
            
            state.lastSetFoundTimestamp = Date.now();
            state.comboCount++;
            state.penaltyCount = 0; 
            
            if(state.currentSessionStats) {
                state.currentSessionStats.setFindTimes.push(timeTaken);
                state.currentSessionStats.correctStreak++;
                state.currentSessionStats.errorStreak = 0;
                state.currentSessionStats.maxCorrectStreak = Math.max(state.currentSessionStats.maxCorrectStreak, state.currentSessionStats.correctStreak);
            }

            if (state.comboCount >= MAX_PENALTY_COUNT) {
                state.totalTimeLeft += COMBO_TIME_BONUS;
                showNotification(`COMBO! +${COMBO_TIME_BONUS}s`, 'success');
                state.comboCount = 0; 
            }
            
            const boardCards = state.boardCards.filter(c => c.id !== state.hiddenCardId);
            const unfoundSets = findAllSets(boardCards, state.gameMode).filter(set => !state.foundSets.has(getSetId(set)));
            state.usefulCardIds = new Set(unfoundSets.flat().map(card => card.id));
            
            updateEarlyFinishButton();

            state.selectedCards.forEach(c => ui.gameBoard.querySelector(`[data-id='${c.id}']`)?.classList.add('correct'));
            
            checkAchievements();
            savePlayerData();
        }

        function processIncorrectSet() {
            showNotification('Sai rồi!', 'error');
            handlePenalty();
            state.selectedCards.forEach(c => {
                const cardEl = ui.gameBoard.querySelector(`[data-id='${c.id}']`);
                if (cardEl) cardEl.style.animation = 'shake 0.4s';
            });
        }
        
        function handleConfirm() {
            if (state.isGameOver || state.isPaused || state.selectedCards.length !== 3 || state.isChecking) return;
            state.isChecking = true;

            const isAValidSet = checkSet(state.selectedCards);
            if (isAValidSet) {
                processCorrectSet();
            } else { 
                processIncorrectSet();
            }

            setTimeout(() => {
                state.selectedCards.forEach(c => {
                     const cardEl = ui.gameBoard.querySelector(`[data-id='${c.id}']`);
                     if(cardEl) {
                        cardEl.style.animation = '';
                        cardEl.classList.remove('correct', 'selected');
                     }
                });
                
                state.selectedCards = [];
                state.isChecking = false;
                renderStats(); 
                updateBoardAppearance();

                if (state.isGameOver) return; 

                if (state.foundSets.size >= state.totalSetsInRound) {
                    levelUp();
                } else {
                    resetAndStartSelectionTimer();
                    if (state.totalTimeLeft <= 0) {
                        promptForTimeRescue();
                    }
                }
            }, 500);
        }

        function handleBoardClick(event) {
            const cardEl = event.target.closest('.card');
            if (!cardEl) return;
            
            const cardId = parseInt(cardEl.dataset.id, 10);
            
            // Handle "Hide Card" logic
            if (state.isHidingCard) {
                if(playerData.inventory.hideCard > 0) {
                    playerData.inventory.hideCard--;
                    if(state.currentSessionStats) state.currentSessionStats.hidesUsed++;
                    updateInventoryDisplay();
                    savePlayerData();
                } else { // Should not happen due to initial check, but as a safeguard
                     state.isHidingCard = false;
                     updateBoardAppearance();
                     startAllTimers();
                     return;
                }

                state.isHidingCard = false;
                state.hiddenCardId = cardId;
                ui.gameBoard.classList.remove('hiding-mode');
                cardEl.classList.add('hidden-card');
                ui.gameBoard.querySelectorAll('.card').forEach(c => c.classList.remove('hiding-mode'));
                
                // Recalculate sets
                const currentBoard = state.boardCards.filter(c => c.id !== state.hiddenCardId);
                state.allSetsInRound = findAllSets(currentBoard, state.gameMode);
                state.totalSetsInRound = state.allSetsInRound.length;
                state.usefulCardIds = new Set(state.allSetsInRound.flat().map(c => c.id));

                updateBoardAppearance();
                renderStats();
                startAllTimers();
                return;
            }
            
            // Normal card selection logic
            if (state.isGameOver || state.isPaused || state.isChecking || (cardEl.classList.contains('dimmed') && !cardEl.classList.contains('selected'))) return;

            const cardData = state.boardCards.find(c => c.id === cardId);
            if (!cardData) return;
            
            const index = state.selectedCards.findIndex(c => c.id === cardData.id);
            
            if (index > -1) { 
                state.selectedCards.splice(index, 1); 
                cardEl.classList.remove('selected'); 
            } else if (state.selectedCards.length < 3) { 
                state.selectedCards.push(cardData); 
                cardEl.classList.add('selected'); 
                if (state.selectedCards.length === 3) {
                    handleConfirm();
                }
            }
            updateBoardAppearance();
        }

        function updateEarlyFinishButton() {
            const percentage = Math.round((state.foundSets.size / state.totalSetsInRound) * 100);
            const isVisible = state.level === 3 && percentage >= 50 && state.foundSets.size < state.totalSetsInRound;

            if(isVisible) {
                const finishButtonHtml = `<button id="finish-early-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-md w-full mb-2">Tổng kết ngay (${percentage}%)</button>`;
                ui.earlyFinishContainer.innerHTML = finishButtonHtml;
                document.getElementById('finish-early-btn').onclick = () => gameOver(`Kết thúc sớm ở cấp 3 với ${percentage}% hoàn thành.`);
            }
            ui.earlyFinishContainer.classList.toggle('hidden', !isVisible);
            ui.earlyFinishIconBtn.classList.toggle('hidden', !isVisible);
        }
        
        function loseLife(){ if(state.lives>0){ state.lives--; renderStats(); if(state.lives<=0) gameOver('Hết mạng!'); } }

        function showGameModal(title, message, buttonText, callback, options = {}) {
            if (document.getElementById('game-modal-overlay')) return; // Prevent multiple modals

            const buttonsHtml = options.buttons ? options.buttons.map(btn => `<button id="${btn.id}" class="${btn.classes}">${btn.text}</button>`).join('') : `<button id="modal-button" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">OK</button>`;
            
            let modalContent = `
                <div id="game-modal-overlay" class="fixed inset-0 bg-black/60 dark:bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" ${options.closeOnOverlay ? 'data-close-on-overlay="true"' : ''}>
                    <div class="panel p-6 sm:p-8 text-center max-w-sm w-full" style="animation: fadeInUp 0.3s ease-out;">
                        ${options.countdownCircle || ''}
                        <h2 class="text-2xl font-bold mb-4">${title}</h2>
                        <p class="mb-6">${message}</p>
                        <div class="flex gap-4 justify-center">${buttonsHtml}</div>
                    </div>
                </div>`;
                
            ui.gameModalContainer.innerHTML = modalContent;
            
            stopAllTimers();

            if (options.buttons) {
                options.buttons.forEach(btn => {
                    const btnEl = document.getElementById(btn.id);
                    if(btnEl) btnEl.onclick = () => { if(btn.callback) btn.callback(); };
                });
            } else {
                 document.getElementById('modal-button').onclick = () => {
                    ui.gameModalContainer.innerHTML = '';
                    if (callback) callback();
                 };
            }
            
            if (options.closeOnOverlay) {
                document.getElementById('game-modal-overlay').addEventListener('click', (e) => {
                    if (e.target.id === 'game-modal-overlay') {
                        if (options.onOverlayClick) options.onOverlayClick();
                    }
                });
            }

            // FIX #8: Xử lý đồng hồ đếm ngược
            if (options.countdown) {
                let timeLeft = options.countdown;
                if (state.modalTimerId) clearInterval(state.modalTimerId);
                const countdownCircle = document.getElementById('countdown-timer-path');
                const timer = setInterval(() => {
                    timeLeft--;
                    if(countdownCircle) {
                        const progress = (timeLeft / options.countdown);
                        countdownCircle.style.strokeDashoffset = 283 * (1 - progress);
                    }
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        state.modalTimerId = null;
                        if (options.onTimerEnd) options.onTimerEnd();
                    }
                }, 1000);
                state.modalTimerId = timer;
            }
        }

        function promptForTimeRescue() {
            stopAllTimers();
            const canAfford = playerData.coins >= TIME_RESCUE_COST;
            const endRescue = () => {
                if (state.modalTimerId) clearInterval(state.modalTimerId);
                state.modalTimerId = null;
                ui.gameModalContainer.innerHTML = '';
                gameOver('Hết giờ!');
            };
            
            showGameModal(
                'Hết giờ!',
                `Dùng ${TIME_RESCUE_COST.toLocaleString()} xu để thêm ${TIME_RESCUE_AMOUNT} giây? <br><br><strong>Số dư: ${playerData.coins.toLocaleString()} xu</strong>`,
                null,
                null,
                {
                    buttons: [{
                        id: 'rescue-yes-btn',
                        text: `Đồng ý (${TIME_RESCUE_COST.toLocaleString()} xu)`,
                        classes: `w-full font-bold py-3 px-4 rounded-lg ${canAfford ? 'bg-green-600 text-white hover:bg-green-700' : 'bg-gray-400 text-gray-700 cursor-not-allowed'}`,
                        callback: () => {
                            // FIX #8: Dừng đồng hồ khi đồng ý
                            if (state.modalTimerId) clearInterval(state.modalTimerId);
                            state.modalTimerId = null;

                            if (canAfford) {
                                playerData.coins -= TIME_RESCUE_COST;
                                state.totalTimeLeft += TIME_RESCUE_AMOUNT;
                                savePlayerData();
                                updateCoinDisplay();
                                ui.gameModalContainer.innerHTML = '';
                                startAllTimers();
                            } else {
                                // If somehow clicked while disabled, just close and end game.
                                endRescue();
                            }
                        }
                    }],
                    countdown: TIME_RESCUE_COUNTDOWN,
                    onTimerEnd: endRescue,
                    closeOnOverlay: true,
                    onOverlayClick: endRescue,
                    countdownCircle: `
                        <div class="relative w-24 h-24 mx-auto mb-4">
                            <svg class="w-full h-full" viewBox="0 0 100 100">
                                <circle class="text-slate-300 dark:text-slate-700" stroke-width="10" stroke="currentColor" fill="transparent" r="45" cx="50" cy="50" />
                                <path id="countdown-timer-path" d="M 50, 5 a 45,45 0 1,1 0,90 a 45,45 0 1,1 0,-90"
                                      class="text-red-500" stroke-width="10" stroke-linecap="round" stroke="currentColor" fill="transparent"
                                      style="stroke-dasharray: 283; stroke-dashoffset: 283; transform: rotate(-90deg); transform-origin: center; transition: stroke-dashoffset 1s linear;" />
                            </svg>
                            <span class="absolute inset-0 flex items-center justify-center text-3xl font-bold">${TIME_RESCUE_COUNTDOWN}</span>
                        </div>
                    `
                }
            );
            document.getElementById('rescue-yes-btn').disabled = !canAfford;
        }


        function gameOver(reason) {
            if(state.isGameOver) return;
            if (state.isPaused) togglePause();
            stopAllTimers();
            state.isGameOver = true;
            ui.gameInfoBar.classList.add('hidden');
            ui.earlyFinishContainer.classList.add('hidden'); 
            ui.earlyFinishIconBtn.classList.add('hidden');
            
            if (state.currentSessionStats) {
                const finalStats = state.currentSessionStats;
                finalStats.isWin = state.level > 3 || (state.level === 3 && state.foundSets.size >= state.totalSetsInRound);
                finalStats.finalScore = state.sessionScore || 0;
                finalStats.highestLevel = state.level;
                finalStats.totalSets = finalStats.setFindTimes.length;
                finalStats.usedAssists = settings;
                if (finalStats.totalSets > 0) {
                    finalStats.avgTimePerSet = finalStats.setFindTimes.reduce((a, b) => a + b, 0) / finalStats.totalSets;
                } else {
                    finalStats.avgTimePerSet = 0;
                }
                gameHistory.push(finalStats);
                checkAchievements(); // Check achievements one last time with final game stats
                saveGameHistory();
                savePlayerData();
            }

            const boardCards = state.boardCards.filter(c => c.id !== state.hiddenCardId);
            const allSetsOnBoard = findAllSets(boardCards, state.gameMode);
            const missedSets = allSetsOnBoard.filter(set => !state.foundSets.has(getSetId(set)));

            const showFinalModal = () => {
                const overlay = document.getElementById('post-game-overlay');
                if (overlay) overlay.remove();
                stopAllTimers();
                
                showGameModal(
                    'Trò Chơi Kết Thúc', 
                    `${reason}<br>Tổng xu hiện tại: <span class="font-bold">${playerData.coins.toLocaleString()}</span>`, 
                    'Về Trang Chính', 
                    () => {
                        cleanupAndResetGame();
                        updateCoinDisplay();
                        showView('mainMenu');
                    },
                    { autoCloseDelay: AUTO_REDIRECT_DELAY }
                );
            };
            
            if (missedSets.length > 0) {
                 const gameContainer = document.getElementById('game-container');
                 gameContainer.insertAdjacentHTML('beforeend', `
                    <div id="post-game-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm flex flex-col justify-between items-center py-8 px-4 z-40 cursor-pointer" style="animation: fadeInUp 0.5s;">
                        <div class="w-full max-w-3xl mx-auto pointer-events-none">
                              <div id="missed-sets-summary" class="flex flex-nowrap gap-4 overflow-x-auto pb-4 pointer-events-auto"></div>
                        </div>
                        <div class="w-full max-w-3xl mx-auto pointer-events-none">
                            <p class="text-white/80 text-center text-sm">Nhấn vào vùng trống để bỏ qua</p>
                        </div>
                    </div>`);
                const missedSetsSummary = document.getElementById('missed-sets-summary');
                document.getElementById('post-game-overlay').onclick = (e) => { if(e.target.id === 'post-game-overlay') showFinalModal(); };
                ui.gameBoard.style.zIndex = '45'; 

                let revealIndex = 0;
                state.revealInterval = setInterval(() => {
                    if (revealIndex < missedSets.length) {
                        ui.gameBoard.querySelectorAll('.card').forEach(c => c.classList.add('dimmed'));
                        missedSets[revealIndex].forEach(card => ui.gameBoard.querySelector(`[data-id='${card.id}']`)?.classList.remove('dimmed'));
                        missedSetsSummary.appendChild(createHistoryItem(missedSets[revealIndex], revealIndex + 1));
                        missedSetsSummary.scrollLeft = missedSetsSummary.scrollWidth;
                        revealIndex++;
                    } else {
                        stopAllTimers();
                        setTimeout(showFinalModal, 2000);
                    }
                }, GAMEOVER_REVEAL_INTERVAL);
            } else {
                showFinalModal();
            }
        }
        
        function levelUp() {
            stopAllTimers();
            updateEarlyFinishButton();
            state.timeRollover = state.totalTimeLeft;
            const nextLevel = state.level + 1;
            
            state.hiddenCardId = null; // Reset hidden card for new level

            if (LEVEL_CONFIG[nextLevel]) {
                showGameModal(`Hoàn Thành Cấp Độ ${state.level}!`, `Bạn thật xuất sắc!<br>Thưởng +${state.timeRollover} giây và +1 mạng!<br>Tổng xu: <span class="font-bold">${playerData.coins.toLocaleString()}</span>`, `Tới Cấp Độ ${nextLevel}`, () => startLevel(nextLevel));
            } else {
                gameOver('Bạn đã hoàn thành tất cả các cấp độ!');
            }
        }
        
        function handlePenalty() {
            state.comboCount = 0;
            state.penaltyCount++;
            const penaltyAmount = PENALTY_TIMES[state.penaltyCount-1] || PENALTY_TIMES[PENALTY_TIMES.length - 1];
            state.totalTimeLeft -= penaltyAmount;

            if(state.currentSessionStats) {
                state.currentSessionStats.errors++;
                state.currentSessionStats.errorStreak++;
                state.currentSessionStats.correctStreak = 0;
                state.currentSessionStats.maxErrorStreak = Math.max(state.currentSessionStats.maxErrorStreak, state.currentSessionStats.errorStreak);
            }

            if (state.penaltyCount >= MAX_PENALTY_COUNT) {
                loseLife();
                showNotification('5 lần bị phạt, -1 mạng!', 'error');
                state.penaltyCount = 0;
            }
            renderStats();
        }
        
        // FIX #9: Sửa lỗi làm mờ các ô đã thuộc bộ cũ
        function updateBoardAppearance() {
            if (!state.boardCards) return;
            const historyCardIds = state.historyHoverSet ? new Set(state.historyHoverSet.map(c => c.id)) : null;
            
            // Logic mới để tìm các thẻ thứ ba hoàn thành một bộ đã tìm thấy
            let completedSetThirdCardIds = new Set();
            if (state.selectedCards.length === 2) {
                const boardCardsToCheck = state.boardCards.filter(c => 
                    c.id !== state.selectedCards[0].id && 
                    c.id !== state.selectedCards[1].id
                );

                for (const thirdCard of boardCardsToCheck) {
                    const candidateSet = [state.selectedCards[0], state.selectedCards[1], thirdCard];
                    const setId = getSetId(candidateSet);
                    if (state.foundSets.has(setId)) {
                        completedSetThirdCardIds.add(thirdCard.id);
                    }
                }
            }
            
            ui.gameBoard.querySelectorAll('.card').forEach(cardEl => {
                const cardId = parseInt(cardEl.dataset.id, 10);
                const cardData = state.boardCards.find(c => c.id === cardId);
                if (!cardData) return;

                const isSelected = state.selectedCards.some(c => c.id === cardId);
                
                if (historyCardIds) {
                    cardEl.classList.toggle('dimmed', !historyCardIds.has(cardId));
                    return;
                }

                let isDimmed = false;
                // Làm mờ các ô không thuộc bộ nào
                if (settings.isUselessDimEnabled && !state.usefulCardIds.has(cardId)) {
                    isDimmed = true;
                }
                // Làm mờ các ô cùng hình dạng
                if (!isDimmed && settings.isShapeDimEnabled && state.selectedCards.length > 0) {
                    const selectedShapes = new Set(state.selectedCards.map(c => c.shape));
                    if (!isSelected && selectedShapes.has(cardData.shape)) {
                        isDimmed = true;
                    }
                }
                // Làm mờ ô thứ 3 của một bộ đã tìm thấy
                if (!isDimmed && !isSelected && completedSetThirdCardIds.has(cardId)) {
                    isDimmed = true;
                }
                
                cardEl.classList.toggle('dimmed', isDimmed);
            });
        }
        
        function togglePause() {
            if (ui.views.game.classList.contains('hidden') || document.getElementById('post-game-overlay') || state.isGameOver) return;
            state.isPaused = !state.isPaused;
            const continueIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M6.3 2.841A1.5 1.5 0 004 4.11V15.89a1.5 1.5 0 002.3 1.269l9.344-5.89a1.5 1.5 0 000-2.538L6.3 2.84z" /></svg>';
            const pauseIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1zm8 0a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1z" /></svg>';
            if (state.isPaused) {
                stopAllTimers();
                ui.boardPauseOverlay.classList.remove('hidden');
                ui.pauseBtns.forEach(btn => btn.innerHTML = (btn.id === 'pause-btn-desktop') ? `${continueIcon} Tiếp tục` : continueIcon);
            } else {
                startAllTimers();
                ui.boardPauseOverlay.classList.add('hidden');
                ui.pauseBtns.forEach(btn => btn.innerHTML = (btn.id === 'pause-btn-desktop') ? `${pauseIcon} Tạm dừng` : pauseIcon);
            }
        }

        function stopAllTimers() {
            clearInterval(state.totalTimerId);
            clearInterval(state.selectionTimerId);
            if(state.revealInterval) clearInterval(state.revealInterval);
            if(state.modalTimerId) clearInterval(state.modalTimerId);
        }

        function startAllTimers() {
            stopAllTimers();
            state.totalTimerId = setInterval(() => {
                if(state.isPaused || state.isGameOver) return;
                if (state.totalTimeLeft > 0) {
                     state.totalTimeLeft--;
                } else {
                    promptForTimeRescue();
                }
                renderStats();
            }, 1000);
            
            state.selectionTimerId = setInterval(() => {
                if(state.isPaused || state.isGameOver) return;
                if (state.selectionTimeLeft > 0) {
                    state.selectionTimeLeft--;
                } else {
                    handlePenalty(); 
                    resetAndStartSelectionTimer();
                }
                renderStats();
            }, 1000);
        }

        function resetAndStartSelectionTimer() {
            state.selectionTimeLeft = FIXED_SELECTION_TIME;
            renderStats();
        }

        function startLevel(level) {
            ui.gameInfoBar.classList.remove('hidden');
            const config = LEVEL_CONFIG[level];
            
            state = {
                ...state,
                level: level,
                isGameOver: false, isChecking: false, isHidingCard: false,
                hiddenCardId: null,
                modalTimerId: null,
                hoveredShape: null, historyHoverSet: null,
                penaltyCount: 0, comboCount: 0,
                selectedCards: [], foundSets: new Set(),
                lastSetFoundTimestamp: Date.now(),
            };

            if (level === 1) { 
                state.sessionScore = 0;
                state.lives = config.baseLives; 
                state.timeRollover = 0; 
                state.totalTimeLeft = config.totalTime;
            } else { 
                state.lives++;
                state.totalTimeLeft = config.totalTime + state.timeRollover;
            }
            
            state.boardCards = generateBoard(level, state.gameMode);
            state.allSetsInRound = findAllSets(state.boardCards, state.gameMode);
            state.totalSetsInRound = state.allSetsInRound.length;
            state.usefulCardIds = new Set(state.allSetsInRound.flat().map(card => card.id));
            ui.historyPanel.innerHTML = '';
            
            renderBoard(ui.gameBoard, state.boardCards);
            startAllTimers();
            resetAndStartSelectionTimer();
            updateBoardAppearance();
            updateEarlyFinishButton();
        }

        function initializeGame() {
            const selectedAssists = document.querySelectorAll('#main-menu .assist-btn.active');
            let canStart = true;
            let failedItems = [];
            selectedAssists.forEach(btn => {
                const assistType = btn.dataset.assistType;
                const itemKey = `assist${assistType.charAt(0).toUpperCase() + assistType.slice(1)}`;
                if (!playerData.inventory[itemKey] || playerData.inventory[itemKey] <= 0) {
                    canStart = false;
                    failedItems.push(SHOP_ITEMS[itemKey]?.name || itemKey);
                }
            });

            if (!canStart) {
                showGameModal('Không đủ vật phẩm', `Bạn không có đủ: ${failedItems.join(', ')}. Hãy vào cửa hàng để mua thêm.`, 'OK', () => { ui.gameModalContainer.innerHTML = '' });
                selectedAssists.forEach(btn => {
                    const assistType = btn.dataset.assistType;
                    const itemKey = `assist${assistType.charAt(0).toUpperCase() + assistType.slice(1)}`;
                    if (failedItems.includes(SHOP_ITEMS[itemKey]?.name)) {
                        btn.classList.remove('active');
                    }
                });
                return;
            }

            cleanupAndResetGame();
            settings = { isUselessDimEnabled: false, isShapeDimEnabled: false };

            selectedAssists.forEach(btn => {
                const assistType = btn.dataset.assistType;
                const itemKey = `assist${assistType.charAt(0).toUpperCase() + assistType.slice(1)}`;
                const settingKey = `is${assistType.charAt(0).toUpperCase() + assistType.slice(1)}DimEnabled`;
                
                playerData.inventory[itemKey]--;
                settings[settingKey] = true;
            });
            
            savePlayerData();
            updateInventoryDisplay();
            renderActiveAssists(); 

            state = { 
                sessionScore: 0,
                gameMode: selectedGameMode, 
                isPaused: false, 
                historyHoverSet: null,
                modalTimerId: null,
                currentSessionStats: { 
                    date: new Date().toISOString(), setFindTimes: [], errors: 0, hintsUsed: 0, hidesUsed: 0,
                    correctStreak: 0, errorStreak: 0, maxCorrectStreak: 0, maxErrorStreak: 0 
                }
            };
            startLevel(1);
            showView('game');
            selectedAssists.forEach(btn => btn.classList.remove('active'));
        }

        // --- ACHIEVEMENTS ---
        function checkAchievements() {
            const lastGameStats = gameHistory[gameHistory.length - 1];
            Object.entries(ACHIEVEMENTS).forEach(([id, ach]) => {
                const playerAch = playerData.achievements[id];
                if (playerAch && !playerAch.unlocked) {
                    let conditionMet = false;
                    // Pass player data for global achievements, and game stats for session-based ones
                    if (id.startsWith('score_') || id.startsWith('sets_')) {
                        conditionMet = ach.condition(playerData);
                    } else if (lastGameStats) {
                         conditionMet = ach.condition(lastGameStats);
                    }

                    if (conditionMet) {
                        unlockAchievement(id);
                    }
                }
            });
        }
        
        function unlockAchievement(id) {
            playerData.achievements[id].unlocked = true;
            showNotification(ACHIEVEMENTS[id].name, 'achievement');
            savePlayerData();
        }

        function claimAchievement(id) {
            const ach = ACHIEVEMENTS[id];
            const playerAch = playerData.achievements[id];
            if (!ach || !playerAch || !playerAch.unlocked || playerAch.claimed) return;

            playerAch.claimed = true;
            const reward = ach.reward;
            if (reward.type === 'coins') {
                playerData.coins += reward.amount;
            } else {
                playerData.inventory[reward.type] = (playerData.inventory[reward.type] || 0) + reward.amount;
            }
            savePlayerData();
            updateCoinDisplay();
            updateInventoryDisplay();
            renderAchievementsModal();
        }
        
        // FIX #7: Hiển thị phần thưởng của thành tựu
        function formatRewardText(reward) {
            if (!reward) return 'Không có';
            const itemInfo = SHOP_ITEMS[reward.type];
            const itemName = itemInfo ? itemInfo.name : reward.type;
            
            switch (reward.type) {
                case 'coins':
                    return `+${reward.amount.toLocaleString()} Xu`;
                default:
                    return `+${reward.amount} ${itemName}`;
            }
        }

        function renderAchievementsModal() {
            ui.achievementsView.list.innerHTML = '';
            Object.entries(ACHIEVEMENTS).forEach(([id, ach]) => {
                const playerAch = playerData.achievements[id];
                const isUnlocked = playerAch.unlocked;
                const isClaimed = playerAch.claimed;
                
                let progressHtml = '';
                if (!isUnlocked && (id.startsWith('score_') || id.startsWith('sets_'))) {
                    let current = 0;
                    let target = 1; // avoid division by zero
                    if (id === 'score_1') { current = playerData.coins; target = 10000; }
                    if (id === 'score_2') { current = playerData.coins; target = 100000; }
                    if (id === 'sets_1') { current = playerData.stats.totalSetsFound || 0; target = 50; }
                    if (id === 'sets_2') { current = playerData.stats.totalSetsFound || 0; target = 250; }
                    const percent = Math.min(100, (current / target) * 100);
                    progressHtml = `
                        <div class="w-full bg-slate-200 dark:bg-slate-600 rounded-full h-1.5 mt-2">
                          <div class="bg-amber-500 h-1.5 rounded-full" style="width: ${percent}%"></div>
                        </div>`;
                }


                const achEl = document.createElement('div');
                achEl.className = `panel p-4 rounded-xl flex items-center gap-4 transition-all ${!isUnlocked ? 'opacity-60' : ''}`;
                achEl.innerHTML = `
                    <div class="flex-shrink-0 w-12 h-12 flex items-center justify-center bg-amber-100 dark:bg-slate-700 rounded-lg text-3xl">${ach.icon}</div>
                    <div class="flex-grow">
                        <h4 class="font-bold text-slate-800 dark:text-slate-100">${ach.name}</h4>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${ach.description}</p>
                        <p class="text-xs font-semibold text-green-500 dark:text-green-400 mt-1">Phần thưởng: ${formatRewardText(ach.reward)}</p>
                        ${progressHtml}
                    </div>
                    <button data-ach-id="${id}" class="claim-ach-btn flex-shrink-0 font-bold py-2 px-4 rounded-lg text-sm transition-colors ${
                        isUnlocked && !isClaimed ? 'bg-green-500 text-white hover:bg-green-600' : 'bg-slate-200 dark:bg-slate-600 text-slate-500 dark:text-slate-400'
                    }" ${!isUnlocked || isClaimed ? 'disabled' : ''}>
                        ${isClaimed ? 'Đã nhận' : (isUnlocked ? 'Nhận' : 'Đã khóa')}
                    </button>
                `;
                ui.achievementsView.list.appendChild(achEl);
            });
            document.querySelectorAll('.claim-ach-btn').forEach(btn => btn.addEventListener('click', () => claimAchievement(btn.dataset.achId)));
        }

        function startTutorial() {
            ui.tutorial.modal.classList.remove('hidden');
            tutorialState.currentStep = 0;
            showTutorialStep(tutorialState.currentStep);
        }

        function showTutorialStep(index) {
            ui.tutorial.contentArea.innerHTML = parseMarkdown(TUTORIAL_STEPS[index].content);
            
            ui.tutorial.progress.innerHTML = '';
            for(let i=0; i < TUTORIAL_STEPS.length; i++) {
                const dot = document.createElement('div');
                dot.className = `w-2 h-2 rounded-full transition-colors ${i === index ? 'bg-blue-500' : 'bg-slate-300 dark:bg-slate-600'}`;
                ui.tutorial.progress.appendChild(dot);
            }

            ui.tutorial.prevBtn.style.visibility = index === 0 ? 'hidden' : 'visible';
            ui.tutorial.nextBtn.textContent = index === TUTORIAL_STEPS.length - 1 ? 'Hoàn thành' : 'Tiếp theo ›';
        }

        function closeTutorial() {
            ui.tutorial.modal.classList.add('hidden');
        }

        function renderHistoryView() {
            if (gameHistory.length === 0) {
                ui.historyView.overallStats.innerHTML = `<p class="text-center text-slate-500">Chưa có dữ liệu. Hãy chơi một ván để xem thống kê!</p>`;
                ui.historyView.highScores.innerHTML = '';
                ui.historyView.gameLog.innerHTML = '';
                return;
            }

            const allTimes = gameHistory.flatMap(g => g.setFindTimes);
            const overall = gameHistory.reduce((acc, game) => {
                acc.totalSets += game.totalSets;
                acc.totalErrors += game.errors;
                acc.totalHints += game.hintsUsed;
                if (game.finalScore > acc.highestScore) acc.highestScore = game.finalScore;
                if (game.maxCorrectStreak > acc.highestStreak) acc.highestStreak = game.maxCorrectStreak;
                if (game.maxErrorStreak > acc.longestErrorStreak) acc.longestErrorStreak = game.maxErrorStreak;
                return acc;
            }, { totalSets: 0, totalErrors: 0, totalHints: 0, highestScore: 0, highestStreak: 0, longestErrorStreak: 0 });
            
            const fastestSet = allTimes.length > 0 ? Math.min(...allTimes) : 0;
            const avgTime = allTimes.length > 0 ? allTimes.reduce((a,b) => a+b, 0) / allTimes.length : 0;

            ui.historyView.overallStats.innerHTML = `
                <h3 class="text-xl font-bold mb-3">Thành Tích Tổng</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-blue-500">${overall.highestScore.toLocaleString()}</div><div class="text-xs text-slate-500">Điểm cao nhất</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-green-500">${fastestSet.toFixed(1)}s</div><div class="text-xs text-slate-500">Bộ nhanh nhất</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-green-500">${avgTime.toFixed(1)}s</div><div class="text-xs text-slate-500">TB / bộ</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-yellow-500">${overall.highestStreak}</div><div class="text-xs text-slate-500">Chuỗi đúng dài nhất</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-red-500">${overall.longestErrorStreak}</div><div class="text-xs text-slate-500">Chuỗi sai dài nhất</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-green-500">${overall.totalSets.toLocaleString()}</div><div class="text-xs text-slate-500">Tổng số bộ</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-red-500">${overall.totalErrors.toLocaleString()}</div><div class="text-xs text-slate-500">Tổng số lỗi</div></div>
                    <div class="panel p-3 rounded-lg"><div class="text-2xl font-bold text-purple-500">${overall.totalHints.toLocaleString()}</div><div class="text-xs text-slate-500">Gợi ý đã dùng</div></div>
                </div>`;

            const highScores = [...gameHistory].sort((a, b) => b.finalScore - a.finalScore).slice(0, 5);
            let highScoresHtml = `<h3 class="text-xl font-bold mb-3">Top 5 Kỉ Lục</h3><div class="space-y-2">`;
            highScores.forEach((game, index) => {
                highScoresHtml += `
                    <div class="panel p-3 rounded-lg flex items-center gap-4">
                        <span class="font-bold text-lg w-6 text-center">${index + 1}</span>
                        <div class="flex-grow"><span class="font-bold">${game.finalScore.toLocaleString()} điểm</span> <span class="text-xs text-slate-500">(${new Date(game.date).toLocaleDateString()})</span></div>
                        <span class="text-sm text-green-500">${game.totalSets} bộ</span>
                        <span class="text-sm text-red-500">${game.errors} lỗi</span>
                    </div>`;
            });
            highScoresHtml += `</div>`;
            ui.historyView.highScores.innerHTML = highScoresHtml;

            let gameLogHtml = `<h3 class="text-xl font-bold mb-3">Nhật Ký Ván Chơi</h3><div class="space-y-2">`;
             [...gameHistory].reverse().slice(0, 20).forEach(game => { // Show last 20 games
                let assistsHtml = '';
                if (game.usedAssists) {
                    if (game.usedAssists.isUselessDimEnabled) assistsHtml += ASSIST_ICONS.useless;
                    if (game.usedAssists.isShapeDimEnabled) assistsHtml += ASSIST_ICONS.shape;
                }

                gameLogHtml += `
                    <div class="panel p-3 rounded-lg">
                        <div class="flex justify-between items-center mb-1">
                            <div class="flex items-center gap-2">
                                <span class="font-bold">${game.finalScore.toLocaleString()} điểm</span>
                                <div class="flex gap-1">${assistsHtml}</div>
                            </div>
                            <span class="text-xs text-slate-500">${new Date(game.date).toLocaleString()}</span>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs text-center">
                            <div><span class="font-semibold">${game.totalSets}</span> bộ</div>
                            <div><span class="font-semibold">${game.errors}</span> lỗi</div>
                            <div><span class="font-semibold">${game.avgTimePerSet.toFixed(1)}s</span> / bộ</div>
                            <div>Chuỗi: <span class="text-green-500">${game.maxCorrectStreak}</span> / <span class="text-red-500">${game.maxErrorStreak}</span></div>
                        </div>
                    </div>`;
            });
            gameLogHtml += `</div>`;
            ui.historyView.gameLog.innerHTML = gameLogHtml;
        }

        function cleanupAndResetGame() {
            stopAllTimers();
            state = {};
            
            const postGameOverlay = document.getElementById('post-game-overlay');
            if (postGameOverlay) postGameOverlay.remove();

            if(ui.gameBoard) ui.gameBoard.style.zIndex = '';
            
            ui.boardPauseOverlay.classList.add('hidden');
            ui.earlyFinishContainer.classList.add('hidden');
            ui.earlyFinishIconBtn.classList.add('hidden');
            ui.historyPanel.innerHTML = '';
            ui.gameBoard.innerHTML = '';
            ui.ingameActiveAssistsDisplay.innerHTML = '';
            
            const pauseIcon = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 16a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1zm8 0a1 1 0 01-1-1V5a1 1 0 012 0v10a1 1 0 01-1 1z" /></svg>';
            ui.pauseBtns.forEach(btn => btn.innerHTML = (btn.id === 'pause-btn-desktop') ? `${pauseIcon} Tạm dừng` : pauseIcon);
        }
        function handleResetData() {
    // Xóa dữ liệu người chơi (xu, vật phẩm, thành tựu) khỏi bộ nhớ trình duyệt
    localStorage.removeItem('tripleZonePlayerData');
    
    // Xóa toàn bộ lịch sử các ván đã chơi
    localStorage.removeItem('tripleZoneGameHistory');
    
    // Xóa dữ liệu phiên bản đã xem để hiển thị lại nhật ký thay đổi
    localStorage.removeItem('lastVersionSeen');

    // Tải lại trang web để bắt đầu lại từ đầu
    location.reload();
}
        // --- APP INITIALIZATION ---
        function initApp() {
            document.getElementById('version-number').textContent = CURRENT_VERSION;
            ui.changelog.openBtn.addEventListener('click', () => ui.changelog.modal.classList.remove('hidden'));
            ui.changelog.closeBtn.addEventListener('click', () => ui.changelog.modal.classList.add('hidden'));

            const lastVersionSeen = localStorage.getItem('lastVersionSeen');
            if (lastVersionSeen !== CURRENT_VERSION) {
                ui.changelog.modal.classList.remove('hidden');
                localStorage.setItem('lastVersionSeen', CURRENT_VERSION);
            }

            tutorialState.steps = TUTORIAL_STEPS;
            loadPlayerData();
            loadGameHistory();
            renderShop();
            checkAchievements(); // Initial check on load

            // OPTIMIZED: Central event listener for the game board
            ui.gameBoard.addEventListener('click', handleBoardClick);
            ui.earlyFinishIconBtn.addEventListener('click', () => {
                const percentage = Math.round((state.foundSets.size / state.totalSetsInRound) * 100);
                gameOver(`Kết thúc sớm ở cấp 3 với ${percentage}% hoàn thành.`);
            });


            document.getElementById('start-game-btn').addEventListener('click', initializeGame);
            
            document.querySelectorAll('.start-tutorial-btn').forEach(btn => btn.addEventListener('click', startTutorial));

            document.getElementById('back-to-menu-btn').addEventListener('click', () => { 
                 showGameModal(
                    'Thoát Ván Chơi?',
                    'Tiến trình hiện tại sẽ bị mất. Bạn có chắc chắn muốn quay về trang chính không?',
                    null,
                    null, { buttons: [
                        { id: 'confirm-exit-yes', text: 'Chắc chắn', classes: 'w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700',
                            callback: () => {
                                gameOver('Bạn đã bỏ cuộc.');
                                ui.gameModalContainer.innerHTML = '';
                            }
                        },
                        { id: 'confirm-exit-no', text: 'Hủy', classes: 'w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg',
                            callback: () => { ui.gameModalContainer.innerHTML = ''; startAllTimers(); } 
                        }
                    ]}
                );
            });
            document.getElementById('reset-game-btn').addEventListener('click', () => {
    showGameModal(
        'Xác nhận Xóa Dữ Liệu',
        'Hành động này không thể hoàn tác. Toàn bộ xu, vật phẩm, và lịch sử chơi của bạn sẽ bị xóa vĩnh viễn. Bạn có chắc chắn muốn tiếp tục không?',
        null, null, {
            buttons: [
                {
                    id: 'confirm-reset-yes',
                    text: 'Xóa Tất Cả',
                    classes: 'w-full bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700',
                    callback: () => {
                        handleResetData(); // Gọi hàm xóa dữ liệu
                    }
                },
                {
                    id: 'confirm-reset-no',
                    text: 'Hủy',
                    classes: 'w-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 font-bold py-2 px-4 rounded-lg',
                    callback: () => { ui.gameModalContainer.innerHTML = ''; }
                }
            ]
        }
    );
});
            ui.shop.openBtns.forEach(btn => btn.addEventListener('click', () => {
                renderShop();
                showView('shop');
            }));
            ui.shop.closeBtn.addEventListener('click', () => showView('mainMenu'));

            ui.historyView.openBtns.forEach(btn => btn.addEventListener('click', () => {
                renderHistoryView();
                showView('history');
            }));
            ui.historyView.closeBtn.addEventListener('click', () => showView('mainMenu'));
            
            ui.achievementsView.openBtns.forEach(btn => btn.addEventListener('click', () => {
                renderAchievementsModal();
                showView('achievements');
            }));
            ui.achievementsView.closeBtn.addEventListener('click', () => showView('mainMenu'));

            ui.pauseBtns.forEach(btn => btn.addEventListener('click', togglePause));
            ui.surrenderBtnPause.addEventListener('click', () => { gameOver("Bạn đã bỏ cuộc"); });
            
            ui.tutorial.closeBtn.addEventListener('click', closeTutorial);
            ui.tutorial.prevBtn.addEventListener('click', () => {
                if (tutorialState.currentStep > 0) { tutorialState.currentStep--; showTutorialStep(tutorialState.currentStep); }
            });
            ui.tutorial.nextBtn.addEventListener('click', () => {
                 if (tutorialState.currentStep < tutorialState.steps.length - 1) { tutorialState.currentStep++; showTutorialStep(tutorialState.currentStep); } else { closeTutorial(); }
            });
            
            document.querySelectorAll('#main-menu .assist-btn').forEach(button => { button.addEventListener('click', () => button.classList.toggle('active')); });
            ui.assistBtns.hint.addEventListener('click', useHint);
            ui.assistBtns.hideCard.addEventListener('click', useHideCard);

            ui.modeButtons.classic.addEventListener('click', () => {
                selectedGameMode = 'classic';
                ui.modeButtons.classic.classList.add('active');
                ui.modeButtons.dual.classList.remove('active');
            });
            ui.modeButtons.dual.addEventListener('click', () => {
                selectedGameMode = 'dual';
                ui.modeButtons.dual.classList.add('active');
                ui.modeButtons.classic.classList.remove('active');
            });

            document.addEventListener('keydown', (e) => {
                if (ui.views.game.classList.contains('hidden') || state.isGameOver) return;
                if (e.key === 'p' || e.key === 'P') { e.preventDefault(); togglePause(); }
            });

            window.addEventListener('resize', () => {
                if (state && !state.isGameOver && !ui.views.game.classList.contains('hidden')) renderStats();
            });

            ui.darkModeToggle.addEventListener('click', () => {
                const isDark = document.documentElement.classList.toggle('dark');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                updateThemeIcons(isDark);
            });

            const savedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                document.documentElement.classList.add('dark');
                updateThemeIcons(true);
            } else {
                updateThemeIcons(false);
            }

            showView('mainMenu');
        }
        
        function updateThemeIcons(isDark) {
            if (isDark) {
                ui.lightThemeIcon.classList.add('hidden');
                ui.darkThemeIcon.classList.remove('hidden');
            } else {
                ui.lightThemeIcon.classList.remove('hidden');
                ui.darkThemeIcon.classList.add('hidden');
            }
        }

        function setupManifest() {
            const createIconDataUrl = (size, isMaskable) => {
                const canvas = document.createElement('canvas'); canvas.width = size; canvas.height = size;
                const ctx = canvas.getContext('2d');
                if (isMaskable) {
                    ctx.fillStyle = '#3b82f6'; ctx.beginPath(); ctx.arc(size / 2, size / 2, size * 0.4, 0, 2 * Math.PI); ctx.fill();
                } else {
                     ctx.fillStyle = '#3b82f6'; ctx.fillRect(0, 0, size, size);
                }
                ctx.fillStyle = 'white'; ctx.font = `bold ${size * 0.7}px 'Inter', sans-serif`;
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText('S', size / 2, size / 2 + size * 0.05);
                return canvas.toDataURL('image/png');
            };
            const manifestContent = {
                "name": "Trận Tử Chiến: Ghép Cặp Hoàn Hảo", "short_name": "Trận Tử Chiến", "description": "Thử thách khả năng quan sát và logic của bạn.", "start_url": ".", "display": "standalone", "orientation": "portrait", "background_color": "#f0f9ff", "theme_color": "#3b82f6",
                "icons": [
                    { "src": createIconDataUrl(192, false), "type": "image/png", "sizes": "192x192" },
                    { "src": createIconDataUrl(512, false), "type": "image/png", "sizes": "512x512" },
                    { "src": createIconDataUrl(512, true), "type": "image/png", "sizes": "512x512", "purpose": "maskable" }
                ]
            };
            const manifestString = JSON.stringify(manifestContent);
            const manifestDataUrl = 'data:application/manifest+json;base64,' + btoa(unescape(encodeURIComponent(manifestString)));
            const existingLink = document.querySelector('link[rel="manifest"]');
            if (existingLink) existingLink.remove();
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest'; manifestLink.href = manifestDataUrl;
            document.head.appendChild(manifestLink);
        }

        initApp();
        setupManifest();

    </script>
</body>
</html>
