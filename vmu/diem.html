<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>·ª®ng d·ª•ng T√≠nh ƒëi·ªÉm Sinh vi√™n</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <!-- TH√äM D√íNG N√ÄY -->

        <style>
            /* ================================================== */
            /*          TO√ÄN B·ªò CSS ƒê√É ƒê∆Ø·ª¢C T·ªêI ∆ØU H√ìA           */
            /* ================================================== */

            body {
                font-family: "Inter", sans-serif;
                background-color: #f8fafc;
            }
            .container {
                max-width: 900px;
                margin: 0 auto;
                padding: 0;
                background-color: white;
                min-height: 100vh;
            }
            select,
            button {
                padding: 0.625rem 0.875rem;
                border-radius: 0.5rem;
                border: 1px solid #cbd5e1;
                transition: all 0.15s ease-in-out;
                font-size: 0.9rem;
            }
            select:focus,
            button:focus {
                outline: none;
                border-color: #2563eb;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            }

            /* === Khu v·ª±c Header C·ªë ƒë·ªãnh (Sticky) - PHI√äN B·∫¢N COMPACT 1 H√ÄNG === */
            .results-sticky-container {
                position: sticky;
                top: 0;
                z-index: 50;
                background-color: white; /* Ho·∫∑c #f8fafc n·∫øu mu·ªën tr√πng m√†u n·ªÅn */
                padding: 0.5rem 1rem; /* Padding nh·ªè h∆°n */
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
                border-bottom: 1px solid #e2e8f0;

                /* Flexbox ƒë·ªÉ x·∫øp t·∫•t c·∫£ l√™n 1 h√†ng */
                display: flex;
                align-items: center;
                justify-content: flex-start; /* Ho·∫∑c space-between n·∫øu mu·ªën d√£n ƒë·ªÅu */
                gap: 0.75rem; /* Kho·∫£ng c√°ch gi·ªØa c√°c th·∫ª */
                overflow-x: auto; /* Cho ph√©p cu·ªôn ngang tr√™n ƒëi·ªán tho·∫°i n·∫øu qu√° d√†i */
                white-space: nowrap; /* Kh√¥ng xu·ªëng d√≤ng */

                /* ·∫®n thanh cu·ªôn x·∫•u x√≠ */
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .results-sticky-container::-webkit-scrollbar {
                display: none;
            }

            /* ·∫®n Ti√™u ƒë·ªÅ l·ªõn v√† Insight text ƒë·ªÉ ti·∫øt ki·ªám di·ªán t√≠ch */
            .results-sticky-container h1,
            .target-insight-text {
                display: none !important;
            }

            /* Style cho c√°c th·∫ª con (Mini Cards) */
            .mini-stat-card {
                display: flex;
                align-items: center;
                gap: 0.5rem;
                padding: 0.35rem 0.75rem;
                background-color: #f1f5f9; /* M√†u n·ªÅn x√°m nh·∫π (ƒë∆°n m√†u) */
                border: 1px solid #cbd5e1;
                border-radius: 9999px; /* Bo tr√≤n d·∫°ng vi√™n thu·ªëc (Pill) */
                font-size: 0.85rem;
                color: #475569;
                flex-shrink: 0; /* Kh√¥ng b·ªã co l·∫°i khi m√†n h√¨nh nh·ªè */
            }

            /* Ri√™ng th·∫ª GPA l√†m n·ªïi b·∫≠t h∆°n 1 ch√∫t nh∆∞ng v·∫´n tinh t·∫ø */
            .mini-stat-card.primary {
                background-color: #eff6ff; /* Xanh r·∫•t nh·∫°t */
                border-color: #bfdbfe;
                color: #1e3a8a;
                font-weight: 600;
            }

            /* C√°c gi√° tr·ªã s·ªë b√™n trong th·∫ª */
            .mini-value {
                font-weight: 700;
                color: #0f172a;
                font-size: 0.95rem;
            }
            .mini-stat-card.primary .mini-value {
                color: #1d4ed8;
                font-size: 1.1rem;
            }

            /* Ch·ªânh l·∫°i c√°i Select box cho nh·ªè v√† ƒë·∫πp */
            .mini-select {
                background: transparent;
                border: none;
                font-size: 0.85rem;
                color: #334155;
                padding: 0;
                margin-left: 4px;
                font-weight: 500;
                cursor: pointer;
            }
            .mini-select:focus {
                outline: none;
            }
            /* ·∫®n c√°c class c≈© kh√¥ng d√πng t·ªõi trong ch·∫ø ƒë·ªô n√†y ƒë·ªÉ tr√°nh l·ªói giao di·ªán */
            .primary-stats-row,
            .secondary-stats-bar {
                display: contents; /* Lo·∫°i b·ªè wrapper div ƒë·ªÉ flex ho·∫°t ƒë·ªông */
            }
            /* B·ªë c·ª•c Header M·ªõi */
            .primary-stats-row {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
                margin-bottom: 1rem;
            }
            /* S·ª≠a l·∫°i rule n√†y */
            .stat-value {
                font-size: 1rem; /* C√≥ th·ªÉ gi·∫£m xu·ªëng t·ª´ 1.125rem n·∫øu mu·ªën */
                font-weight: 600;
                color: #334155;
            }
            .target-item-value {
                font-size: 1.25rem; /* C√≥ th·ªÉ gi·∫£m xu·ªëng t·ª´ 1.5rem n·∫øu mu·ªën */
                font-weight: 700;
                color: #15803d;
            }
            .stat-card {
                padding: 1rem;
                text-align: center;
                border-radius: 0.75rem;
                background-color: #f8fafc;
                border: 1px solid #e2e8f0;
                display: flex; /* TH√äM D√íNG N√ÄY */
                flex-direction: column; /* TH√äM D√íNG N√ÄY */
                justify-content: center; /* TH√äM D√íNG N√ÄY */
            }
            .stat-card-label {
                font-size: 0.875rem;
                color: #64748b;
                margin-bottom: 0.25rem;
            }
            .stat-card-value {
                font-weight: 700;
                line-height: 1;
            }
            .gpa-highlight {
                font-size: 2.75rem;
            }
            /* S·ª≠a l·∫°i rule n√†y */
            .rank-highlight {
                font-size: 1.75rem;
                /* padding-top: 1rem; */ /* X√ìA HO·∫∂C CH√ö TH√çCH D√íNG N√ÄY */
                /* C√°c m√†u s·∫Øc gi·ªØ nguy√™n */
            }
            .rank-highlight.text-purple {
                color: #7e22ce;
            }
            .rank-highlight.text-blue {
                color: #1d4ed8;
            }
            .rank-highlight.text-green {
                color: #15803d;
            }
            .rank-highlight.text-yellow {
                color: #a16207;
            }
            .rank-highlight.text-orange {
                color: #c2410c;
            }
            .rank-highlight.text-red {
                color: #b91c1c;
            }
            .rank-highlight.text-slate {
                color: #475569;
            }

            .secondary-stats-bar {
                display: flex;
                flex-wrap: wrap;
                justify-content: space-around;
                align-items: center;
                background-color: #f8fafc;
                border-radius: 0.5rem;
                padding: 0.5rem 1rem;
                gap: 1rem;
                border: 1px solid #e2e8f0;
            }
            .info-item {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }
            .info-label {
                font-size: 0.8rem;
                color: #475569;
            }
            .info-value {
                font-size: 0.9rem;
                font-weight: 600;
                color: #1e293b;
            }
            .target-select-inline {
                padding: 0.25rem 0.5rem;
                font-size: 0.9rem;
                border-radius: 0.375rem;
                background-color: white;
            }
            .target-info {
                display: none;
            }
            .target-info.visible {
                display: flex;
            }
            .target-insight-text {
                margin-top: 0.75rem;
                padding: 0.75rem;
                background-color: #f1f5f9;
                border-radius: 0.5rem;
                font-size: 0.875rem;
                color: #475569;
                text-align: center;
                min-height: 40px;
                display: none;
            }
            .target-insight-text.visible {
                display: block;
            }

            /* === Khu v·ª±c Danh s√°ch m√¥n h·ªçc === */
            .subjects-list-main-container {
                padding: 1rem;
            }
            .semester-block {
                margin-bottom: 0.75rem;
            }
            .semester-header {
                background-color: #f1f5f9;
                padding: 0.75rem 1.25rem;
                border-radius: 0.5rem;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border: 1px solid #e2e8f0;
            }
            .semester-header:hover {
                background-color: #e2e8f0;
            }
            .semester-header-content {
                display: flex;
                align-items: center;
                flex-wrap: wrap;
                gap: 0.5rem;
            }
            .semester-header h3 {
                color: #334155;
                font-size: 1.125rem;
                font-weight: 600;
                margin: 0;
            }
            .semester-grade-count,
            .semester-gpa-display {
                font-size: 0.75rem;
                font-weight: 500;
                color: #475569;
                background-color: #e2e8f0;
                padding: 0.125rem 0.5rem;
                border-radius: 0.25rem;
            }
            .semester-gpa-display {
                color: #1e3a8a;
                background-color: #dbeafe;
            }
            .semester-arrow {
                transition: transform 0.3s ease;
                color: #475569;
            }
            .semester-arrow.expanded svg {
                transform: rotate(90deg);
            }
            .subjects-list {
                padding-left: 0.5rem;
                overflow: hidden;
                max-height: 0;
                transition: max-height 0.5s ease-out;
                border-left: 2px solid #e2e8f0;
                margin-left: 0.5rem;
                margin-top: 0.5rem;
            }
            .subjects-list.expanded {
                max-height: 1500px;
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            .subject-item {
                display: grid;
                grid-template-columns: 1fr 60px 100px;
                gap: 0.75rem;
                align-items: center;
                padding: 0.875rem 0.75rem;
                border-bottom: 1px solid #f1f5f9;
                transition: background-color 0.3s ease;
            }
            .subject-item:hover {
                background-color: #f8fafc;
            }
            .subject-item.selected-briefly {
                background-color: #e0f2fe;
            }
            .subject-item:last-child {
                border-bottom: none;
            }
            .header-item-subjects {
                font-weight: 600;
                color: #4b5563;
                padding: 0.75rem;
                background-color: #f8fafc;
                border-bottom: 1px solid #e5e7eb;
                border-radius: 0.5rem 0.5rem 0 0;
            }
            .subject-name {
                word-break: break-word;
                font-size: 0.95rem;
                color: #334155;
            }
            .subject-name-wrapper {
                display: flex;
                flex-direction: column;
            }
            .subject-tags-container {
                display: flex;
                flex-wrap: wrap;
                gap: 0.375rem;
                margin-top: 0.25rem;
            }
            .subject-tag {
                font-size: 0.7rem;
                font-weight: 500;
                padding: 0.125rem 0.5rem;
                border-radius: 9999px;
                border: 1px solid;
                line-height: 1.2;
            }
            .tag-tn {
                background-color: #e0f2fe;
                color: #075985;
                border-color: #bae6fd;
            }
            .tag-tl {
                background-color: #eef2ff;
                color: #3730a3;
                border-color: #c7d2fe;
            }
            .tag-th-true {
                background-color: #f0fdf4;
                color: #15803d;
                border-color: #bbf7d0;
            }
            .editable-subject-name {
                cursor: pointer;
                text-decoration: underline;
                text-decoration-style: dotted;
                text-decoration-color: #94a3b8;
                transition: color 0.2s ease;
            }
            .editable-subject-name:hover {
                color: #2563eb;
                text-decoration-color: #2563eb;
            }

            /* === B·ªô l·ªçc nhanh === */
            .filter-group .filter-label {
                font-size: 0.875rem;
                font-weight: 500;
                color: #475569;
            }
            .quick-filter-button {
                padding: 0.25rem 0.75rem;
                font-size: 0.8rem;
                border-radius: 0.375rem;
                border: 1px solid #cbd5e1;
                background-color: white;
                color: #475569;
                cursor: pointer;
                transition: all 0.2s;
            }
            .quick-filter-button:not(.active):hover {
                background-color: #f1f5f9;
            }
            .quick-filter-button.active {
                background-color: #2563eb;
                color: white;
                border-color: #2563eb;
                font-weight: 600;
            }

            /* === C√°c n√∫t h√†nh ƒë·ªông ch√≠nh === */
            .button-container {
                padding: 1rem 1rem 1.5rem 1rem;
                background-color: white;
                border-top: 1px solid #e5e7eb;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
            .main-action-button {
                background-color: #2563eb;
                color: white;
                font-weight: 600;
                width: 100%;
                padding: 0.875rem 1rem;
                font-size: 1rem;
                border-radius: 0.5rem;
            }
            .main-action-button:hover {
                background-color: #1d4ed8;
            }
            .secondary-action-button {
                background-color: #f1f5f9;
                color: #334155;
                font-weight: 500;
                width: 100%;
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
                border-radius: 0.5rem;
                border: 1px solid #e2e8f0;
            }
            .secondary-action-button:hover {
                background-color: #e2e8f0;
            }

            /* === C√°c th√†nh ph·∫ßn ph·ª• tr·ª£ (Toast, ScrollToTop) === */
            .toast-notification {
                display: none;
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #1f2937;
                color: white;
                padding: 0.875rem 1.5rem;
                border-radius: 0.5rem;
                box-shadow:
                    0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
                z-index: 1002;
                font-size: 0.9rem;
                opacity: 0;
                transition:
                    opacity 0.3s ease-in-out,
                    bottom 0.3s ease-in-out;
            }
            .toast-notification.show {
                display: block;
                opacity: 1;
                bottom: 30px;
            }
            #scrollToTopBtn {
                position: fixed;
                bottom: 25px;
                right: 25px;
                z-index: 99;
                border: none;
                outline: none;
                background-color: #2563eb;
                color: white;
                cursor: pointer;
                padding: 0.75rem;
                width: 44px;
                height: 44px;
                border-radius: 50%;
                font-size: 20px;
                box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                display: none;
                align-items: center;
                justify-content: center;
            }
            #scrollToTopBtn:hover {
                background-color: #1d4ed8;
            }

            /* === Modal Chung === */
            .modal-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background-color: rgba(0, 0, 0, 0.6);
                z-index: 1001;
                justify-content: center;
                align-items: center;
                padding: 1rem;
            }
            .modal-overlay.visible {
                display: flex;
            }
            .modal-content-wrapper {
                background-color: white;
                border-radius: 0.75rem;
                box-shadow:
                    0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
                width: 100%;
                max-height: 90vh;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            }
            #editSubjectModalOverlay {
                z-index: 1002;
            }

            /* === Modal Th·ªëng k√™ chi ti·∫øt === */
            .modal-content-wrapper .detailed-stats-section {
                flex-grow: 1;
                overflow-y: auto;
                padding: 1.5rem;
            }
            .stats-summary-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            .collapsible-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.75rem 1rem;
                background-color: #f9fafb;
                cursor: pointer;
                border-bottom: 1px solid #f3f4f6;
            }
            .collapsible-section.expanded .collapsible-header {
                border-bottom-color: #e5e7eb;
            }
            .collapsible-header:hover {
                background-color: #f3f4f6;
            }
            .collapsible-arrow {
                transition: transform 0.3s ease;
                font-size: 1rem;
                font-weight: bold;
                color: #9ca3af;
                transform: rotate(0deg);
            }
            .collapsible-section.expanded .collapsible-arrow::before {
                content: "‚ñº";
            }
            .collapsible-section:not(.expanded) .collapsible-arrow::before {
                content: "‚ñ∂";
            }

            .collapsible-content {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.5s ease-in-out;
            }
            .collapsible-section.expanded .collapsible-content {
                max-height: 3000px;
            }

            .insight-card {
                background-color: #f8fafc;
                border-radius: 0.5rem;
                padding: 1rem;
                border: 1px solid #e2e8f0;
            }
            .insight-card .insight-title {
                font-size: 0.875rem;
                font-weight: 500;
                color: #475569;
                margin-bottom: 0.5rem;
            }
            .insight-card .insight-body {
                font-weight: 600;
                color: #1e293b;
            }
            .insight-card.positive {
                background-color: #f0fdf4;
                border-color: #bbf7d0;
            }
            .insight-card.positive .insight-title {
                color: #166534;
            }
            .insight-card.positive .insight-body {
                color: #15803d;
            }
            .insight-card.negative {
                background-color: #fef2f2;
                border-color: #fecaca;
            }
            .insight-card.negative .insight-title {
                color: #991b1b;
            }
            .insight-card.negative .insight-body {
                color: #b91c1c;
            }

            .grade-distribution-list {
                list-style: none;
                padding: 0;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 0.5rem;
            }
            .grade-distribution-list li {
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                padding: 0.75rem 0.5rem;
                line-height: 1.3;
                cursor: pointer;
                transition: background-color 0.2s ease;
                background-color: #eff6ff;
                color: #1e40af;
                border-color: #dbeafe;
                border: 1px solid;
                border-radius: 0.375rem;
            }
            .grade-distribution-list li:hover {
                background-color: #dbeafe;
                border-color: #bfdbfe;
            }
            .grade-distribution-list li.active-filter {
                background-color: #60a5fa !important;
                color: #1d4ed8 !important;
                border-color: #3b82f6 !important;
            }
            .grade-label {
                font-weight: 600;
                font-size: 1.1em;
                margin-bottom: 0.25rem;
            }
            .grade-info {
                font-size: 0.8em;
                color: #4b5563;
            }
            .grade-percentage {
                font-size: 0.9em;
                font-weight: 500;
                margin-top: 0.25rem;
            }

            .subject-details-table {
                width: 100%;
                border-collapse: collapse;
                font-size: 0.875rem;
            }
            .subject-details-table th,
            .subject-details-table td {
                border: 1px solid #e5e7eb;
                padding: 0.5rem 0.75rem;
                text-align: left;
            }
            .subject-details-table th {
                background-color: #f3f4f6;
                font-weight: 600;
                color: #374151;
            }
            .subject-details-table th[data-sortable] {
                cursor: pointer;
            }
            .subject-details-table th[data-sortable]:hover {
                background-color: #e9ecef;
            }
            .sort-arrow {
                font-size: 0.8em;
                margin-left: 5px;
                display: inline-block;
                width: 1em;
                text-align: center;
            }
            .sort-arrow::before {
                content: "\00a0";
            }
            .subject-details-table th.sorted-asc .sort-arrow::before {
                content: "‚ñ≤";
            }
            .subject-details-table th.sorted-desc .sort-arrow::before {
                content: "‚ñº";
            }
            .deviation-positive {
                color: #16a34a;
                font-weight: 500;
            }
            .deviation-negative {
                color: #dc2626;
                font-weight: 500;
            }
            /* B·ªï sung CSS cho 4 th·∫ª th·ªëng k√™ t·ªïng quan trong modal */
            .stats-summary-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 1rem;
                margin-bottom: 1.5rem;
            }
            .stats-summary-grid div {
                background-color: #f8fafc; /* M√†u n·ªÅn gi·ªëng c√°c th·∫ª kh√°c */
                padding: 1rem;
                border-radius: 0.5rem;
                text-align: center;
                border: 1px solid #e2e8f0;
            }
            .stats-summary-grid div p:first-child {
                font-size: 0.875rem;
                color: #4b5563; /* text-slate-600 */
                margin-bottom: 0.25rem;
            }
            .stats-summary-grid div p:last-child {
                font-size: 1.25rem;
                font-weight: 600;
                color: #1e3a8a; /* text-blue-800 */
            }
            .result-value {
                font-weight: 700; /* S·ª≠ d·ª•ng font-weight c·ª• th·ªÉ, v√≠ d·ª• 700 cho bold */
                line-height: 1.1;
                font-size: 1.25rem; /* K√≠ch th∆∞·ªõc ch·ªØ chung cho c√°c gi√° tr·ªã ph·ª• */
                color: #1e293b; /* M√†u ch·ªØ m·∫∑c ƒë·ªãnh */
            }
            /* === C√¥ng c·ª• cho nh√† ph√°t tri·ªÉn === */
            #rawDataOutput {
                max-height: 400px;
            }
            /* === CSS CHO DASHBOARD D·∫†NG TAB === */
            .dashboard-tab-nav {
                display: flex;
                gap: 0.5rem;
                border-bottom: 2px solid #e2e8f0;
                margin-bottom: 1.5rem;
            }
            .dashboard-tab-btn {
                padding: 0.75rem 1.25rem;
                font-weight: 600;
                color: #64748b;
                background: transparent;
                border: none;
                border-bottom: 2px solid transparent;
                margin-bottom: -2px; /* ƒê√® l√™n border c·ªßa nav */
                cursor: pointer;
                transition: all 0.2s;
            }
            .dashboard-tab-btn:hover {
                color: #2563eb;
                background-color: #f1f5f9;
                border-radius: 0.5rem 0.5rem 0 0;
            }
            .dashboard-tab-btn.active {
                color: #2563eb;
                border-bottom-color: #2563eb;
                background-color: white; /* Ho·∫∑c m√†u n·ªÅn modal */
            }
            .dashboard-tab-content {
                display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
                animation: fadeIn 0.3s ease;
            }
            .dashboard-tab-content.active {
                display: block; /* Hi·ªán khi active */
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(5px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="results-sticky-container">
                <div class="mini-stat-card primary">
                    <span>GPA:</span>
                    <span id="gpa" class="mini-value">0.00</span>
                </div>

                <div class="mini-stat-card">
                    <span>X·∫øp lo·∫°i:</span>
                    <span id="rank" class="mini-value text-slate-700">N/A</span>
                </div>

                <div class="mini-stat-card">
                    <span>ƒê√£ h·ªçc:</span>
                    <span class="mini-value"><span id="totalCredits">0</span> TC</span>
                    <span style="color: #94a3b8; margin: 0 2px">|</span>
                    <span id="completionPercentage" class="mini-value">0%</span>
                </div>

                <div class="mini-stat-card">
                    <span>M·ª•c ti√™u:</span>
                    <select id="targetRankSelect" class="mini-select">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="Xu·∫•t s·∫Øc">Xu·∫•t s·∫Øc (‚â• 3.6)</option>
                        <option value="Gi·ªèi">Gi·ªèi (‚â• 3.2)</option>
                        <option value="Kh√°">Kh√° (‚â• 2.5)</option>
                    </select>
                </div>

                <div id="target-gpa-item" class="mini-stat-card">
                    <span>C·∫ßn ƒë·∫°t:</span>
                    <span id="minAvgForRemaining" class="mini-value text-green-600">--</span>
                </div>

                <div id="targetInsight" style="display: none"></div>
            </div>

            <div class="subjects-list-main-container">
                <!-- S·ª≠a l·∫°i to√†n b·ªô div#quickFiltersContainer -->
                <div id="quickFiltersContainer" class="p-3 mb-3 bg-slate-50 rounded-lg border border-slate-200">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                        <div class="filter-group">
                            <span class="filter-label">H√¨nh th·ª©c thi:</span>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <button
                                    class="quick-filter-button active"
                                    data-filter-group="finalExamType"
                                    data-filter-value="all"
                                >
                                    T·∫•t c·∫£
                                </button>
                                <button
                                    class="quick-filter-button"
                                    data-filter-group="finalExamType"
                                    data-filter-value="Tr·∫Øc nghi·ªám"
                                >
                                    Tr·∫Øc nghi·ªám
                                </button>
                                <button
                                    class="quick-filter-button"
                                    data-filter-group="finalExamType"
                                    data-filter-value="T·ª± lu·∫≠n (kh√¥ng t√†i li·ªáu)"
                                >
                                    T·ª± lu·∫≠n
                                </button>
                            </div>
                        </div>
                        <div class="filter-group">
                            <span class="filter-label">Th·ª±c h√†nh:</span>
                            <div class="flex flex-wrap gap-2 mt-1">
                                <button
                                    class="quick-filter-button active"
                                    data-filter-group="hasPractice"
                                    data-filter-value="all"
                                >
                                    T·∫•t c·∫£
                                </button>
                                <button
                                    class="quick-filter-button"
                                    data-filter-group="hasPractice"
                                    data-filter-value="true"
                                >
                                    C√≥ TH
                                </button>
                                <button
                                    class="quick-filter-button"
                                    data-filter-group="hasPractice"
                                    data-filter-value="false"
                                >
                                    Kh√¥ng TH
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="subject-item header-item-subjects mb-2">
                    <span class="subject-name">T√™n M√¥n h·ªçc/H·ªçc ph·∫ßn</span>
                    <span class="text-center">S·ªë TC</span>
                    <span class="text-center">ƒêi·ªÉm ch·ªØ</span>
                </div>
                <div id="semestersContainer">
                    <!-- Semester blocks will be injected here -->
                </div>
            </div>

            <div class="button-container mt-4">
                <button id="calculateButton" class="main-action-button">L∆∞u & C·∫≠p nh·∫≠t</button>
                <button id="toggleDetailedStatsButton" class="secondary-action-button mt-2">
                    Xem Th·ªëng K√™ Chi Ti·∫øt
                </button>
            </div>
        </div>

        <div class="p-4 m-4 border rounded-lg bg-slate-50" style="display: none">
            <h3 class="font-semibold text-slate-700 mb-2">C√¥ng c·ª• d√†nh cho Nh√† ph√°t tri·ªÉn</h3>
            <p class="text-sm text-slate-500 mb-3">
                S·ª≠ d·ª•ng n√∫t n√†y ƒë·ªÉ xem to√†n b·ªô d·ªØ li·ªáu m√¥n h·ªçc ·ªü ƒë·ªãnh d·∫°ng JSON. B·∫°n c√≥ th·ªÉ sao ch√©p, ch·ªânh s·ª≠a v√† d√°n
                l·∫°i v√†o m√£ ngu·ªìn.
            </p>
            <button id="showRawDataButton" class="secondary-action-button w-auto">Hi·ªÉn th·ªã/·∫®n D·ªØ li·ªáu Th√¥</button>
            <pre
                id="rawDataOutput"
                class="hidden mt-4 p-4 bg-slate-800 text-white rounded-md text-xs overflow-x-auto"
            ></pre>
        </div>
        <!-- MODAL CHO TH·ªêNG K√ä CHI TI·∫æT -->
        <div id="detailedStatsModalOverlay" class="modal-overlay">
            <div class="modal-content-wrapper">
                <div id="detailedStatsContainer" class="detailed-stats-section">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">Th·ªëng k√™ h·ªçc t·∫≠p</h2>
                            <p class="text-sm text-gray-500">T·ªïng quan t√¨nh h√¨nh t√≠ch l≈©y t√≠n ch·ªâ v√† ƒëi·ªÉm s·ªë</p>
                        </div>
                        <button
                            id="closeDetailedStatsButton"
                            class="text-gray-400 hover:text-gray-600 p-2 rounded-full hover:bg-gray-100"
                        >
                            <svg
                                xmlns="http://www.w3.org/2000/svg"
                                width="24"
                                height="24"
                                fill="none"
                                viewBox="0 0 24 24"
                                stroke="currentColor"
                            >
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"
                                />
                            </svg>
                        </button>
                    </div>

                    <div class="stats-summary-grid mb-6">
                        <div>
                            <p>T·ªïng TC Ch∆∞∆°ng tr√¨nh</p>
                            <p id="statsTotalProgramCredits">--</p>
                        </div>
                        <div>
                            <p>T·ªïng TC Ho√†n th√†nh</p>
                            <p id="statsTotalCompletedCredits">--</p>
                        </div>
                        <div>
                            <p>T·ª∑ l·ªá Ho√†n th√†nh</p>
                            <p id="statsCompletionRate">--</p>
                        </div>
                        <div>
                            <p>GPA T√≠ch l≈©y</p>
                            <p id="statsOverallGPA" class="text-blue-700">--</p>
                        </div>
                    </div>

                    <div class="dashboard-tab-nav">
                        <button class="dashboard-tab-btn active" onclick="switchDashboardTab('overview')">
                            T·ªïng quan & Ph√¢n t√≠ch
                        </button>
                        <button class="dashboard-tab-btn" onclick="switchDashboardTab('charts')">
                            Bi·ªÉu ƒë·ªì tr·ª±c quan
                        </button>
                        <button class="dashboard-tab-btn" onclick="switchDashboardTab('details')">
                            B·∫£ng ƒëi·ªÉm chi ti·∫øt
                        </button>
                    </div>

                    <div id="tab-overview" class="dashboard-tab-content active">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3">ƒêi·ªÉm nh·∫•n (Insights)</h4>
                            <div id="insightsContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            <div class="mt-6 bg-indigo-50 p-5 rounded-lg border border-indigo-100">
                                <h4 class="font-bold text-indigo-900 mb-4 flex items-center gap-2">
                                    üéØ L·ªô tr√¨nh & D·ª± b√°o (Rank Up Calculator)
                                </h4>
                                <div id="rankUpContent" class="text-sm text-indigo-800">
                                    <p class="italic opacity-75">
                                        Vui l√≤ng ch·ªçn "M·ª•c ti√™u" tr√™n thanh c√¥ng c·ª• ƒë·ªÉ xem ph√¢n t√≠ch l·ªô tr√¨nh.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-charts" class="dashboard-tab-content">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                <h4 class="text-center font-medium text-gray-600 mb-2">GPA c√°c H·ªçc k·ª≥</h4>
                                <div style="height: 250px; position: relative">
                                    <canvas id="semesterGpaChart"></canvas>
                                </div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                                <h4 class="text-center font-medium text-gray-600 mb-2">Ph√¢n ph·ªëi T√≠n ch·ªâ theo ƒêi·ªÉm</h4>
                                <div style="height: 250px; position: relative">
                                    <canvas id="gradeCreditDistributionChart"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm">
                            <h4 class="text-center font-medium text-gray-600 mb-2">Bi·∫øn ƒë·ªông GPA T√≠ch l≈©y (Ti·∫øn ƒë·ªô)</h4>
                            <div style="height: 250px; position: relative">
                                <canvas id="cumulativeGpaChart"></canvas>
                            </div>
                            <div class="bg-white p-4 rounded-lg border border-slate-200 shadow-sm mt-6">
                                <h4 class="text-center font-medium text-gray-600 mb-1">
                                    Ma tr·∫≠n T√≠n ch·ªâ - ƒêi·ªÉm s·ªë (Scatter Plot)
                                </h4>
                                <p class="text-center text-xs text-gray-400 mb-4">
                                    V√πng nguy hi·ªÉm: ƒêi·ªÉm th·∫•p + T√≠n ch·ªâ cao (G√≥c d∆∞·ªõi b√™n ph·∫£i)
                                </p>
                                <div style="height: 300px; position: relative">
                                    <canvas id="scatterChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="tab-details" class="dashboard-tab-content">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-semibold text-gray-700">Danh s√°ch m√¥n h·ªçc chi ti·∫øt</h4>
                            <button
                                id="clearGradeFilterButton"
                                class="secondary-action-button hidden"
                                style="padding: 0.25rem 0.75rem; font-size: 0.8rem; width: auto"
                            >
                                B·ªè l·ªçc ƒëi·ªÉm
                            </button>
                        </div>

                        <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4">
                            <p class="text-xs text-gray-500 mb-2 font-medium uppercase tracking-wide">
                                L·ªçc nhanh theo ƒëi·ªÉm s·ªë:
                            </p>
                            <ul id="statsGradeDistribution" class="grade-distribution-list"></ul>
                        </div>

                        <div class="overflow-x-auto border rounded-lg shadow-sm">
                            <table class="subject-details-table">
                                <thead>
                                    <tr>
                                        <th class="bg-gray-50">T√™n M√¥n</th>
                                        <th class="bg-gray-50" data-sortable data-sort-key="credits">
                                            S·ªë TC <span class="sort-arrow"></span>
                                        </th>
                                        <th class="bg-gray-50" data-sortable data-sort-key="letterGrade">
                                            ƒêi·ªÉm Ch·ªØ <span class="sort-arrow"></span>
                                        </th>
                                        <th class="bg-gray-50" data-sortable data-sort-key="point">
                                            ƒêi·ªÉm 4 <span class="sort-arrow"></span>
                                        </th>
                                        <th class="bg-gray-50" data-sortable data-sort-key="deviation">
                                            ƒê·ªô l·ªách <span class="sort-arrow"></span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="statsSubjectDetailsTableBody" class="bg-white"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="mt-6 text-center pt-4 border-t border-gray-100">
                        <button
                            id="closeDetailedStatsButtonInternal"
                            class="secondary-action-button w-auto mx-auto px-6"
                        >
                            ƒê√≥ng
                        </button>
                    </div>
                </div>
            </div>
            <!-- [TH√äM D√íNG N√ÄY] - ƒë·ªÉ ƒë√≥ng .modal-content-wrapper -->
        </div>
        <!-- [TH√äM D√íNG N√ÄY] - ƒë·ªÉ ƒë√≥ng #detailedStatsModalOverlay -->
        <!-- K·∫æT TH√öC MODAL -->
        <button id="scrollToTopBtn" title="Cu·ªôn l√™n ƒë·∫ßu trang">
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="20"
                height="20"
                fill="currentColor"
                class="bi bi-arrow-up-short"
                viewBox="0 0 16 16"
            >
                <path
                    fill-rule="evenodd"
                    d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5z"
                />
            </svg>
        </button>

        <div id="toastNotification" class="toast-notification">ƒê√£ l∆∞u v√† c·∫≠p nh·∫≠t ƒëi·ªÉm!</div>
        <!-- MODAL CH·ªàNH S·ª¨A CHI TI·∫æT M√îN H·ªåC -->
        <!-- MODAL CH·ªàNH S·ª¨A CHI TI·∫æT M√îN H·ªåC (ƒê√É ƒê∆†N GI·∫¢N H√ìA) -->
        <div id="editSubjectModalOverlay" class="modal-overlay" style="z-index: 1002">
            <div class="modal-content-wrapper" style="max-width: 500px">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-2">
                        <h3 class="text-xl font-bold text-gray-800">Ch·ªânh s·ª≠a H√¨nh th·ª©c thi</h3>
                        <button id="closeEditModalButton" class="text-gray-400 hover:text-gray-600">√ó</button>
                    </div>
                    <p id="editModalSubjectName" class="text-sm text-gray-500 mb-4"></p>

                    <form id="editSubjectForm">
                        <input type="hidden" id="editSubjectId" />

                        <div class="mb-4">
                            <label for="editFinalExamType" class="block text-sm font-medium text-gray-700 mb-1"
                                >Thi cu·ªëi k·ª≥ (L√Ω thuy·∫øt)</label
                            >
                            <select
                                id="editFinalExamType"
                                class="w-full p-2 border border-gray-300 rounded-md bg-white"
                            >
                                <option value="">-- Ch∆∞a x√°c ƒë·ªãnh --</option>
                                <option value="Tr·∫Øc nghi·ªám">Tr·∫Øc nghi·ªám</option>
                                <option value="T·ª± lu·∫≠n (kh√¥ng t√†i li·ªáu)">T·ª± lu·∫≠n (kh√¥ng t√†i li·ªáu)</option>
                                <option value="T·ª± lu·∫≠n (c√≥ t√†i li·ªáu)">T·ª± lu·∫≠n (c√≥ t√†i li·ªáu)</option>
                                <option value="B√°o c√°o/Ti·ªÉu lu·∫≠n">B√°o c√°o/Ti·ªÉu lu·∫≠n</option>
                            </select>
                        </div>

                        <div class="mb-4">
                            <label for="editPracticeExamType" class="block text-sm font-medium text-gray-700 mb-1"
                                >Thi th·ª±c h√†nh (n·∫øu c√≥)</label
                            >
                            <select
                                id="editPracticeExamType"
                                class="w-full p-2 border border-gray-300 rounded-md bg-white"
                            >
                                <option value="">-- Ch∆∞a x√°c ƒë·ªãnh / Kh√¥ng c√≥ --</option>
                                <option value="Ch·ªâ th·ª±c h√†nh">Ch·ªâ th·ª±c h√†nh</option>
                                <option value="Thuy·∫øt tr√¨nh">Thuy·∫øt tr√¨nh</option>
                                <option value="Th·ª±c h√†nh + V·∫•n ƒë√°p">Th·ª±c h√†nh + V·∫•n ƒë√°p</option>
                                <option value="T·ª± lu·∫≠n">T·ª± lu·∫≠n</option>
                            </select>
                        </div>

                        <div class="flex justify-end gap-3 mt-6">
                            <button type="button" id="cancelEditButton" class="secondary-action-button w-auto px-4">
                                H·ªßy
                            </button>
                            <button type="submit" id="saveEditButton" class="main-action-button w-auto px-4">
                                L∆∞u
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            //======================================================================
            // KH·ªêI CODE JAVASCRIPT HO√ÄN CH·ªàNH - SAO CH√âP V√Ä D√ÅN TO√ÄN B·ªò V√ÄO FILE
            //======================================================================

            const detailedStatsModalOverlay = document.getElementById("detailedStatsModalOverlay");

            // 1. D·ªÆ LI·ªÜU & C√ÅC H·∫∞NG S·ªê C∆† B·∫¢N
            // =================================
            // Thay th·∫ø to√†n b·ªô m·∫£ng `subjects` b·∫±ng phi√™n b·∫£n n√†y
            const subjects = [
                // H·ªçc k·ª≥ 1
                {
                    id: "hk1_nn1",
                    name: "Ngo·∫°i ng·ªØ I",
                    code: "1017001113",
                    semester: 1,
                    credits: 3,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk1_gdtc",
                    name: "Gi√°o d·ª•c th·ªÉ ch·∫•t *",
                    code: "1017001748",
                    semester: 1,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: true,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk1_shdt",
                    name: "Sinh h·ªçc - Di truy·ªÅn Y h·ªçc",
                    code: "1017001973",
                    semester: 1,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk1_triet",
                    name: "Tri·∫øt h·ªçc M√°c-L√™nin",
                    code: "1017002021",
                    semester: 1,
                    credits: 3,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk1_tin",
                    name: "Tin h·ªçc",
                    code: "1017002098",
                    semester: 1,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 2
                {
                    id: "hk2_tamly",
                    name: "T√¢m l√Ω y h·ªçc - ƒê·∫°o ƒë·ª©c y h·ªçc",
                    code: "1017000494",
                    semester: 2,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk2_xstk",
                    name: "X√°c su·∫•t th·ªëng k√™ Y h·ªçc",
                    code: "1017001112",
                    semester: 2,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk2_gdqp",
                    name: "GDQP An ninh *",
                    code: "1017001118",
                    semester: 2,
                    credits: 8,
                    hasPractice: true,
                    notInGpa: true,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk2_gp",
                    name: "Gi·∫£i ph·∫´u",
                    code: "1017001651",
                    semester: 2,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk2_hoavc",
                    name: "H√≥a ƒë·∫°i c∆∞∆°ng v√¥ c∆°",
                    code: "1017001747",
                    semester: 2,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk2_vatly",
                    name: "V·∫≠t l√Ω ƒë·∫°i c∆∞∆°ng",
                    code: "1017002179",
                    semester: 2,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 3
                {
                    id: "hk3_sinhly",
                    name: "Sinh l√Ω",
                    code: "1017001653",
                    semester: 3,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk3_kst",
                    name: "K√Ω sinh tr√πng",
                    code: "1017001656",
                    semester: 3,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk3_hoahc",
                    name: "H√≥a h·ªØu c∆°",
                    code: "1017001749",
                    semester: 3,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk3_ktct",
                    name: "Kinh t·∫ø ch√≠nh tr·ªã",
                    code: "1017001790",
                    semester: 3,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk3_cnxhkh",
                    name: "Ch·ªß nghƒ©a x√£ h·ªôi khoa h·ªçc",
                    code: "1017002022",
                    semester: 3,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk3_tvd1",
                    name: "Th·ª±c v·∫≠t d∆∞·ª£c I",
                    code: "1017002129",
                    semester: 3,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk3_nn2",
                    name: "Ngo·∫°i ng·ªØ II",
                    code: "1017002175",
                    semester: 3,
                    credits: 4,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 4
                {
                    id: "hk4_tthcm",
                    name: "T∆∞ t∆∞·ªüng H·ªì Ch√≠ Minh",
                    code: "1017001203",
                    semester: 4,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk4_lsd",
                    name: "L·ªãch s·ª≠ ƒê·∫£ng c·ªông s·∫£n Vi·ªát Nam",
                    code: "1017001719",
                    semester: 4,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk4_hoasinh",
                    name: "H√≥a sinh",
                    code: "1017001770",
                    semester: 4,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk4_ttgds",
                    name: "Truy·ªÅn th√¥ng v√† GD s·ª©c kh·ªèe",
                    code: "1017001772",
                    semester: 4,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk4_visinh",
                    name: "Vi sinh",
                    code: "1017001912",
                    semester: 4,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk4_hpt1",
                    name: "H√≥a ph√¢n t√≠ch I",
                    code: "1017002108",
                    semester: 4,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk4_slbmd",
                    name: "Sinh l√Ω b·ªánh - Mi·ªÖn d·ªãch",
                    code: "1017002126",
                    semester: 4,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 5
                {
                    id: "hk5_benhhoc",
                    name: "B·ªánh h·ªçc",
                    code: "1017001667",
                    semester: 5,
                    credits: 3,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk5_ddhnd",
                    name: "ƒê·∫°o ƒë·ª©c h√†nh ngh·ªÅ d∆∞·ª£c",
                    code: "1017001682",
                    semester: 5,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk5_pldc",
                    name: "Ph√°p lu·∫≠t ƒë·∫°i c∆∞∆°ng",
                    code: "1017001745",
                    semester: 5,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk5_hoalyd",
                    name: "H√≥a l√Ω d∆∞·ª£c",
                    code: "1017001773",
                    semester: 5,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk5_hpt2",
                    name: "H√≥a ph√¢n t√≠ch II",
                    code: "1017002109",
                    semester: 5,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk5_tvd2",
                    name: "Th·ª±c v·∫≠t d∆∞·ª£c II",
                    code: "1017002130",
                    semester: 5,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 6
                {
                    id: "hk6_qlyktd",
                    name: "Qu·∫£n l√Ω v√† kinh t·∫ø d∆∞·ª£c",
                    code: "1017001665",
                    semester: 6,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk6_ddh",
                    name: "D∆∞·ª£c ƒë·ªông h·ªçc",
                    code: "1017001776",
                    semester: 6,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk6_qlydbv",
                    name: "Qu·∫£n l√Ω d∆∞·ª£c b·ªánh vi·ªán",
                    code: "1017001962",
                    semester: 6,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk6_dl1",
                    name: "D∆∞·ª£c li·ªáu I",
                    code: "1017002110",
                    semester: 6,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk6_hd1",
                    name: "H√≥a d∆∞·ª£c I",
                    code: "1017002111",
                    semester: 6,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk6_bcsdh1",
                    name: "B√†o ch·∫ø v√† sinh d∆∞·ª£c h·ªçc I",
                    code: "1017002131",
                    semester: 6,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 7
                {
                    id: "hk7_pcd",
                    name: "Ph√°p ch·∫ø d∆∞·ª£c",
                    code: "1017001661",
                    semester: 7,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk7_hd2",
                    name: "H√≥a d∆∞·ª£c II",
                    code: "1017002112",
                    semester: 7,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk7_dl2",
                    name: "D∆∞·ª£c li·ªáu II",
                    code: "1017002113",
                    semester: 7,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk7_dl1",
                    name: "D∆∞·ª£c l√Ω I",
                    code: "1017002114",
                    semester: 7,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk7_bcsdh2",
                    name: "B√†o ch·∫ø v√† sinh d∆∞·ª£c h·ªçc II",
                    code: "1017002132",
                    semester: 7,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk7_ppnckh",
                    name: "Ph∆∞∆°ng ph√°p NCKH",
                    code: "1017002095",
                    semester: 7,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },

                // H·ªçc k·ª≥ 8
                {
                    id: "hk8_dch",
                    name: "ƒê·ªôc ch·∫•t h·ªçc",
                    code: "1017001663",
                    semester: 8,
                    credits: 2,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk8_sdtdt",
                    name: "S·ª≠ d·ª•ng thu·ªëc trong ƒëi·ªÅu tr·ªã",
                    code: "1017001961",
                    semester: 8,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk8_ttcd",
                    name: "Th√¥ng tin v√† c·∫£nh gi√°c d∆∞·ª£c",
                    code: "1017001963",
                    semester: 8,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk8_sxdp",
                    name: "S·∫£n xu·∫•t d∆∞·ª£c ph·∫©m",
                    code: "1017001964",
                    semester: 8,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk8_dl2",
                    name: "D∆∞·ª£c l√Ω II",
                    code: "1017002115",
                    semester: 8,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 9
                {
                    id: "hk9_dhct",
                    name: "D∆∞·ª£c h·ªçc c·ªï truy·ªÅn",
                    code: "1017001672",
                    semester: 9,
                    credits: 3,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk9_dls",
                    name: "D∆∞·ª£c l√¢m s√†ng",
                    code: "1017001915",
                    semester: 9,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk9_kndp",
                    name: "Ki·ªÉm nghi·ªám d∆∞·ª£c ph·∫©m",
                    code: "1017001916",
                    semester: 9,
                    credits: 4,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk9_thdlsbv",
                    name: "Th·ª±c h√†nh d∆∞·ª£c l√¢m s√†ng BV",
                    code: "1017001917",
                    semester: 9,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk9_tnct",
                    name: "T√†i nguy√™n c√¢y thu·ªëc",
                    code: "1017001965",
                    semester: 9,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk9_thqlcut",
                    name: "Th·ª±c h√†nh qu·∫£n l√Ω v√† cung ·ª©ng thu·ªëc",
                    code: "1017002133",
                    semester: 9,
                    credits: 2,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                // H·ªçc k·ª≥ 10
                {
                    id: "hk10_tttn",
                    name: "Th·ª±c t·∫ø t·ªët nghi·ªáp",
                    code: "1017000556",
                    semester: 10,
                    credits: 5,
                    hasPractice: true,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
                {
                    id: "hk10_kltn",
                    name: "Kh√≥a lu·∫≠n t·ªët nghi·ªáp/ Thi t·ªët nghi·ªáp",
                    code: "1017002134",
                    semester: 10,
                    credits: 10,
                    hasPractice: false,
                    notInGpa: false,
                    finalExamType: null,
                    practiceExamType: null,
                },
            ];
            const gradePoints = {
                "A+": 4.0,
                A: 3.7,
                "B+": 3.5,
                B: 3.0,
                "C+": 2.5,
                C: 2.0,
                "D+": 1.5,
                D: 1.0,
                F: 0.0,
                "": null,
            };
            const gradeOptions = ["", "A+", "A", "B+", "B", "C+", "C", "D+", "D", "F"];
            const RANK_THRESHOLDS = { "Xu·∫•t s·∫Øc": 3.6, Gi·ªèi: 3.2, Kh√°: 2.5, "Trung b√¨nh": 2.0 };
            const MAX_POSSIBLE_GRADE_POINT = 4.0;
            const LOCAL_STORAGE_KEY = "studentGrades_v2"; // ƒê·ªïi t√™n key ƒë·ªÉ l∆∞u c·∫•u tr√∫c m·ªõi
            const LOCAL_STORAGE_TARGET_RANK_KEY = "studentTargetRank";
            const LOCAL_STORAGE_EXPANDED_SEMESTERS_KEY = "expandedSemesters";

            // 2. C√ÅC BI·∫æN TR·∫†NG TH√ÅI
            // =========================
            let activeQuickFilters = { finalExamType: "all", hasPractice: "all" };
            let currentGradeFilter = null;
            let currentSort = { key: null, order: "asc" };
            let allCompletedSubjectsForStats = [];
            let detailedStatsTableHeadersInitialized = false;
            let cumulativeGpaChartInstance = null;
            let toastTimeout;

            // 3. T√çNH TO√ÅN D·ªÆ LI·ªÜU BAN ƒê·∫¶U
            // ================================
            const totalProgramCredits = subjects.reduce((sum, s) => (s.notInGpa ? sum : sum + s.credits), 0);
            const subjectsBySemester = subjects.reduce((acc, subject) => {
                acc[subject.semester] = acc[subject.semester] || [];
                acc[subject.semester].push(subject);
                return acc;
            }, {});

            // 4. L·∫§Y C√ÅC TH√ÄNH PH·∫¶N DOM
            // ===========================
            const semestersContainer = document.getElementById("semestersContainer");
            const calculateButton = document.getElementById("calculateButton");
            const resultsArea = document.getElementById("resultsArea");
            const totalCreditsEl = document.getElementById("totalCredits");
            const gpaEl = document.getElementById("gpa");
            const rankEl = document.getElementById("rank");
            const toastNotification = document.getElementById("toastNotification");
            const scrollToTopBtn = document.getElementById("scrollToTopBtn");
            const targetRankSelect = document.getElementById("targetRankSelect");
            const targetAchievableEl = document.getElementById("targetAchievable");
            const remainingCreditsForTargetEl = document.getElementById("remainingCreditsForTarget");
            const minAvgForRemainingEl = document.getElementById("minAvgForRemaining");
            // Ngay d∆∞·ªõi d√≤ng `const minAvgForRemainingEl = ...`

            // Detailed Stats Elements (B·ªï sung c√°c bi·∫øn b·ªã thi·∫øu)
            const toggleDetailedStatsButton = document.getElementById("toggleDetailedStatsButton");
            const statsTotalProgramCreditsEl = document.getElementById("statsTotalProgramCredits");
            const statsTotalCompletedCreditsEl = document.getElementById("statsTotalCompletedCredits");
            const statsCompletionRateEl = document.getElementById("statsCompletionRate");
            const statsOverallGPAEl = document.getElementById("statsOverallGPA");
            const statsSubjectDetailsTableBodyEl = document.getElementById("statsSubjectDetailsTableBody");
            const clearGradeFilterButton = document.getElementById("clearGradeFilterButton");
            let gradeCreditChartInstance = null;
            let semesterGpaChartInstance = null;
            const targetGpaItemEl = document.getElementById("target-gpa-item");
            const completionPercentageEl = document.getElementById("completionPercentage");
            const targetInsightEl = document.getElementById("targetInsight");
            // 5. C√ÅC H√ÄM TI·ªÜN √çCH
            // ====================
            function showToast(message) {
                if (toastTimeout) clearTimeout(toastTimeout);
                toastNotification.textContent = message;
                toastNotification.classList.add("show");
                toastTimeout = setTimeout(() => {
                    toastNotification.classList.remove("show");
                }, 2500);
            }

            const createTagsHTML = (subject) => {
                let tags = "";
                if (subject.finalExamType === "Tr·∫Øc nghi·ªám") {
                    tags += '<span class="subject-tag tag-tn">Tr·∫Øc nghi·ªám</span>';
                } else if (subject.finalExamType && subject.finalExamType.includes("T·ª± lu·∫≠n")) {
                    tags += '<span class="subject-tag tag-tl">T·ª± lu·∫≠n</span>';
                }
                if (subject.hasPractice) {
                    tags += '<span class="subject-tag tag-th-true">C√≥ TH</span>';
                }
                if (subject.notInGpa) {
                    tags +=
                        '<span class="subject-tag" style="background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db;">Kh√¥ng t√≠nh ƒëi·ªÉm</span>';
                }
                return tags;
            };

            function getRank(gpa) {
                if (gpa === null || isNaN(gpa)) return "N/A";
                if (gpa >= 3.6) return "Xu·∫•t s·∫Øc";
                if (gpa >= 3.2) return "Gi·ªèi";
                if (gpa >= 2.5) return "Kh√°";
                if (gpa >= 2.0) return "Trung b√¨nh";
                if (gpa >= 1.0) return "Y·∫øu";
                return "K√©m";
            }

            function getRankColor(rank) {
                const rankLower = String(rank || "").toLowerCase();
                switch (rankLower) {
                    case "xu·∫•t s·∫Øc":
                        return "purple";
                    case "gi·ªèi":
                        return "blue";
                    case "kh√°":
                        return "green";
                    case "trung b√¨nh":
                        return "yellow";
                    case "y·∫øu":
                        return "orange";
                    case "k√©m":
                        return "red";
                    default:
                        return "slate";
                }
            }

            // 6. X·ª¨ L√ù L∆ØU V√Ä T·∫¢I D·ªÆ LI·ªÜU (LOCALSTORAGE)
            // ===========================================
            // Thay th·∫ø h√†m c≈© b·∫±ng h√†m n√†y
            function upgradeAndLoadSavedData() {
                const OLD_GRADES_KEY = "studentGrades";
                const NEW_DATA_KEY = "studentGrades_v2"; // S·ª≠ d·ª•ng m·ªôt key m·ªõi ƒë·ªÉ tr√°nh xung ƒë·ªôt

                const savedNewData = localStorage.getItem(NEW_DATA_KEY);

                if (savedNewData) {
                    // N·∫øu ƒë√£ c√≥ d·ªØ li·ªáu m·ªõi, ch·ªâ c·∫ßn t·∫£i n√≥
                    try {
                        const parsedData = JSON.parse(savedNewData);
                        subjects.forEach((subject) => {
                            const savedSubject = parsedData[subject.id];
                            if (savedSubject) {
                                subject.finalExamType = savedSubject.finalExamType;
                                subject.practiceExamType = savedSubject.practiceExamType;
                                const gradeSelect = document.getElementById(subject.id);
                                if (gradeSelect) {
                                    gradeSelect.value = savedSubject.grade || "";
                                }
                            }
                        });
                    } catch (e) {
                        console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu v2:", e);
                        localStorage.removeItem(NEW_DATA_KEY); // X√≥a d·ªØ li·ªáu l·ªói
                    }
                } else {
                    // N·∫øu kh√¥ng c√≥ d·ªØ li·ªáu m·ªõi, th·ª≠ n√¢ng c·∫•p t·ª´ d·ªØ li·ªáu c≈© (key: "studentGrades")
                    const savedOldGrades = localStorage.getItem(OLD_GRADES_KEY);
                    if (savedOldGrades) {
                        try {
                            const parsedOldGrades = JSON.parse(savedOldGrades);
                            Object.keys(parsedOldGrades).forEach((oldId) => {
                                const gradeSelect = document.getElementById(oldId);
                                if (gradeSelect) {
                                    gradeSelect.value = parsedOldGrades[oldId] || "";
                                }
                            });
                            showToast("ƒê√£ t·∫£i ƒëi·ªÉm t·ª´ phi√™n b·∫£n c≈©. H√£y l∆∞u l·∫°i ƒë·ªÉ ho√†n t·∫•t n√¢ng c·∫•p.");
                        } catch (e) {
                            console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu c≈©:", e);
                        }
                    }
                }
            }
            function saveStateToLocalStorage() {
                const dataToSave = {};
                subjects.forEach((subject) => {
                    const gradeSelect = document.getElementById(subject.id);
                    dataToSave[subject.id] = {
                        grade: gradeSelect ? gradeSelect.value : "",
                        finalExamType: subject.finalExamType,
                        practiceExamType: subject.practiceExamType,
                    };
                });
                const expandedSemesters = [];
                document.querySelectorAll(".semester-block .subjects-list.expanded").forEach((list) => {
                    expandedSemesters.push(list.dataset.semester);
                });
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
                    if (targetRankSelect) localStorage.setItem(LOCAL_STORAGE_TARGET_RANK_KEY, targetRankSelect.value);
                    localStorage.setItem(LOCAL_STORAGE_EXPANDED_SEMESTERS_KEY, JSON.stringify(expandedSemesters));
                } catch (e) {
                    console.error("L·ªói khi l∆∞u v√†o localStorage:", e);
                    showToast("L·ªói: Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu!");
                }
            }

            // Thay th·∫ø to√†n b·ªô h√†m loadStateFromLocalStorage c≈© b·∫±ng h√†m n√†y
            function loadStateFromLocalStorage() {
                const OLD_GRADES_KEY = "studentGrades";
                const NEW_DATA_KEY = "studentGrades_v2"; // S·ª≠ d·ª•ng key m·ªõi

                // T·∫£i c√°c c√†i ƒë·∫∑t giao di·ªán tr∆∞·ªõc
                const savedTargetRank = localStorage.getItem(LOCAL_STORAGE_TARGET_RANK_KEY);
                if (targetRankSelect && savedTargetRank) {
                    targetRankSelect.value = savedTargetRank;
                }
                const savedExpandedSemesters = localStorage.getItem(LOCAL_STORAGE_EXPANDED_SEMESTERS_KEY);
                if (savedExpandedSemesters) {
                    const expanded = JSON.parse(savedExpandedSemesters);
                    expanded.forEach((semNum) => {
                        const semList = document.querySelector(`.subjects-list[data-semester="${semNum}"]`);
                        const semArrow = document.querySelector(
                            `.semester-header[data-semester="${semNum}"] .semester-arrow`
                        );
                        if (semList) semList.classList.add("expanded");
                        if (semArrow) semArrow.classList.add("expanded");
                    });
                }

                // X·ª≠ l√Ω t·∫£i d·ªØ li·ªáu m√¥n h·ªçc (ƒëi·ªÉm v√† h√¨nh th·ª©c thi)
                const savedNewData = localStorage.getItem(NEW_DATA_KEY);
                if (savedNewData) {
                    // --- TR∆Ø·ªúNG H·ª¢P 1: ƒê√É C√ì D·ªÆ LI·ªÜU M·ªöI ---
                    try {
                        const parsedData = JSON.parse(savedNewData);
                        subjects.forEach((subject) => {
                            const savedSubject = parsedData[subject.id];
                            if (savedSubject) {
                                // C·∫≠p nh·∫≠t c·∫£ h√¨nh th·ª©c thi V√ÄO M·∫¢NG JS
                                subject.finalExamType = savedSubject.finalExamType;
                                subject.practiceExamType = savedSubject.practiceExamType;

                                // C·∫≠p nh·∫≠t ƒëi·ªÉm V√ÄO GIAO DI·ªÜN
                                const gradeSelect = document.getElementById(subject.id);
                                if (gradeSelect) {
                                    gradeSelect.value = savedSubject.grade || "";
                                }
                            }
                        });
                    } catch (e) {
                        console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu v2:", e);
                        localStorage.removeItem(NEW_DATA_KEY);
                    }
                } else {
                    // --- TR∆Ø·ªúNG H·ª¢P 2: CH·ªà C√ì D·ªÆ LI·ªÜU ƒêI·ªÇM C≈® ---
                    const savedOldGrades = localStorage.getItem(OLD_GRADES_KEY);
                    if (savedOldGrades) {
                        try {
                            const parsedOldGrades = JSON.parse(savedOldGrades);
                            // Ch·ªâ ƒëi·ªÅn ƒëi·ªÉm v√†o giao di·ªán, h√¨nh th·ª©c thi gi·ªØ nguy√™n l√† null
                            Object.keys(parsedOldGrades).forEach((oldId) => {
                                const gradeSelect = document.getElementById(oldId);
                                if (gradeSelect) {
                                    gradeSelect.value = parsedOldGrades[oldId] || "";
                                }
                            });
                            showToast("ƒê√£ t·∫£i ƒëi·ªÉm t·ª´ phi√™n b·∫£n c≈©. H√£y nh·∫≠p h√¨nh th·ª©c thi v√† l∆∞u l·∫°i.");
                        } catch (e) {
                            console.error("L·ªói khi ƒë·ªçc d·ªØ li·ªáu c≈©:", e);
                        }
                    }
                }
                subjects.forEach((subject) => {
                    const subjectDiv = document.querySelector(`.subject-item[data-id="${subject.id}"]`);
                    if (subjectDiv) {
                        const tagsContainer = subjectDiv.querySelector(".subject-tags-container");
                        const finalExamTypeDataAttribute = subjectDiv.querySelector(".subject-name-wrapper");
                        if (tagsContainer) tagsContainer.innerHTML = createTagsHTML(subject);
                        // C·∫≠p nh·∫≠t c·∫£ data-attribute ƒë·ªÉ b·ªô l·ªçc ho·∫°t ƒë·ªông ƒë√∫ng
                        subjectDiv.dataset.finalExamType = subject.finalExamType || "";
                    }
                });
            }
            // 7. HI·ªÇN TH·ªä GIAO DI·ªÜN & T√çNH TO√ÅN
            // ===================================
            //==============================================================
            // THAY TH·∫æ TO√ÄN B·ªò C√ÅC H√ÄM T·ª™ ƒê√ÇY TR·ªû XU·ªêNG
            //==============================================================

            //==============================================================
            // THAY TH·∫æ TO√ÄN B·ªò C√ÅC H√ÄM T·ª™ ƒê√ÇY TR·ªû XU·ªêNG
            //==============================================================

            function populateSubjectsAndSemesters() {
                Object.keys(subjectsBySemester)
                    .sort((a, b) => parseInt(a) - parseInt(b))
                    .forEach((semesterNumber) => {
                        const semesterSubjects = subjectsBySemester[semesterNumber];
                        const semesterBlock = document.createElement("div");
                        semesterBlock.className = "semester-block";
                        const semesterHeader = document.createElement("div");
                        semesterHeader.className = "semester-header";
                        semesterHeader.dataset.semester = semesterNumber;
                        semesterHeader.innerHTML = `
            <div class="semester-header-content">
                <h3 class="font-semibold">H·ªçc k·ª≥ ${semesterNumber}</h3>
                <span class="semester-grade-count" id="sem-count-${semesterNumber}"></span>
                <span class="semester-gpa-display" id="sem-gpa-${semesterNumber}">GPA HK: N/A</span>
            </div>
            <span class="semester-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
            </span>`;
                        const subjectsList = document.createElement("div");
                        subjectsList.className = "subjects-list";
                        subjectsList.dataset.semester = semesterNumber;
                        semesterSubjects.forEach((subject) => {
                            const subjectDiv = document.createElement("div");
                            subjectDiv.className = "subject-item";
                            subjectDiv.dataset.id = subject.id;
                            subjectDiv.dataset.hasPractice = subject.hasPractice;
                            subjectDiv.dataset.finalExamType = subject.finalExamType || "";
                            subjectDiv.innerHTML = `
                <div class="subject-name-wrapper">
                    <span class="subject-name editable-subject-name" title="${subject.name}" data-subject-id="${subject.id}">${subject.name}</span>
                    <div class="subject-tags-container">${createTagsHTML(subject)}</div>
                </div>
                <span class="text-center">${subject.credits}</span>
                <select id="${subject.id}" class="w-full subject-grade-select bg-white py-2 px-1 text-sm rounded-md border-slate-300">
                    ${gradeOptions.map((grade) => `<option value="${grade}" ${subject.notInGpa ? "disabled" : ""}>${grade || "--"}</option>`).join("")}
                </select>`;
                            subjectsList.appendChild(subjectDiv);
                            subjectDiv.querySelector(`#${subject.id}`).addEventListener("change", (event) => {
                                calculateAndDisplayResults();
                                event.target.closest(".subject-item").classList.add("selected-briefly");
                                setTimeout(
                                    () => event.target.closest(".subject-item").classList.remove("selected-briefly"),
                                    300
                                );
                            });
                        });
                        semesterBlock.appendChild(semesterHeader);
                        semesterBlock.appendChild(subjectsList);
                        semestersContainer.appendChild(semesterBlock);
                        semesterHeader.addEventListener("click", () => {
                            subjectsList.classList.toggle("expanded");
                            semesterHeader.querySelector(".semester-arrow").classList.toggle("expanded");
                            saveStateToLocalStorage();
                        });
                    });
            }

            function calculateAndDisplayResults() {
                let totalWeightedPoints = 0,
                    currentTotalCompletedCredits = 0,
                    hasInput = false;
                const completedSubjectsDetails = [];
                subjects.forEach((subject) => {
                    if (subject.notInGpa) return;
                    const gradeSelect = document.getElementById(subject.id);
                    if (!gradeSelect) return;
                    const letterGrade = gradeSelect.value;
                    if (letterGrade && gradePoints[letterGrade] !== null) {
                        hasInput = true;
                        const point = gradePoints[letterGrade];
                        const weightedPoints = point * subject.credits;
                        totalWeightedPoints += weightedPoints;
                        currentTotalCompletedCredits += subject.credits;
                        completedSubjectsDetails.push({
                            id: subject.id,
                            name: subject.name,
                            credits: subject.credits,
                            letterGrade: letterGrade,
                            point: point,
                            weightedPoints: weightedPoints,
                        });
                    }
                });
                let currentGPA =
                    hasInput && currentTotalCompletedCredits > 0
                        ? totalWeightedPoints / currentTotalCompletedCredits
                        : 0;
                if (hasInput) {
                    currentGPA =
                        currentTotalCompletedCredits > 0 ? totalWeightedPoints / currentTotalCompletedCredits : 0;
                    const currentRank = getRank(currentGPA);
                    const rankColor = getRankColor(currentRank);

                    gpaEl.textContent = currentGPA.toFixed(2);
                    rankEl.textContent = currentRank;
                    rankEl.className = `result-value rank-highlight text-${rankColor}`; // C·∫≠p nh·∫≠t m√†u cho ch·ªØ
                    totalCreditsEl.textContent = currentTotalCompletedCredits;

                    const percentage =
                        totalProgramCredits > 0 ? (currentTotalCompletedCredits / totalProgramCredits) * 100 : 0;
                    completionPercentageEl.textContent = `${percentage.toFixed(0)}%`;
                } else {
                    // Reset v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
                    gpaEl.textContent = "0.00";
                    rankEl.textContent = "N/A";
                    rankEl.className = "result-value rank-highlight text-slate";
                    totalCreditsEl.textContent = "0";
                    completionPercentageEl.textContent = "0%";
                }
                updateTargetRank(currentTotalCompletedCredits, totalWeightedPoints);
                updateSemesterStats();
                updateDetailedStatistics(completedSubjectsDetails, currentGPA);
                saveStateToLocalStorage();
            }

            function updateSemesterStats() {
                Object.keys(subjectsBySemester).forEach((semesterNumber) => {
                    const semesterSubjects = subjectsBySemester[semesterNumber].filter((s) => !s.notInGpa);
                    let gradedCount = 0,
                        semesterWeightedPoints = 0,
                        semesterCompletedCredits = 0;
                    semesterSubjects.forEach((subject) => {
                        const gradeSelect = document.getElementById(subject.id);
                        if (gradeSelect && gradeSelect.value !== "") {
                            gradedCount++;
                            const point = gradePoints[gradeSelect.value];
                            if (point !== null) {
                                semesterWeightedPoints += point * subject.credits;
                                semesterCompletedCredits += subject.credits;
                            }
                        }
                    });
                    document.getElementById(`sem-count-${semesterNumber}`).textContent =
                        `(${gradedCount}/${semesterSubjects.length})`;
                    const gpaDisplay = document.getElementById(`sem-gpa-${semesterNumber}`);
                    gpaDisplay.textContent =
                        semesterCompletedCredits > 0
                            ? `GPA HK: ${(semesterWeightedPoints / semesterCompletedCredits).toFixed(2)}`
                            : `GPA HK: N/A`;
                });
            }

            // THAY TH·∫æ TO√ÄN B·ªò H√ÄM updateTargetRank
            // THAY TH·∫æ TO√ÄN B·ªò H√ÄM N√ÄY
            function updateTargetRank(currentTotalCompletedCredits, totalWeightedPoints) {
                const selectedTargetRankValue = targetRankSelect.value;
                const targetGPAThreshold = RANK_THRESHOLDS[selectedTargetRankValue];

                if (selectedTargetRankValue && targetGPAThreshold) {
                    targetGpaItemEl.classList.add("visible");
                    targetInsightEl.classList.add("visible");

                    const remainingCredits = totalProgramCredits - currentTotalCompletedCredits;
                    // D√≤ng n√†y kh√¥ng c·∫ßn n·ªØa v√¨ ƒë√£ c√≥ trong thanh ph·ª•: remainingCreditsForTargetEl.textContent = remainingCredits >= 0 ? remainingCredits : "L·ªói";

                    if (remainingCredits <= 0) {
                        const finalGPA =
                            currentTotalCompletedCredits > 0 ? totalWeightedPoints / currentTotalCompletedCredits : 0;
                        minAvgForRemainingEl.textContent = "N/A";
                        targetInsightEl.textContent = "B·∫°n ƒë√£ ho√†n th√†nh ch∆∞∆°ng tr√¨nh h·ªçc!";
                    } else {
                        const pointsStillNeeded = targetGPAThreshold * totalProgramCredits - totalWeightedPoints;
                        if (pointsStillNeeded <= 0) {
                            minAvgForRemainingEl.textContent = "0.00";
                            targetInsightEl.textContent =
                                "Tuy·ªát v·ªùi! B·∫°n ch·ªâ c·∫ßn qua t·∫•t c·∫£ c√°c m√¥n c√≤n l·∫°i l√† ƒë·∫°t m·ª•c ti√™u.";
                        } else {
                            const avgNeeded = pointsStillNeeded / remainingCredits;
                            minAvgForRemainingEl.textContent = avgNeeded.toFixed(2);
                            if (avgNeeded > MAX_POSSIBLE_GRADE_POINT) {
                                targetInsightEl.textContent =
                                    "ƒêi·ªÉm trung b√¨nh y√™u c·∫ßu ƒë√£ v∆∞·ª£t qu√° m·ª©c t·ªëi ƒëa c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c.";
                                minAvgForRemainingEl.classList.add("text-red-600");
                            } else if (avgNeeded >= 3.7) {
                                targetInsightEl.textContent = `R·∫•t kh√≥! B·∫°n c·∫ßn ƒë·∫°t ƒëi·ªÉm trung b√¨nh g·∫ßn nh∆∞ tuy·ªát ƒë·ªëi (A/A+) cho c√°c m√¥n c√≤n l·∫°i.`;
                                minAvgForRemainingEl.classList.remove("text-red-600");
                            } else {
                                targetInsightEl.textContent = `C·ªë l√™n! H√£y duy tr√¨ ƒëi·ªÉm trung b√¨nh c√°c m√¥n c√≤n l·∫°i ·ªü m·ª©c ${avgNeeded.toFixed(2)} tr·ªü l√™n.`;
                                minAvgForRemainingEl.classList.remove("text-red-600");
                            }
                        }
                    }
                } else {
                    // Khi ch∆∞a ch·ªçn m·ª•c ti√™u
                    targetGpaItemEl.classList.remove("visible");
                    targetInsightEl.classList.remove("visible");
                }
            }
            // ===============================================
            // C√ÅC H√ÄM CHO MODAL TH·ªêNG K√ä CHI TI·∫æT
            // ===============================================

            function updateDetailedStatistics(completedSubjectsData, overallGPA) {
                allCompletedSubjectsForStats = [...completedSubjectsData];
                const completedCredits = allCompletedSubjectsForStats.reduce((sum, s) => sum + s.credits, 0);
                statsTotalProgramCreditsEl.textContent = totalProgramCredits;
                statsTotalCompletedCreditsEl.textContent = completedCredits;
                const completionRate = totalProgramCredits > 0 ? (completedCredits / totalProgramCredits) * 100 : 0;
                statsCompletionRateEl.textContent = `${completionRate.toFixed(1)}%`;
                statsOverallGPAEl.textContent = `${overallGPA.toFixed(2)}`;

                generateInsights(allCompletedSubjectsForStats, overallGPA);
                renderGradeDistribution(allCompletedSubjectsForStats);
                renderGradeCreditDistributionChart(allCompletedSubjectsForStats);
                renderSemesterGpaChart(allCompletedSubjectsForStats, overallGPA);
                updateCumulativeGpaChart(allCompletedSubjectsForStats);
                renderDetailedTable();
                renderScatterChart(allCompletedSubjectsForStats);
                // T√≠nh l·∫°i credits v√† weightedPoints hi·ªán t·∫°i
                let curPoints = 0;
                completedSubjectsData.forEach((s) => (curPoints += s.weightedPoints));
                let curCredits = completedSubjectsData.reduce((sum, s) => sum + s.credits, 0);
                renderRankUpCalculator(curCredits, curPoints);
            }

            function renderDetailedTable() {
                let displayData = [...allCompletedSubjectsForStats];
                if (currentGradeFilter) {
                    displayData = displayData.filter((subject) => subject.letterGrade === currentGradeFilter);
                }
                if (currentSort.key) {
                    displayData.sort((a, b) => {
                        let valA = a[currentSort.key],
                            valB = b[currentSort.key];
                        const overallGPA = parseFloat(statsOverallGPAEl.textContent) || 0;
                        if (currentSort.key === "deviation") {
                            valA = a.point - overallGPA;
                            valB = b.point - overallGPA;
                        } else if (currentSort.key === "letterGrade") {
                            valA = gradePoints[a.letterGrade] || -1;
                            valB = gradePoints[b.letterGrade] || -1;
                        }
                        if (typeof valA === "string")
                            return currentSort.order === "asc" ? valA.localeCompare(valB) : valB.localeCompare(valA);
                        return currentSort.order === "asc" ? valA - valB : valB - valA;
                    });
                }
                statsSubjectDetailsTableBodyEl.innerHTML = "";
                if (displayData.length === 0) {
                    statsSubjectDetailsTableBodyEl.innerHTML = `<tr><td colspan="5" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu.</td></tr>`;
                    return;
                }
                const overallGPAForDeviation = parseFloat(statsOverallGPAEl.textContent) || 0;
                displayData.forEach((data) => {
                    const deviation = data.point - overallGPAForDeviation;
                    const row = statsSubjectDetailsTableBodyEl.insertRow();
                    row.innerHTML = `
            <td>${data.name}</td>
            <td class="text-center">${data.credits}</td>
            <td class="text-center">${data.letterGrade}</td>
            <td class="text-center">${data.point.toFixed(1)}</td>
            <td class="text-center ${deviation >= 0.01 ? "deviation-positive" : deviation <= -0.01 ? "deviation-negative" : ""}">${deviation.toFixed(2)}</td>
        `;
                });
                updateSortArrows();
            }

            function handleSortClick(key) {
                if (currentSort.key === key) {
                    currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
                } else {
                    currentSort.key = key;
                    currentSort.order = "asc";
                }
                renderDetailedTable();
            }

            function updateSortArrows() {
                document.querySelectorAll(".subject-details-table th[data-sortable]").forEach((th) => {
                    th.classList.remove("sorted-asc", "sorted-desc");
                    if (th.dataset.sortKey === currentSort.key) {
                        th.classList.add(currentSort.order === "asc" ? "sorted-asc" : "sorted-desc");
                    }
                });
            }

            function handleGradeFilterClick(grade) {
                currentGradeFilter = currentGradeFilter === grade ? null : grade;
                renderGradeDistribution(allCompletedSubjectsForStats);
                renderDetailedTable();
                clearGradeFilterButton.classList.toggle("hidden", !currentGradeFilter);
            }

            function renderGradeDistribution(completedSubjects) {
                const distEl = document.getElementById("statsGradeDistribution");
                if (!distEl) return;
                const gradeCounts = {},
                    gradeCredits = {},
                    totalGradedCredits = completedSubjects.reduce((sum, s) => sum + s.credits, 0);
                gradeOptions.forEach((g) => {
                    if (g) {
                        gradeCounts[g] = 0;
                        gradeCredits[g] = 0;
                    }
                });
                completedSubjects.forEach((s) => {
                    if (s.letterGrade) {
                        gradeCounts[s.letterGrade]++;
                        gradeCredits[s.letterGrade] += s.credits;
                    }
                });
                distEl.innerHTML = "";
                Object.keys(gradeCounts)
                    .sort((a, b) => gradePoints[b] - gradePoints[a])
                    .forEach((grade) => {
                        if (gradeCounts[grade] > 0) {
                            const percentage =
                                totalGradedCredits > 0 ? (gradeCredits[grade] / totalGradedCredits) * 100 : 0;
                            const li = document.createElement("li");
                            li.className = `grade-dist-item-default ${grade === currentGradeFilter ? "active-filter" : ""}`;
                            li.innerHTML = `<span class="grade-label">${grade}</span><span class="grade-info">${gradeCounts[grade]} m√¥n / ${gradeCredits[grade]} TC</span><span class="grade-percentage">${percentage.toFixed(1)}% TC</span>`;
                            li.addEventListener("click", () => handleGradeFilterClick(grade));
                            distEl.appendChild(li);
                        }
                    });
            }

            function generateInsights(completedSubjects, gpa) {
                const insightsContainer = document.getElementById("insightsContainer");
                if (!insightsContainer) return;
                insightsContainer.innerHTML = "";
                if (completedSubjects.length < 1) {
                    insightsContainer.innerHTML =
                        '<p class="text-gray-500 col-span-full">Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ t·∫°o ph√¢n t√≠ch.</p>';
                    return;
                }
                let bestImpact = { name: "", impact: -Infinity };
                completedSubjects.forEach((s) => {
                    const impact = s.credits * (s.point - gpa);
                    if (impact > bestImpact.impact) {
                        bestImpact = { name: s.name, impact: impact, credits: s.credits, grade: s.letterGrade };
                    }
                });
                if (bestImpact.impact > 0) {
                    insightsContainer.innerHTML += `<div class="insight-card positive"><div class="insight-title">üöÄ M√¥n T√≠ch c·ª±c nh·∫•t</div><div class="insight-body"><span class="font-bold">${bestImpact.name}</span><p class="text-sm">${bestImpact.credits}TC - ƒêi·ªÉm ${bestImpact.grade}</p></div></div>`;
                }
                let worstImpact = { name: "", impact: Infinity };
                completedSubjects.forEach((s) => {
                    const impact = s.credits * (s.point - gpa);
                    if (impact < worstImpact.impact) {
                        worstImpact = { name: s.name, impact: impact, credits: s.credits, grade: s.letterGrade };
                    }
                });
                if (worstImpact.impact < 0) {
                    insightsContainer.innerHTML += `<div class="insight-card negative"><div class="insight-title">üìâ M√¥n C·∫ßn c·∫£i thi·ªán</div><div class="insight-body"><span class="font-bold">${worstImpact.name}</span><p class="text-sm">${worstImpact.credits}TC - ƒêi·ªÉm ${worstImpact.grade}</p></div></div>`;
                }
                const semesterGPAs = {};
                completedSubjects.forEach((s) => {
                    const original = subjects.find((sub) => sub.id === s.id);
                    if (!original) return;
                    const sem = original.semester;
                    if (!semesterGPAs[sem]) semesterGPAs[sem] = { points: 0, credits: 0 };
                    semesterGPAs[sem].points += s.weightedPoints;
                    semesterGPAs[sem].credits += s.credits;
                });
                let bestSem = { sem: null, gpa: -1 };
                Object.keys(semesterGPAs).forEach((sem) => {
                    const semGpa =
                        semesterGPAs[sem].credits > 0 ? semesterGPAs[sem].points / semesterGPAs[sem].credits : 0;
                    if (semGpa > bestSem.gpa) bestSem = { sem, gpa: semGpa };
                });
                if (bestSem.sem) {
                    insightsContainer.innerHTML += `<div class="insight-card"><div class="insight-title">üèÜ H·ªçc k·ª≥ N·ªïi b·∫≠t</div><div class="insight-body">H·ªçc k·ª≥ ${bestSem.sem} v·ªõi GPA ${bestSem.gpa.toFixed(2)}</div></div>`;
                }
            }

            function renderGradeCreditDistributionChart(completedSubjects) {
                const ctx = document.getElementById("gradeCreditDistributionChart")?.getContext("2d");
                if (!ctx) return;
                if (gradeCreditChartInstance) gradeCreditChartInstance.destroy();
                if (completedSubjects.length === 0) return;
                const creditByGrade = {};
                gradeOptions.forEach((g) => {
                    if (g) creditByGrade[g] = 0;
                });
                completedSubjects.forEach((s) => {
                    if (s.letterGrade) creditByGrade[s.letterGrade] += s.credits;
                });
                const sortedGrades = Object.keys(creditByGrade).sort((a, b) => gradePoints[b] - gradePoints[a]);
                gradeCreditChartInstance = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: sortedGrades,
                        datasets: [
                            {
                                label: "S·ªë T√≠n ch·ªâ",
                                data: sortedGrades.map((grade) => creditByGrade[grade]),
                                backgroundColor: "rgba(59, 130, 246, 0.6)",
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, title: { display: true, text: "T·ªïng s·ªë T√≠n ch·ªâ" } } },
                        plugins: { legend: { display: false } },
                    },
                });
            }

            function renderSemesterGpaChart(completedSubjects, overallGPA) {
                const ctx = document.getElementById("semesterGpaChart")?.getContext("2d");
                if (!ctx) return;
                if (semesterGpaChartInstance) semesterGpaChartInstance.destroy();
                if (completedSubjects.length === 0) return;

                // 1. Nh√≥m d·ªØ li·ªáu theo h·ªçc k·ª≥
                const semesterData = {};
                completedSubjects.forEach((s) => {
                    const original = subjects.find((sub) => sub.id === s.id);
                    if (!original || original.notInGpa) return;
                    const sem = original.semester;
                    if (!semesterData[sem]) semesterData[sem] = { points: 0, credits: 0 };
                    semesterData[sem].points += s.weightedPoints;
                    semesterData[sem].credits += s.credits;
                });

                const sortedSemesters = Object.keys(semesterData).sort((a, b) => a - b);
                const labels = sortedSemesters.map((s) => `K·ª≥ ${s}`);

                // 2. T√≠nh GPA ri√™ng t·ª´ng h·ªçc k·ª≥ (C·ªôt xanh)
                const semesterGpaData = sortedSemesters.map((s) =>
                    semesterData[s].credits > 0 ? semesterData[s].points / semesterData[s].credits : 0
                );

                // 3. --- LOGIC M·ªöI: T√≠nh GPA T√≠ch l≈©y theo ti·∫øn ƒë·ªô (ƒê∆∞·ªùng ƒë·ªè) ---
                let runningPoints = 0;
                let runningCredits = 0;
                const cumulativeGpaLineData = sortedSemesters.map((s) => {
                    runningPoints += semesterData[s].points;
                    runningCredits += semesterData[s].credits;
                    return runningCredits > 0 ? runningPoints / runningCredits : 0;
                });

                // 4. V·∫Ω bi·ªÉu ƒë·ªì
                semesterGpaChartInstance = new Chart(ctx, {
                    type: "bar",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                type: "line",
                                label: "GPA T√≠ch l≈©y (Ti·∫øn ƒë·ªô)",
                                data: cumulativeGpaLineData, // D√πng d·ªØ li·ªáu t√≠ch l≈©y ƒë·ªông v·ª´a t√≠nh
                                borderColor: "#ef4444",
                                borderWidth: 2.5,
                                fill: false,
                                pointRadius: 3, // Th√™m ƒëi·ªÉm tr√≤n ƒë·ªÉ d·ªÖ nh√¨n m·ªëc t·ª´ng k·ª≥
                                pointBackgroundColor: "#fff",
                                pointBorderColor: "#ef4444",
                                tension: 0.1, // L√†m m∆∞·ª£t ƒë∆∞·ªùng m·ªôt ch√∫t
                                order: 1,
                            },
                            {
                                type: "bar",
                                label: "GPA H·ªçc k·ª≥",
                                data: semesterGpaData,
                                backgroundColor: "rgba(34, 197, 94, 0.6)",
                                order: 2,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 4.0,
                                title: { display: true, text: "ƒêi·ªÉm GPA h·ªá 4" },
                            },
                        },
                        plugins: {
                            legend: { position: "top" },
                            tooltip: {
                                mode: "index",
                                intersect: false,
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || "";
                                        if (label) {
                                            label += ": ";
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    },
                                },
                            },
                        },
                    },
                });
            }
            function updateCumulativeGpaChart(completedSubjects) {
                const chartCanvas = document.getElementById("cumulativeGpaChart");
                if (!chartCanvas) return;
                if (cumulativeGpaChartInstance) cumulativeGpaChartInstance.destroy();
                if (completedSubjects.length === 0) return;
                const subjectsByCompletedSemester = {};
                completedSubjects.forEach((subject) => {
                    const originalSubject = subjects.find((s) => s.id === subject.id);
                    if (originalSubject) {
                        const semester = originalSubject.semester;
                        if (!subjectsByCompletedSemester[semester]) subjectsByCompletedSemester[semester] = [];
                        subjectsByCompletedSemester[semester].push(subject);
                    }
                });
                let cumulativeWeightedPoints = 0,
                    cumulativeCredits = 0;
                const semesterLabels = [],
                    cumulativeGpaData = [];
                const maxSemesterWithGrade = Math.max(...Object.keys(subjectsByCompletedSemester).map(Number), 0);
                for (let sem = 1; sem <= maxSemesterWithGrade; sem++) {
                    semesterLabels.push(`K·ª≥ ${sem}`);
                    if (subjectsByCompletedSemester[sem]) {
                        subjectsByCompletedSemester[sem].forEach((subject) => {
                            cumulativeWeightedPoints += subject.weightedPoints;
                            cumulativeCredits += subject.credits;
                        });
                    }
                    cumulativeGpaData.push(cumulativeCredits > 0 ? cumulativeWeightedPoints / cumulativeCredits : 0);
                }
                if (cumulativeGpaData.length === 0) return;
                cumulativeGpaChartInstance = new Chart(chartCanvas, {
                    type: "line",
                    data: {
                        labels: semesterLabels,
                        datasets: [
                            {
                                label: "GPA T√≠ch l≈©y",
                                data: cumulativeGpaData,
                                fill: true,
                                borderColor: "rgb(59, 130, 246)",
                                backgroundColor: "rgba(59, 130, 246, 0.2)",
                                tension: 0.1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, max: 4.0 } },
                        plugins: { legend: { display: true, position: "top" } },
                    },
                });
            }

            // 8. LOGIC CHO C√ÅC MODAL V√Ä B·ªò L·ªåC
            // ===================================
            const editModalOverlay = document.getElementById("editSubjectModalOverlay");
            const closeEditModalButton = document.getElementById("closeEditModalButton");
            const cancelEditButton = document.getElementById("cancelEditButton");
            const editSubjectForm = document.getElementById("editSubjectForm");
            const editModalSubjectName = document.getElementById("editModalSubjectName");
            const editSubjectId = document.getElementById("editSubjectId");
            const editFinalExamType = document.getElementById("editFinalExamType");
            const editPracticeExamType = document.getElementById("editPracticeExamType");
            function openEditModal(subjectId) {
                const subject = subjects.find((s) => s.id === subjectId);
                if (!subject) return;
                editSubjectId.value = subject.id;
                editModalSubjectName.textContent = subject.name;
                editFinalExamType.value = subject.finalExamType || "";
                editPracticeExamType.value = subject.practiceExamType || "";
                editPracticeExamType.disabled = !subject.hasPractice;
                editModalOverlay.classList.add("visible");
            }
            function closeEditModal() {
                editModalOverlay.classList.remove("visible");
            }
            semestersContainer.addEventListener("click", function (event) {
                if (event.target && event.target.classList.contains("editable-subject-name"))
                    openEditModal(event.target.dataset.subjectId);
            });
            closeEditModalButton.addEventListener("click", closeEditModal);
            cancelEditButton.addEventListener("click", closeEditModal);
            editModalOverlay.addEventListener("click", (event) => {
                if (event.target === editModalOverlay) closeEditModal();
            });
            editSubjectForm.addEventListener("submit", function (event) {
                event.preventDefault();
                const idToUpdate = editSubjectId.value;
                const subjectIndex = subjects.findIndex((s) => s.id === idToUpdate);
                if (subjectIndex > -1) {
                    subjects[subjectIndex].finalExamType = editFinalExamType.value;
                    subjects[subjectIndex].practiceExamType = editPracticeExamType.value;
                    const subjectDiv = document.querySelector(`.subject-item[data-id="${idToUpdate}"]`);
                    if (subjectDiv) {
                        subjectDiv.querySelector(".subject-tags-container").innerHTML = createTagsHTML(
                            subjects[subjectIndex]
                        );
                        subjectDiv.dataset.finalExamType = subjects[subjectIndex].finalExamType || "";
                    }
                    showToast(`ƒê√£ c·∫≠p nh·∫≠t: ${subjects[subjectIndex].name}`);
                    if (!rawDataOutput.classList.contains("hidden")) {
                        rawDataOutput.textContent = JSON.stringify(subjects, null, 2);
                    }
                }
                closeEditModal();
            });
            function applyQuickFilters() {
                const allSubjectItems = document.querySelectorAll("#semestersContainer .subject-item");
                allSubjectItems.forEach((item) => {
                    const examTypeFilterValue = activeQuickFilters.finalExamType;
                    const subjectExamType = item.dataset.finalExamType;
                    let matchExamType =
                        examTypeFilterValue === "all" ||
                        (subjectExamType && subjectExamType.includes(examTypeFilterValue));
                    const matchPractice =
                        activeQuickFilters.hasPractice === "all" ||
                        item.dataset.hasPractice === activeQuickFilters.hasPractice;
                    item.style.display = matchExamType && matchPractice ? "grid" : "none";
                });
                document.querySelectorAll(".semester-block").forEach((semesterBlock) => {
                    const visibleSubjects = semesterBlock.querySelectorAll(".subject-item[style*='display: grid']");
                    semesterBlock.style.display = visibleSubjects.length > 0 ? "block" : "none";
                });
            }
            const quickFiltersContainer = document.getElementById("quickFiltersContainer");
            if (quickFiltersContainer) {
                quickFiltersContainer.addEventListener("click", (event) => {
                    const target = event.target;
                    if (target.classList.contains("quick-filter-button")) {
                        const group = target.dataset.filterGroup;
                        const value = target.dataset.filterValue;
                        activeQuickFilters[group] = value;
                        quickFiltersContainer
                            .querySelectorAll(`.quick-filter-button[data-filter-group="${group}"]`)
                            .forEach((btn) => btn.classList.remove("active"));
                        target.classList.add("active");
                        applyQuickFilters();
                    }
                });
            }
            const showRawDataButton = document.getElementById("showRawDataButton");
            const rawDataOutput = document.getElementById("rawDataOutput");
            showRawDataButton.addEventListener("click", () => {
                rawDataOutput.classList.toggle("hidden");
                if (!rawDataOutput.classList.contains("hidden")) {
                    rawDataOutput.textContent = JSON.stringify(subjects, null, 2);
                }
            });

            // 9. G·∫ÆN C√ÅC S·ª∞ KI·ªÜN CH√çNH
            // =============================
            calculateButton.addEventListener("click", () => {
                calculateAndDisplayResults();
                showToast("ƒê√£ l∆∞u v√† c·∫≠p nh·∫≠t ƒëi·ªÉm!");
            });
            targetRankSelect.addEventListener("change", calculateAndDisplayResults);
            toggleDetailedStatsButton.addEventListener("click", () => {
                calculateAndDisplayResults();
                detailedStatsModalOverlay.classList.add("visible");
                const firstSection = document.querySelector("#detailedStatsModalOverlay .collapsible-section");
                if (firstSection && !firstSection.classList.contains("expanded"))
                    firstSection.classList.add("expanded");
            });
            const closeButtons = [
                document.getElementById("closeDetailedStatsButton"),
                document.getElementById("closeDetailedStatsButtonInternal"),
            ];
            closeButtons.forEach((btn) =>
                btn?.addEventListener("click", () => {
                    detailedStatsModalOverlay.classList.remove("visible");
                    if (cumulativeGpaChartInstance) cumulativeGpaChartInstance.destroy();
                    if (gradeCreditChartInstance) gradeCreditChartInstance.destroy();
                    if (semesterGpaChartInstance) semesterGpaChartInstance.destroy();
                    cumulativeGpaChartInstance = gradeCreditChartInstance = semesterGpaChartInstance = null;
                })
            );
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape" && detailedStatsModalOverlay.classList.contains("visible"))
                    closeButtons[0].click();
            });
            document.querySelectorAll(".collapsible-header").forEach((header) => {
                header.addEventListener("click", () => {
                    header.parentElement.classList.toggle("expanded");
                });
            });
            clearGradeFilterButton.addEventListener("click", () => handleGradeFilterClick(null));
            document.querySelectorAll(".subject-details-table th[data-sortable]").forEach((th) => {
                th.addEventListener("click", () => handleSortClick(th.dataset.sortKey));
            });
            window.onscroll = function () {
                scrollToTopBtn.style.display =
                    document.body.scrollTop > 100 || document.documentElement.scrollTop > 100 ? "flex" : "none";
            };
            scrollToTopBtn.addEventListener("click", () => {
                document.body.scrollTop = 0;
                document.documentElement.scrollTop = 0;
            });
            // --- H√ÄM X·ª¨ L√ù CHUY·ªÇN TAB DASHBOARD ---
            function switchDashboardTab(tabName) {
                // 1. X√≥a active ·ªü t·∫•t c·∫£ c√°c n√∫t
                document.querySelectorAll(".dashboard-tab-btn").forEach((btn) => {
                    btn.classList.remove("active");
                });
                // 2. ·∫®n t·∫•t c·∫£ n·ªôi dung tab
                document.querySelectorAll(".dashboard-tab-content").forEach((content) => {
                    content.classList.remove("active");
                });

                // 3. K√≠ch ho·∫°t n√∫t ƒë∆∞·ª£c b·∫•m (t√¨m theo text ho·∫∑c logic, ·ªü ƒë√¢y ta d√πng onclick tr·ª±c ti·∫øp g√°n class n√™n ta ch·ªâ c·∫ßn add active cho n√∫t g·ªçi h√†m n√†y)
                // Tuy nhi√™n, v√¨ d√πng onclick inline, ta c·∫ßn t√¨m n√∫t t∆∞∆°ng ·ª©ng. C√°ch d·ªÖ nh·∫•t l√†:
                const clickedBtn = event.currentTarget; // L·∫•y n√∫t v·ª´a b·∫•m
                clickedBtn.classList.add("active");

                // 4. Hi·ªán n·ªôi dung tab t∆∞∆°ng ·ª©ng
                document.getElementById(`tab-${tabName}`).classList.add("active");
            }
            // --- T√çNH NƒÇNG: BI·ªÇU ƒê·ªí PH√ÇN T√ÅN (SCATTER PLOT) - ƒê√É FIX MAX TR·ª§C X ---
            let scatterChartInstance = null;
            function renderScatterChart(completedSubjects) {
                const ctx = document.getElementById("scatterChart")?.getContext("2d");
                if (!ctx) return;
                if (scatterChartInstance) scatterChartInstance.destroy();

                // T√≠nh to√°n max t√≠n ch·ªâ th·ª±c t·∫ø t·ª´ d·ªØ li·ªáu ƒë·ªÉ set tr·ª•c X
                // M·∫∑c ƒë·ªãnh l√† 5 n·∫øu ch∆∞a c√≥ d·ªØ li·ªáu, ho·∫∑c max + 1 ƒë·ªÉ ƒë·ªì th·ªã tho√°ng h∆°n
                const maxCreditsInList =
                    completedSubjects.length > 0 ? Math.max(...completedSubjects.map((s) => s.credits)) : 4;
                const xAxisMax = maxCreditsInList + 1;

                // T·∫°o d·ªØ li·ªáu cho Scatter Plot (Th√™m ch√∫t nhi·ªÖu Jitter)
                const scatterData = completedSubjects.map((s) => ({
                    x: s.credits + (Math.random() - 0.5) * 0.15,
                    y: s.point + (Math.random() - 0.5) * 0.15,
                    subjectName: s.name,
                    realCredits: s.credits,
                    realPoint: s.point,
                }));

                scatterChartInstance = new Chart(ctx, {
                    type: "scatter",
                    data: {
                        datasets: [
                            {
                                label: "M√¥n h·ªçc",
                                data: scatterData,
                                backgroundColor: function (context) {
                                    const val = context.raw;
                                    if (!val) return "#94a3b8";
                                    if (val.realCredits >= 3 && val.realPoint < 2.5) return "#ef4444";
                                    if (val.realCredits >= 3 && val.realPoint >= 3.2) return "#16a34a";
                                    return "rgba(59, 130, 246, 0.6)";
                                },
                                pointRadius: function (context) {
                                    const val = context.raw;
                                    return val ? 4 + val.realCredits * 1.5 : 5;
                                },
                                pointHoverRadius: 8,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                type: "linear",
                                position: "bottom",
                                title: { display: true, text: "S·ªë T√≠n ch·ªâ" },
                                min: 0,
                                max: xAxisMax, // <--- ƒê√£ s·ª≠a th√†nh bi·∫øn ƒë·ªông
                                ticks: { stepSize: 1 },
                            },
                            y: {
                                title: { display: true, text: "ƒêi·ªÉm s·ªë (h·ªá 4)" },
                                min: 0,
                                max: 4.2,
                            },
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        const d = context.raw;
                                        return `${d.subjectName}: ${d.realCredits}TC - ${d.realPoint.toFixed(1)}ƒë`;
                                    },
                                },
                            },
                            legend: { display: false },
                        },
                    },
                });
            }
            // --- T√çNH NƒÇNG: RANK UP CALCULATOR (D·ª∞ B√ÅO) - ƒê√É FIX TEXT ---
            function renderRankUpCalculator(currentCredits, currentWeightedPoints) {
                const container = document.getElementById("rankUpContent");
                if (!container) return;

                const remainingCredits = totalProgramCredits - currentCredits;
                const targetRank = targetRankSelect.value;
                const targetGPA = RANK_THRESHOLDS[targetRank];

                // 1. N·∫øu ch∆∞a ch·ªçn m·ª•c ti√™u ho·∫∑c ƒë√£ h·ªçc xong
                if (!targetRank) {
                    container.innerHTML = `<p class="text-center text-gray-500 py-4">üîª H√£y ch·ªçn m·ª©c x·∫øp lo·∫°i m·ª•c ti√™u tr√™n thanh c√¥ng c·ª• ƒë·ªÉ xem l·ªô tr√¨nh.</p>`;
                    return;
                }
                if (remainingCredits <= 0) {
                    container.innerHTML = `<p class="font-semibold text-green-700">üéâ B·∫°n ƒë√£ ho√†n th√†nh ch∆∞∆°ng tr√¨nh h·ªçc!</p>`;
                    return;
                }

                // 2. T√≠nh to√°n k·ªãch b·∫£n
                const pointsNeededTotal = targetGPA * totalProgramCredits;
                const pointsNeededRemaining = pointsNeededTotal - currentWeightedPoints;
                const avgNeeded = pointsNeededRemaining / remainingCredits;

                // K·ªãch b·∫£n T·ªëi ƒëa (N·∫øu to√†n b·ªô ph·∫ßn c√≤n l·∫°i ƒë·∫°t 4.0)
                const maxPossiblePoints = currentWeightedPoints + remainingCredits * 4.0;
                const maxPossibleGPA = maxPossiblePoints / totalProgramCredits;

                // T√≠nh "Qu·ªπ ƒëi·ªÉm sai s·ªë" (Buffer)
                const surplusPointsIfAllA = maxPossiblePoints - pointsNeededTotal;
                const creditsAllowanceForB = Math.floor(surplusPointsIfAllA / 1.0);

                // ∆Ø·ªõc l∆∞·ª£ng s·ªë m√¥n (Gi·∫£ s·ª≠ m√¥n 2TC v√† 3TC)
                const estSubjectsMin = Math.floor(creditsAllowanceForB / 3);
                const estSubjectsMax = Math.floor(creditsAllowanceForB / 2);

                let html = `<div class="grid grid-cols-1 md:grid-cols-2 gap-6">`;

                // C·ªôt 1: Hi·ªán tr·∫°ng & Y√™u c·∫ßu
                html += `
        <div>
            <div class="mb-3">
                <p class="text-xs uppercase font-bold text-indigo-400">Y√™u c·∫ßu t·ªëi thi·ªÉu</p>
                <p class="text-2xl font-bold ${avgNeeded > 4.0 ? "text-red-600" : "text-indigo-700"}">
                    ${avgNeeded > 4.0 ? "> 4.0 (B·∫•t kh·∫£ thi)" : avgNeeded.toFixed(2)} 
                    <span class="text-sm font-normal text-gray-600">/ 4.0</span>
                </p>
                <p class="text-xs text-gray-500">ƒêi·ªÉm trung b√¨nh c·∫ßn ƒë·∫°t cho ${remainingCredits} TC c√≤n l·∫°i.</p>
            </div>
            <div class="mb-3">
                <p class="text-xs uppercase font-bold text-indigo-400">Ti·ªÅm nƒÉng t·ªëi ƒëa</p>
                <p class="text-lg font-semibold text-gray-700">GPA ${maxPossibleGPA.toFixed(2)}</p>
                <p class="text-xs text-gray-500">N·∫øu b·∫°n ƒë·∫°t to√†n ƒëi·ªÉm A (4.0) t·ª´ gi·ªù ƒë·∫øn cu·ªëi kh√≥a.</p>
            </div>
        </div>
    `;

                // C·ªôt 2: Chi·∫øn l∆∞·ª£c (Strategy)
                html += `<div><p class="text-xs uppercase font-bold text-indigo-400 mb-2">Chi·∫øn l∆∞·ª£c C·ª• th·ªÉ</p>`;

                if (avgNeeded > 4.0) {
                    html += `<div class="p-3 bg-red-100 text-red-700 rounded-md text-sm border border-red-200">
                    ‚ö†Ô∏è <strong>C·∫£nh b√°o:</strong> Ngay c·∫£ khi b·∫°n ƒë·∫°t to√†n b·ªô ƒëi·ªÉm A+ c√°c m√¥n c√≤n l·∫°i, GPA t·ªëi ƒëa ch·ªâ ƒë·∫°t <strong>${maxPossibleGPA.toFixed(2)}</strong>. Kh√¥ng th·ªÉ ƒë·∫°t m·ª•c ti√™u ${targetRank} (${targetGPA}).
                 </div>`;
                } else if (avgNeeded <= 2.0) {
                    html += `<div class="p-3 bg-green-100 text-green-700 rounded-md text-sm border border-green-200">
                    üòé <strong>Th∆∞ th·∫£:</strong> B·∫°n ƒë√£ c√≥ n·ªÅn t·∫£ng r·∫•t t·ªët. Ch·ªâ c·∫ßn duy tr√¨ s·ª©c h·ªçc trung b√¨nh l√† ƒë·∫°t m·ª•c ti√™u.
                 </div>`;
                } else {
                    html += `<ul class="space-y-2 text-sm">
                    <li class="flex items-start gap-2">
                        <span class="text-green-600 font-bold">‚úì</span>
                        <span>M·ª•c ti√™u: ƒê·∫°t GPA <strong>${targetRank} (${targetGPA})</strong>.</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-blue-600 font-bold">‚Ñπ</span>
                        <span>Gi·∫£ s·ª≠ c√°c m√¥n c√≤n l·∫°i b·∫°n c·ªë g·∫Øng ƒë·∫°t ƒëi·ªÉm A (4.0), b·∫°n c√≥ <strong>"qu·ªπ sai s·ªë"</strong> l√†:</span>
                    </li>
                    <li class="bg-white p-2 rounded border border-indigo-100 text-center font-semibold text-indigo-600">
                         ${creditsAllowanceForB > 0 ? creditsAllowanceForB : 0} T√≠n ch·ªâ
                    </li>
                    
                 </ul>`;
                }
                html += `</div></div>`;

                container.innerHTML = html;
            }
            // 10. KH·ªûI CH·∫†Y ·ª®NG D·ª§NG
            // ========================
            populateSubjectsAndSemesters();
            loadStateFromLocalStorage();
            calculateAndDisplayResults();
        </script>
    </body>
</html>
