<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ứng dụng Tính điểm Sinh viên</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- THÊM DÒNG NÀY -->

<style>
    /* ================================================== */
/*          TOÀN BỘ CSS ĐÃ ĐƯỢC TỐI ƯU HÓA           */
/* ================================================== */

body {
    font-family: 'Inter', sans-serif;
    background-color: #f8fafc;
}
.container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0;
    background-color: white;
    min-height: 100vh;
}
select, button {
    padding: 0.625rem 0.875rem;
    border-radius: 0.5rem;
    border: 1px solid #cbd5e1;
    transition: all 0.15s ease-in-out;
    font-size: 0.9rem;
}
select:focus, button:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
}

/* === Khu vực Header Cố định (Sticky) === */
.results-sticky-container {
    position: sticky;
    top: 0;
    z-index: 50;
    background-color: white;
    padding: 1rem;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid #e5e7eb;
}
@media (min-width: 768px) {
    .results-sticky-container { padding: 1.5rem 2rem; }
}

/* Bố cục Header Mới */
.primary-stats-row {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
    margin-bottom: 1rem;
}
/* Sửa lại rule này */
.stat-value {
    font-size: 1rem; /* Có thể giảm xuống từ 1.125rem nếu muốn */
    font-weight: 600;
    color: #334155;
}
.target-item-value {
    font-size: 1.25rem; /* Có thể giảm xuống từ 1.5rem nếu muốn */
    font-weight: 700;
    color: #15803d;
}
.stat-card {
    padding: 1rem;
    text-align: center;
    border-radius: 0.75rem;
    background-color: #f8fafc;
    border: 1px solid #e2e8f0;
    display: flex; /* THÊM DÒNG NÀY */
    flex-direction: column; /* THÊM DÒNG NÀY */
    justify-content: center; /* THÊM DÒNG NÀY */
}
.stat-card-label {
    font-size: 0.875rem;
    color: #64748b;
    margin-bottom: 0.25rem;
}
.stat-card-value {
    font-weight: 700;
    line-height: 1;
}
.gpa-highlight { font-size: 2.75rem; }
/* Sửa lại rule này */
.rank-highlight {
    font-size: 1.75rem; 
    /* padding-top: 1rem; */ /* XÓA HOẶC CHÚ THÍCH DÒNG NÀY */
    /* Các màu sắc giữ nguyên */
}
.rank-highlight.text-purple { color: #7e22ce; } .rank-highlight.text-blue { color: #1d4ed8; } .rank-highlight.text-green { color: #15803d; } .rank-highlight.text-yellow { color: #a16207; } .rank-highlight.text-orange { color: #c2410c; } .rank-highlight.text-red { color: #b91c1c; } .rank-highlight.text-slate { color: #475569; }

.secondary-stats-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-around;
    align-items: center;
    background-color: #f8fafc;
    border-radius: 0.5rem;
    padding: 0.5rem 1rem;
    gap: 1rem;
    border: 1px solid #e2e8f0;
}
.info-item { display: flex; align-items: center; gap: 0.5rem; }
.info-label { font-size: 0.8rem; color: #475569; }
.info-value { font-size: 0.9rem; font-weight: 600; color: #1e293b; }
.target-select-inline { padding: 0.25rem 0.5rem; font-size: 0.9rem; border-radius: 0.375rem; background-color: white; }
.target-info { display: none; }
.target-info.visible { display: flex; }
.target-insight-text {
    margin-top: 0.75rem; padding: 0.75rem; background-color: #f1f5f9;
    border-radius: 0.5rem; font-size: 0.875rem; color: #475569;
    text-align: center; min-height: 40px; display: none;
}
.target-insight-text.visible { display: block; }

/* === Khu vực Danh sách môn học === */
.subjects-list-main-container { padding: 1rem; }
.semester-block { margin-bottom: 0.75rem; }
.semester-header {
    background-color: #f1f5f9;
    padding: 0.75rem 1.25rem;
    border-radius: 0.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e2e8f0;
}
.semester-header:hover { background-color: #e2e8f0; }
.semester-header-content { display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem; }
.semester-header h3 { color: #334155; font-size: 1.125rem; font-weight: 600; margin: 0; }
.semester-grade-count, .semester-gpa-display {
    font-size: 0.75rem; font-weight: 500; color: #475569;
    background-color: #e2e8f0; padding: 0.125rem 0.5rem; border-radius: 0.25rem;
}
.semester-gpa-display { color: #1e3a8a; background-color: #dbeafe; }
.semester-arrow { transition: transform 0.3s ease; color: #475569; }
.semester-arrow.expanded svg { transform: rotate(90deg); }
.subjects-list {
    padding-left: 0.5rem; overflow: hidden; max-height: 0;
    transition: max-height 0.5s ease-out;
    border-left: 2px solid #e2e8f0;
    margin-left: 0.5rem; margin-top: 0.5rem;
}
.subjects-list.expanded { max-height: 1500px; padding-top: 0.5rem; padding-bottom: 0.5rem; }
.subject-item {
    display: grid; grid-template-columns: 1fr 60px 100px; gap: 0.75rem;
    align-items: center; padding: 0.875rem 0.75rem; border-bottom: 1px solid #f1f5f9;
    transition: background-color 0.3s ease;
}
.subject-item:hover { background-color: #f8fafc; }
.subject-item.selected-briefly { background-color: #e0f2fe; }
.subject-item:last-child { border-bottom: none; }
.header-item-subjects {
    font-weight: 600; color: #4b5563; padding: 0.75rem;
    background-color: #f8fafc; border-bottom: 1px solid #e5e7eb; border-radius: 0.5rem 0.5rem 0 0;
}
.subject-name { word-break: break-word; font-size: 0.95rem; color: #334155; }
.subject-name-wrapper { display: flex; flex-direction: column; }
.subject-tags-container { display: flex; flex-wrap: wrap; gap: 0.375rem; margin-top: 0.25rem; }
.subject-tag {
    font-size: 0.7rem; font-weight: 500; padding: 0.125rem 0.5rem;
    border-radius: 9999px; border: 1px solid; line-height: 1.2;
}
.tag-tn { background-color: #e0f2fe; color: #075985; border-color: #bae6fd; }
.tag-tl { background-color: #eef2ff; color: #3730a3; border-color: #c7d2fe; }
.tag-th-true { background-color: #f0fdf4; color: #15803d; border-color: #bbf7d0; }
.editable-subject-name { cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: #94a3b8; transition: color 0.2s ease; }
.editable-subject-name:hover { color: #2563eb; text-decoration-color: #2563eb; }

/* === Bộ lọc nhanh === */
.filter-group .filter-label { font-size: 0.875rem; font-weight: 500; color: #475569; }
.quick-filter-button {
    padding: 0.25rem 0.75rem; font-size: 0.8rem; border-radius: 0.375rem;
    border: 1px solid #cbd5e1; background-color: white; color: #475569;
    cursor: pointer; transition: all 0.2s;
}
.quick-filter-button:not(.active):hover { background-color: #f1f5f9; }
.quick-filter-button.active { background-color: #2563eb; color: white; border-color: #2563eb; font-weight: 600; }

/* === Các nút hành động chính === */
.button-container { padding: 1rem 1rem 1.5rem 1rem; background-color: white; border-top: 1px solid #e5e7eb; display: flex; flex-direction: column; gap: 0.75rem; }
.main-action-button { background-color: #2563eb; color: white; font-weight: 600; width: 100%; padding: 0.875rem 1rem; font-size: 1rem; border-radius: 0.5rem; }
.main-action-button:hover { background-color: #1d4ed8; }
.secondary-action-button { background-color: #f1f5f9; color: #334155; font-weight: 500; width: 100%; padding: 0.75rem 1rem; font-size: 0.9rem; border-radius: 0.5rem; border: 1px solid #e2e8f0; }
.secondary-action-button:hover { background-color: #e2e8f0; }

/* === Các thành phần phụ trợ (Toast, ScrollToTop) === */
.toast-notification {
    display: none; position: fixed; bottom: 20px; left: 50%;
    transform: translateX(-50%); background-color: #1f2937; color: white;
    padding: 0.875rem 1.5rem; border-radius: 0.5rem;
    box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    z-index: 1002; font-size: 0.9rem; opacity: 0;
    transition: opacity 0.3s ease-in-out, bottom 0.3s ease-in-out;
}
.toast-notification.show { display: block; opacity: 1; bottom: 30px; }
#scrollToTopBtn {
    position: fixed; bottom: 25px; right: 25px; z-index: 99;
    border: none; outline: none; background-color: #2563eb; color: white;
    cursor: pointer; padding: 0.75rem; width: 44px; height: 44px;
    border-radius: 50%; font-size: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    display: none; align-items: center; justify-content: center;
}
#scrollToTopBtn:hover { background-color: #1d4ed8;  }

/* === Modal Chung === */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.6); z-index: 1001;
    justify-content: center; align-items: center; padding: 1rem;
}
.modal-overlay.visible { display: flex; }
.modal-content-wrapper {
    background-color: white; border-radius: 0.75rem;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    width: 100%; max-height: 90vh;
    overflow: hidden; display: flex; flex-direction: column;
}
#editSubjectModalOverlay { z-index: 1002; }

/* === Modal Thống kê chi tiết === */
.modal-content-wrapper .detailed-stats-section {
    flex-grow: 1; overflow-y: auto; padding: 1.5rem;
}
.stats-summary-grid {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem; margin-bottom: 1.5rem;
}
.collapsible-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 0.75rem 1rem; background-color: #f9fafb; cursor: pointer;
    border-bottom: 1px solid #f3f4f6;
}
.collapsible-section.expanded .collapsible-header { border-bottom-color: #e5e7eb; }
.collapsible-header:hover { background-color: #f3f4f6; }
.collapsible-arrow {
    transition: transform 0.3s ease; font-size: 1rem; font-weight: bold;
    color: #9ca3af; transform: rotate(0deg);
}
.collapsible-section.expanded .collapsible-arrow::before { content: '▼'; }
.collapsible-section:not(.expanded) .collapsible-arrow::before { content: '▶'; }

.collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
.collapsible-section.expanded .collapsible-content { max-height: 3000px; }

.insight-card {
    background-color: #f8fafc; border-radius: 0.5rem; padding: 1rem;
    border: 1px solid #e2e8f0;
}
.insight-card .insight-title { font-size: 0.875rem; font-weight: 500; color: #475569; margin-bottom: 0.5rem; }
.insight-card .insight-body { font-weight: 600; color: #1e293b; }
.insight-card.positive { background-color: #f0fdf4; border-color: #bbf7d0; }
.insight-card.positive .insight-title { color: #166534; }
.insight-card.positive .insight-body { color: #15803d; }
.insight-card.negative { background-color: #fef2f2; border-color: #fecaca; }
.insight-card.negative .insight-title { color: #991b1b; }
.insight-card.negative .insight-body { color: #b91c1c; }

.grade-distribution-list { list-style: none; padding: 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.5rem; }
.grade-distribution-list li {
    display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center;
    padding: 0.75rem 0.5rem; line-height: 1.3; cursor: pointer; transition: background-color 0.2s ease;
    background-color: #eff6ff; color: #1e40af; border-color: #dbeafe; border: 1px solid; border-radius: 0.375rem;
}
.grade-distribution-list li:hover { background-color: #dbeafe; border-color: #bfdbfe; }
.grade-distribution-list li.active-filter { background-color: #60a5fa !important; color: #1d4ed8 !important; border-color: #3b82f6 !important; }
.grade-label { font-weight: 600; font-size: 1.1em; margin-bottom: 0.25rem; }
.grade-info { font-size: 0.8em; color: #4b5563; }
.grade-percentage { font-size: 0.9em; font-weight: 500; margin-top: 0.25rem; }

.subject-details-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
.subject-details-table th, .subject-details-table td { border: 1px solid #e5e7eb; padding: 0.5rem 0.75rem; text-align: left; }
.subject-details-table th { background-color: #f3f4f6; font-weight: 600; color: #374151; }
.subject-details-table th[data-sortable] { cursor: pointer; }
.subject-details-table th[data-sortable]:hover { background-color: #e9ecef; }
.sort-arrow { font-size: 0.8em; margin-left: 5px; display: inline-block; width: 1em; text-align: center; }
.sort-arrow::before { content: '\00a0'; }
.subject-details-table th.sorted-asc .sort-arrow::before { content: '▲'; }
.subject-details-table th.sorted-desc .sort-arrow::before { content: '▼'; }
.deviation-positive { color: #16a34a; font-weight: 500; }
.deviation-negative { color: #dc2626; font-weight: 500; }
/* Bổ sung CSS cho 4 thẻ thống kê tổng quan trong modal */
.stats-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}
.stats-summary-grid div {
    background-color: #f8fafc; /* Màu nền giống các thẻ khác */
    padding: 1rem;
    border-radius: 0.5rem;
    text-align: center;
    border: 1px solid #e2e8f0;
}
.stats-summary-grid div p:first-child {
    font-size: 0.875rem;
    color: #4b5563; /* text-slate-600 */
    margin-bottom: 0.25rem;
}
.stats-summary-grid div p:last-child {
    font-size: 1.25rem;
    font-weight: 600;
    color: #1e3a8a; /* text-blue-800 */
}
.result-value {
    font-weight: 700; /* Sử dụng font-weight cụ thể, ví dụ 700 cho bold */
    line-height: 1.1;
    font-size: 1.25rem; /* Kích thước chữ chung cho các giá trị phụ */
    color: #1e293b; /* Màu chữ mặc định */
}
/* === Công cụ cho nhà phát triển === */
#rawDataOutput { max-height: 400px; }
</style>
  </head>
  <body>
    <div class="container">
      <div class="results-sticky-container">
       <!-- THAY THẾ TOÀN BỘ NỘI DUNG BÊN TRONG .results-sticky-container -->
<h1 class="text-xl md:text-2xl font-bold text-center mb-4 text-slate-700">Chương trình Tính điểm Sinh viên</h1>

<!-- Hàng 1: Kết quả chính -->
<div class="primary-stats-row">
    <div class="stat-card gpa-card">
        <p class="stat-card-label">GPA Tích lũy</p>
        <p id="gpa" class="stat-card-value gpa-highlight"></p>
    </div>
    <div class="stat-card rank-card">
        <p class="stat-card-label">Xếp loại</p>
        <p id="rank" class="stat-card-value rank-highlight"></p>
    </div>
</div>

<!-- Hàng 2: Phân tích & Mục tiêu -->
<div class="secondary-stats-bar">
    <div class="info-item">
        <span class="info-label">TC Tích lũy:</span>
        <span id="totalCredits" class="info-value"></span>
    </div>
    <div class="info-item">
        <span class="info-label">Hoàn thành:</span>
        <span id="completionPercentage" class="info-value"></span>
    </div>
    <div class="info-item">
        <span class="info-label">Mục tiêu:</span>
        <select id="targetRankSelect" class="target-select-inline">
            <option value="">-- Chọn --</option>
            <option value="Xuất sắc">Xuất sắc (≥ 3.6)</option>
            <option value="Giỏi">Giỏi (≥ 3.2)</option>
            <option value="Khá">Khá (≥ 2.5)</option>
        </select>
    </div>
    <div id="target-gpa-item" class="info-item target-info">
        <span class="info-label">GPA Cần đạt:</span>
        <span id="minAvgForRemaining" class="info-value font-bold text-green-600"></span>
    </div>
</div>

<!-- Hàng 3: Insight -->
<div id="targetInsight" class="target-insight-text">
    <!-- Phân tích chi tiết sẽ được sinh ra bởi JS -->
</div>
      </div>

      <div class="subjects-list-main-container">
        <!-- Sửa lại toàn bộ div#quickFiltersContainer -->
<div id="quickFiltersContainer" class="p-3 mb-3 bg-slate-50 rounded-lg border border-slate-200">
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div class="filter-group">
            <span class="filter-label">Hình thức thi:</span>
            <div class="flex flex-wrap gap-2 mt-1">
                <button class="quick-filter-button active" data-filter-group="finalExamType" data-filter-value="all">Tất cả</button>
                <button class="quick-filter-button" data-filter-group="finalExamType" data-filter-value="Trắc nghiệm">Trắc nghiệm</button>
                <button class="quick-filter-button" data-filter-group="finalExamType" data-filter-value="Tự luận (không tài liệu)">Tự luận</button>
            </div>
        </div>
        <div class="filter-group">
            <span class="filter-label">Thực hành:</span>
             <div class="flex flex-wrap gap-2 mt-1">
                <button class="quick-filter-button active" data-filter-group="hasPractice" data-filter-value="all">Tất cả</button>
                <button class="quick-filter-button" data-filter-group="hasPractice" data-filter-value="true">Có TH</button>
                <button class="quick-filter-button" data-filter-group="hasPractice" data-filter-value="false">Không TH</button>
            </div>
        </div>
    </div>
</div>
        <div class="subject-item header-item-subjects mb-2">
          <span class="subject-name">Tên Môn học/Học phần</span>
          <span class="text-center">Số TC</span>
          <span class="text-center">Điểm chữ</span>
        </div>
        <div id="semestersContainer">
          <!-- Semester blocks will be injected here -->
        </div>
      </div>

      <div class="button-container mt-4">
        <button id="calculateButton" class="main-action-button">
          Lưu & Cập nhật
        </button>
        <button
          id="toggleDetailedStatsButton"
          class="secondary-action-button mt-2"
        >
          Xem Thống Kê Chi Tiết
        </button>
        
  </div>
      </div>
    </div>
    <div class="p-4 m-4 border rounded-lg bg-slate-50">
        <h3 class="font-semibold text-slate-700 mb-2">Công cụ dành cho Nhà phát triển</h3>
        <p class="text-sm text-slate-500 mb-3">Sử dụng nút này để xem toàn bộ dữ liệu môn học ở định dạng JSON. Bạn có thể sao chép, chỉnh sửa và dán lại vào mã nguồn.</p>
        <button id="showRawDataButton" class="secondary-action-button w-auto">Hiển thị/Ẩn Dữ liệu Thô</button>
        <pre id="rawDataOutput" class="hidden mt-4 p-4 bg-slate-800 text-white rounded-md text-xs overflow-x-auto"></pre>
    </div>
    <!-- MODAL CHO THỐNG KÊ CHI TIẾT -->
    <div id="detailedStatsModalOverlay" class="modal-overlay">
      <div class="modal-content-wrapper">
        <!-- Nội dung của detailedStatsContainer sẽ được đặt ở đây -->
        <div id="detailedStatsContainer" class="detailed-stats-section">
<!-- THAY THẾ TOÀN BỘ NỘI DUNG BÊN TRONG #detailedStatsContainer -->
<!-- THAY THẾ TOÀN BỘ NỘI DUNG BÊN TRONG #detailedStatsContainer -->

<div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold text-gray-800">Dashboard Phân tích</h2>
    <button id="closeDetailedStatsButton" class="text-gray-400 hover:text-gray-600">×</button>
</div>

<!-- Lưới Thống kê Tổng quan -->
<div class="stats-summary-grid mb-6">
    <div><p>Tổng TC Chương trình</p><p id="statsTotalProgramCredits"></p></div>
    <div><p>Tổng TC Hoàn thành</p><p id="statsTotalCompletedCredits"></p></div>
    <div><p>Tỷ lệ Hoàn thành</p><p id="statsCompletionRate"></p></div>
    <div><p>GPA Tích lũy</p><p id="statsOverallGPA"></p></div>
</div>

<!-- MỖI KHU VỰC SẼ ĐƯỢC BỌC TRONG 1 COLLAPSIBLE-SECTION -->
<!-- Khu vực 1: Insights -->
<div class="collapsible-section mb-4 border rounded-lg">
    <div class="collapsible-header">
        <h3 class="text-lg font-semibold text-gray-700">Các Điểm nhấn</h3>
        <span class="collapsible-arrow">></span>
    </div>
    <div class="collapsible-content">
        <div id="insightsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
            <!-- Nội dung insight -->
        </div>
    </div>
</div>

<!-- Khu vực 2: Phân phối điểm (Bộ lọc) -->
<div class="collapsible-section mb-4 border rounded-lg">
    <div class="collapsible-header">
        <h3 class="text-lg font-semibold text-gray-700">Phân phối & Lọc theo Điểm</h3>
        <span class="collapsible-arrow">></span>
    </div>
    <div class="collapsible-content">
        <div class="p-4">
            <ul id="statsGradeDistribution" class="grade-distribution-list">
                <!-- Bộ lọc điểm sẽ được sinh ra ở đây -->
            </ul>
        </div>
    </div>
</div>

<!-- Khu vực 3: Biểu đồ -->
<div class="collapsible-section mb-4 border rounded-lg">
    <div class="collapsible-header">
        <h3 class="text-lg font-semibold text-gray-700">Trực quan hóa Dữ liệu</h3>
        <span class="collapsible-arrow">></span>
    </div>
    <div class="collapsible-content">
        <div id="chartsContainer" class="grid grid-cols-1 lg:grid-cols-2 gap-6 p-4">
            <div>
                <h4 class="text-center font-medium text-gray-600 mb-2">Phân phối Tín chỉ theo Điểm</h4>
                <div style="height: 300px; position: relative;"><canvas id="gradeCreditDistributionChart"></canvas></div>
            </div>
            <div>
                <h4 class="text-center font-medium text-gray-600 mb-2">GPA các Học kỳ</h4>
                <div style="height: 300px; position: relative;"><canvas id="semesterGpaChart"></canvas></div>
            </div>
        </div>
        <div class="cumulative-gpa-chart-container p-4">
            <h4 class="text-center font-medium text-gray-600 mb-2">Biến động GPA Tích lũy</h4>
            <div style="height: 300px; position: relative;"><canvas id="cumulativeGpaChart"></canvas></div>
        </div>
    </div>
</div>

<!-- Khu vực 4: Bảng chi tiết -->
<div class="collapsible-section mb-4 border rounded-lg">
    <div class="collapsible-header">
        <h3 class="text-lg font-semibold text-gray-700">Bảng Chi tiết Điểm (Sắp xếp & Lọc)</h3>
        <span class="collapsible-arrow">></span>
    </div>
    <div class="collapsible-content">
        <div class="p-4">
            <div class="flex justify-between items-center mb-2">
                <button id="clearGradeFilterButton" class="secondary-action-button hidden" style="padding: 0.25rem 0.5rem; font-size: 0.75rem; width: auto;">Bỏ lọc điểm</button>
            </div>
            <div class="overflow-x-auto">
                <table class="subject-details-table">
                    <thead>
                        <tr>
                            <th>Tên Môn</th>
                            <th data-sortable data-sort-key="credits">Số TC <span class="sort-arrow"></span></th>
                            <th data-sortable data-sort-key="letterGrade">Điểm Chữ <span class="sort-arrow"></span></th>
                            <th data-sortable data-sort-key="point">Điểm 4 <span class="sort-arrow"></span></th>
                            <th data-sortable data-sort-key="deviation">Độ lệch GPA <span class="sort-arrow"></span></th>
                        </tr>
                    </thead>
                    <tbody id="statsSubjectDetailsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="mt-8 text-center">
     <button id="closeDetailedStatsButtonInternal" class="secondary-action-button w-auto mx-auto px-8">Đóng</button>
</div>
    </div>
    
</div> <!-- [THÊM DÒNG NÀY] - để đóng .modal-content-wrapper -->
</div> <!-- [THÊM DÒNG NÀY] - để đóng #detailedStatsModalOverlay -->
    <!-- KẾT THÚC MODAL -->
    <button id="scrollToTopBtn" title="Cuộn lên đầu trang">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="20"
        height="20"
        fill="currentColor"
        class="bi bi-arrow-up-short"
        viewBox="0 0 16 16"
      >
        <path
          fill-rule="evenodd"
          d="M8 12a.5.5 0 0 0 .5-.5V5.707l2.146 2.147a.5.5 0 0 0 .708-.708l-3-3a.5.5 0 0 0-.708 0l-3 3a.5.5 0 1 0 .708.708L7.5 5.707V11.5a.5.5 0 0 0 .5.5z"
        />
      </svg>
    </button>

    <div id="toastNotification" class="toast-notification">
      Đã lưu và cập nhật điểm!
    </div>
<!-- MODAL CHỈNH SỬA CHI TIẾT MÔN HỌC -->
<!-- MODAL CHỈNH SỬA CHI TIẾT MÔN HỌC (ĐÃ ĐƠN GIẢN HÓA) -->
<div id="editSubjectModalOverlay" class="modal-overlay" style="z-index: 1002;">
    <div class="modal-content-wrapper" style="max-width: 500px;">
        <div class="p-6">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-800">Chỉnh sửa Hình thức thi</h3>
                <button id="closeEditModalButton" class="text-gray-400 hover:text-gray-600">×</button>
            </div>
            <p id="editModalSubjectName" class="text-sm text-gray-500 mb-4"></p>

            <form id="editSubjectForm">
                <input type="hidden" id="editSubjectId">
                
                <div class="mb-4">
                    <label for="editFinalExamType" class="block text-sm font-medium text-gray-700 mb-1">Thi cuối kỳ (Lý thuyết)</label>
                    <select id="editFinalExamType" class="w-full p-2 border border-gray-300 rounded-md bg-white">
                        <option value="">-- Chưa xác định --</option>
                        <option value="Trắc nghiệm">Trắc nghiệm</option>
                        <option value="Tự luận (không tài liệu)">Tự luận (không tài liệu)</option>
                        <option value="Tự luận (có tài liệu)">Tự luận (có tài liệu)</option>
                        <option value="Báo cáo/Tiểu luận">Báo cáo/Tiểu luận</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="editPracticeExamType" class="block text-sm font-medium text-gray-700 mb-1">Thi thực hành (nếu có)</label>
                    <select id="editPracticeExamType" class="w-full p-2 border border-gray-300 rounded-md bg-white">
                        <option value="">-- Chưa xác định / Không có --</option>
                        <option value="Chỉ thực hành">Chỉ thực hành</option>
                        <option value="Thuyết trình">Thuyết trình</option>
                        <option value="Thực hành + Vấn đáp">Thực hành + Vấn đáp</option>
                        <option value="Tự luận">Tự luận</option>
                    </select>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelEditButton" class="secondary-action-button w-auto px-4">Hủy</button>
                    <button type="submit" id="saveEditButton" class="main-action-button w-auto px-4">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

   <script>
    //======================================================================
// KHỐI CODE JAVASCRIPT HOÀN CHỈNH - SAO CHÉP VÀ DÁN TOÀN BỘ VÀO FILE
//======================================================================

const detailedStatsModalOverlay = document.getElementById('detailedStatsModalOverlay');

// 1. DỮ LIỆU & CÁC HẰNG SỐ CƠ BẢN
// =================================
// Thay thế toàn bộ mảng `subjects` bằng phiên bản này
const subjects = [
    // Học kỳ 1
    { id: "hk1_nn1", name: "Ngoại ngữ I", code: "1017001113", semester: 1, credits: 3, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk1_gdtc", name: "Giáo dục thể chất *", code: "1017001748", semester: 1, credits: 3, hasPractice: true, notInGpa: true, finalExamType: null, practiceExamType: null },
    { id: "hk1_shdt", name: "Sinh học - Di truyền Y học", code: "1017001973", semester: 1, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk1_triet", name: "Triết học Mác-Lênin", code: "1017002021", semester: 1, credits: 3, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk1_tin", name: "Tin học", code: "1017002098", semester: 1, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 2
    { id: "hk2_tamly", name: "Tâm lý y học - Đạo đức y học", code: "1017000494", semester: 2, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk2_xstk", name: "Xác suất thống kê Y học", code: "1017001112", semester: 2, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk2_gdqp", name: "GDQP An ninh *", code: "1017001118", semester: 2, credits: 8, hasPractice: true, notInGpa: true, finalExamType: null, practiceExamType: null },
    { id: "hk2_gp", name: "Giải phẫu", code: "1017001651", semester: 2, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk2_hoavc", name: "Hóa đại cương vô cơ", code: "1017001747", semester: 2, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk2_vatly", name: "Vật lý đại cương", code: "1017002179", semester: 2, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 3
    { id: "hk3_sinhly", name: "Sinh lý", code: "1017001653", semester: 3, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk3_kst", name: "Ký sinh trùng", code: "1017001656", semester: 3, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk3_hoahc", name: "Hóa hữu cơ", code: "1017001749", semester: 3, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk3_ktct", name: "Kinh tế chính trị", code: "1017001790", semester: 3, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk3_cnxhkh", name: "Chủ nghĩa xã hội khoa học", code: "1017002022", semester: 3, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk3_tvd1", name: "Thực vật dược I", code: "1017002129", semester: 3, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk3_nn2", name: "Ngoại ngữ II", code: "1017002175", semester: 3, credits: 4, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 4
    { id: "hk4_tthcm", name: "Tư tưởng Hồ Chí Minh", code: "1017001203", semester: 4, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk4_lsd", name: "Lịch sử Đảng cộng sản Việt Nam", code: "1017001719", semester: 4, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk4_hoasinh", name: "Hóa sinh", code: "1017001770", semester: 4, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk4_ttgds", name: "Truyền thông và GD sức khỏe", code: "1017001772", semester: 4, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk4_visinh", name: "Vi sinh", code: "1017001912", semester: 4, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk4_hpt1", name: "Hóa phân tích I", code: "1017002108", semester: 4, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk4_slbmd", name: "Sinh lý bệnh - Miễn dịch", code: "1017002126", semester: 4, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 5
    { id: "hk5_benhhoc", name: "Bệnh học", code: "1017001667", semester: 5, credits: 3, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk5_ddhnd", name: "Đạo đức hành nghề dược", code: "1017001682", semester: 5, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk5_pldc", name: "Pháp luật đại cương", code: "1017001745", semester: 5, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk5_hoalyd", name: "Hóa lý dược", code: "1017001773", semester: 5, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk5_hpt2", name: "Hóa phân tích II", code: "1017002109", semester: 5, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk5_tvd2", name: "Thực vật dược II", code: "1017002130", semester: 5, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 6
    { id: "hk6_qlyktd", name: "Quản lý và kinh tế dược", code: "1017001665", semester: 6, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk6_ddh", name: "Dược động học", code: "1017001776", semester: 6, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk6_qlydbv", name: "Quản lý dược bệnh viện", code: "1017001962", semester: 6, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk6_dl1", name: "Dược liệu I", code: "1017002110", semester: 6, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk6_hd1", name: "Hóa dược I", code: "1017002111", semester: 6, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk6_bcsdh1", name: "Bào chế và sinh dược học I", code: "1017002131", semester: 6, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 7
    { id: "hk7_pcd", name: "Pháp chế dược", code: "1017001661", semester: 7, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk7_hd2", name: "Hóa dược II", code: "1017002112", semester: 7, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk7_dl2", name: "Dược liệu II", code: "1017002113", semester: 7, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk7_dl1", name: "Dược lý I", code: "1017002114", semester: 7, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk7_bcsdh2", name: "Bào chế và sinh dược học II", code: "1017002132", semester: 7, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 8
    { id: "hk8_dch", name: "Độc chất học", code: "1017001663", semester: 8, credits: 2, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk8_sdtdt", name: "Sử dụng thuốc trong điều trị", code: "1017001961", semester: 8, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk8_ttcd", name: "Thông tin và cảnh giác dược", code: "1017001963", semester: 8, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk8_sxdp", name: "Sản xuất dược phẩm", code: "1017001964", semester: 8, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk8_ppnckh", name: "Phương pháp NCKH", code: "1017002095", semester: 8, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk8_dl2", name: "Dược lý II", code: "1017002115", semester: 8, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 9
    { id: "hk9_dhct", name: "Dược học cổ truyền", code: "1017001672", semester: 9, credits: 3, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk9_dls", name: "Dược lâm sàng", code: "1017001915", semester: 9, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk9_kndp", name: "Kiểm nghiệm dược phẩm", code: "1017001916", semester: 9, credits: 4, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk9_thdlsbv", name: "Thực hành dược lâm sàng BV", code: "1017001917", semester: 9, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk9_tnct", name: "Tài nguyên cây thuốc", code: "1017001965", semester: 9, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk9_thqlcut", name: "Thực hành quản lý và cung ứng thuốc", code: "1017002133", semester: 9, credits: 2, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    // Học kỳ 10
    { id: "hk10_tttn", name: "Thực tế tốt nghiệp", code: "1017000556", semester: 10, credits: 5, hasPractice: true, notInGpa: false, finalExamType: null, practiceExamType: null },
    { id: "hk10_kltn", name: "Khóa luận tốt nghiệp/ Thi tốt nghiệp", code: "1017002134", semester: 10, credits: 10, hasPractice: false, notInGpa: false, finalExamType: null, practiceExamType: null }
];
const gradePoints = { "A+": 4.0, "A": 3.7, "B+": 3.5, "B": 3.0, "C+": 2.5, "C": 2.0, "D+": 1.5, "D": 1.0, "F": 0.0, "": null };
const gradeOptions = ["", "A+", "A", "B+", "B", "C+", "C", "D+", "D", "F"];
const RANK_THRESHOLDS = { "Xuất sắc": 3.6, "Giỏi": 3.2, "Khá": 2.5, "Trung bình": 2.0 };
const MAX_POSSIBLE_GRADE_POINT = 4.0;
const LOCAL_STORAGE_KEY = "studentGrades_v2"; // Đổi tên key để lưu cấu trúc mới
const LOCAL_STORAGE_TARGET_RANK_KEY = "studentTargetRank";
const LOCAL_STORAGE_EXPANDED_SEMESTERS_KEY = "expandedSemesters";

// 2. CÁC BIẾN TRẠNG THÁI
// =========================
let activeQuickFilters = { finalExamType: 'all', hasPractice: 'all' };
let currentGradeFilter = null;
let currentSort = { key: null, order: 'asc' };
let allCompletedSubjectsForStats = [];
let detailedStatsTableHeadersInitialized = false;
let cumulativeGpaChartInstance = null;
let toastTimeout;

// 3. TÍNH TOÁN DỮ LIỆU BAN ĐẦU
// ================================
const totalProgramCredits = subjects.reduce((sum, s) => s.notInGpa ? sum : sum + s.credits, 0);
const subjectsBySemester = subjects.reduce((acc, subject) => {
    acc[subject.semester] = acc[subject.semester] || [];
    acc[subject.semester].push(subject);
    return acc;
}, {});

// 4. LẤY CÁC THÀNH PHẦN DOM
// ===========================
const semestersContainer = document.getElementById('semestersContainer');
const calculateButton = document.getElementById('calculateButton');
const resultsArea = document.getElementById('resultsArea');
const totalCreditsEl = document.getElementById('totalCredits');
const gpaEl = document.getElementById('gpa');
const rankEl = document.getElementById('rank');
const toastNotification = document.getElementById('toastNotification'); 
const scrollToTopBtn = document.getElementById('scrollToTopBtn');
const targetRankSelect = document.getElementById('targetRankSelect');
const targetAchievableEl = document.getElementById('targetAchievable');
const remainingCreditsForTargetEl = document.getElementById('remainingCreditsForTarget');
const minAvgForRemainingEl = document.getElementById('minAvgForRemaining');
// Ngay dưới dòng `const minAvgForRemainingEl = ...`

// Detailed Stats Elements (Bổ sung các biến bị thiếu)
const toggleDetailedStatsButton = document.getElementById('toggleDetailedStatsButton');
const statsTotalProgramCreditsEl = document.getElementById('statsTotalProgramCredits');
const statsTotalCompletedCreditsEl = document.getElementById('statsTotalCompletedCredits');
const statsCompletionRateEl = document.getElementById('statsCompletionRate');
const statsOverallGPAEl = document.getElementById('statsOverallGPA');
const statsSubjectDetailsTableBodyEl = document.getElementById('statsSubjectDetailsTableBody');
const clearGradeFilterButton = document.getElementById('clearGradeFilterButton');
let gradeCreditChartInstance = null;
let semesterGpaChartInstance = null;
const targetGpaItemEl = document.getElementById('target-gpa-item');
const completionPercentageEl = document.getElementById('completionPercentage');
const targetInsightEl = document.getElementById('targetInsight');
// 5. CÁC HÀM TIỆN ÍCH
// ====================
function showToast(message) {
    if (toastTimeout) clearTimeout(toastTimeout); 
    toastNotification.textContent = message;
    toastNotification.classList.add('show');
    toastTimeout = setTimeout(() => {
        toastNotification.classList.remove('show');
    }, 2500); 
}

const createTagsHTML = (subject) => {
    let tags = '';
    if (subject.finalExamType === 'Trắc nghiệm') {
        tags += '<span class="subject-tag tag-tn">Trắc nghiệm</span>';
    } else if (subject.finalExamType && subject.finalExamType.includes('Tự luận')) {
        tags += '<span class="subject-tag tag-tl">Tự luận</span>';
    }
    if (subject.hasPractice) {
        tags += '<span class="subject-tag tag-th-true">Có TH</span>';
    }
    if (subject.notInGpa) {
        tags += '<span class="subject-tag" style="background-color: #e5e7eb; color: #4b5563; border-color: #d1d5db;">Không tính điểm</span>';
    }
    return tags;
};

function getRank(gpa) {
    if (gpa === null || isNaN(gpa)) return "N/A";
    if (gpa >= 3.6) return "Xuất sắc";
    if (gpa >= 3.2) return "Giỏi";
    if (gpa >= 2.5) return "Khá";
    if (gpa >= 2.0) return "Trung bình";
    if (gpa >= 1.0) return "Yếu";
    return "Kém";
}

function getRankColor(rank) {
    const rankLower = String(rank || "").toLowerCase();
    switch (rankLower) {
        case "xuất sắc": return "purple";
        case "giỏi": return "blue";
        case "khá": return "green";
        case "trung bình": return "yellow";
        case "yếu": return "orange"; 
        case "kém": return "red";
        default: return "slate"; 
    }
}

// 6. XỬ LÝ LƯU VÀ TẢI DỮ LIỆU (LOCALSTORAGE)
// ===========================================
// Thay thế hàm cũ bằng hàm này
function upgradeAndLoadSavedData() {
    const OLD_GRADES_KEY = "studentGrades"; 
    const NEW_DATA_KEY = "studentGrades_v2"; // Sử dụng một key mới để tránh xung đột

    const savedNewData = localStorage.getItem(NEW_DATA_KEY);

    if (savedNewData) {
        // Nếu đã có dữ liệu mới, chỉ cần tải nó
        try {
            const parsedData = JSON.parse(savedNewData);
            subjects.forEach(subject => {
                const savedSubject = parsedData[subject.id];
                if (savedSubject) {
                    subject.finalExamType = savedSubject.finalExamType;
                    subject.practiceExamType = savedSubject.practiceExamType;
                    const gradeSelect = document.getElementById(subject.id);
                    if (gradeSelect) {
                        gradeSelect.value = savedSubject.grade || "";
                    }
                }
            });
        } catch (e) {
            console.error("Lỗi khi đọc dữ liệu v2:", e);
            localStorage.removeItem(NEW_DATA_KEY); // Xóa dữ liệu lỗi
        }
    } else {
        // Nếu không có dữ liệu mới, thử nâng cấp từ dữ liệu cũ (key: "studentGrades")
        const savedOldGrades = localStorage.getItem(OLD_GRADES_KEY);
        if (savedOldGrades) {
            try {
                const parsedOldGrades = JSON.parse(savedOldGrades);
                Object.keys(parsedOldGrades).forEach(oldId => {
                    const gradeSelect = document.getElementById(oldId);
                    if (gradeSelect) {
                        gradeSelect.value = parsedOldGrades[oldId] || "";
                    }
                });
                showToast("Đã tải điểm từ phiên bản cũ. Hãy lưu lại để hoàn tất nâng cấp.");
            } catch(e) {
                 console.error("Lỗi khi đọc dữ liệu cũ:", e);
            }
        }
    }
}
function saveStateToLocalStorage() {
    const dataToSave = {};
    subjects.forEach((subject) => {
        const gradeSelect = document.getElementById(subject.id);
        dataToSave[subject.id] = {
            grade: gradeSelect ? gradeSelect.value : "",
            finalExamType: subject.finalExamType,
            practiceExamType: subject.practiceExamType
        };
    });
    const expandedSemesters = [];
    document.querySelectorAll(".semester-block .subjects-list.expanded").forEach(list => {
        expandedSemesters.push(list.dataset.semester);
    });
    try {
        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave));
        if (targetRankSelect) localStorage.setItem(LOCAL_STORAGE_TARGET_RANK_KEY, targetRankSelect.value);
        localStorage.setItem(LOCAL_STORAGE_EXPANDED_SEMESTERS_KEY, JSON.stringify(expandedSemesters));
    } catch (e) {
        console.error("Lỗi khi lưu vào localStorage:", e);
        showToast("Lỗi: Không thể lưu dữ liệu!");
    }
}

// Thay thế toàn bộ hàm loadStateFromLocalStorage cũ bằng hàm này
function loadStateFromLocalStorage() {
    const OLD_GRADES_KEY = "studentGrades";
    const NEW_DATA_KEY = "studentGrades_v2"; // Sử dụng key mới
    
    // Tải các cài đặt giao diện trước
    const savedTargetRank = localStorage.getItem(LOCAL_STORAGE_TARGET_RANK_KEY);
    if (targetRankSelect && savedTargetRank) {
        targetRankSelect.value = savedTargetRank;
    }
    const savedExpandedSemesters = localStorage.getItem(LOCAL_STORAGE_EXPANDED_SEMESTERS_KEY);
    if (savedExpandedSemesters) {
        const expanded = JSON.parse(savedExpandedSemesters);
        expanded.forEach((semNum) => {
            const semList = document.querySelector(`.subjects-list[data-semester="${semNum}"]`);
            const semArrow = document.querySelector(`.semester-header[data-semester="${semNum}"] .semester-arrow`);
            if (semList) semList.classList.add("expanded");
            if (semArrow) semArrow.classList.add("expanded");
        });
    }

    // Xử lý tải dữ liệu môn học (điểm và hình thức thi)
    const savedNewData = localStorage.getItem(NEW_DATA_KEY);
    if (savedNewData) {
        // --- TRƯỜNG HỢP 1: ĐÃ CÓ DỮ LIỆU MỚI ---
        try {
            const parsedData = JSON.parse(savedNewData);
            subjects.forEach(subject => {
                const savedSubject = parsedData[subject.id];
                if (savedSubject) {
                    // Cập nhật cả hình thức thi VÀO MẢNG JS
                    subject.finalExamType = savedSubject.finalExamType;
                    subject.practiceExamType = savedSubject.practiceExamType;

                    // Cập nhật điểm VÀO GIAO DIỆN
                    const gradeSelect = document.getElementById(subject.id);
                    if (gradeSelect) {
                        gradeSelect.value = savedSubject.grade || "";
                    }
                }
            });
        } catch (e) {
            console.error("Lỗi khi đọc dữ liệu v2:", e);
            localStorage.removeItem(NEW_DATA_KEY);
        }
    } else {
        // --- TRƯỜNG HỢP 2: CHỈ CÓ DỮ LIỆU ĐIỂM CŨ ---
        const savedOldGrades = localStorage.getItem(OLD_GRADES_KEY);
        if (savedOldGrades) {
            try {
                const parsedOldGrades = JSON.parse(savedOldGrades);
                // Chỉ điền điểm vào giao diện, hình thức thi giữ nguyên là null
                Object.keys(parsedOldGrades).forEach(oldId => {
                    const gradeSelect = document.getElementById(oldId);
                    if (gradeSelect) {
                        gradeSelect.value = parsedOldGrades[oldId] || "";
                    }
                });
                showToast("Đã tải điểm từ phiên bản cũ. Hãy nhập hình thức thi và lưu lại.");
            } catch(e) {
                console.error("Lỗi khi đọc dữ liệu cũ:", e);
            }
        }
    }
    subjects.forEach(subject => {
        const subjectDiv = document.querySelector(`.subject-item[data-id="${subject.id}"]`);
        if (subjectDiv) {
            const tagsContainer = subjectDiv.querySelector('.subject-tags-container');
            const finalExamTypeDataAttribute = subjectDiv.querySelector('.subject-name-wrapper');
            if(tagsContainer) tagsContainer.innerHTML = createTagsHTML(subject);
            // Cập nhật cả data-attribute để bộ lọc hoạt động đúng
            subjectDiv.dataset.finalExamType = subject.finalExamType || '';
        }
    });
}
// 7. HIỂN THỊ GIAO DIỆN & TÍNH TOÁN
// ===================================
//==============================================================
// THAY THẾ TOÀN BỘ CÁC HÀM TỪ ĐÂY TRỞ XUỐNG
//==============================================================

//==============================================================
// THAY THẾ TOÀN BỘ CÁC HÀM TỪ ĐÂY TRỞ XUỐNG
//==============================================================

function populateSubjectsAndSemesters() {
    Object.keys(subjectsBySemester).sort((a,b) => parseInt(a) - parseInt(b)).forEach(semesterNumber => {
        const semesterSubjects = subjectsBySemester[semesterNumber];
        const semesterBlock = document.createElement('div');
        semesterBlock.className = 'semester-block';
        const semesterHeader = document.createElement('div');
        semesterHeader.className = 'semester-header';
        semesterHeader.dataset.semester = semesterNumber;
        semesterHeader.innerHTML = `
            <div class="semester-header-content">
                <h3 class="font-semibold">Học kỳ ${semesterNumber}</h3>
                <span class="semester-grade-count" id="sem-count-${semesterNumber}"></span>
                <span class="semester-gpa-display" id="sem-gpa-${semesterNumber}">GPA HK: N/A</span>
            </div>
            <span class="semester-arrow">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chevron-right" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.646 1.646a.5.5 0 0 1 .708 0l6 6a.5.5 0 0 1 0 .708l-6 6a.5.5 0 0 1-.708-.708L10.293 8 4.646 2.354a.5.5 0 0 1 0-.708z"/></svg>
            </span>`;
        const subjectsList = document.createElement('div');
        subjectsList.className = 'subjects-list';
        subjectsList.dataset.semester = semesterNumber;
        semesterSubjects.forEach(subject => {
            const subjectDiv = document.createElement('div');
            subjectDiv.className = 'subject-item';
            subjectDiv.dataset.id = subject.id;
            subjectDiv.dataset.hasPractice = subject.hasPractice;
            subjectDiv.dataset.finalExamType = subject.finalExamType || '';
            subjectDiv.innerHTML = `
                <div class="subject-name-wrapper">
                    <span class="subject-name editable-subject-name" title="${subject.name}" data-subject-id="${subject.id}">${subject.name}</span>
                    <div class="subject-tags-container">${createTagsHTML(subject)}</div>
                </div>
                <span class="text-center">${subject.credits}</span>
                <select id="${subject.id}" class="w-full subject-grade-select bg-white py-2 px-1 text-sm rounded-md border-slate-300">
                    ${gradeOptions.map(grade => `<option value="${grade}" ${subject.notInGpa ? 'disabled' : ''}>${grade || '--'}</option>`).join('')}
                </select>`;
            subjectsList.appendChild(subjectDiv);
            subjectDiv.querySelector(`#${subject.id}`).addEventListener('change', (event) => {
                calculateAndDisplayResults(); 
                event.target.closest('.subject-item').classList.add('selected-briefly');
                setTimeout(() => event.target.closest('.subject-item').classList.remove('selected-briefly'), 300);
            });
        });
        semesterBlock.appendChild(semesterHeader);
        semesterBlock.appendChild(subjectsList);
        semestersContainer.appendChild(semesterBlock);
        semesterHeader.addEventListener('click', () => {
            subjectsList.classList.toggle('expanded');
            semesterHeader.querySelector('.semester-arrow').classList.toggle('expanded'); 
            saveStateToLocalStorage(); 
        });
    });
}

function calculateAndDisplayResults() {
    let totalWeightedPoints = 0, currentTotalCompletedCredits = 0, hasInput = false;
    const completedSubjectsDetails = [];
    subjects.forEach(subject => {
        if (subject.notInGpa) return;
        const gradeSelect = document.getElementById(subject.id);
        if (!gradeSelect) return; 
        const letterGrade = gradeSelect.value;
        if (letterGrade && gradePoints[letterGrade] !== null) {
            hasInput = true;
            const point = gradePoints[letterGrade];
            const weightedPoints = point * subject.credits;
            totalWeightedPoints += weightedPoints;
            currentTotalCompletedCredits += subject.credits;
            completedSubjectsDetails.push({ id: subject.id, name: subject.name, credits: subject.credits, letterGrade: letterGrade, point: point, weightedPoints: weightedPoints });
        }
    });
    let currentGPA = hasInput && currentTotalCompletedCredits > 0 ? (totalWeightedPoints / currentTotalCompletedCredits) : 0;
    if (hasInput) {
    currentGPA = currentTotalCompletedCredits > 0 ? (totalWeightedPoints / currentTotalCompletedCredits) : 0;
    const currentRank = getRank(currentGPA);
    const rankColor = getRankColor(currentRank);
    
    gpaEl.textContent = currentGPA.toFixed(2);
    rankEl.textContent = currentRank;
    rankEl.className = `result-value rank-highlight text-${rankColor}`; // Cập nhật màu cho chữ
    totalCreditsEl.textContent = currentTotalCompletedCredits;
    
    const percentage = totalProgramCredits > 0 ? (currentTotalCompletedCredits / totalProgramCredits * 100) : 0;
    completionPercentageEl.textContent = `${percentage.toFixed(0)}%`;

} else {
    // Reset về trạng thái ban đầu
    gpaEl.textContent = "0.00";
    rankEl.textContent = "N/A";
    rankEl.className = 'result-value rank-highlight text-slate';
    totalCreditsEl.textContent = "0";
    completionPercentageEl.textContent = "0%";
}
    updateTargetRank(currentTotalCompletedCredits, totalWeightedPoints);
    updateSemesterStats();
    updateDetailedStatistics(completedSubjectsDetails, currentGPA);
    saveStateToLocalStorage();
}

function updateSemesterStats() {
    Object.keys(subjectsBySemester).forEach(semesterNumber => {
        const semesterSubjects = subjectsBySemester[semesterNumber].filter(s => !s.notInGpa);
        let gradedCount = 0, semesterWeightedPoints = 0, semesterCompletedCredits = 0;
        semesterSubjects.forEach(subject => {
            const gradeSelect = document.getElementById(subject.id); 
            if (gradeSelect && gradeSelect.value !== "") {
                gradedCount++;
                const point = gradePoints[gradeSelect.value];
                if (point !== null) {
                    semesterWeightedPoints += point * subject.credits;
                    semesterCompletedCredits += subject.credits;
                }
            }
        });
        document.getElementById(`sem-count-${semesterNumber}`).textContent = `(${gradedCount}/${semesterSubjects.length})`;
        const gpaDisplay = document.getElementById(`sem-gpa-${semesterNumber}`);
        gpaDisplay.textContent = semesterCompletedCredits > 0 ? `GPA HK: ${(semesterWeightedPoints / semesterCompletedCredits).toFixed(2)}` : `GPA HK: N/A`;
    });
}

// THAY THẾ TOÀN BỘ HÀM updateTargetRank
// THAY THẾ TOÀN BỘ HÀM NÀY
function updateTargetRank(currentTotalCompletedCredits, totalWeightedPoints) {
    const selectedTargetRankValue = targetRankSelect.value;
    const targetGPAThreshold = RANK_THRESHOLDS[selectedTargetRankValue];

    if (selectedTargetRankValue && targetGPAThreshold) {
        targetGpaItemEl.classList.add('visible');
        targetInsightEl.classList.add('visible');
        
        const remainingCredits = totalProgramCredits - currentTotalCompletedCredits;
        // Dòng này không cần nữa vì đã có trong thanh phụ: remainingCreditsForTargetEl.textContent = remainingCredits >= 0 ? remainingCredits : "Lỗi";
        
        if (remainingCredits <= 0) {
            const finalGPA = currentTotalCompletedCredits > 0 ? (totalWeightedPoints / currentTotalCompletedCredits) : 0;
            minAvgForRemainingEl.textContent = "N/A";
            targetInsightEl.textContent = "Bạn đã hoàn thành chương trình học!";
        } else { 
            const pointsStillNeeded = (targetGPAThreshold * totalProgramCredits) - totalWeightedPoints;
            if (pointsStillNeeded <= 0) { 
                minAvgForRemainingEl.textContent = "0.00";
                targetInsightEl.textContent = "Tuyệt vời! Bạn chỉ cần qua tất cả các môn còn lại là đạt mục tiêu.";
            } else {
                const avgNeeded = pointsStillNeeded / remainingCredits;
                minAvgForRemainingEl.textContent = avgNeeded.toFixed(2);
                if (avgNeeded > MAX_POSSIBLE_GRADE_POINT) {
                    targetInsightEl.textContent = "Điểm trung bình yêu cầu đã vượt quá mức tối đa có thể đạt được.";
                    minAvgForRemainingEl.classList.add("text-red-600");
                } else if (avgNeeded >= 3.7) {
                    targetInsightEl.textContent = `Rất khó! Bạn cần đạt điểm trung bình gần như tuyệt đối (A/A+) cho các môn còn lại.`;
                     minAvgForRemainingEl.classList.remove("text-red-600");
                } else {
                    targetInsightEl.textContent = `Cố lên! Hãy duy trì điểm trung bình các môn còn lại ở mức ${avgNeeded.toFixed(2)} trở lên.`;
                     minAvgForRemainingEl.classList.remove("text-red-600");
                }
            }
        }
    } else { 
        // Khi chưa chọn mục tiêu
        targetGpaItemEl.classList.remove('visible');
        targetInsightEl.classList.remove('visible');
    }
}
// ===============================================
// CÁC HÀM CHO MODAL THỐNG KÊ CHI TIẾT
// ===============================================

function updateDetailedStatistics(completedSubjectsData, overallGPA) {
    allCompletedSubjectsForStats = [...completedSubjectsData];
    const completedCredits = allCompletedSubjectsForStats.reduce((sum, s) => sum + s.credits, 0);
    statsTotalProgramCreditsEl.textContent = totalProgramCredits;
    statsTotalCompletedCreditsEl.textContent = completedCredits;
    const completionRate = totalProgramCredits > 0 ? (completedCredits / totalProgramCredits * 100) : 0;
    statsCompletionRateEl.textContent = `${completionRate.toFixed(1)}%`;
    statsOverallGPAEl.textContent = `${overallGPA.toFixed(2)}`;
    
    generateInsights(allCompletedSubjectsForStats, overallGPA);
    renderGradeDistribution(allCompletedSubjectsForStats);
    renderGradeCreditDistributionChart(allCompletedSubjectsForStats);
    renderSemesterGpaChart(allCompletedSubjectsForStats, overallGPA);
    updateCumulativeGpaChart(allCompletedSubjectsForStats);
    renderDetailedTable(); 
}

function renderDetailedTable() {
    let displayData = [...allCompletedSubjectsForStats];
    if (currentGradeFilter) {
        displayData = displayData.filter(subject => subject.letterGrade === currentGradeFilter);
    }
    if (currentSort.key) {
        displayData.sort((a, b) => {
            let valA = a[currentSort.key], valB = b[currentSort.key];
            const overallGPA = parseFloat(statsOverallGPAEl.textContent) || 0;
            if (currentSort.key === 'deviation') {
                valA = a.point - overallGPA; valB = b.point - overallGPA;
            } else if (currentSort.key === 'letterGrade') {
                valA = gradePoints[a.letterGrade] || -1; valB = gradePoints[b.letterGrade] || -1;
            }
            if (typeof valA === 'string') return currentSort.order === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
            return currentSort.order === 'asc' ? valA - valB : valB - valA;
        });
    }
    statsSubjectDetailsTableBodyEl.innerHTML = '';
    if (displayData.length === 0) {
        statsSubjectDetailsTableBodyEl.innerHTML = `<tr><td colspan="5" class="text-center">Không có dữ liệu.</td></tr>`;
        return;
    }
    const overallGPAForDeviation = parseFloat(statsOverallGPAEl.textContent) || 0;
    displayData.forEach(data => {
        const deviation = data.point - overallGPAForDeviation;
        const row = statsSubjectDetailsTableBodyEl.insertRow();
        row.innerHTML = `
            <td>${data.name}</td>
            <td class="text-center">${data.credits}</td>
            <td class="text-center">${data.letterGrade}</td>
            <td class="text-center">${data.point.toFixed(1)}</td>
            <td class="text-center ${deviation >= 0.01 ? 'deviation-positive' : (deviation <= -0.01 ? 'deviation-negative' : '')}">${deviation.toFixed(2)}</td>
        `;
    });
    updateSortArrows();
}

function handleSortClick(key) {
    if (currentSort.key === key) {
        currentSort.order = currentSort.order === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.key = key;
        currentSort.order = 'asc';
    }
    renderDetailedTable();
}

function updateSortArrows() {
    document.querySelectorAll('.subject-details-table th[data-sortable]').forEach(th => {
        th.classList.remove('sorted-asc', 'sorted-desc');
        if (th.dataset.sortKey === currentSort.key) {
            th.classList.add(currentSort.order === 'asc' ? 'sorted-asc' : 'sorted-desc');
        }
    });
}

function handleGradeFilterClick(grade) {
    currentGradeFilter = (currentGradeFilter === grade) ? null : grade;
    renderGradeDistribution(allCompletedSubjectsForStats);
    renderDetailedTable();
    clearGradeFilterButton.classList.toggle('hidden', !currentGradeFilter);
}

function renderGradeDistribution(completedSubjects) {
    const distEl = document.getElementById('statsGradeDistribution');
    if (!distEl) return;
    const gradeCounts = {}, gradeCredits = {}, totalGradedCredits = completedSubjects.reduce((sum, s) => sum + s.credits, 0);
    gradeOptions.forEach(g => { if(g) { gradeCounts[g] = 0; gradeCredits[g] = 0; } });
    completedSubjects.forEach(s => { if(s.letterGrade) { gradeCounts[s.letterGrade]++; gradeCredits[s.letterGrade] += s.credits; } });
    distEl.innerHTML = '';
    Object.keys(gradeCounts).sort((a,b) => gradePoints[b] - gradePoints[a]).forEach(grade => {
        if (gradeCounts[grade] > 0) {
            const percentage = totalGradedCredits > 0 ? (gradeCredits[grade] / totalGradedCredits * 100) : 0;
            const li = document.createElement('li');
            li.className = `grade-dist-item-default ${grade === currentGradeFilter ? 'active-filter' : ''}`;
            li.innerHTML = `<span class="grade-label">${grade}</span><span class="grade-info">${gradeCounts[grade]} môn / ${gradeCredits[grade]} TC</span><span class="grade-percentage">${percentage.toFixed(1)}% TC</span>`;
            li.addEventListener('click', () => handleGradeFilterClick(grade));
            distEl.appendChild(li);
        }
    });
}

function generateInsights(completedSubjects, gpa) {
    const insightsContainer = document.getElementById('insightsContainer');
    if (!insightsContainer) return;
    insightsContainer.innerHTML = '';
    if (completedSubjects.length < 1) {
        insightsContainer.innerHTML = '<p class="text-gray-500 col-span-full">Chưa có dữ liệu để tạo phân tích.</p>';
        return;
    }
    let bestImpact = { name: '', impact: -Infinity };
    completedSubjects.forEach(s => {
        const impact = s.credits * (s.point - gpa);
        if (impact > bestImpact.impact) {
            bestImpact = { name: s.name, impact: impact, credits: s.credits, grade: s.letterGrade };
        }
    });
    if (bestImpact.impact > 0) {
        insightsContainer.innerHTML += `<div class="insight-card positive"><div class="insight-title">🚀 Môn Tích cực nhất</div><div class="insight-body"><span class="font-bold">${bestImpact.name}</span><p class="text-sm">${bestImpact.credits}TC - Điểm ${bestImpact.grade}</p></div></div>`;
    }
    let worstImpact = { name: '', impact: Infinity };
    completedSubjects.forEach(s => {
        const impact = s.credits * (s.point - gpa);
        if (impact < worstImpact.impact) {
            worstImpact = { name: s.name, impact: impact, credits: s.credits, grade: s.letterGrade };
        }
    });
    if (worstImpact.impact < 0) {
        insightsContainer.innerHTML += `<div class="insight-card negative"><div class="insight-title">📉 Môn Cần cải thiện</div><div class="insight-body"><span class="font-bold">${worstImpact.name}</span><p class="text-sm">${worstImpact.credits}TC - Điểm ${worstImpact.grade}</p></div></div>`;
    }
    const semesterGPAs = {};
    completedSubjects.forEach(s => {
        const original = subjects.find(sub => sub.id === s.id);
        if (!original) return;
        const sem = original.semester;
        if (!semesterGPAs[sem]) semesterGPAs[sem] = { points: 0, credits: 0 };
        semesterGPAs[sem].points += s.weightedPoints;
        semesterGPAs[sem].credits += s.credits;
    });
    let bestSem = { sem: null, gpa: -1 };
    Object.keys(semesterGPAs).forEach(sem => {
        const semGpa = semesterGPAs[sem].credits > 0 ? semesterGPAs[sem].points / semesterGPAs[sem].credits : 0;
        if (semGpa > bestSem.gpa) bestSem = { sem, gpa: semGpa };
    });
    if (bestSem.sem) {
        insightsContainer.innerHTML += `<div class="insight-card"><div class="insight-title">🏆 Học kỳ Nổi bật</div><div class="insight-body">Học kỳ ${bestSem.sem} với GPA ${bestSem.gpa.toFixed(2)}</div></div>`;
    }
}

function renderGradeCreditDistributionChart(completedSubjects) {
    const ctx = document.getElementById('gradeCreditDistributionChart')?.getContext('2d');
    if (!ctx) return;
    if (gradeCreditChartInstance) gradeCreditChartInstance.destroy();
    if (completedSubjects.length === 0) return;
    const creditByGrade = {};
    gradeOptions.forEach(g => { if (g) creditByGrade[g] = 0; });
    completedSubjects.forEach(s => { if (s.letterGrade) creditByGrade[s.letterGrade] += s.credits; });
    const sortedGrades = Object.keys(creditByGrade).sort((a,b) => gradePoints[b] - gradePoints[a]);
    gradeCreditChartInstance = new Chart(ctx, { type: 'bar', data: { labels: sortedGrades, datasets: [{ label: 'Số Tín chỉ', data: sortedGrades.map(grade => creditByGrade[grade]), backgroundColor: 'rgba(59, 130, 246, 0.6)' }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, title: { display: true, text: 'Tổng số Tín chỉ' } } }, plugins: { legend: { display: false } } } });
}

function renderSemesterGpaChart(completedSubjects, overallGPA) {
    const ctx = document.getElementById('semesterGpaChart')?.getContext('2d');
    if (!ctx) return;
    if (semesterGpaChartInstance) semesterGpaChartInstance.destroy();
    if (completedSubjects.length === 0) return;
    const semesterData = {};
    completedSubjects.forEach(s => {
        const original = subjects.find(sub => sub.id === s.id);
        if (!original || original.notInGpa) return;
        const sem = original.semester;
        if (!semesterData[sem]) semesterData[sem] = { points: 0, credits: 0 };
        semesterData[sem].points += s.weightedPoints;
        semesterData[sem].credits += s.credits;
    });
    const sortedSemesters = Object.keys(semesterData).sort((a,b) => a-b);
    const labels = sortedSemesters.map(s => `Kỳ ${s}`);
    const data = sortedSemesters.map(s => semesterData[s].credits > 0 ? (semesterData[s].points / semesterData[s].credits) : 0);
    const overallGpaLineData = Array(labels.length).fill(overallGPA);
    semesterGpaChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                { type: 'line', label: 'GPA Tích lũy', data: overallGpaLineData, borderColor: '#ef4444', borderWidth: 2.5, fill: false, pointRadius: 0, order: 1 },
                { type: 'bar', label: 'GPA Học kỳ', data: data, backgroundColor: 'rgba(34, 197, 94, 0.6)', order: 2 }
            ]
        },
        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 4.0, title: { display: true, text: 'Điểm GPA hệ 4' } } }, plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } } }
    });
}

function updateCumulativeGpaChart(completedSubjects) {
    const chartCanvas = document.getElementById('cumulativeGpaChart');
    if (!chartCanvas) return;
    if (cumulativeGpaChartInstance) cumulativeGpaChartInstance.destroy();
    if (completedSubjects.length === 0) return;
    const subjectsByCompletedSemester = {};
    completedSubjects.forEach(subject => {
        const originalSubject = subjects.find(s => s.id === subject.id);
        if (originalSubject) {
            const semester = originalSubject.semester;
            if (!subjectsByCompletedSemester[semester]) subjectsByCompletedSemester[semester] = [];
            subjectsByCompletedSemester[semester].push(subject);
        }
    });
    let cumulativeWeightedPoints = 0, cumulativeCredits = 0;
    const semesterLabels = [], cumulativeGpaData = [];
    const maxSemesterWithGrade = Math.max(...Object.keys(subjectsByCompletedSemester).map(Number), 0);
    for (let sem = 1; sem <= maxSemesterWithGrade; sem++) {
        semesterLabels.push(`Kỳ ${sem}`);
        if (subjectsByCompletedSemester[sem]) {
            subjectsByCompletedSemester[sem].forEach(subject => {
                cumulativeWeightedPoints += subject.weightedPoints;
                cumulativeCredits += subject.credits;
            });
        }
        cumulativeGpaData.push(cumulativeCredits > 0 ? (cumulativeWeightedPoints / cumulativeCredits) : 0);
    }
    if (cumulativeGpaData.length === 0) return;
    cumulativeGpaChartInstance = new Chart(chartCanvas, { type: 'line', data: { labels: semesterLabels, datasets: [{ label: 'GPA Tích lũy', data: cumulativeGpaData, fill: true, borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.2)', tension: 0.1 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 4.0 } }, plugins: { legend: { display: true, position: 'top'} } } });
}

// 8. LOGIC CHO CÁC MODAL VÀ BỘ LỌC
// ===================================
const editModalOverlay = document.getElementById('editSubjectModalOverlay');
const closeEditModalButton = document.getElementById('closeEditModalButton');
const cancelEditButton = document.getElementById('cancelEditButton');
const editSubjectForm = document.getElementById('editSubjectForm');
const editModalSubjectName = document.getElementById('editModalSubjectName');
const editSubjectId = document.getElementById('editSubjectId');
const editFinalExamType = document.getElementById('editFinalExamType');
const editPracticeExamType = document.getElementById('editPracticeExamType');
function openEditModal(subjectId) { const subject = subjects.find(s => s.id === subjectId); if (!subject) return; editSubjectId.value = subject.id; editModalSubjectName.textContent = subject.name; editFinalExamType.value = subject.finalExamType || ""; editPracticeExamType.value = subject.practiceExamType || ""; editPracticeExamType.disabled = !subject.hasPractice; editModalOverlay.classList.add('visible'); }
function closeEditModal() { editModalOverlay.classList.remove('visible'); }
semestersContainer.addEventListener('click', function(event) { if (event.target && event.target.classList.contains('editable-subject-name')) openEditModal(event.target.dataset.subjectId); });
closeEditModalButton.addEventListener('click', closeEditModal);
cancelEditButton.addEventListener('click', closeEditModal);
editModalOverlay.addEventListener('click', (event) => { if (event.target === editModalOverlay) closeEditModal(); });
editSubjectForm.addEventListener('submit', function(event) {
    event.preventDefault();
    const idToUpdate = editSubjectId.value;
    const subjectIndex = subjects.findIndex(s => s.id === idToUpdate);
    if (subjectIndex > -1) {
        subjects[subjectIndex].finalExamType = editFinalExamType.value;
        subjects[subjectIndex].practiceExamType = editPracticeExamType.value;
        const subjectDiv = document.querySelector(`.subject-item[data-id="${idToUpdate}"]`);
        if (subjectDiv) {
            subjectDiv.querySelector('.subject-tags-container').innerHTML = createTagsHTML(subjects[subjectIndex]);
            subjectDiv.dataset.finalExamType = subjects[subjectIndex].finalExamType || '';
        }
        showToast(`Đã cập nhật: ${subjects[subjectIndex].name}`);
        if (!rawDataOutput.classList.contains('hidden')) {
             rawDataOutput.textContent = JSON.stringify(subjects, null, 2);
        }
    }
    closeEditModal();
});
function applyQuickFilters() {
    const allSubjectItems = document.querySelectorAll('#semestersContainer .subject-item');
    allSubjectItems.forEach(item => {
        const examTypeFilterValue = activeQuickFilters.finalExamType;
        const subjectExamType = item.dataset.finalExamType;
        let matchExamType = examTypeFilterValue === 'all' || (subjectExamType && subjectExamType.includes(examTypeFilterValue));
        const matchPractice = activeQuickFilters.hasPractice === 'all' || item.dataset.hasPractice === activeQuickFilters.hasPractice;
        item.style.display = (matchExamType && matchPractice) ? 'grid' : 'none';
    });
    document.querySelectorAll('.semester-block').forEach(semesterBlock => {
        const visibleSubjects = semesterBlock.querySelectorAll(".subject-item[style*='display: grid']");
        semesterBlock.style.display = (visibleSubjects.length > 0) ? 'block' : 'none';
    });
}
const quickFiltersContainer = document.getElementById('quickFiltersContainer');
if (quickFiltersContainer) {
    quickFiltersContainer.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('quick-filter-button')) {
            const group = target.dataset.filterGroup;
            const value = target.dataset.filterValue;
            activeQuickFilters[group] = value;
            quickFiltersContainer.querySelectorAll(`.quick-filter-button[data-filter-group="${group}"]`).forEach(btn => btn.classList.remove('active'));
            target.classList.add('active');
            applyQuickFilters();
        }
    });
}
const showRawDataButton = document.getElementById('showRawDataButton');
const rawDataOutput = document.getElementById('rawDataOutput');
showRawDataButton.addEventListener('click', () => {
    rawDataOutput.classList.toggle('hidden');
    if (!rawDataOutput.classList.contains('hidden')) {
        rawDataOutput.textContent = JSON.stringify(subjects, null, 2);
    }
});

// 9. GẮN CÁC SỰ KIỆN CHÍNH
// =============================
calculateButton.addEventListener('click', () => { calculateAndDisplayResults(); showToast("Đã lưu và cập nhật điểm!"); });
targetRankSelect.addEventListener('change', calculateAndDisplayResults);
toggleDetailedStatsButton.addEventListener('click', () => {
    calculateAndDisplayResults(); 
    detailedStatsModalOverlay.classList.add('visible');
    const firstSection = document.querySelector('#detailedStatsModalOverlay .collapsible-section');
    if (firstSection && !firstSection.classList.contains('expanded')) firstSection.classList.add('expanded');
});
const closeButtons = [document.getElementById('closeDetailedStatsButton'), document.getElementById('closeDetailedStatsButtonInternal')];
closeButtons.forEach(btn => btn?.addEventListener('click', () => {
    detailedStatsModalOverlay.classList.remove('visible');
    if (cumulativeGpaChartInstance) cumulativeGpaChartInstance.destroy();
    if (gradeCreditChartInstance) gradeCreditChartInstance.destroy();
    if (semesterGpaChartInstance) semesterGpaChartInstance.destroy();
    cumulativeGpaChartInstance = gradeCreditChartInstance = semesterGpaChartInstance = null;
}));
document.addEventListener('keydown', function(event) { if (event.key === "Escape" && detailedStatsModalOverlay.classList.contains('visible')) closeButtons[0].click(); });
document.querySelectorAll('.collapsible-header').forEach(header => {
    header.addEventListener('click', () => {
        header.parentElement.classList.toggle('expanded');
    });
});
clearGradeFilterButton.addEventListener('click', () => handleGradeFilterClick(null));
document.querySelectorAll('.subject-details-table th[data-sortable]').forEach(th => {
    th.addEventListener('click', () => handleSortClick(th.dataset.sortKey));
});
window.onscroll = function() { scrollToTopBtn.style.display = (document.body.scrollTop > 100 || document.documentElement.scrollTop > 100) ? "flex" : "none"; };
scrollToTopBtn.addEventListener('click', () => { document.body.scrollTop = 0; document.documentElement.scrollTop = 0; });

// 10. KHỞI CHẠY ỨNG DỤNG
// ========================
populateSubjectsAndSemesters();
loadStateFromLocalStorage();
calculateAndDisplayResults();
   </script>
  </body>
</html>

