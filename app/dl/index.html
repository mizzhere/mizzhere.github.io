<!doctype html>
<html lang="vi" class="light">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Dược liệu by mizz</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <script src="https://unpkg.com/lucide@latest"></script>
        <style>
            :root {
                --background: #f8fafc;
                --foreground: #020817;
                --card: #ffffff;
                --card-foreground: #020817;
                --popover: #ffffff;
                --popover-foreground: #020817;
                --primary: #3b82f6;
                --primary-foreground: #f8fafc;
                --secondary: #f1f5f9;
                --secondary-foreground: #0f172a;
                --muted: #f1f5f9;
                --muted-foreground: #64748b;
                --accent: #f1f5f9;
                --accent-foreground: #0f172a;
                --border: #e2e8f0;
                --input: #e2e8f0;
                --ring: #3b82f6;
            }

            html.dark {
                --background: #020817;
                --foreground: #f8fafc;
                --card: #0f172a;
                --card-foreground: #f8fafc;
                --popover: #020817;
                --popover-foreground: #f8fafc;
                --primary: #3b82f6;
                --primary-foreground: #f8fafc;
                --secondary: #1e293b;
                --secondary-foreground: #f8fafc;
                --muted: #1e293b;
                --muted-foreground: #94a3b8;
                --accent: #1e293b;
                --accent-foreground: #f8fafc;
                --border: #1e293b;
                --input: #1e293b;
                --ring: #3b82f6;
            }

            body {
                font-family: "Inter", sans-serif;
                background-color: var(--background);
                color: var(--foreground);
            }
            .no-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .no-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .lucide {
                stroke-width: 2;
            }
            .custom-ring:focus-visible {
                outline: 2px solid var(--ring);
                outline-offset: 2px;
            }

            /* --- TỔNG CẢI TIẾN UI & ANIMATION --- */
            .view-container {
                animation-duration: 250ms;
                animation-timing-function: ease-in-out;
                animation-fill-mode: forwards;
            }
            .view-fade-in {
                animation-name: view-fade-in-anim;
                /* Sử dụng curve giống hệt header để chuyển động cùng nhịp */
                animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
                animation-duration: 300ms; /* Tăng nhẹ lên 300ms cho bằng header */
            }
            .view-fade-out {
                animation-name: view-fade-out-anim;
            }
            @keyframes view-fade-in-anim {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            @keyframes view-fade-out-anim {
                from {
                    opacity: 1;
                    transform: translateY(0);
                }
                to {
                    opacity: 0;
                    transform: translateY(-10px);
                }
            }

            /* --- MÃ MỚI: Header tự ẩn khi cuộn --- */
            #mobile-header {
                position: sticky;
                top: 0;
                z-index: 25;
                width: 100%;
                transition:
                    transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                    margin-top 0.3s cubic-bezier(0.4, 0, 0.2, 1);

                will-change: transform; /* Tối ưu hiệu năng render */
            }

            .header-scroll-hidden {
                transform: translateY(-100%);
                margin-top: -57px; /* Thêm dòng này (giá trị xấp xỉ chiều cao header) */
            }
            /* Đảm bảo khi vào chi tiết (header-hidden cũ) thì nó vẫn ẩn hẳn */
            .header-hidden {
                max-height: 0 !important;
                opacity: 0 !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
                overflow: hidden;
                border-bottom-width: 0px !important;
                /* Bổ sung transition để đảm bảo nó trượt lên êm ái */
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            .plant-card {
                transition:
                    transform 0.2s ease-out,
                    box-shadow 0.2s ease-out,
                    border-color 0.2s ease-out;
            }
            .plant-card:hover {
                transform: translateY(-4px);
                box-shadow:
                    0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -4px rgba(0, 0, 0, 0.1);
            }

            .animate-on-scroll {
                opacity: 0;
                transform: translateY(20px);
                transition:
                    opacity 0.5s cubic-bezier(0.25, 1, 0.5, 1),
                    transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
            }
            .animate-on-scroll.is-visible {
                opacity: 1;
                transform: translateY(0);
            }

            /* --- MÃ MỚI: Animation cho Mobile Sidebar --- */
            #mobile-menu {
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease-in-out;
            }
            #mobile-menu.is-open {
                opacity: 1;
                pointer-events: auto;
            }
            #mobile-menu > aside {
                transform: translateX(-100%);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #mobile-menu.is-open > aside {
                transform: translateX(0);
            }

            dialog {
                background-color: var(--card);
                color: var(--card-foreground);
            }
            dialog::backdrop {
                background: rgba(0, 0, 0, 0.5);
                transition: all 0.3s ease-out;
            }
            dialog[open] {
                animation: modal-scale-in 0.3s ease-out forwards;
            }
            dialog[open]::backdrop {
                backdrop-filter: blur(4px);
            }
            @keyframes modal-scale-in {
                from {
                    opacity: 0;
                    transform: scale(0.95);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }

            #toast-container {
                position: fixed;
                top: 1.25rem;
                right: 1.25rem;
                z-index: 1000;
                display: flex;
                flex-direction: column;
                gap: 0.75rem;
            }
            .toast {
                display: flex;
                align-items: center;
                padding: 1rem;
                border-radius: 0.75rem;
                box-shadow:
                    0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
                animation: toast-in 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards;
                min-width: 320px;
            }
            .toast.success {
                background-color: #dcfce7;
                color: #166534;
            }
            .toast.error {
                background-color: #fee2e2;
                color: #991b1b;
            }
            html.dark .toast.success {
                background-color: #14532d;
                color: #f0fdf4;
            }
            html.dark .toast.error {
                background-color: #7f1d1d;
                color: #fef2f2;
            }
            @keyframes toast-in {
                from {
                    opacity: 0;
                    transform: translateX(100%);
                }
                to {
                    opacity: 1;
                    transform: translateX(0);
                }
            }

            #sidebar {
                transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }
            #sidebar.collapsed {
                width: 72px;
            }
            #sidebar.collapsed .sidebar-text,
            #sidebar.collapsed .sidebar-header-text,
            #sidebar.collapsed #groups-nav {
                display: none;
            }
            .group-details summary::-webkit-details-marker {
                display: none;
            }
            .group-details summary {
                list-style: none;
            }
            .group-details summary .chevron {
                transition: transform 0.2s;
            }
            .group-details[open] > summary .chevron {
                transform: rotate(90deg);
            }
            .group-details > ul {
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.3s ease-in-out;
            }
            .group-details[open] > ul {
                max-height: 1000px; /* Adjust if menus are very long */
            }
            a.bg-\[var\(--primary\)\]:hover,
            details > summary.bg-\[var\(--primary\)\]:hover {
                background-color: var(--primary);
                filter: brightness(0.9);
            }
            .autocomplete-list {
                z-index: 20;
            }
            .plant-card.selected {
                border-color: var(--primary);
                box-shadow: 0 0 0 2px var(--primary);
            }

            .detail-actions-menu {
                transition:
                    opacity 0.2s ease-out,
                    transform 0.2s ease-out;
            }
            .detail-actions-menu.hidden {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
                pointer-events: none;
            }

            #search-view {
                transition: transform 0.3s ease-in-out;
            }

            /* --- Search Context Styling --- */
            .search-highlight {
                background-color: #fef08a; /* yellow-200 */
                color: #713f12; /* yellow-800 */
                font-weight: 600;
                padding: 0 2px;
                border-radius: 3px;
            }
            html.dark .search-highlight {
                background-color: #a16207; /* yellow-700 */
                color: #fefce8; /* yellow-50 */
            }
            .search-context {
                font-size: 0.8rem;
                color: var(--muted-foreground);
                margin-top: 4px;
                padding-top: 4px;
                border-top: 1px dashed var(--border);
                -webkit-box-orient: vertical;
                -webkit-line-clamp: 2;
                line-clamp: 2;
                overflow: hidden;
                display: -webkit-box;
            }
            .search-context strong {
                color: var(--card-foreground);
            }

            .sticky-group-header {
                position: sticky;
                top: -1rem;
                z-index: 10;
                background-color: var(--background);
                padding: 0.75rem 0 0.75rem 0;
            }

            @media (min-width: 768px) {
                .sticky-group-header {
                    top: -2rem;
                    padding-top: 2.75rem;
                }
            }

            @media (max-width: 767px) {
                #plant-list-container,
                #plant-detail-view,
                #search-results-container {
                    padding-bottom: 80px;
                }
            }
            #search-view-back-label {
                display: none;
            }
            /* DÁN VÀO CUỐI THẺ STYLE */
            .ghost-text-container {
                display: grid;
                grid-template-areas: "content";
            }
            .ghost-text-container > * {
                grid-area: content;
                font: inherit;
                letter-spacing: inherit;
                color: inherit;
                background-color: transparent;
                padding: inherit;
                border: none;
            }
            #search-ghost-text,
            #search-view-ghost-text {
                padding-top: 0.5rem;
                padding-bottom: 0.5rem;
            }
            .autocomplete-item.active {
                background-color: var(--accent);
            }
            #search-ghost-text,
            #search-view-ghost-text {
                opacity: 0.7; /* Độ mờ mặc định cho giao diện sáng */
            }

            html.dark #search-ghost-text,
            html.dark #search-view-ghost-text {
                opacity: 0.4; /* Độ mờ hơn cho giao diện tối */
            }
            .header-hidden {
                max-height: 0 !important;
                opacity: 0 !important;
                padding-top: 0 !important;
                padding-bottom: 0 !important;
                overflow: hidden;
                border-bottom-width: 0px !important;
            }
            #mobile-menu-button {
                position: relative; /* Bắt buộc phải có để z-index hoạt động */
                z-index: 41; /* Cao hơn z-index: 40 của lớp phủ mờ */
            }
            /* Dán vào cuối thẻ style */
            @keyframes flash-animation {
                0% {
                    background-color: rgba(59, 130, 246, 0.3);
                } /* Màu xanh dương nhạt */
                100% {
                    background-color: transparent;
                }
            }
            .flash-highlight {
                animation: flash-animation 3s ease-out;
                border-radius: 8px;
            }
            /* --- FIX GIAO DIỆN QUIZ DARK MODE --- */

            /* 1. Trạng thái bình thường ở Dark Mode */
            html.dark .quiz-option {
                background-color: var(--card); /* Nền tối */
                border-color: var(--border);
                color: var(--foreground); /* Chữ sáng */
            }
            html.dark .quiz-option:hover {
                background-color: var(--accent); /* Hover sáng nhẹ */
            }

            /* 2. Trạng thái ĐÚNG (Override bg-green-100) */
            html.dark .quiz-option.bg-green-100 {
                background-color: rgba(20, 83, 45, 0.5) !important; /* Xanh rêu đậm trong suốt */
                border-color: #22c55e !important; /* Viền xanh lá sáng */
                color: #ecfdf5 !important; /* Chữ trắng xanh */
            }
            /* Xử lý icon tròn khi đúng */
            html.dark .quiz-option.bg-green-100 .border-green-600 {
                border-color: #4ade80 !important;
            }
            html.dark .quiz-option.bg-green-100 .bg-green-600 {
                background-color: #4ade80 !important;
            }

            /* 3. Trạng thái SAI (Override bg-red-100) */
            html.dark .quiz-option.bg-red-100 {
                background-color: rgba(127, 29, 29, 0.5) !important; /* Đỏ mận đậm trong suốt */
                border-color: #ef4444 !important; /* Viền đỏ sáng */
                color: #fef2f2 !important; /* Chữ trắng đỏ */
            }
            /* Xử lý icon tròn khi sai */
            html.dark .quiz-option.bg-red-100 .border-red-600 {
                border-color: #f87171 !important;
            }
            html.dark .quiz-option.bg-red-100 .bg-red-600 {
                background-color: #f87171 !important;
            }

            .grid-locked {
                pointer-events: none !important;
            }
            /* --- CSS CHO ẢNH DƯỢC LIỆU --- */
            .plant-img-thumb {
                width: 100%;
                height: 160px; /* Chiều cao cố định cho ảnh thẻ */
                object-fit: cover; /* Đảm bảo ảnh đầy khung mà không bị méo */
                background-color: var(--muted); /* Màu nền khi ảnh đang tải */
                border-bottom: 1px solid var(--border);
                transition: opacity 0.3s ease;
            }

            .plant-img-detail {
                width: 100%;
                max-height: 400px;
                object-fit: contain; /* Hiển thị trọn vẹn ảnh trong chi tiết */
                background-color: var(--card); /* Nền tối/sáng tùy theme */
                border-radius: 0.75rem;
                margin-bottom: 1.5rem;
                border: 1px solid var(--border);
                box-shadow: var(--shadow-sm);
            }

            /* Ẩn ảnh nếu lỗi tải (để giao diện sạch) */
            img.img-error {
                display: none !important;
            }
            /* Style riêng cho highlight trong thẻ Overlay màu tối */
            .search-context-overlay .search-highlight,
            .plant-card .text-white .search-highlight {
                background-color: rgba(255, 255, 0, 0.3); /* Vàng trong suốt */
                color: #fff;
                padding: 0 2px;
                border-radius: 2px;
            }
            /* Gallery Styles */
.gallery-thumbs {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    padding: 5px 0;
    scrollbar-width: thin;
}
.thumb-item {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    border: 2px solid transparent;
    cursor: pointer;
    object-fit: cover;
    opacity: 0.6;
    transition: all 0.2s;
    flex-shrink: 0;
}
.thumb-item:hover { opacity: 1; }
.thumb-item.active {
    border-color: var(--primary);
    opacity: 1;
    transform: scale(1.05);
}
.img-caption {
    text-align: center;
    font-size: 0.9rem;
    color: var(--muted-foreground);
    margin-top: 8px;
    font-style: italic;
}
/* --- CSS CHO CHẾ ĐỘ ÔN TẬP THỰC HÀNH --- */
.practice-nav-btn {
    width: 2.5rem;
    height: 2.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    border: 1px solid var(--border);
    background: var(--card);
    transition: all 0.2s;
    /* THÊM 2 DÒNG DƯỚI */
    cursor: pointer;
    position: relative; 
    z-index: 10;
}
.practice-nav-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
}
.practice-nav-btn.completed {
    border-color: var(--primary);
    color: var(--primary);
    background: var(--accent);
}

.practice-input-group label {
    font-size: 0.8rem;
    text-transform: uppercase;
    color: var(--muted-foreground);
    font-weight: 600;
    margin-bottom: 0.25rem;
    display: block;
}
.practice-input {
    width: 100%;
    padding: 0.5rem;
    border-radius: 0.5rem;
    border: 1px solid var(--border);
    background: var(--background);
    transition: border-color 0.2s;
}
.practice-input:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px var(--ring);
}
.practice-input.correct {
    border-color: #22c55e;
    background-color: #f0fdf4;
}
.practice-input.incorrect {
    border-color: #ef4444;
    background-color: #fef2f2;
}
html.dark .practice-input.correct { background-color: rgba(34, 197, 94, 0.1); }
html.dark .practice-input.incorrect { background-color: rgba(239, 68, 68, 0.1); }

.diff-result {
    font-size: 0.9rem;
    margin-top: 0.25rem;
}
.diff-correct { color: #16a34a; }
.diff-missed { color: #dc2626; font-style: italic; }
#quiz-question-screen .flex-1.overflow-y-auto {
    padding-bottom: 50vh !important; /* Dành 50% chiều cao màn hình làm đệm */
    scroll-behavior: smooth;
}
/* CSS CHO CHẾ ĐỘ NHANH */
.quick-feedback-overlay {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 50;
    color: white;
    padding: 2rem;
    text-align: center;
    animation: fade-in 0.2s ease-out;
}
.quick-input-container {
    transition: all 0.3s ease;
}
.quick-input-container.shake {
    animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
    border-color: #ef4444;
}
@keyframes shake {
    10%, 90% { transform: translate3d(-1px, 0, 0); }
    20%, 80% { transform: translate3d(2px, 0, 0); }
    30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
    40%, 60% { transform: translate3d(4px, 0, 0); }
}
        </style>
    </head>
    <body class="h-[100dvh] w-screen overflow-hidden">
        <div class="flex h-full w-full">
            <!-- Sidebar -->
            <aside
                id="sidebar"
                class="hidden md:flex flex-col w-72 border-r border-[var(--border)] bg-[var(--card)] p-3"
            >
                <!-- Sidebar content (Desktop) -->
                <div class="flex items-center gap-2 mb-4 px-2">
                    <i data-lucide="sprout" class="text-[var(--primary)] flex-shrink-0"></i>
                    <h1 class="text-xl font-bold sidebar-text">Dược liệu</h1>
                </div>
                <div id="sidebar-top-actions" class="flex items-center gap-2 mb-4 px-1">
                    <div class="relative flex-grow">
                        <i
                            data-lucide="search"
                            class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--muted-foreground)] pointer-events-none z-10"
                        ></i>
                        <div class="relative w-full">
                            <input
                                type="text"
                                id="search-input"
                                placeholder="Tìm kiếm..."
                                class="relative w-full pl-10 pr-9 py-2 rounded-lg border border-[var(--border)] bg-transparent focus:ring-2 focus:ring-[var(--ring)] outline-none transition-all z-10"
                                autocomplete="off"
                            />
                            <button
                                id="search-clear-desktop"
                                class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-[var(--muted-foreground)] hover:bg-[var(--accent)] hover:text-[var(--foreground)] z-20 hidden transition-colors"
                            >
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>

                            <div
                                id="search-ghost-text"
                                class="absolute inset-y-0 left-10 right-9 flex items-center text-[var(--muted-foreground)] pointer-events-none overflow-hidden whitespace-nowrap"
                            ></div>
                        </div>
                        <div
                            id="search-autocomplete-list"
                            class="absolute top-full mt-2 w-full bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg z-20 hidden"
                        ></div>
                    </div>
                </div>
                <div id="sidebar-top-actions-collapsed" class="hidden flex-col items-center gap-2 mb-4">
                    <button
                        id="search-button-collapsed"
                        class="relative group flex-shrink-0 flex items-center justify-center w-10 h-10 hover:bg-[var(--accent)] rounded-lg transition-colors custom-ring"
                    >
                        <i data-lucide="search" class="w-5 h-5 text-[var(--muted-foreground)]"></i>
                    </button>
                </div>
                <h2 class="text-sm font-semibold text-[var(--muted-foreground)] mb-2 px-3 sidebar-header-text">
                    NHÓM CHẤT
                </h2>
                <nav id="groups-nav" class="flex-1 overflow-y-auto no-scrollbar"></nav>
                <div class="mt-auto pt-4 border-t border-[var(--border)]">
                    <div id="sidebar-bottom-actions" class="flex items-center gap-2 overflow-hidden">
                        <div class="flex items-center gap-1 overflow-x-auto no-scrollbar flex-1 pr-1 mask-linear">
                            <button
                                id="practice-list-btn-desktop"
                                class="flex-shrink-0 relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i data-lucide="star" class="w-5 h-5 text-yellow-500 fill-current"></i>
                                <span
                                    class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >DS Thực hành</span
                                >
                            </button>
                            <button
                                data-action="show-quiz"
                                class="flex-shrink-0 relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i data-lucide="brain-circuit" class="w-5 h-5 text-[var(--muted-foreground)]"></i>
                                <span
                                    class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >Trắc nghiệm</span
                                >
                            </button>
                            <button
                                id="import-button-desktop"
                                class="flex-shrink-0 relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i data-lucide="upload" class="w-5 h-5 text-[var(--muted-foreground)]"></i>
                                <span
                                    class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >Nhập</span
                                >
                            </button>
                            <button
                                id="export-button-desktop"
                                class="flex-shrink-0 relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i data-lucide="download" class="w-5 h-5 text-[var(--muted-foreground)]"></i>
                                <span
                                    class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >Xuất</span
                                >
                            </button>
                            <button
                                id="theme-toggle-desktop"
                                class="flex-shrink-0 relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i data-lucide="sun" class="w-5 h-5 text-[var(--muted-foreground)] light-icon"></i>
                                <i
                                    data-lucide="moon"
                                    class="w-5 h-5 text-[var(--muted-foreground)] dark-icon hidden"
                                ></i>
                                <span
                                    class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >Giao diện</span
                                >
                            </button>
                            <button
                                data-action="show-about"
                                class="flex-shrink-0 relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i data-lucide="user-circle-2" class="w-5 h-5 text-[var(--muted-foreground)]"></i>
                                <span
                                    class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >Giới thiệu</span
                                >
                            </button>
                        </div>

                        <div class="flex-shrink-0 border-l border-[var(--border)] pl-1">
                            <button
                                id="sidebar-toggle"
                                class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                            >
                                <i
                                    data-lucide="chevrons-left"
                                    class="w-5 h-5 text-[var(--muted-foreground)] toggle-icon transition-transform"
                                ></i>
                                <span
                                    class="tooltip-text absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                                    >Thu gọn</span
                                >
                            </button>
                        </div>
                    </div>
                    <div id="sidebar-bottom-actions-collapsed" class="hidden space-y-1">
                        <button
                            id="practice-list-btn-collapsed"
                            class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i data-lucide="star" class="w-5 h-5 text-yellow-500 fill-current"></i>
                            <span
                                class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                            >
                                DS Thực hành
                            </span>
                        </button>
                        <button
                            data-action="show-quiz"
                            class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i data-lucide="brain-circuit" class="w-5 h-5 text-[var(--muted-foreground)]"></i>
                            <span
                                class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10"
                            >
                                Trắc nghiệm
                            </span>
                        </button>
                        <button
                            id="import-button-desktop-collapsed"
                            class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i data-lucide="upload" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                            ><span class="text-sm font-medium sidebar-text">Nhập Dữ liệu</span>
                        </button>
                        <button
                            id="export-button-desktop-collapsed"
                            class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i data-lucide="download" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                            ><span class="text-sm font-medium sidebar-text">Xuất Dữ liệu</span>
                        </button>
                        <button
                            id="theme-toggle-desktop-collapsed"
                            class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i data-lucide="sun" class="w-5 h-5 text-[var(--muted-foreground)] light-icon"></i
                            ><i data-lucide="moon" class="w-5 h-5 text-[var(--muted-foreground)] dark-icon hidden"></i>
                            <span class="text-sm font-medium sidebar-text">Giao diện</span>
                        </button>
                        <button
                            data-action="show-about"
                            class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i data-lucide="user-circle-2" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                            ><span class="text-sm font-medium sidebar-text">Giới thiệu</span>
                        </button>
                        <button
                            id="sidebar-toggle-collapsed"
                            class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                        >
                            <i
                                data-lucide="chevrons-right"
                                class="w-5 h-5 text-[var(--muted-foreground)] toggle-icon transition-transform"
                            ></i
                            ><span class="text-sm font-medium sidebar-text">Mở rộng</span>
                        </button>
                    </div>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 flex flex-col relative overflow-hidden">
                <header
                    id="mobile-header"
                    class="flex md:hidden items-center justify-between p-2 border-b border-[var(--border)] bg-[var(--card)]"
                >
                    <div class="flex items-center gap-2">
                        <button id="mobile-menu-button" class="p-2 rounded-md hover:bg-[var(--accent)] custom-ring">
                            <i data-lucide="menu" class="menu-icon"></i>
                        </button>
                        <div id="mobile-logo-action" class="flex items-center gap-2 cursor-pointer select-none">
                            <i data-lucide="sprout" class="text-[var(--primary)]"></i>
                            <h1 class="text-xl font-bold">Dược liệu</h1>
                        </div>
                    </div>

                    <button id="mobile-search-button" class="p-2 rounded-md hover:bg-[var(--accent)] custom-ring">
                        <i data-lucide="search"></i>
                    </button>
                </header>
                <div
                    id="sticky-header"
                    class="md:hidden fixed top-0 left-0 right-0 z-30 flex items-center gap-4 p-2 border-b border-[var(--border)] bg-[var(--card)]/80 backdrop-blur-sm transition-transform duration-300 ease-in-out -translate-y-full"
                >
                    <button id="sticky-back-button" class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring">
                        <i data-lucide="arrow-left"></i>
                    </button>
                    <div class="flex-1 text-center overflow-hidden">
                        <h3 id="sticky-title" class="font-bold text-base truncate"></h3>
                        <p id="sticky-subtitle" class="text-xs text-[var(--muted-foreground)] truncate"></p>
                    </div>
                    <button id="sticky-home-button" class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring">
                        <i data-lucide="home" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="plant-list-container" class="flex-1 overflow-y-auto p-4 md:p-8">
                    <!-- Welcome screen and plant grid -->
                    <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                        <div class="p-6 bg-[var(--card)] rounded-full mb-4">
                            <i data-lucide="book-open-text" class="w-16 h-16 text-[var(--primary)]"></i>
                        </div>
                        <h2 class="text-2xl font-bold mb-2">Chào mừng bạn!</h2>
                        <p class="max-w-md text-[var(--muted-foreground)] mb-6">
                            Bắt đầu bằng cách nhập dữ liệu có sẵn, hoặc tìm kiếm trong danh sách dược liệu của bạn.
                        </p>
                        <p id="plant-count" class="text-sm text-[var(--muted-foreground)] mb-4"></p>
                    </div>
                    <div id="plant-list-grid"></div>
                </div>
                <div
                    id="plant-detail-view"
                    class="flex-1 overflow-y-auto p-4 md:p-8 bg-[var(--background)] hidden"
                ></div>
                <div id="quiz-view" class="flex-1 overflow-y-auto p-4 md:p-8 bg-[var(--background)] hidden">
                    <div class="max-w-2xl mx-auto h-full flex flex-col justify-center">
                        <div id="quiz-start-screen" class="text-center space-y-6">
                            <div class="flex justify-start w-full mb-2">
                                <button
                                    id="quiz-start-back-btn"
                                    class="flex items-center gap-1 text-[var(--muted-foreground)] hover:text-[var(--primary)] font-medium p-2 -ml-2 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                                >
                                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                                    <span>Quay lại</span>
                                </button>
                            </div>

                            <div class="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto">
                                <i data-lucide="graduation-cap" class="w-10 h-10 text-blue-600"></i>
                            </div>
                            <h2 class="text-3xl font-bold">Ôn tập Dược liệu</h2>
                            <div
                                class="bg-[var(--card)] border border-[var(--border)] rounded-xl p-4 text-left max-w-lg mx-auto"
                            >
                                <h3 class="font-semibold mb-3 flex items-center gap-2">
                                    <i data-lucide="filter" class="w-4 h-4"></i> Cấu hình nội dung thi:
                                </h3>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="quiz-settings-form">
                                    <label
                                        class="flex items-center space-x-3 p-2 rounded-lg hover:bg-[var(--accent)] cursor-pointer border border-transparent hover:border-[var(--border)] transition-all"
                                    >
                                        <input
                                            type="checkbox"
                                            name="quiz-type"
                                            value="family"
                                            checked
                                            class="w-5 h-5 text-[var(--primary)] rounded focus:ring-[var(--primary)] border-gray-300"
                                        />
                                        <span class="text-sm">Họ thực vật</span>
                                    </label>
                                    <label
                                        class="flex items-center space-x-3 p-2 rounded-lg hover:bg-[var(--accent)] cursor-pointer border border-transparent hover:border-[var(--border)] transition-all"
                                    >
                                        <input
                                            type="checkbox"
                                            name="quiz-type"
                                            value="chem"
                                            checked
                                            class="w-5 h-5 text-[var(--primary)] rounded focus:ring-[var(--primary)] border-gray-300"
                                        />
                                        <span class="text-sm">Thành phần hóa học</span>
                                    </label>
                                    <label
                                        class="hidden flex items-center space-x-3 p-2 rounded-lg hover:bg-[var(--accent)] cursor-pointer border border-transparent hover:border-[var(--border)] transition-all"
                                    >
                                        <input
                                            type="checkbox"
                                            name="quiz-type"
                                            value="use"
                                            class="w-5 h-5 text-[var(--primary)] rounded focus:ring-[var(--primary)] border-gray-300"
                                        />
                                        <span class="text-sm">Công dụng & Tác dụng (Tạm khóa)</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-4 justify-center w-full">
                                <button
                                    id="start-quiz-btn"
                                    class="flex-1 sm:flex-none px-8 py-3 bg-[var(--primary)] text-white rounded-xl font-bold hover:opacity-90 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 flex items-center justify-center gap-2"
                                >
                                    <i data-lucide="layers" class="w-5 h-5"></i>
                                    Tất cả danh sách
                                </button>
                                <button
                                    id="start-practice-quiz-btn"
                                    class="flex-1 sm:flex-none px-8 py-3 bg-orange-600 text-white rounded-xl font-bold hover:opacity-90 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 flex items-center justify-center gap-2"
                                >
                                    <i data-lucide="image" class="w-5 h-5 fill-current"></i> Ôn tập Thực hành (Xem hình)
                                </button>
                                <button
        id="start-quick-practice-btn"
        class="flex-1 sm:flex-none px-8 py-3 bg-green-600 text-white rounded-xl font-bold hover:opacity-90 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1 flex items-center justify-center gap-2"
    >
        <i data-lucide="zap" class="w-5 h-5 fill-current"></i> 
        Ôn tập Nhanh
    </button>
                            </div>
                        </div>

                        <div id="quiz-question-screen" class="hidden flex flex-col h-full relative overflow-hidden bg-[var(--background)]">
    <div class="flex-shrink-0 z-10 p-2 border-b border-[var(--border)] bg-[var(--card)] flex justify-between items-center">
        <button id="quiz-quit-btn" class="flex items-center gap-1 text-[var(--muted-foreground)] hover:text-[var(--primary)] font-medium p-2 rounded-lg hover:bg-[var(--accent)] transition-colors text-sm">
            <i data-lucide="arrow-left" class="w-4 h-4"></i> Thoát
        </button>
        <h3 class="font-bold text-lg">Thi Thực hành</h3>
        <button id="practice-submit-all" class="px-4 py-1.5 bg-[var(--primary)] text-white text-sm font-bold rounded-lg shadow-sm hover:opacity-90">
            Nộp bài
        </button>
    </div>

    <div class="flex-shrink-0 p-3 flex justify-center gap-2 overflow-x-auto" id="practice-nav-container">
        </div>

    <div class="flex-1 overflow-y-auto p-4">
        <div class="max-w-5xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
            
            <div class="flex flex-col">
                <div class="relative aspect-square md:aspect-[4/3] rounded-xl overflow-hidden border border-[var(--border)] bg-black/5 shadow-inner">
                    <img id="practice-image" src="" class="w-full h-full object-contain" alt="Dược liệu">
                    <div class="absolute inset-0 flex items-center justify-center -z-10 text-[var(--muted-foreground)]">
                        <i data-lucide="image-off" class="w-10 h-10"></i>
                    </div>
                </div>
                <p class="text-center text-sm text-[var(--muted-foreground)] mt-2 italic">Quan sát kỹ đặc điểm trong ảnh để định danh.</p>
            </div>

            <div class="flex flex-col gap-4 bg-[var(--card)] p-4 rounded-xl border border-[var(--border)] shadow-sm">
                <div class="practice-input-group">
                    <label>Tên Dược liệu</label>
                    <input type="text" class="practice-input" data-field="name" placeholder="Nhập tên cây...">
                    <div class="diff-container" id="res-name"></div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="practice-input-group">
                        <label>Họ (Tiếng Việt)</label>
                        <input type="text" class="practice-input" data-field="familyVn" placeholder="Vd: Họ Cà phê">
                        <div class="diff-container" id="res-familyVn"></div>
                    </div>
                    <div class="practice-input-group">
                        <label>Họ (Khoa học)</label>
                        <input type="text" class="practice-input" data-field="familySci" placeholder="Vd: Rubiaceae">
                        <div class="diff-container" id="res-familySci"></div>
                    </div>
                </div>

                <div class="practice-input-group">
                    <label>Bộ phận dùng</label>
                    <input type="text" class="practice-input" data-field="part" placeholder="Vd: Rễ, củ...">
                    <div class="diff-container" id="res-part"></div>
                </div>

                <div class="practice-input-group">
                    <label>Thành phần hóa học chính</label>
                    <input type="text" class="practice-input" data-field="chem" placeholder="Vd: Alcaloid, Strychnin...">
                    <div class="diff-container" id="res-chem"></div>
                </div>
            </div>
        </div>
    </div>
</div>

                        <div id="quiz-result-screen" class="hidden text-center space-y-6">
                            <h2 class="text-3xl font-bold">Kết quả</h2>
                            <div class="text-6xl font-black text-[var(--primary)]" id="quiz-final-score">0/10</div>
                            <p id="quiz-result-message" class="text-[var(--muted-foreground)]"></p>
                            <div class="flex justify-center gap-4">
                                <button
                                    id="quiz-home-btn"
                                    class="px-6 py-2 border border-[var(--border)] rounded-lg hover:bg-[var(--accent)]"
                                >
                                    Về trang chủ
                                </button>
                                <button
                                    id="quiz-restart-btn"
                                    class="px-6 py-2 bg-[var(--primary)] text-white rounded-lg hover:opacity-90"
                                >
                                    Làm lại
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Selection Toolbar -->
                <div
                    id="selection-toolbar"
                    class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 bg-[var(--card)] border border-[var(--border)] rounded-full shadow-lg p-2 flex items-center gap-2 z-30 transition-all"
                >
                    <span id="selection-count" class="text-sm font-medium px-3"></span>
                    <button
                        id="deselect-all-btn"
                        class="flex items-center justify-center w-10 h-10 text-[var(--muted-foreground)] rounded-full hover:bg-[var(--accent)] transition-colors custom-ring"
                        title="Bỏ chọn tất cả"
                    >
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                    <button
                        id="delete-selected-btn"
                        class="flex items-center justify-center w-10 h-10 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors custom-ring"
                        title="Xóa mục đã chọn"
                    >
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
                <div
                    id="edit-toolbar"
                    class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 bg-[var(--card)] border border-[var(--border)] rounded-full shadow-lg p-2 flex items-center gap-2 z-30 transition-all"
                >
                    <button
                        id="cancel-edit-btn"
                        class="flex items-center justify-center w-10 h-10 text-[var(--muted-foreground)] rounded-full hover:bg-[var(--accent)] transition-colors custom-ring"
                        title="Hủy thay đổi"
                    >
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                    <span class="text-sm font-medium px-3 text-[var(--muted-foreground)]">Chế độ chỉnh sửa</span>
                    <button
                        id="save-edit-btn"
                        class="flex items-center justify-center w-10 h-10 bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors custom-ring"
                        title="Lưu thay đổi"
                    >
                        <i data-lucide="check" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="about-view" class="flex-1 overflow-y-auto p-4 md:p-8 bg-[var(--background)] hidden">
                    <div class="max-w-4xl mx-auto">
                        <div
                            class="md:hidden -mx-4 px-2 pt-2 pb-1 mb-2 top-0 bg-[var(--background)]/80 backdrop-blur-sm z-20 flex items-center justify-between"
                        >
                            <button
                                id="back-from-about-mobile"
                                class="flex items-center gap-1 text-sm font-medium text-[var(--primary)] p-2 rounded-lg custom-ring"
                            >
                                <i data-lucide="chevron-left" class="w-5 h-5 flex-shrink-0"></i>
                                <span class="truncate">Quay lại</span>
                            </button>
                        </div>

                        <div class="hidden md:flex items-center mb-4">
                            <button
                                id="back-from-about-desktop"
                                class="flex items-center gap-2 text-[var(--muted-foreground)] hover:text-[var(--primary)] transition-colors font-medium custom-ring rounded-md -ml-2 p-1"
                            >
                                <i data-lucide="arrow-left"></i>
                                <span>Quay lại</span>
                            </button>
                        </div>

                        <div
                            class="bg-[var(--card)] rounded-xl border border-[var(--border)] p-6 md:p-8 text-center animate-on-scroll"
                        >
                            <h2 class="text-3xl font-bold">Nguyễn Ngọc Tiệp</h2>
                            <p class="text-lg text-[var(--muted-foreground)] mt-1">@eu_2iw</p>
                            <p class="max-w-2xl mx-auto mt-4 text-base">
                                Liên hệ Zalo để được hỗ trợ thêm về ứng dụng hoặc đóng góp ý kiến.
                            </p>

                            <div class="mt-8 flex justify-center items-center gap-4">
                                <a
                                    href="https://zalo.me/0867832917"
                                    target="_blank"
                                    class="p-3 bg-[var(--secondary)] hover:bg-[var(--accent)] rounded-full custom-ring"
                                    title="Zalo"
                                >
                                    <i data-lucide="phone" class="w-6 h-6"></i>
                                </a>
                                <a
                                    href="https://www.instagram.com/eu_2iw/"
                                    target="_blank"
                                    class="p-3 bg-[var(--secondary)] hover:bg-[var(--accent)] rounded-full custom-ring"
                                    title="Instagram"
                                >
                                    <i data-lucide="instagram" class="w-6 h-6"></i>
                                </a>
                            </div>
                        </div>

                        <footer class="text-center mt-8 text-sm text-[var(--muted-foreground)]">
                            <p>Từ điển Dược liệu Thông minh &copy; 2025</p>
                        </footer>
                    </div>
                </div>
            </main>
        </div>

        <!-- Search View (Mobile) -->
        <div
            id="search-view"
            class="md:hidden fixed inset-0 bg-[var(--background)] z-50 transform translate-x-full flex flex-col"
        >
            <header class="flex-shrink-0 flex items-center gap-2 p-2 border-b border-[var(--border)] bg-[var(--card)]">
                <button
                    id="search-view-back-button"
                    class="flex items-center gap-1 text-sm font-medium text-[var(--primary)] p-2 rounded-lg custom-ring -ml-2"
                >
                    <i data-lucide="chevron-left" class="w-5 h-5 flex-shrink-0"></i>
                    <span id="search-view-back-label" class="truncate">Quay lại</span>
                </button>
                <div class="relative flex-grow">
                    <i
                        data-lucide="search"
                        class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--muted-foreground)] pointer-events-none z-10"
                    ></i>
                    <div class="relative w-full">
                        <input
                            type="text"
                            id="search-view-input"
                            placeholder="Tìm kiếm dược liệu..."
                            class="relative w-full pl-10 pr-9 py-2 rounded-lg border-none bg-transparent focus:ring-0 outline-none z-10"
                            autocomplete="off"
                        />
                        <button
                            id="search-clear-mobile"
                            class="absolute right-2 top-1/2 -translate-y-1/2 p-1 rounded-full text-[var(--muted-foreground)] hover:bg-[var(--accent)] hover:text-[var(--foreground)] z-20 hidden transition-colors"
                        >
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>

                        <div
                            id="search-view-ghost-text"
                            class="absolute inset-y-0 left-10 right-9 flex items-center text-[var(--muted-foreground)] pointer-events-none overflow-hidden whitespace-nowrap"
                        ></div>
                    </div>
                </div>
            </header>
            <div id="search-results-container" class="flex-1 overflow-y-auto p-4">
                <div id="search-results-grid"></div>
            </div>
        </div>

        <!-- Mobile Menu -->
        <div id="mobile-menu" class="fixed inset-0 bg-black/40 z-40 hidden">
            <aside class="absolute inset-y-0 left-0 w-72 bg-[var(--card)] p-4 flex flex-col">
                <div class="flex items-center justify-between gap-2 mb-6"></div>
                <h2 class="text-sm font-semibold text-[var(--muted-foreground)] mb-2 px-2">NHÓM CHẤT</h2>
                <nav id="groups-nav-mobile" class="flex-1 overflow-y-auto no-scrollbar"></nav>
                <div class="mt-4 pt-4 border-t border-[var(--border)] space-y-2">
                    <button
                        id="practice-list-btn-mobile"
                        class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                    >
                        <i data-lucide="star" class="w-5 h-5 text-yellow-500 fill-current"></i>
                        <span class="text-sm font-medium">Danh sách Thực hành</span>
                    </button>
                    <button
                        data-action="show-quiz"
                        class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                    >
                        <i data-lucide="brain-circuit" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                        ><span class="text-sm font-medium">Trắc nghiệm</span>
                    </button>
                    <button
                        id="import-button-mobile"
                        class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                    >
                        <i data-lucide="upload" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                        ><span class="text-sm font-medium">Nhập Dữ liệu</span>
                    </button>
                    <button
                        id="export-button-mobile"
                        class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                    >
                        <i data-lucide="download" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                        ><span class="text-sm font-medium">Xuất Dữ liệu</span>
                    </button>
                    <button
                        id="theme-toggle-mobile"
                        class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                    >
                        <i data-lucide="sun" class="w-5 h-5 text-[var(--muted-foreground)] light-icon"></i
                        ><i data-lucide="moon" class="w-5 h-5 text-[var(--muted-foreground)] dark-icon hidden"></i>
                        <span class="text-sm font-medium">Giao diện</span>
                    </button>
                    <button
                        data-action="show-about"
                        class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"
                    >
                        <i data-lucide="user-circle-2" class="w-5 h-5 text-[var(--muted-foreground)]"></i
                        ><span class="text-sm font-medium">Giới thiệu</span>
                    </button>
                </div>
            </aside>
        </div>

        <!-- Context Menu, Modals, Toast -->

        <dialog id="plant-modal" class="p-0 rounded-xl shadow-2xl w-11/12 max-w-2xl">
            <form id="plant-form" class="p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="modal-title" class="text-2xl font-bold">Chỉnh sửa Dược liệu</h2>
                    <button
                        type="button"
                        id="close-modal-button"
                        class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring"
                    >
                        <i data-lucide="x"></i>
                    </button>
                </div>
                <input type="hidden" id="plant-id" />
                <div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="relative">
                            <label
                                for="ten-duoc-lieu-input"
                                class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                                >Tên dược liệu</label
                            >
                            <input
                                type="text"
                                id="ten-duoc-lieu-input"
                                required
                                class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                            />
                        </div>
                        <div class="relative">
                            <label
                                for="ho-cay-input"
                                class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                                >Họ cây</label
                            >
                            <input
                                type="text"
                                id="ho-cay-input"
                                autocomplete="off"
                                required
                                class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                            />
                            <div
                                id="ho-cay-list"
                                class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"
                            ></div>
                        </div>
                    </div>
                    <div class="relative">
                        <label
                            for="nhom-chat-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Nhóm chất</label
                        >
                        <input
                            type="text"
                            id="nhom-chat-input"
                            placeholder="Vd: Alkaloid > Indol, Flavonoid"
                            required
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        />
                        <div
                            id="nhom-chat-list"
                            class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"
                        ></div>
                    </div>
                    <div class="relative">
                        <label
                            for="thanh-phan-hoa-hoc-chinh-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Thành phần hóa học chính</label
                        >
                        <input
                            type="text"
                            id="thanh-phan-hoa-hoc-chinh-input"
                            placeholder="Vd: Reserpin, Rutin, Strychnin"
                            required
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        />
                        <div
                            id="thanh-phan-hoa-hoc-chinh-list"
                            class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"
                        ></div>
                    </div>
                    <div class="relative">
                        <label
                            for="bo-phan-dung-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Bộ phận dùng</label
                        >
                        <input
                            type="text"
                            id="bo-phan-dung-input"
                            required
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        />
                        <div
                            id="bo-phan-dung-list"
                            class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"
                        ></div>
                    </div>
                    <div class="relative">
                        <label
                            for="tac-dung-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Tác dụng</label
                        >
                        <textarea
                            id="tac-dung-input"
                            rows="3"
                            required
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        ></textarea>
                        <div
                            id="tac-dung-list"
                            class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"
                        ></div>
                    </div>
                    <div class="relative">
                        <label
                            for="cong-dung-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Công dụng</label
                        >
                        <textarea
                            id="cong-dung-input"
                            rows="3"
                            required
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        ></textarea>
                        <div
                            id="cong-dung-list"
                            class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"
                        ></div>
                    </div>
                    <div class="relative">
                        <label
                            for="lieu-dung-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Liều dùng</label
                        >
                        <textarea
                            id="lieu-dung-input"
                            rows="2"
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        ></textarea>
                    </div>
                    <div class="relative">
                        <label for="luu-y-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Lưu ý</label
                        >
                        <textarea
                            id="luu-y-input"
                            rows="2"
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        ></textarea>
                    </div>
                    <div class="relative">
                        <label
                            for="dac-diem-duoc-lieu-input"
                            class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]"
                            >Đặc điểm dược liệu</label
                        >
                        <textarea
                            id="dac-diem-duoc-lieu-input"
                            rows="3"
                            class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"
                        ></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end gap-3">
                    <button
                        type="button"
                        id="cancel-button"
                        class="px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--secondary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring"
                    >
                        Hủy
                    </button>
                    <button
                        type="submit"
                        class="px-4 py-2 rounded-lg bg-[var(--primary)] text-[var(--primary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring"
                    >
                        Lưu
                    </button>
                </div>
            </form>
        </dialog>
        <dialog id="import-options-modal" class="p-0 rounded-xl shadow-2xl w-11/12 max-w-md">
            <div class="p-6">
                <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
                        <i data-lucide="file-down" class="h-6 w-6 text-blue-600"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium leading-6">Tùy chọn Nhập Dữ liệu</h3>
                        <p id="import-info" class="mt-1 text-sm text-[var(--muted-foreground)]"></p>
                    </div>
                </div>
                <div class="mt-6 flex flex-col gap-3">
                    <button
                        id="import-overwrite-btn"
                        class="w-full text-left p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring border border-[var(--border)]"
                    >
                        <p class="font-semibold">Ghi đè toàn bộ (Reset)</p>
                        <p class="text-sm text-[var(--muted-foreground)]">
                            Xóa sạch dữ liệu cũ và thay thế bằng file mới.
                        </p>
                    </button>

                    <button
                        id="import-update-btn"
                        class="w-full text-left p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring border border-[var(--border)] bg-blue-50/50 border-blue-200"
                    >
                        <p class="font-semibold text-blue-700">Cập nhật thông minh (Smart Update)</p>
                        <p class="text-sm text-[var(--muted-foreground)]">
                            Tìm cây theo ID hoặc Tên. Chỉ đè lên các trường có trong file, giữ nguyên thông tin khác.
                        </p>
                    </button>
                    <button
                        id="import-merge-btn"
                        class="w-full text-left p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring border border-[var(--border)]"
                    >
                        <p class="font-semibold">Hợp nhất (Chỉ thêm mới)</p>
                        <p class="text-sm text-[var(--muted-foreground)]">Giữ lại dữ liệu cũ, chỉ thêm cây chưa có.</p>
                    </button>
                    <button
                        id="import-cancel-btn"
                        class="mt-4 w-full px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--secondary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring"
                    >
                        Hủy
                    </button>
                </div>
            </div>
        </dialog>
        <dialog id="confirm-modal" class="p-0 rounded-xl shadow-2xl w-11/12 max-w-sm">
            <div class="p-6 text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-yellow-600"></i>
                </div>
                <h3 class="text-lg font-medium">Bạn có chắc không?</h3>
                <p id="confirm-message" class="mt-2 text-sm text-[var(--muted-foreground)]"></p>
                <div class="mt-6 flex justify-center gap-3">
                    <button
                        id="confirm-cancel"
                        class="px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--secondary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring"
                    >
                        Hủy
                    </button>
                    <button
                        id="confirm-proceed"
                        class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors custom-ring"
                    >
                        Xác nhận
                    </button>
                </div>
            </div>
        </dialog>
        <div id="toast-container"></div>

        <script>
            document.addEventListener("DOMContentLoaded", () => {
                class MedicinalPlantApp {
                    constructor() {
                        this.plants = [];
                        this.currentFilter = { group: "all", search: "" };
                        this.lastScrollY = 0;
                        this.handleListScroll = this.handleListScroll.bind(this);
                        this.activeAutocomplete = null;
                        this.selectedPlants = new Set();

                        this.isTransitioning = false;
                        this.observer = null;
                        this.currentView = { type: "list" };
                        this.isDetailEditing = false;
                        this.currentListTitle = "Tất cả Dược liệu";
                        this.postRenderAction = null;

                        this.initDataLists();
                        this.initDOMElements();
                        this.initIntersectionObserver();
                        this.loadPlants();
                        this.initHistory();
                        this.initEventListeners();
                        this.initTheme();
                        this.initSidebarState();
                        history.scrollRestoration = "manual";
                    }
                    openMenu() {
                        this.els.mobileMenu.classList.remove("hidden");
                        setTimeout(() => this.els.mobileMenu.classList.add("is-open"), 10);
                        // Đã xóa dòng toggle class hidden cho icon
                    }

                    closeMenu() {
                        this.els.mobileMenu.classList.remove("is-open");
                        setTimeout(() => this.els.mobileMenu.classList.add("hidden"), 300);
                        // Đã xóa dòng toggle class hidden cho icon
                    }
                    _normalizeText(str) {
                        if (!str) return "";
                        return str
                            .toString()
                            .toLowerCase()
                            .normalize("NFD")
                            .replace(/[\u0300-\u036f]/g, "")
                            .replace(/đ/g, "d");
                    }
                    _normalizeGroup(str) {
                        if (!str) return "";
                        return str.trim().replace(/\s*\(.*\)\s*$/g, "");
                    }

                    isMobile() {
                        return window.innerWidth < 768;
                    }

                    initIntersectionObserver() {
                        const options = { root: null, rootMargin: "0px", threshold: 0.1 };
                        this.observer = new IntersectionObserver((entries, observer) => {
                            entries.forEach((entry) => {
                                if (entry.isIntersecting) {
                                    entry.target.classList.add("is-visible");
                                    observer.unobserve(entry.target);
                                }
                            });
                        }, options);
                    }

                    initDataLists() {
                        this.dataLists = {
                            families: [
                                { s: "Acanthaceae", v: "Họ Ô rô" },
                                { s: "Amaranthaceae", v: "Họ Dền" },
                                { s: "Apiaceae", v: "Họ Hoa tán" },
                                { s: "Apocynaceae", v: "Họ Trúc đào" },
                                { s: "Araceae", v: "Họ Ráy" },
                                { s: "Araliaceae", v: "Họ Nhân sâm" },
                                { s: "Asteraceae", v: "Họ Cúc" },
                                { s: "Balsaminaceae", v: "Họ Bóng nước" },
                                { s: "Bignoniaceae", v: "Họ Chùm ớt" },
                                { s: "Boraginaceae", v: "Họ Vòi voi" },
                                { s: "Brassicaceae", v: "Họ Cải" },
                                { s: "Burseraceae", v: "Họ Trám" },
                                { s: "Caesalpiniaceae", v: "Họ Vang" },
                                { s: "Campanulaceae", v: "Họ Hoa chuông" },
                                { s: "Capparaceae", v: "Họ Màn màn" },
                                { s: "Celastraceae", v: "Họ Dây gối" },
                                { s: "Clusiaceae", v: "Họ Bứa" },
                                { s: "Combretaceae", v: "Họ Bàng" },
                                { s: "Convolvulaceae", v: "Họ Bìm bìm" },
                                { s: "Crassulaceae", v: "Họ Thuốc bỏng" },
                                { s: "Cucurbitaceae", v: "Họ Bầu bí" },
                                { s: "Cyperaceae", v: "Họ Cói" },
                                { s: "Dioscoreaceae", v: "Họ Củ nâu" },
                                { s: "Euphorbiaceae", v: "Họ Thầu dầu" },
                                { s: "Fabaceae", v: "Họ Đậu" },
                                { s: "Gentianaceae", v: "Họ Long đởm" },
                                { s: "Gesneriaceae", v: "Họ Tai voi" },
                                { s: "Lamiaceae", v: "Họ Hoa môi" },
                                { s: "Lauraceae", v: "Họ Long não" },
                                { s: "Lecythidaceae", v: "Họ Lộc vừng" },
                                { s: "Liliaceae", v: "Họ Loa kèn" },
                                { s: "Loganiaceae", v: "Họ Mã tiền" },
                                { s: "Lythraceae", v: "Họ Bằng lăng" },
                                { s: "Malvaceae", v: "Họ Bông" },
                                { s: "Melastomataceae", v: "Họ Mua" },
                                { s: "Meliaceae", v: "Họ Xoan" },
                                { s: "Menispermaceae", v: "Họ Tiết dê" },
                                { s: "Mimosaceae", v: "Họ Trinh nữ" },
                                { s: "Moraceae", v: "Họ Dâu tằm" },
                                { s: "Myrtaceae", v: "Họ Sim" },
                                { s: "Orchidaceae", v: "Họ Lan" },
                                { s: "Passifloraceae", v: "Họ Lạc tiên" },
                                { s: "Phyllanthaceae", v: "Họ Diệp hạ châu" },
                                { s: "Piperaceae", v: "Họ Hồ tiêu" },
                                { s: "Poaceae", v: "Họ Lúa" },
                                { s: "Polygonaceae", v: "Họ Rau răm" },
                                { s: "Ranunculaceae", v: "Họ Hoàng liên" },
                                { s: "Rhamnaceae", v: "Họ Táo ta" },
                                { s: "Rosaceae", v: "Họ Hoa hồng" },
                                { s: "Rubiaceae", v: "Họ Cà phê" },
                                { s: "Rutaceae", v: "Họ Cam" },
                                { s: "Sapindaceae", v: "Họ Bồ hòn" },
                                { s: "Scrophulariaceae", v: "Họ Mõm sói" },
                                { s: "Solanaceae", v: "Họ Cà" },
                                { s: "Sterculiaceae", v: "Họ Trôm" },
                                { s: "Thymelaeaceae", v: "Họ Trầm" },
                                { s: "Urticaceae", v: "Họ Gai" },
                                { s: "Verbenaceae", v: "Họ Cỏ roi ngựa" },
                                { s: "Violaceae", v: "Họ Hoa tím" },
                                { s: "Vitaceae", v: "Họ Nho" },
                                { s: "Zingiberaceae", v: "Họ Gừng" },
                            ].sort((a, b) => a.s.localeCompare(b.s)),
                        };
                    }

                    initDOMElements() {
                        this.els = {
                            sidebar: document.getElementById("sidebar"),
                            sidebarToggle: document.getElementById("sidebar-toggle"),
                            sidebarToggleCollapsed: document.getElementById("sidebar-toggle-collapsed"),
                            searchInput: document.getElementById("search-input"),
                            searchClearDesktop: document.getElementById("search-clear-desktop"),
                            groupsNav: document.getElementById("groups-nav"),
                            groupsNavMobile: document.getElementById("groups-nav-mobile"),
                            plantListContainer: document.getElementById("plant-list-container"),
                            plantListGrid: document.getElementById("plant-list-grid"),
                            plantDetailView: document.getElementById("plant-detail-view"),
                            plantModal: document.getElementById("plant-modal"),
                            plantForm: document.getElementById("plant-form"),
                            modalTitle: document.getElementById("modal-title"),
                            closeModalButton: document.getElementById("close-modal-button"),
                            cancelButton: document.getElementById("cancel-button"),
                            plantIdInput: document.getElementById("plant-id"),
                            welcomeScreen: document.getElementById("welcome-screen"),
                            plantCount: document.getElementById("plant-count"),
                            importButtonDesktop: document.getElementById("import-button-desktop"),
                            exportButtonDesktop: document.getElementById("export-button-desktop"),
                            themeToggleDesktop: document.getElementById("theme-toggle-desktop"),
                            importButtonDesktopCollapsed: document.getElementById("import-button-desktop-collapsed"),
                            exportButtonDesktopCollapsed: document.getElementById("export-button-desktop-collapsed"),
                            themeToggleDesktopCollapsed: document.getElementById("theme-toggle-desktop-collapsed"),
                            mobileHeader: document.getElementById("mobile-header"),
                            mobileLogoAction: document.getElementById("mobile-logo-action"),
                            mobileMenuButton: document.getElementById("mobile-menu-button"),
                            mobileMenu: document.getElementById("mobile-menu"),
                            stickyHeader: document.getElementById("sticky-header"),
                            stickyTitle: document.getElementById("sticky-title"),
                            stickySubtitle: document.getElementById("sticky-subtitle"),
                            searchViewBackLabel: document.getElementById("search-view-back-label"),
                            stickyBackButton: document.getElementById("sticky-back-button"),
                            stickyHomeButton: document.getElementById("sticky-home-button"),
                            importButtonMobile: document.getElementById("import-button-mobile"),
                            exportButtonMobile: document.getElementById("export-button-mobile"),
                            themeToggles: document.querySelectorAll(
                                "#theme-toggle-desktop, #theme-toggle-desktop-collapsed, #theme-toggle-mobile"
                            ),
                            toastContainer: document.getElementById("toast-container"),
                            confirmModal: document.getElementById("confirm-modal"),
                            confirmMessage: document.getElementById("confirm-message"),
                            confirmCancel: document.getElementById("confirm-cancel"),
                            confirmProceed: document.getElementById("confirm-proceed"),

                            selectionToolbar: document.getElementById("selection-toolbar"),
                            selectionCount: document.getElementById("selection-count"),
                            deleteSelectedBtn: document.getElementById("delete-selected-btn"),
                            deselectAllBtn: document.getElementById("deselect-all-btn"),
                            importOptionsModal: document.getElementById("import-options-modal"),
                            importInfo: document.getElementById("import-info"),
                            importOverwriteBtn: document.getElementById("import-overwrite-btn"),
                            importUpdateBtn: document.getElementById("import-update-btn"),
                            importMergeBtn: document.getElementById("import-merge-btn"),
                            importCancelBtn: document.getElementById("import-cancel-btn"),
                            tenDuocLieu: {
                                input: document.getElementById("ten-duoc-lieu-input"),
                            },
                            hoCay: {
                                input: document.getElementById("ho-cay-input"),
                                list: document.getElementById("ho-cay-list"),
                            },
                            nhomChat: {
                                input: document.getElementById("nhom-chat-input"),
                                list: document.getElementById("nhom-chat-list"),
                            },
                            thanhPhanHoaHocChinh: {
                                input: document.getElementById("thanh-phan-hoa-hoc-chinh-input"),
                                list: document.getElementById("thanh-phan-hoa-hoc-chinh-list"),
                            },
                            boPhanDung: {
                                input: document.getElementById("bo-phan-dung-input"),
                                list: document.getElementById("bo-phan-dung-list"),
                            },
                            tacDung: {
                                input: document.getElementById("tac-dung-input"),
                                list: document.getElementById("tac-dung-list"),
                            },
                            congDung: {
                                input: document.getElementById("cong-dung-input"),
                                list: document.getElementById("cong-dung-list"),
                            },
                            lieuDung: { input: document.getElementById("lieu-dung-input") },
                            luuY: { input: document.getElementById("luu-y-input") },
                            dacDiemDuocLieu: {
                                input: document.getElementById("dac-diem-duoc-lieu-input"),
                            },
                            sidebarTopActions: document.getElementById("sidebar-top-actions"),
                            sidebarTopActionsCollapsed: document.getElementById("sidebar-top-actions-collapsed"),
                            searchButtonCollapsed: document.getElementById("search-button-collapsed"),
                            sidebarBottomActions: document.getElementById("sidebar-bottom-actions"),
                            sidebarBottomActionsCollapsed: document.getElementById("sidebar-bottom-actions-collapsed"),
                            mobileSearchButton: document.getElementById("mobile-search-button"),
                            searchView: document.getElementById("search-view"),
                            searchViewBackButton: document.getElementById("search-view-back-button"),
                            searchViewInput: document.getElementById("search-view-input"),
                            searchClearMobile: document.getElementById("search-clear-mobile"),
                            searchResultsGrid: document.getElementById("search-results-grid"),
                            searchGhostText: document.getElementById("search-ghost-text"),
                            searchAutocompleteList: document.getElementById("search-autocomplete-list"),
                            searchViewGhostText: document.getElementById("search-view-ghost-text"),
                            aboutView: document.getElementById("about-view"),

                            // Thêm vào object this.els:
                            quizView: document.getElementById("quiz-view"),
                            quizStartScreen: document.getElementById("quiz-start-screen"),
                            quizQuestionScreen: document.getElementById("quiz-question-screen"),
                            quizResultScreen: document.getElementById("quiz-result-screen"),
                            startQuizBtn: document.getElementById("start-quiz-btn"),
                            quizQuestionText: document.getElementById("quiz-question-text"),
                            quizOptionsContainer: document.getElementById("quiz-options-container"),
                            quizNextBtn: document.getElementById("quiz-next-btn"),
                            quizProgress: document.getElementById("quiz-progress"),
                            quizScore: document.getElementById("quiz-score"),
                            quizProgressBar: document.getElementById("quiz-progress-bar"),
                            quizFinalScore: document.getElementById("quiz-final-score"),
                            quizResultMessage: document.getElementById("quiz-result-message"),
                            quizRestartBtn: document.getElementById("quiz-restart-btn"),
                            quizHomeBtn: document.getElementById("quiz-home-btn"),
                            startPracticeQuizBtn: document.getElementById("start-practice-quiz-btn"),
                            quizQuitBtn: document.getElementById("quiz-quit-btn"),
                            quizStartBackBtn: document.getElementById("quiz-start-back-btn"),
                            quizCorrectCount: document.getElementById("quiz-correct-count"), // Mới
                            quizWrongCount: document.getElementById("quiz-wrong-count"), // Mới
                            practiceListBtnDesktop: document.getElementById("practice-list-btn-desktop"),
                            practiceListBtnCollapsed: document.getElementById("practice-list-btn-collapsed"),
                            practiceListBtnMobile: document.getElementById("practice-list-btn-mobile"),
                        };
                    }
                    // [THÊM] Hàm helper để tách Họ khoa học và Họ tiếng Việt
                    _parseHoCay(hoCayString) {
                        if (!hoCayString) return { scientific: "Chưa cập nhật", vietnamese: "Chưa cập nhật" };
                        // Ví dụ: "Apocynaceae (Họ Trúc đào)"
                        const match = hoCayString.match(/^(.+?)\s*\((.+?)\)$/);
                        if (match) {
                            return {
                                scientific: match[1].trim(),
                                vietnamese: match[2].trim(),
                            };
                        }
                        // Trường hợp chỉ có một tên (ít xảy ra)
                        const name = hoCayString.trim();
                        return {
                            scientific: name.startsWith("Họ") ? name : name, // Dùng tên là Sci nếu không có ngoặc
                            vietnamese: name.startsWith("Họ") ? name : `Họ ${name}`, // Giả định là họ tiếng Việt
                        };
                    }
                    initHistory() {
                        history.replaceState({ view: "list", filter: this.currentFilter }, "", "#list");
                        window.addEventListener("popstate", (e) => {
                            if (e.state) {
                                this.handleStateChange(e.state);
                            }
                        });
                    }
                    // [TÍNH NĂNG MỚI] Xử lý ẩn/hiện header khi cuộn
                    handleListScroll() {
                        if (this.currentView.type !== "list") return;

                        const currentScrollY = this.els.plantListContainer.scrollTop;
                        const header = this.els.mobileHeader;

                        // Bỏ qua hiệu ứng nảy (bounce) trên iOS
                        if (currentScrollY < 0) return;

                        // Ngưỡng phát hiện cuộn (giảm xuống 5 để nhạy hơn)
                        const delta = Math.abs(currentScrollY - this.lastScrollY);
                        if (delta < 10) return;

                        // Logic:
                        // 1. Nếu cuộn xuống VÀ đã cuộn qua 50px -> ẨN
                        // 2. Nếu cuộn lên (currentScrollY < lastScrollY) -> HIỆN NGAY LẬP TỨC
                        if (currentScrollY > this.lastScrollY && currentScrollY > 50) {
                            header.classList.add("header-scroll-hidden");
                        } else if (currentScrollY < this.lastScrollY) {
                            header.classList.remove("header-scroll-hidden");
                        }

                        this.lastScrollY = currentScrollY;
                    }
                    handleStateChange(state) {
                        this.closeModal();
                        this.els.mobileMenu.classList.add("hidden");

                        // [FIX] Reset triệt để trạng thái Menu Mobile: Ẩn và Xóa trạng thái mở
                        this.els.mobileMenu.classList.add("hidden");
                        this.els.mobileMenu.classList.remove("is-open"); // <-- THÊM DÒNG NÀY ĐỂ FIX LỖI BẤM 2 LẦN

                        // [FIX] Nếu state bị null (trường hợp load lại trang hoặc lỗi trình duyệt), tự tạo state mặc định
                        const currentState = state || { view: "list", filter: { group: "all", search: "" } };
                        this.currentView = currentState;

                        // Xác định view hiện tại đang mở để transition từ đó
                        const activeViews = [
                            this.els.plantListContainer,
                            this.els.plantDetailView,
                            this.els.searchView,
                            this.els.aboutView,
                            this.els.quizView,
                        ];
                        let fromView =
                            activeViews.find((v) => v && !v.classList.contains("hidden")) ||
                            this.els.plantListContainer;

                        switch (currentState.view) {
                            case "detail":
                                this.hideSearchView(true);
                                const backTitle = currentState.backTitle || "Quay lại";
                                this.showPlantDetail(currentState.id, true, backTitle, true);
                                break;
                            case "search":
                                this.showSearchView(true, currentState);
                                break;
                            case "about":
                                this.hideSearchView(true);
                                this.showAboutView(currentState);
                                break;
                            case "quiz":
                                this.navigateToQuizInternal(fromView);
                                break;
                            case "list":
                            default:
                                // [FIX] Khôi phục bộ lọc từ lịch sử, nếu không có thì reset về mặc định
                                this.currentFilter = currentState.filter || { group: "all", search: "" };

                                // [FIX] Đồng bộ lại ô tìm kiếm và tiêu đề
                                this.els.searchInput.value = this.currentFilter.search || "";
                                this.currentListTitle =
                                    this.currentFilter.group === "all" ? "Tất cả Dược liệu" : this.currentFilter.group;

                                // Ẩn search view nếu đang mở
                                this.hideSearchView(true);

                                // Gọi hiển thị list (quan trọng là tham số true để biết là đang back)
                                this.showListView(true);

                                // [FIX] Highlight lại menu bên trái để đồng bộ
                                this.highlightActiveGroup();
                                break;
                        }
                    }
                    // THÊM HÀM MỚI NÀY VÀO CLASS MedicinalPlantApp
                    showPracticeList() {
                        this.currentFilter = { group: "practice", search: "" };
                        this.currentListTitle = "Danh sách Thực hành";
                        // Xóa ô tìm kiếm nếu có
                        this.els.searchInput.value = "";
                        this.els.searchClearDesktop.classList.add("hidden");
                        // Đẩy state mới vào history
                        const newState = { view: "list", filter: this.currentFilter };
                        history.pushState(newState, "", "#list/practice");

                        this.showListView();
                        this.highlightActiveGroup(); // Cập nhật highlight menu
                    }
                    initEventListeners() {
                        this.els.plantListContainer.addEventListener("scroll", this.handleListScroll);
                        if (this.els.mobileLogoAction) {
                            this.els.mobileLogoAction.addEventListener("click", () => {
                                // Nếu đang ở search view thì đóng lại trước
                                if (this.currentView.type === "search") {
                                    this.hideSearchView();
                                }
                                // Cuộn mượt lên đầu danh sách
                                this.els.plantListContainer.scrollTo({ top: 0, behavior: "smooth" });
                            });
                        }
                        // 1. Logic đóng mở Sidebar
                        [this.els.sidebarToggle, this.els.sidebarToggleCollapsed].forEach((btn) =>
                            btn.addEventListener("click", () => this.toggleSidebar())
                        );

                        // 2. FIX DESKTOP SEARCH: Ép chuyển sang trạng thái search khi gõ
                        this.els.searchInput.addEventListener("input", (e) => {
                            const val = e.target.value;

                            // Hiển thị/Ẩn nút X
                            this.els.searchClearDesktop.classList.toggle("hidden", !val);

                            if (this.currentView.type !== "search" && val.trim().length > 0) {
                                this.navigateToSearch(val);
                            } else {
                                this.handleSearch(val);
                            }
                            this.handleSearchAutocomplete(val, this.els.searchInput);
                        });
                        const quickBtn = document.getElementById('start-quick-practice-btn');
if (quickBtn) {
    quickBtn.addEventListener('click', () => {
        this.els.quizStartScreen.classList.add("hidden");
        this.startQuickPracticeSession();
    });
}
                        // [MỚI] Sự kiện click nút X Desktop
                        this.els.searchClearDesktop.addEventListener("click", () => {
                            this.els.searchInput.value = "";
                            this.els.searchClearDesktop.classList.add("hidden");
                            this.els.searchInput.focus();
                            this.handleSearch(""); // Reset kết quả
                            this.handleSearchAutocomplete("", this.els.searchInput);
                        });

                        this.els.searchInput.addEventListener("keydown", (e) => {
                            if (e.key === "Tab" && this.els.searchGhostText.textContent) {
                                e.preventDefault();
                                e.target.value = this.els.searchGhostText.textContent;
                                this.navigateToSearch(e.target.value); // Fix: Dùng navigate thay vì handleSearch
                                this.handleSearchAutocomplete(e.target.value, this.els.searchInput);
                            }
                        });

                        // 3. Sự kiện nút Search Collapsed
                        this.els.searchButtonCollapsed.addEventListener("click", () => {
                            if (this.els.sidebar.classList.contains("collapsed")) {
                                this.toggleSidebar();
                                setTimeout(() => this.els.searchInput.focus(), 100);
                            }
                        });

                        // 4. FIX MOBILE SEARCH: Đảm bảo sự kiện click hoạt động
                        // Xóa bỏ listener cũ nếu có, gán mới trực tiếp
                        this.els.mobileSearchButton.onclick = (e) => {
                            e.preventDefault();
                            e.stopPropagation();
                            this.navigateToSearch();
                        };

                        // 5. Sự kiện cho các nút "Danh sách Thực hành" (MỚI)
                        [
                            this.els.practiceListBtnDesktop,
                            this.els.practiceListBtnCollapsed,
                            this.els.practiceListBtnMobile,
                        ].forEach((btn) => {
                            if (btn) {
                                btn.addEventListener("click", () => {
                                    this.closeMenu();
                                    this.showPracticeList();
                                });
                            }
                        });

                        // --- CÁC SỰ KIỆN KHÁC GIỮ NGUYÊN ---
                        this.els.plantForm.addEventListener("submit", (e) => this.handleFormSubmit(e));
                        this.els.closeModalButton.addEventListener("click", () => this.closeModal());
                        this.els.cancelButton.addEventListener("click", () => this.closeModal());
                        this.els.plantModal.addEventListener("click", (e) => {
                            if (e.target === this.els.plantModal) this.closeModal();
                        });

                        this.els.mobileMenuButton.addEventListener("click", () => {
                            if (this.els.mobileMenu.classList.contains("is-open")) {
                                this.closeMenu();
                            } else {
                                this.openMenu();
                            }
                        });

                        this.els.quizStartBackBtn.addEventListener("click", () => window.history.back());
                        this.els.mobileMenu.addEventListener("click", (e) => {
                            if (e.target === this.els.mobileMenu) this.closeMenu();
                        });
                        this.els.groupsNavMobile.addEventListener("click", (e) => {
                            if (e.target.closest(".group-link")) {
                                this.closeMenu();
                            }
                        });
                        this.els.stickyBackButton.addEventListener("click", () => window.history.back());
                        this.els.stickyHomeButton.addEventListener("click", () => this.goHome());

                        [
                            this.els.importButtonDesktop,
                            this.els.importButtonDesktopCollapsed,
                            this.els.importButtonMobile,
                        ].forEach((btn) => btn.addEventListener("click", () => this.importData()));
                        [
                            this.els.exportButtonDesktop,
                            this.els.exportButtonDesktopCollapsed,
                            this.els.exportButtonMobile,
                        ].forEach((btn) => btn.addEventListener("click", () => this.exportData()));
                        this.els.themeToggles.forEach((btn) => btn.addEventListener("click", () => this.toggleTheme()));
                        this.els.deleteSelectedBtn.addEventListener("click", () => this.deleteSelectedPlants());
                        this.els.deselectAllBtn.addEventListener("click", () => this.clearSelection());

                        // Sự kiện Search View Back (Mobile)
                        this.els.searchViewBackButton.addEventListener("click", () => window.history.back());

                        // [CẬP NHẬT] Logic tìm kiếm Mobile có thêm nút Clear
                        this.els.searchViewInput.addEventListener("input", (e) => {
                            const val = e.target.value;
                            this.els.searchClearMobile.classList.toggle("hidden", !val);
                            this.renderSearchResults(val);
                        });

                        // [MỚI] Sự kiện click nút X Mobile
                        this.els.searchClearMobile.addEventListener("click", () => {
                            this.els.searchViewInput.value = "";
                            this.els.searchClearMobile.classList.add("hidden");
                            this.els.searchViewInput.focus();
                            this.renderSearchResults(""); // Reset kết quả
                        });

                        this.els.searchAutocompleteList.addEventListener("mousedown", (e) => {
                            const item = e.target.closest(".autocomplete-item");
                            if (item) {
                                this.els.searchInput.value = item.dataset.value;
                                this.navigateToSearch(item.dataset.value); // Fix: Dùng navigate
                                this.handleSearchAutocomplete(item.dataset.value, this.els.searchInput);
                                this.els.searchAutocompleteList.classList.add("hidden");
                            }
                        });

                        this.setupAutocomplete("nhomChat", () => this.getDynamicSuggestions("nhomChat"), {
                            append: true,
                            separator: ">",
                        });
                        this.setupAutocomplete(
                            "thanhPhanHoaHocChinh",
                            () => this.getDynamicSuggestions("thanhPhanHoaHocChinh"),
                            { append: true }
                        );
                        this.setupAutocomplete("boPhanDung", () => this.getDynamicSuggestions("boPhanDung"), {
                            append: true,
                        });
                        this.setupAutocomplete("tacDung", () => this.getDynamicSuggestions("tacDung"), {
                            append: true,
                        });
                        this.setupAutocomplete("congDung", () => this.getDynamicSuggestions("congDung"), {
                            append: true,
                        });

                        document.addEventListener("click", (e) => {
                            // Đã xóa this.hideContextMenu();
                            if (
                                this.activeAutocomplete &&
                                !this.els[this.activeAutocomplete].input.contains(e.target) &&
                                !this.els[this.activeAutocomplete].list.contains(e.target)
                            ) {
                                this.hideAutocomplete();
                            }
                        });

                        document.querySelectorAll('[data-action="show-about"]').forEach((btn) => {
                            btn.addEventListener("click", () => this.navigateToAbout());
                        });
                        document.querySelectorAll('[data-action="show-quiz"]').forEach((btn) => {
                            btn.addEventListener("click", () => this.navigateToQuiz());
                        });

this.els.startPracticeQuizBtn.addEventListener("click", () => {
    // Đóng màn hình Start
    this.els.quizStartScreen.classList.add("hidden");
    // Gọi chế độ thực hành mới
    this.startPracticeSession(); 
});                        this.els.startQuizBtn.addEventListener("click", () => this.startQuiz("all"));
                        //this.els.quizNextBtn.addEventListener("click", () => this.nextQuestion());
                        this.els.quizRestartBtn.addEventListener("click", () => this.startQuiz());
                        this.els.quizHomeBtn.addEventListener("click", () => this.goHome());
                        this.els.quizQuitBtn.addEventListener("click", () =>
                            this.showConfirm("Bạn có chắc muốn thoát bài thi không?", () => this.goHome())
                        );
                        // --- DÁN VÀO CUỐI HÀM initEventListeners() ---

// Xử lý tự động cuộn khi bàn phím hiện lên (Fix lỗi che ô nhập)
this.els.quizQuestionScreen.addEventListener('focusin', (e) => {
    // Chỉ áp dụng cho các ô input thực hành
    if (e.target.classList.contains('practice-input')) {
        // Delay 300ms để chờ bàn phím điện thoại đẩy giao diện lên xong
        setTimeout(() => {
            e.target.scrollIntoView({ 
                behavior: 'smooth', 
                block: 'center', // Đưa ô nhập vào giữa màn hình
                inline: 'nearest'
            });
        }, 300);
    }
});
                    }

                    // THAY THẾ TOÀN BỘ HÀM CŨ BẰNG HÀM NÀY
                    handleLeafNodeClick(groupName) {
                        const pathParts = groupName.split(" > ");
                        const targetSubgroupName = pathParts.pop();
                        const parentGroupName = pathParts.length > 0 ? pathParts.join(" > ") : "all";

                        // Đây là hàm sẽ thực hiện việc cuộn và nháy sáng
                        const scrollAndFlash = () => {
                            const headers = this.els.plantListGrid.querySelectorAll("h2.sticky-group-header");
                            for (const header of headers) {
                                const headerText = header.textContent.replace(/\s*\(\d+\)$/, "").trim();
                                if (this._normalizeText(headerText) === this._normalizeText(targetSubgroupName)) {
                                    header.scrollIntoView({ behavior: "smooth", block: "center" });
                                    header.classList.add("flash-highlight");
                                    setTimeout(() => {
                                        header.classList.remove("flash-highlight");
                                    }, 1500);
                                    break;
                                }
                            }
                        };

                        // TRƯỜNG HỢP 1: Đã ở đúng trang cha -> Bỏ qua render, thực thi luôn
                        if (this.currentFilter.group === parentGroupName) {
                            scrollAndFlash();
                        }
                        // TRƯỜNG HỢP 2: Cần chuyển trang -> Đặt hẹn hành động và kích hoạt render
                        else {
                            this.postRenderAction = scrollAndFlash;
                            this.handleGroupFilter(parentGroupName);
                        }
                    }
                    getActiveViewElement() {
                        if (!this.els.plantListContainer.classList.contains("hidden"))
                            return this.els.plantListContainer;
                        if (!this.els.plantDetailView.classList.contains("hidden")) return this.els.plantDetailView;
                        if (!this.els.aboutView.classList.contains("hidden")) return this.els.aboutView;
                        return null;
                    }
                    // THAY THẾ TOÀN BỘ HÀM loadPlants() CŨ BẰNG HÀM NÀY

                    loadPlants() {
                        // Luôn luôn fetch (tải) dữ liệu từ file data.json mỗi khi ứng dụng khởi động.
                        fetch("data.json")
                            .then((res) => {
                                if (!res.ok) throw new Error("Không thể tải dữ liệu mặc định");
                                return res.json();
                            })
                            .then((defaultData) => {
                                // Gán dữ liệu từ file vào ứng dụng.
                                this.plants = defaultData;

                                // Dòng này vẫn cần thiết để nếu bạn có chỉnh sửa, localStorage sẽ được cập nhật,
                                // nhưng nó sẽ bị ghi đè lại ở lần tải trang tiếp theo.
                                this.savePlants();
                                this.renderAll();
                            })
                            .catch((error) => {
                                // Xử lý trường hợp không tải được file data.json (ví dụ: file bị xóa, lỗi mạng)
                                console.error("Lỗi khi tải data.json:", error);
                                this.showToast("Không thể tải dữ liệu từ server.", "error");

                                // Như một phương án dự phòng, ta có thể thử tải từ localStorage
                                // hoặc bắt đầu với một mảng rỗng.
                                const data = localStorage.getItem("medicinalPlants");
                                if (data) {
                                    this.plants = JSON.parse(data);
                                } else {
                                    this.plants = [];
                                }
                                this.renderAll();
                            });
                    }

                    savePlants() {
                        localStorage.setItem("medicinalPlants", JSON.stringify(this.plants));
                    }
                    saveCurrentScrollPosition() {
                        const activeView = this.getActiveViewElement();
                        if (activeView && history.state) {
                            const scrollY = activeView.scrollTop;
                            history.replaceState({ ...history.state, scrollY }, "");
                        }
                    }
                    // ---- THAY THẾ TOÀN BỘ HÀM updatePlant BẰNG MÃ NÀY ----
                    updatePlant(id, data) {
                        // Cập nhật dữ liệu trong mảng plants
                        this.plants = this.plants.map((p) => (p.id === id ? { ...p, id, ...data } : p));
                        this.savePlants(); // Lưu vào localStorage
                        this.renderAll(); // Cập nhật lại danh sách nền (sidebar, list view)

                        this.showToast("Cập nhật thành công!", "success");

                        // Quan trọng: Gọi exitEditMode với ID để nó render lại trang chi tiết
                        // y hệt như khi bấm nút "Hủy".
                        this.exitEditMode(id);
                    }
                    deletePlant(id) {
                        this.showConfirm("Bạn có chắc chắn muốn xóa dược liệu này không?", () => {
                            this.plants = this.plants.filter((p) => p.id !== id);
                            this.selectedPlants.delete(id);
                            this.savePlants();
                            this.renderAll();
                            // If we are in detail view of the deleted plant, go back
                            if (this.currentView.type === "detail" && this.currentView.id === id) {
                                history.back();
                            }
                            this.showToast("Đã xóa dược liệu.", "success");
                        });
                    }
                    deleteSelectedPlants() {
                        const c = this.selectedPlants.size;
                        if (c === 0) return;
                        this.showConfirm(`Bạn có chắc muốn xóa ${c} mục đã chọn không?`, () => {
                            this.plants = this.plants.filter((p) => !this.selectedPlants.has(p.id));
                            this.selectedPlants.clear();
                            this.savePlants();
                            this.renderAll();
                            this.showToast(`Đã xóa ${c} dược liệu.`, "success");
                        });
                    }

                    renderAll() {
                        const p = this.getFilteredPlants();
                        this.renderGroups();
                        this.renderPlantList(p);
                        this.updateUIState();
                        this.updateSelectionToolbar();
                    }

                    renderGroups() {
                        const openGroups = new Set();
                        // Lưu lại trạng thái mở của các nhóm
                        this.els.groupsNav
                            .querySelectorAll("details[open] > summary .group-name-action")
                            .forEach((el) => {
                                openGroups.add(el.dataset.group);
                            });
                        const openGroupsMobile = new Set();
                        this.els.groupsNavMobile
                            .querySelectorAll("details[open] > summary .group-name-action")
                            .forEach((el) => {
                                openGroupsMobile.add(el.dataset.group);
                            });

                        // Tự động mở nhóm đang active
                        const currentGroupPath = this.currentFilter.group;
                        if (currentGroupPath && currentGroupPath !== "all") {
                            const pathParts = currentGroupPath.split(" > ");
                            let path = "";
                            for (const part of pathParts) {
                                path = path ? `${path} > ${part}` : part;
                                openGroups.add(path);
                                openGroupsMobile.add(path);
                            }
                        }

                        const tree = {};
                        this.plants.forEach((p) => {
                            if (!p.nhomChat) return;
                            const paths = p.nhomChat
                                .split(",")
                                .map((c) => c.trim())
                                .filter(Boolean);
                            paths.forEach((pathStr) => {
                                const path = pathStr.split(">").map((part) => part.trim());
                                let node = tree;
                                path.forEach((part) => {
                                    const normalizedPart = this._normalizeGroup(part);
                                    if (!node[normalizedPart]) node[normalizedPart] = {};
                                    node = node[normalizedPart];
                                });
                            });
                        });

                        const buildHTML = (node, path = "", level = 0) =>
                            Object.keys(node)
                                .sort()
                                .map((key) => {
                                    const children = node[key];
                                    const currentPath = path ? `${path} > ${key}` : key;

                                    // Trường hợp 1: Nhóm Cha (Có con) -> TÁCH 2 PHẦN
                                    if (Object.keys(children).length > 0) {
                                        return `
                    <li>
                        <details class="group-details">
                            <summary class="flex items-center justify-between gap-1 px-2 py-1 rounded-lg hover:bg-[var(--accent)] cursor-pointer group select-none">
                                <span class="group-name-action flex-grow py-1.5 px-2 text-sm font-medium hover:text-[var(--primary)] transition-colors rounded" 
                                      data-group="${currentPath}">
                                    ${key}
                                </span>
                                <div class="chevron-action p-1.5 rounded-md text-[var(--muted-foreground)] hover:bg-[var(--background)] hover:text-[var(--foreground)] transition-colors">
                                    <i data-lucide="chevron-right" class="chevron w-4 h-4 transition-transform duration-200"></i>
                                </div>
                            </summary>
                            <ul class="pl-4 border-l border-[var(--border)] ml-3 mt-1 space-y-0.5">
                                ${buildHTML(children, currentPath, level + 1)}
                            </ul>
                        </details>
                    </li>`;
                                    }

                                    // Trường hợp 2: Nhóm Lá (Không con) -> Link thường
                                    return `<li>
                    <a href="#" class="group-link block px-4 py-2 text-sm rounded-lg transition-colors hover:bg-[var(--accent)] hover:text-[var(--primary)]" 
                       data-group="${currentPath}" data-is-leaf="true">
                       ${key}
                    </a>
                </li>`;
                                })
                                .join("");

                        const allLink = `<li>
        <a href="#" class="group-link flex items-center gap-3 px-3 py-2 rounded-lg transition-colors hover:bg-[var(--accent)] font-medium" data-group="Tất cả">
            <i data-lucide="library" class="w-5 h-5 text-[var(--primary)]"></i>
            <span class="sidebar-text">Tất cả Dược liệu</span>
        </a>
    </li>`;

                        const html = `<ul class="space-y-1">${allLink}${buildHTML(tree)}</ul>`;
                        this.els.groupsNav.innerHTML = html;
                        this.els.groupsNavMobile.innerHTML = html;

                        // --- KHÔI PHỤC TRẠNG THÁI MỞ ---
                        const restoreState = (nav, openSet) => {
                            nav.querySelectorAll(".group-name-action").forEach((el) => {
                                if (openSet.has(el.dataset.group)) {
                                    el.closest("details").open = true;
                                }
                            });
                        };
                        restoreState(this.els.groupsNav, openGroups);
                        restoreState(this.els.groupsNavMobile, openGroupsMobile);

                        // --- GÁN SỰ KIỆN ---

                        // 1. Sự kiện cho Nhóm Cha (Click vào Tên -> Lọc, KHÔNG Toggle)
                        const handleParentClick = (e) => {
                            e.preventDefault(); // Chặn hành vi toggle mặc định của summary
                            e.stopPropagation(); // Chặn nổi bọt

                            const groupName = e.currentTarget.dataset.group;
                            if (groupName === this.currentFilter.group) return;

                            this.handleGroupFilter(groupName);

                            if (this.isMobile()) {
                                setTimeout(() => this.closeMenu(), 150);
                            }
                        };

                        document.querySelectorAll(".group-name-action").forEach((el) => {
                            el.addEventListener("click", handleParentClick);
                        });

                        // 2. Sự kiện cho Nhóm Lá & Nút Tất cả (Link thường)
                        document.querySelectorAll(".group-link").forEach((link) => {
                            link.addEventListener("click", (e) => {
                                e.preventDefault();
                                const groupName = link.dataset.group === "Tất cả" ? "all" : link.dataset.group;

                                // [LOGIC MỚI] Nếu bấm "Tất cả" -> Gọi goHome() để reset toàn bộ (tìm kiếm, lọc...)
                                if (groupName === "all") {
                                    this.goHome();
                                    if (this.isMobile()) {
                                        setTimeout(() => this.closeMenu(), 150);
                                    }
                                    return;
                                }

                                // Logic cũ cho các nhóm con và nhóm lá
                                const isLeaf = link.dataset.isLeaf === "true";

                                if (isLeaf) {
                                    this.handleLeafNodeClick(groupName);
                                } else {
                                    if (groupName === this.currentFilter.group) return;
                                    this.handleGroupFilter(groupName);
                                }

                                if (this.isMobile()) {
                                    setTimeout(() => this.closeMenu(), 150);
                                }
                            });
                        });

                        this.highlightActiveGroup();
                        lucide.createIcons();
                    }
                    navigateToQuizInternal(fromView) {
                        this.currentView = { type: "quiz" };
                        this.els.mobileHeader.classList.add("header-hidden");
                        this.transitionView(fromView, this.els.quizView);

                        // Reset về màn hình start (quan trọng)
                        this.els.quizStartScreen.classList.remove("hidden");
                        this.els.quizQuestionScreen.classList.add("hidden");
                        this.els.quizResultScreen.classList.add("hidden");
                    }
                    navigateToQuiz() {
                        if (this.currentView.type === "quiz") return;
                        history.pushState({ view: "quiz" }, "", "#quiz");
                        this.handleStateChange({ view: "quiz" }); // Gọi handleStateChange để thực hiện chuyển đổi
                    }

                    showQuizView() {
                        this.currentView = { type: "quiz" };
                        this.els.mobileHeader.classList.add("header-hidden");
                        const fromView = this.getActiveViewElement();
                        this.transitionView(fromView, this.els.quizView);

                        // Reset về màn hình start
                        this.els.quizStartScreen.classList.remove("hidden");
                        this.els.quizQuestionScreen.classList.add("hidden");
                        this.els.quizResultScreen.classList.add("hidden");
                    }
                    // [CẬP NHẬT] startQuiz nhận tham số mode và xử lý checkbox
                    startQuiz(mode = "all") {
                        // 1. Thu thập các loại câu hỏi từ Checkbox
                        const checkboxes = document.querySelectorAll('input[name="quiz-type"]:checked');
                        const selectedTypes = Array.from(checkboxes).map((cb) => cb.value);

                        if (selectedTypes.length === 0) {
                            this.showToast("Vui lòng chọn ít nhất một nội dung để ôn tập.", "error");
                            return;
                        }

                        this.quizState = {
                            questions: [],
                            currentQIndex: 0,
                            correctCount: 0, // Sửa từ score thành count
                            wrongCount: 0, // Thêm biến đếm sai
                            wrongAnswersList: [],
                            totalQ: 10,
                            mode: mode,
                        };

                        // 2. Lọc danh sách nguồn
                        let sourceList = this.plants;
                        if (mode === "practice") {
                            sourceList = this.plants.filter((p) => p.isThucHanh === true);
                            if (sourceList.length < 4) {
                                this.showToast(
                                    "Cần đánh dấu ít nhất 4 dược liệu 'Thực hành' để ôn tập mục này.",
                                    "error"
                                );
                                return;
                            }
                        }

                        // 3. Truyền sourceList VÀ selectedTypes vào hàm generateQuestions
                        this.generateQuestions(sourceList, selectedTypes);

                        if (this.quizState.questions.length < 4) {
                            this.showToast(
                                "Không đủ dữ liệu hợp lệ (thiếu thông tin cây) để tạo câu hỏi cho các mục đã chọn.",
                                "error"
                            );
                            this.navigateToQuizInternal(this.els.quizView);
                            return;
                        }

                        this.els.quizStartScreen.classList.add("hidden");
                        this.els.quizResultScreen.classList.add("hidden");
                        this.els.quizQuestionScreen.classList.remove("hidden");

                        this.els.quizCorrectCount.textContent = "0";
                        this.els.quizWrongCount.textContent = "0";
                        this.renderQuestion();
                    }

                    // [CẬP NHẬT] Hàm generateQuestions hỗ trợ lọc loại câu hỏi
                    generateQuestions(sourcePlants, allowedGroups = ["family", "chem", "use"]) {
                        const targets = sourcePlants || this.plants;

                        // 1. Định nghĩa map giữa Nhóm (checkbox) và Loại câu hỏi (internal ID)
                        const typeMapping = {
                            family: ["family_sci_to_vn", "family_vn_to_sci", "plant_to_sci_family"],
                            chem: ["plant_to_chem"],
                            //use: ["plant_to_congdung", "plant_to_tacdung"],
                        };

                        // 2. Tạo danh sách các loại câu hỏi được phép dựa trên checkbox
                        let allowedTypes = [];
                        allowedGroups.forEach((group) => {
                            if (typeMapping[group]) {
                                allowedTypes = allowedTypes.concat(typeMapping[group]);
                            }
                        });

                        // 3. Lọc cây có đủ dữ liệu cho CÁC LOẠI CÂU HỎI ĐƯỢC CHỌN
                        // Logic: Cây phải có ít nhất 1 trường dữ liệu liên quan đến loại câu hỏi đã chọn
                        const plantsWithData = targets.filter((p) => {
                            // Kiểm tra họ
                            const hasFamily = p.hoCay && p.hoCay !== "Chưa cập nhật";
                            // Kiểm tra hóa học
                            const hasChem = p.thanhPhanHoaHocChinh && p.thanhPhanHoaHocChinh !== "Chưa cập nhật";
                            // Kiểm tra công dụng
                            const hasUse =
                                (p.congDung && p.congDung !== "Chưa cập nhật") ||
                                (p.tacDung && p.tacDung !== "Chưa cập nhật");

                            // Chỉ giữ lại cây nếu nó có dữ liệu phục vụ cho ít nhất 1 nhóm đã chọn
                            if (allowedGroups.includes("family") && hasFamily) return true;
                            if (allowedGroups.includes("chem") && hasChem) return true;
                            if (allowedGroups.includes("use") && hasUse) return true;

                            return false;
                        });

                        // Dữ liệu nhiễu lấy từ toàn bộ kho
                        const allPlantsData = this.plants;
                        const families = this._getUniqueFamilyNames();
                        const uniqueSci = families.uniqueSci;
                        const uniqueVn = families.uniqueVn;

                        // Số lượng câu mong muốn
                        const total = Math.min(this.quizState.totalQ, plantsWithData.length * allowedTypes.length);

                        let questionPool = [];

                        // 4. Chỉ tạo pool câu hỏi từ allowedTypes
                        plantsWithData.forEach((plant) => {
                            allowedTypes.forEach((type) => {
                                // Kiểm tra kỹ lại dữ liệu cụ thể cho từng loại câu hỏi trước khi push
                                const parsedFamily = this._parseHoCay(plant.hoCay);
                                const hasFamilyData = parsedFamily.scientific && parsedFamily.vietnamese;

                                if (type.includes("family") && !hasFamilyData) return;
                                if (
                                    type === "plant_to_chem" &&
                                    (!plant.thanhPhanHoaHocChinh || plant.thanhPhanHoaHocChinh === "Chưa cập nhật")
                                )
                                    return;
                                if (
                                    type === "plant_to_congdung" &&
                                    (!plant.congDung || plant.congDung === "Chưa cập nhật")
                                )
                                    return;
                                if (
                                    type === "plant_to_tacdung" &&
                                    (!plant.tacDung || plant.tacDung === "Chưa cập nhật")
                                )
                                    return;

                                questionPool.push({ plant, type });
                            });
                        });

                        if (questionPool.length === 0) return;

                        // Xáo trộn pool
                        questionPool.sort(() => 0.5 - Math.random());
                        const finalPool = questionPool.slice(0, total);

                        let generatedQuestions = [];

                        finalPool.forEach(({ plant, type }) => {
                            let questionText = "";
                            let correctAnswer = "";
                            let allAnswers = [];
                            const parsedFamily = this._parseHoCay(plant.hoCay);

                            switch (type) {
                                case "family_sci_to_vn":
                                    questionText = `Họ khoa học <strong class="text-[var(--primary)]">${parsedFamily.scientific}</strong> có tên tiếng Việt là gì?`;
                                    correctAnswer = parsedFamily.vietnamese;
                                    allAnswers = uniqueVn;
                                    break;
                                case "family_vn_to_sci":
                                    questionText = `<strong class="text-[var(--primary)]">${parsedFamily.vietnamese}</strong> có tên khoa học là gì?`;
                                    correctAnswer = parsedFamily.scientific;
                                    allAnswers = uniqueSci;
                                    break;
                                case "plant_to_sci_family":
                                    questionText = `Dược liệu <strong class="text-[var(--primary)]">${plant.tenDuocLieu}</strong> thuộc họ nào?`;
                                    correctAnswer = parsedFamily.scientific;
                                    allAnswers = uniqueSci;
                                    break;
                                case "plant_to_chem":
                                    questionText = `Thành phần hóa học chính của <strong class="text-[var(--primary)]">${plant.tenDuocLieu}</strong> là gì?`;
                                    correctAnswer = plant.thanhPhanHoaHocChinh;
                                    allAnswers = allPlantsData.map((p) => p.thanhPhanHoaHocChinh);
                                    break;
                                case "plant_to_congdung":
                                    questionText = `Công dụng chính của dược liệu <strong class="text-[var(--primary)]">${plant.tenDuocLieu}</strong> là gì?`;
                                    correctAnswer = plant.congDung;
                                    allAnswers = allPlantsData.map((p) => p.congDung);
                                    break;
                                case "plant_to_tacdung":
                                    questionText = `Tác dụng dược lý của dược liệu <strong class="text-[var(--primary)]">${plant.tenDuocLieu}</strong> là gì?`;
                                    correctAnswer = plant.tacDung;
                                    allAnswers = allPlantsData.map((p) => p.tacDung);
                                    break;
                            }

                            // Tạo đáp án nhiễu
                            const uniqueAllAnswers = [...new Set(allAnswers)].filter(
                                (ans) => ans && ans !== correctAnswer && ans !== "Chưa cập nhật"
                            );
                            const wrongAnswers = uniqueAllAnswers.sort(() => 0.5 - Math.random()).slice(0, 3);
                            while (wrongAnswers.length < 3) wrongAnswers.push("Chưa rõ thông tin");

                            const options = [correctAnswer, ...wrongAnswers].sort(() => 0.5 - Math.random());

                            generatedQuestions.push({
                                text: questionText,
                                correct: correctAnswer,
                                options: options,
                                type: type,
                            });
                        });

                        this.quizState.questions = generatedQuestions;
                        this.quizState.totalQ = generatedQuestions.length;
                    }

                    // [THÊM] Hàm helper để lấy tên họ duy nhất
                    _getUniqueFamilyNames() {
                        const families = this.plants.map((p) => this._parseHoCay(p.hoCay));
                        const uniqueSci = [...new Set(families.map((f) => f.scientific))].filter(
                            (n) => n && n !== "Chưa cập nhật" && !n.startsWith("Họ")
                        );
                        const uniqueVn = [...new Set(families.map((f) => f.vietnamese))].filter(
                            (n) => n && n !== "Chưa cập nhật"
                        );
                        return { uniqueSci, uniqueVn };
                    }

                    renderQuestion() {
                        const q = this.quizState.questions[this.quizState.currentQIndex];
                        this.els.quizOptionsContainer.classList.remove("answered");

                        // Logic nút Next
                        this.els.quizNextBtn.classList.add("invisible");
                        this.els.quizNextBtn.classList.remove("hidden");

                        this.els.quizQuestionText.innerHTML = q.text;
                        this.els.quizProgress.textContent = `${this.quizState.currentQIndex + 1}/${this.quizState.totalQ}`;

                        this.els.quizProgressBar.style.width = `${(this.quizState.currentQIndex / this.quizState.totalQ) * 100}%`;

                        // --- SỬA ĐOẠN NÀY ---
                        // Thêm class 'option-icon' vào thẻ div bao ngoài (w-5)
                        // Thêm class 'option-fill' vào thẻ div chấm tròn bên trong (w-2.5)
                        this.els.quizOptionsContainer.innerHTML = q.options
                            .map(
                                (opt) => `
        <button class="quiz-option w-full text-left p-3 rounded-lg border border-[var(--border)] hover:bg-[var(--accent)] transition-all flex items-start gap-3 group" onclick="app.handleQuizAnswer(this, '${opt.replace(/'/g, "\\'")}')">
            <div class="option-icon w-5 h-5 mt-0.5 flex-shrink-0 rounded-full border-2 border-[var(--muted-foreground)] flex items-center justify-center group-hover:border-[var(--primary)]">
                <div class="option-fill w-2.5 h-2.5 rounded-full bg-[var(--primary)] opacity-0 transition-opacity"></div>
            </div>
            <span class="flex-1 text-sm md:text-base leading-snug">${opt}</span>
        </button>
    `
                            )
                            .join("");
                    }
                    handleQuizAnswer(btn, selectedValue) {
                        if (this.els.quizOptionsContainer.classList.contains("answered")) return;
                        this.els.quizOptionsContainer.classList.add("answered");

                        const q = this.quizState.questions[this.quizState.currentQIndex];
                        const isCorrect = selectedValue === q.correct;
                        const allBtns = this.els.quizOptionsContainer.querySelectorAll(".quiz-option");

                        allBtns.forEach((b) => {
                            const optionText = b.querySelector("span").textContent.trim();

                            // --- SỬA ĐOẠN NÀY ---
                            // Sử dụng class định danh thay vì utility class của Tailwind
                            const iconDiv = b.querySelector(".option-icon");
                            const fillDiv = b.querySelector(".option-fill");

                            b.classList.remove("hover:bg-[var(--accent)]");
                            b.style.pointerEvents = "none";

                            if (optionText === q.correct) {
                                b.classList.add("bg-green-100", "border-green-500");

                                // Logic đổi màu giữ nguyên
                                iconDiv.classList.replace("border-[var(--muted-foreground)]", "border-green-600");
                                fillDiv.classList.add("bg-green-600", "opacity-100");
                                fillDiv.classList.remove("bg-[var(--primary)]");
                            } else if (b === btn && !isCorrect) {
                                b.classList.add("bg-red-100", "border-red-500");
                                iconDiv.classList.replace("border-[var(--muted-foreground)]", "border-red-600");
                                fillDiv.classList.add("bg-red-600", "opacity-100");
                                fillDiv.classList.remove("bg-[var(--primary)]");
                            }

                            if (b !== btn && optionText !== q.correct) {
                                iconDiv.classList.remove("group-hover:border-[var(--primary)]");
                            }
                        });

                        // Cập nhật điểm số
                        if (isCorrect) {
                            this.quizState.correctCount++;
                            this.els.quizCorrectCount.textContent = this.quizState.correctCount;
                            this.els.quizCorrectCount.parentElement.classList.add("scale-125");
                            setTimeout(
                                () => this.els.quizCorrectCount.parentElement.classList.remove("scale-125"),
                                200
                            );
                        } else {
                            this.quizState.wrongCount++;
                            this.els.quizWrongCount.textContent = this.quizState.wrongCount;

                            // [MỚI] Lưu lại câu sai
                            this.quizState.wrongAnswersList.push({
                                question: q.text,
                                userChoice: selectedValue,
                                correct: q.correct,
                            });

                            this.els.quizWrongCount.parentElement.classList.add("scale-125");
                            setTimeout(() => this.els.quizWrongCount.parentElement.classList.remove("scale-125"), 200);
                        }

                        this.els.quizNextBtn.classList.remove("invisible");
                    }

                    nextQuestion() {
                        this.quizState.currentQIndex++;
                        if (this.quizState.currentQIndex < this.quizState.totalQ) {
                            this.renderQuestion();
                        } else {
                            this.finishQuiz();
                        }
                    }
                    togglePractice(id) {
                        const plant = this.plants.find((p) => p.id === id);
                        if (plant) {
                            plant.isThucHanh = !plant.isThucHanh;
                            this.savePlants();
                            this.showToast(
                                plant.isThucHanh ? "Đã thêm vào danh sách Thực hành" : "Đã xóa khỏi danh sách Thực hành"
                            );
                            // Render lại chi tiết để cập nhật icon (không cần transition)
                            this.showPlantDetail(id, true, history.state?.backTitle || "Quay lại", false);
                        }
                    }
                    // [FIX LỖI] finishQuiz - Đảm bảo nút "Làm lại" nhớ đúng chế độ (Thực hành/Tất cả)
                    finishQuiz() {
                        // 1. LƯU LẠI CHẾ ĐỘ THI HIỆN TẠI NGAY LẬP TỨC
                        const currentMode = this.quizState.mode || "all";

                        this.els.quizQuestionScreen.classList.add("hidden");
                        this.els.quizResultScreen.classList.remove("hidden");
                        this.els.quizResultScreen.classList.remove("animate-on-scroll");
                        this.els.quizResultScreen.style.opacity = "1";
                        this.els.quizResultScreen.style.transform = "translateY(0)";

                        // Tính điểm
                        const finalScore = this.quizState.correctCount * 10;
                        const maxScore = this.quizState.totalQ * 10;

                        this.els.quizFinalScore.textContent = `${finalScore}/${maxScore}`;

                        const percentage = (finalScore / maxScore) * 100;
                        let msg = "";

                        if (this.quizState.totalQ === 0) {
                            msg = "Không đủ câu hỏi để hoàn thành Quiz.";
                        } else if (percentage === 100) {
                            msg = "Tuyệt vời! Bạn là chuyên gia dược liệu!";
                        } else if (percentage >= 80) {
                            msg = "Rất tốt! Kiến thức vững vàng.";
                        } else if (percentage >= 50) {
                            msg = "Khá tốt, hãy ôn tập thêm nhé.";
                        } else {
                            msg = "Cần cố gắng hơn nữa!";
                        }

                        this.els.quizResultMessage.textContent = msg;

                        // Nút Xem lại lỗi
                        const hasWrong = this.quizState.wrongAnswersList.length > 0;
                        const reviewBtnHTML = hasWrong
                            ? `<button id="quiz-review-btn" class="px-6 py-2 bg-red-100 text-red-700 border border-red-200 rounded-lg hover:bg-red-200">Xem câu sai (${this.quizState.wrongAnswersList.length})</button>`
                            : "";

                        this.els.quizResultScreen.innerHTML = `
        <h2 class="text-3xl font-bold">Kết quả</h2>
        <div class="text-6xl font-black text-[var(--primary)]" id="quiz-final-score">${finalScore}/${maxScore}</div>
        <p id="quiz-result-message" class="text-[var(--muted-foreground)]">${msg}</p>
        
        <div id="quiz-review-section" class="hidden text-left bg-[var(--card)] border border-[var(--border)] rounded-xl p-4 max-h-60 overflow-y-auto w-full max-w-lg mx-auto space-y-3">
            ${this.quizState.wrongAnswersList
                .map(
                    (w, i) => `
                <div class="text-sm border-b border-[var(--border)] pb-2 last:border-0">
                    <p class="font-semibold mb-1">Câu ${i + 1}: ${w.question}</p>
                    <div class="flex flex-col gap-1">
                        <span class="text-red-600"><i data-lucide="x" class="w-3 h-3 inline"></i> Bạn chọn: ${w.userChoice}</span>
                        <span class="text-green-600"><i data-lucide="check" class="w-3 h-3 inline"></i> Đáp án: ${w.correct}</span>
                    </div>
                </div>
            `
                )
                .join("")}
        </div>

        <div class="flex flex-wrap justify-center gap-4 mt-4">
            <button id="quiz-home-btn" class="px-6 py-2 border border-[var(--border)] rounded-lg hover:bg-[var(--accent)]">Về trang chủ</button>
            ${reviewBtnHTML}
            <button id="quiz-restart-btn" class="px-6 py-2 bg-[var(--primary)] text-white rounded-lg hover:opacity-90">Làm lại</button>
        </div>
    `;

                        // Gán sự kiện
                        this.els.quizResultScreen
                            .querySelector("#quiz-home-btn")
                            .addEventListener("click", () => this.goHome());

                        // [QUAN TRỌNG] Dùng biến currentMode đã lưu ở trên để restart đúng chế độ
                        this.els.quizResultScreen
                            .querySelector("#quiz-restart-btn")
                            .addEventListener("click", () => this.startQuiz(currentMode));

                        if (hasWrong) {
                            this.els.quizResultScreen
                                .querySelector("#quiz-review-btn")
                                .addEventListener("click", (e) => {
                                    const section = this.els.quizResultScreen.querySelector("#quiz-review-section");
                                    section.classList.toggle("hidden");
                                    e.target.textContent = section.classList.contains("hidden")
                                        ? `Xem câu sai (${this.quizState.wrongAnswersList.length})`
                                        : "Ẩn xem lại";
                                    lucide.createIcons();
                                });
                        }
                        lucide.createIcons();
                    }

                    // [CẬP NHẬT] renderPlantList - Fix lỗi gom nhóm ở Danh sách Thực hành
                    renderPlantList(plantsData) {
                        const { exactMatches, fuzzyMatches } = plantsData;
                        const hasSearch = !!this.currentFilter.search;

                        // Xử lý trường hợp không tìm thấy kết quả nào
                        if (
                            exactMatches.length === 0 &&
                            fuzzyMatches.length === 0 &&
                            (hasSearch || this.plants.length > 0)
                        ) {
                            this.els.plantListGrid.innerHTML = `<div class="col-span-full text-center text-[var(--muted-foreground)] py-10"><i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4"></i><p class="font-semibold">Không tìm thấy kết quả</p><p>Vui lòng thử lại với từ khóa hoặc bộ lọc khác.</p></div>`;
                            this.els.plantListGrid.className = "";
                            lucide.createIcons();
                            return;
                        }

                        // Trường hợp 1: Người dùng đang thực hiện tìm kiếm
                        if (hasSearch) {
                            let html = "";
                            if (exactMatches.length > 0) {
                                html += `
            <div class="group-container mb-4">
                <h2 class="sticky-group-header text-sm font-semibold uppercase text-[var(--muted-foreground)] tracking-wider">Có ${exactMatches.length} kết quả khớp nhất</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pt-2">
                    ${exactMatches.map((p) => this.createPlantCardHTML(p, this._findMatchContext(p, this._normalizeText(this.currentFilter.search)))).join("")}
                </div>
            </div>`;
                            }
                            if (fuzzyMatches.length > 0) {
                                html += `
            <div class="group-container mb-4">
                <h2 class="sticky-group-header text-sm font-semibold uppercase text-[var(--muted-foreground)] tracking-wider">Có thể bạn đang tìm...</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pt-2">
                    ${fuzzyMatches.map((p) => this.createPlantCardHTML(p, this._findMatchContext(p, this._normalizeText(this.currentFilter.search)))).join("")}
                </div>
            </div>`;
                            }
                            this.els.plantListGrid.innerHTML = html;
                            this.els.plantListGrid.className = "";
                        }
                        // Trường hợp 2: Xem danh sách (Tất cả / Theo nhóm / Thực hành)
                        else {
                            const filter = this.currentFilter.group;
                            const isPractice = filter === "practice";

                            // [FIX] Nếu là practice, ta coi như đang ở cấp độ gốc (giống 'all') để lấy nhóm cha
                            const filterParts = filter === "all" || isPractice ? [] : filter.split(" > ");
                            const currentLevel = filterParts.length;
                            this.els.plantListGrid.className = "";

                            const groups = {};

                            exactMatches.forEach((p) => {
                                let key = "Chưa phân loại"; // Đổi tên mặc định cho rõ nghĩa hơn
                                if (p.nhomChat) {
                                    const relevantPath = (
                                        p.nhomChat
                                            .split(",")
                                            .map((x) => x.trim())
                                            // [FIX] Nếu là practice hoặc all, lấy bất kỳ nhóm nào. Nếu đang lọc nhóm con, phải khớp filter
                                            .find((x) => filter === "all" || isPractice || x.startsWith(filter)) || ""
                                    )
                                        .split(">")
                                        .map((y) => y.trim());

                                    if (relevantPath.length > currentLevel) {
                                        key = relevantPath[currentLevel];
                                    }
                                }
                                if (!groups[key]) groups[key] = [];
                                groups[key].push(p);
                            });

                            // Sắp xếp nhóm: Đưa "Chưa phân loại" xuống cuối, các nhóm khác alphabet
                            const sortedKeys = Object.keys(groups).sort((a, b) => {
                                if (a === "Chưa phân loại") return 1;
                                if (b === "Chưa phân loại") return -1;
                                return a.localeCompare(b);
                            });

                            this.els.plantListGrid.innerHTML = sortedKeys
                                .map(
                                    (key) => `
            <div class="group-container mb-4">
                <h2 class="sticky-group-header text-sm font-semibold uppercase text-[var(--muted-foreground)] tracking-wider">${key} (${groups[key].length})</h2>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pt-2">
                    ${groups[key].map((p) => this.createPlantCardHTML(p)).join("")}
                </div>
            </div>`
                                )
                                .join("");
                        }

                        this.addEventListenersToCards(this.els.plantListGrid);
                        this.els.plantListGrid
                            .querySelectorAll(".animate-on-scroll")
                            .forEach((el) => this.observer.observe(el));
                        lucide.createIcons();
                        if (this.postRenderAction) {
                            this.postRenderAction();
                            this.postRenderAction = null;
                        }
                    }

                    // Thêm 3 hàm mới này
                    navigateToAbout() {
                        if (this.currentView.type === "about") return;
                        const newState = {
                            view: "about",
                            filter: this.currentFilter,
                            backTitle: this.currentListTitle,
                        };
                        history.pushState(newState, "", "#about");
                        this.handleStateChange(newState);
                        this.closeMenu();
                    }

                    showAboutView(state) {
                        this.els.mobileHeader.classList.add("header-hidden");
                        this.currentView = { type: "about" };

                        const fromView = this.getActiveViewElement();

                        this.transitionView(fromView, this.els.aboutView, () => {
                            this.els.aboutView.querySelector(".animate-on-scroll").classList.remove("is-visible");
                            this.observer.observe(this.els.aboutView.querySelector(".animate-on-scroll"));
                        });

                        this.els.aboutView.scrollTop = 0;

                        // Gán sự kiện cho các nút quay lại
                        this.els.aboutView.querySelector("#back-from-about-mobile").onclick = () =>
                            window.history.back();
                        this.els.aboutView.querySelector("#back-from-about-desktop").onclick = () =>
                            window.history.back();

                        lucide.createIcons();
                    }
                    // [CẬP NHẬT] Thêm tham số immediateSwap = false
                    async transitionView(fromEl, toEl, onTransitionCallback = null, immediateSwap = false) {
                        if (this.isTransitioning) return;
                        this.isTransitioning = true;
                        document.body.style.pointerEvents = "none";

                        try {
                            // 1. Xử lý View cũ
                            if (fromEl && !fromEl.classList.contains("hidden")) {
                                // Nếu immediateSwap = true (ví dụ: vào chi tiết), ta bỏ qua hiệu ứng mờ dần
                                // để view mới hiện lên ngay lập tức cùng lúc với header.
                                if (!immediateSwap) {
                                    fromEl.classList.add("view-fade-out");
                                    await new Promise((resolve) => setTimeout(resolve, 250));
                                    fromEl.classList.remove("view-fade-out");
                                }
                                // Ẩn view cũ
                                fromEl.classList.add("hidden");
                            }

                            // 2. Dọn dẹp view rác
                            [
                                this.els.plantListContainer,
                                this.els.plantDetailView,
                                this.els.searchView,
                                this.els.aboutView,
                                this.els.quizView,
                            ].forEach((el) => {
                                if (el && el !== toEl) el.classList.add("hidden");
                            });

                            // 3. Hiện View mới
                            toEl.classList.remove("hidden");
                            if (onTransitionCallback) onTransitionCallback();

                            toEl.classList.add("view-fade-in");
                            // Chờ animation vào (300ms cho khớp CSS mới)
                            await new Promise((resolve) => setTimeout(resolve, 300));
                            toEl.classList.remove("view-fade-in");
                        } finally {
                            this.isTransitioning = false;
                            document.body.style.pointerEvents = "auto";
                        }
                    }
                    navigateToDetail(id) {
                        this.saveCurrentScrollPosition();
                        this.els.searchViewInput.blur();

                        if (this.currentView.type === "detail" && this.currentView.id === id) {
                            return;
                        }
                        let backTitle = "";
                        if (this.currentView.type === "detail") {
                            const previousPlant = this.plants.find((p) => p.id === this.currentView.id);
                            backTitle = previousPlant ? previousPlant.tenDuocLieu : this.currentListTitle;
                        } else {
                            backTitle = this.currentListTitle;
                        }

                        const newState = { view: "detail", id: id, filter: this.currentFilter, backTitle: backTitle };
                        history.pushState(newState, "", `#detail/${id}`);
                        this.handleStateChange(newState);
                    }
                    // --- LOGIC ÔN TẬP NHANH (QUICK PRACTICE) ---

// 1. Khởi động chế độ nhanh
startQuickPracticeSession() {
    // Lọc cây có đánh dấu thực hành
    const practicePlants = this.plants.filter(p => p.isThucHanh === true);

    if (practicePlants.length < 5) {
        this.showToast("Cần ít nhất 5 dược liệu thuộc danh sách 'Thực hành' để bắt đầu.", "error");
        return;
    }

    // Chọn 5 cây ngẫu nhiên khác nhau
    const selectedPlants = practicePlants.sort(() => 0.5 - Math.random()).slice(0, 5);

    // Chuẩn bị dữ liệu (Mỗi cây chọn sẵn 1 ảnh)
    const sessionItems = selectedPlants.map(p => {
        let imgSrc = `${p.id}.jpg`;
        let correctName = p.tenDuocLieu;

        // Ưu tiên ảnh gallery nếu có
        if (p.gallery && Array.isArray(p.gallery) && p.gallery.length > 0) {
            const randomImg = p.gallery[Math.floor(Math.random() * p.gallery.length)];
            imgSrc = randomImg.src;
            if (randomImg.title && randomImg.title.trim()) {
                correctName = randomImg.title.trim();
            }
        }

        return {
            plant: p,
            imgSrc: imgSrc,
            correctName: correctName,
            // 3 giai đoạn: 0 (Tên), 1 (Họ Việt), 2 (Họ KH)
            stage: 0 
        };
    });

    this.quickState = {
        items: sessionItems,
        plantIndex: 0, // Cây hiện tại (0-4)
        isFeedbackShowing: false
    };

    // UI Setup: Dùng chung màn hình Question nhưng ẩn nav bar đi
    this.els.quizStartScreen.classList.add("hidden");
    this.els.quizResultScreen.classList.add("hidden");
    this.els.quizQuestionScreen.classList.remove("hidden");
    
    // Ẩn nút Nộp bài và Nav bar của chế độ thường
    const submitBtn = document.getElementById('practice-submit-all');
    if(submitBtn) submitBtn.classList.add("hidden");
    const navContainer = document.getElementById('practice-nav-container');
    if(navContainer) navContainer.innerHTML = ''; // Xóa nav cũ

    this.renderQuickQuestion();
}

// 2. Render câu hỏi hiện tại
renderQuickQuestion() {
    // Kiểm tra nếu hết 5 cây -> Kết thúc
    if (this.quickState.plantIndex >= 5) {
        this.finishQuickSession();
        return;
    }

    const currentItem = this.quickState.items[this.quickState.plantIndex];
    const stage = currentItem.stage;
    const p = currentItem.plant;

    // Xác định câu hỏi dựa trên Stage
    let questionLabel = "";
    let placeholder = "";
    
    if (stage === 0) {
        questionLabel = "Tên Dược liệu này là gì?";
        placeholder = "Nhập tên cây...";
    } else if (stage === 1) {
        questionLabel = `Họ TIẾNG VIỆT của ${currentItem.correctName}?`;
        placeholder = "Ví dụ: Họ Cà phê";
    } else if (stage === 2) {
        questionLabel = `Họ KHOA HỌC của ${currentItem.correctName}?`;
        placeholder = "Ví dụ: Rubiaceae";
    }

    // Render giao diện (Tận dụng layout cũ nhưng sửa nội dung cột phải)
    const imgEl = document.getElementById('practice-image');
    if (imgEl) imgEl.src = `./images/${currentItem.imgSrc}`;

    // DOM Inject cho cột phải (Form)
    // Lưu ý: Ta xóa hết form cũ, thay bằng form đơn giản của Quick Mode
    const rightColumn = document.querySelector('#quiz-question-screen .grid-cols-1 > div:nth-child(2)');
    
    rightColumn.innerHTML = `
        <div class="flex flex-col justify-center h-full gap-4 quick-input-container">
            <div class="flex justify-between text-sm text-[var(--muted-foreground)] uppercase font-bold">
                <span>Cây ${this.quickState.plantIndex + 1}/5</span>
                <span>Câu hỏi ${stage + 1}/3</span>
            </div>
            
            <div class="practice-input-group">
                <label class="text-lg text-[var(--primary)]">${questionLabel}</label>
                <input type="text" id="quick-input" class="practice-input mt-2 p-3 text-lg" placeholder="${placeholder}" autocomplete="off">
            </div>

            <button id="quick-submit-btn" class="w-full py-3 bg-[var(--primary)] text-white font-bold rounded-lg hover:opacity-90 shadow-md">
                Xác nhận (Enter)
            </button>

            <p class="text-xs text-[var(--muted-foreground)] text-center mt-2 italic">
                Trả lời đúng để sang câu tiếp theo. Sai sẽ hiện đáp án và qua cây mới.
            </p>
        </div>
    `;

    // Focus vào ô input
    const inputEl = document.getElementById('quick-input');
    setTimeout(() => inputEl.focus(), 100);

    // Gán sự kiện Enter và Click
    const handleSubmit = () => this.handleQuickAnswer(inputEl.value);
    
    document.getElementById('quick-submit-btn').onclick = handleSubmit;
    inputEl.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleSubmit();
    });
}

// 3. Xử lý đáp án
handleQuickAnswer(userVal) {
    if (this.quickState.isFeedbackShowing) return;

    const currentItem = this.quickState.items[this.quickState.plantIndex];
    const stage = currentItem.stage;
    const p = currentItem.plant;
    const familyInfo = this._parseHoCay(p.hoCay);

    let correctVal = "";
    if (stage === 0) correctVal = currentItem.correctName;
    else if (stage === 1) correctVal = familyInfo.vietnamese;
    else if (stage === 2) correctVal = familyInfo.scientific;

    // Chuẩn hóa và so sánh
    const isCorrect = this._normalizeStr(userVal) === this._normalizeStr(correctVal);

    if (isCorrect) {
        // ĐÚNG -> Sang câu tiếp theo của cây này
        this.showToast("Chính xác! ✨", "success");
        
        currentItem.stage++; // Tăng stage
        
        // Nếu đã xong stage 2 (Họ KH) -> Qua cây mới
        if (currentItem.stage > 2) {
            this.quickState.plantIndex++;
        }
        
        this.renderQuickQuestion();

    } else {
        // SAI -> Hiện đáp án full, lưu lịch sử, qua cây mới
        this.saveWrongHistory(p); // Lưu vào localstorage
        this.showQuickFeedback(p, currentItem.correctName, familyInfo);
    }
}

// 4. Hiển thị bảng đáp án khi sai
showQuickFeedback(plant, imgName, famInfo) {
    this.quickState.isFeedbackShowing = true;

    // Tạo overlay
    const overlay = document.createElement('div');
    overlay.className = 'quick-feedback-overlay';
    overlay.innerHTML = `
        <div class="bg-[var(--card)] text-[var(--foreground)] p-6 rounded-xl max-w-sm w-full shadow-2xl border-2 border-red-500 animate-on-scroll">
            <div class="text-red-500 mb-4 flex justify-center"><i data-lucide="x-circle" class="w-12 h-12"></i></div>
            <h3 class="text-xl font-bold mb-4 text-center">Sai rồi!</h3>
            
            <div class="text-left space-y-2 text-sm bg-[var(--accent)] p-4 rounded-lg mb-4">
                <p><strong>Tên cây:</strong> <span class="text-[var(--primary)]">${imgName}</span></p>
                <p><strong>Họ Tiếng Việt:</strong> ${famInfo.vietnamese}</p>
                <p><strong>Họ Khoa học:</strong> ${famInfo.scientific}</p>
            </div>

            <button id="next-plant-btn" class="w-full py-2 bg-[var(--primary)] text-white rounded-lg font-bold">
                Qua cây tiếp theo
            </button>
        </div>
    `;

    document.body.appendChild(overlay);
    lucide.createIcons();

    // Sự kiện nút Next
    document.getElementById('next-plant-btn').onclick = () => {
        overlay.remove();
        this.quickState.isFeedbackShowing = false;
        this.quickState.plantIndex++; // Buộc qua cây mới
        this.renderQuickQuestion();
    };
}

// 5. Lưu lịch sử sai vào LocalStorage
saveWrongHistory(plant) {
    let history = JSON.parse(localStorage.getItem('wrong_practice_history') || '[]');
    // Kiểm tra xem đã có cây này chưa để tránh trùng lặp
    if (!history.some(h => h.id === plant.id)) {
        history.push({
            id: plant.id,
            name: plant.tenDuocLieu,
            time: new Date().toISOString()
        });
        localStorage.setItem('wrong_practice_history', JSON.stringify(history));
    }
}

// 6. Kết thúc phiên nhanh
finishQuickSession() {
    this.showToast("Đã hoàn thành lượt ôn tập nhanh!", "success");
    // Quay về màn hình Start Quiz
    this.els.quizQuestionScreen.classList.add("hidden");
    this.els.quizStartScreen.classList.remove("hidden");
}
                    // [FIX] Cập nhật hàm navigateToSearch
                    navigateToSearch(searchTerm = "", fromTitle = null) {
                        if (this.currentView.type === "search") {
                            if (searchTerm) {
                                this.els.searchViewInput.value = searchTerm;
                                // [FIX] Hiện nút X ngay lập tức nếu có nội dung
                                this.els.searchClearMobile.classList.remove("hidden");
                                this.renderSearchResults(searchTerm);
                            }
                            return;
                        }

                        const newState = {
                            view: "search",
                            filter: this.currentFilter,
                            backTitle: fromTitle || this.currentListTitle,
                        };

                        history.pushState(newState, "", `#search`);

                        this.showSearchView(false, newState);

                        if (searchTerm) {
                            this.els.searchViewInput.value = searchTerm;
                            // [FIX] Hiện nút X ngay lập tức
                            this.els.searchClearMobile.classList.remove("hidden");
                            this.renderSearchResults(searchTerm);
                        }
                    }
                    showPlantDetail(id, isPoppedState = false, backTitle = "Quay lại", isTransition = true) {
                        // --- LOGIC MỚI: Xử lý ẩn Header thông minh ---
                        // Kiểm tra: Nếu header đang bị ẩn do cuộn (có class header-scroll-hidden)
                        if (this.els.mobileHeader.classList.contains("header-scroll-hidden")) {
                            // 1. Tắt transition ngay lập tức (dùng !important để đè CSS)
                            this.els.mobileHeader.style.setProperty("transition", "none", "important");

                            // 2. Thêm class ẩn hẳn và Gỡ class ẩn do cuộn
                            this.els.mobileHeader.classList.add("header-hidden");
                            this.els.mobileHeader.classList.remove("header-scroll-hidden");

                            // 3. Force Reflow (Bắt trình duyệt cập nhật giao diện ngay lập tức)
                            void this.els.mobileHeader.offsetWidth;

                            // 4. Trả lại transition sau 50ms để khi bấm Quay lại (Back), header hiện ra mượt mà
                            setTimeout(() => {
                                this.els.mobileHeader.style.removeProperty("transition");
                            }, 50);
                        } else {
                            // Nếu header ĐANG HIỆN -> Giữ nguyên hiệu ứng lướt lên cho mượt
                            this.els.mobileHeader.classList.add("header-hidden");
                        }
                        // ---------------------------------------------

                        const plant = this.plants.find((p) => p.id === id);
                        if (!plant) {
                            this.showToast("Không tìm thấy dược liệu.", "error");
                            if (!isPoppedState) history.back();
                            return;
                        }

                        // --- KHÔI PHỤC: Gán dữ liệu vào Sticky Header (Cái gương) ---
                        this.els.stickyTitle.textContent = plant.tenDuocLieu;
                        this.els.stickySubtitle.textContent = plant.hoCay;
                        // -----------------------------------------------------------

                        const { exactMatches, fuzzyMatches } = this.getFilteredPlants();
                        const currentFilteredList = [...exactMatches, ...fuzzyMatches];
                        const currentIndex = currentFilteredList.findIndex((p) => p.id === id);
                        const prevPlant = currentIndex > 0 ? currentFilteredList[currentIndex - 1] : null;
                        const nextPlant =
                            currentIndex < currentFilteredList.length - 1
                                ? currentFilteredList[currentIndex + 1]
                                : null;

                        const relatedFamilyPlants = this.plants.filter(
                            (p) => p.hoCay === plant.hoCay && p.id !== plant.id
                        );
                        const relatedGroupsData = [];
                        const primaryGroupPath = (plant.nhomChat || "").split(",")[0].trim();

                        if (primaryGroupPath) {
                            const groupParts = primaryGroupPath.split(">").map((p) => p.trim());
                            let currentPath = "";
                            for (const part of groupParts) {
                                currentPath = currentPath ? `${currentPath} > ${part}` : part;
                                const normalizedCurrentPath = this._normalizeGroup(currentPath);
                                const relatedPlants = this.plants.filter(
                                    (p) =>
                                        p.id !== plant.id &&
                                        p.nhomChat &&
                                        p.nhomChat
                                            .split(",")
                                            .some((g) =>
                                                this._normalizeGroup(g.trim()).startsWith(normalizedCurrentPath)
                                            )
                                );
                                if (relatedPlants.length > 0) {
                                    relatedGroupsData.push({
                                        groupName: part,
                                        fullPath: currentPath,
                                        plants: relatedPlants,
                                    });
                                }
                            }
                        }

                        // Formatting functions
                        const isThucHanh = plant.isThucHanh === true;
                        const starClass = isThucHanh
                            ? "fill-yellow-400 text-yellow-400"
                            : "text-[var(--muted-foreground)]";
                        const tenKhoaHocDisplay = plant.tenKhoaHoc
                            ? `<a href="https://www.google.com/search?q=${encodeURIComponent(plant.tenKhoaHoc)}" target="_blank" class="group flex items-center gap-2 w-fit text-lg italic text-[var(--primary)] mb-1 hover:text-blue-600 transition-colors"><span>${plant.tenKhoaHoc}</span><i data-lucide="search" class="w-4 h-4 opacity-0 group-hover:opacity-100 transition-opacity"></i></a>`
                            : `<p class="text-lg italic text-[var(--muted-foreground)] opacity-50 mb-1">Chưa cập nhật tên khoa học</p>`;

                        const renderMultilineText = (s) =>
                            !s || !s.trim()
                                ? "<p>Chưa có thông tin</p>"
                                : s.split(/(?:;|\.\s+|\n)/g).filter(Boolean).length <= 1
                                  ? `<p>${s}</p>`
                                  : `<ul class="list-disc pl-5 space-y-1">${s
                                        .split(/(?:;|\.\s+|\n)/g)
                                        .map((i) => i.trim())
                                        .filter(Boolean)
                                        .map((i) => `<li>${i.replace(/\.$/, "")}</li>`)
                                        .join("")}</ul>`;
                        const renderTacDung = (s) =>
                            !s || !s.trim()
                                ? "<p>Chưa có thông tin</p>"
                                : `<ul class="list-disc pl-5 space-y-2">${s
                                      .split(";")
                                      .map((i) => {
                                          const p = i.trim().split(":");
                                          return p.length === 2
                                              ? `<li><span class="font-semibold">${p[0].trim()}:</span> ${p[1].trim()}</li>`
                                              : `<li>${i.trim()}</li>`;
                                      })
                                      .join("")}</ul>`;
                        const renderCongDung = (s) =>
                            !s || !s.trim()
                                ? "<p>Chưa có thông tin</p>"
                                : `<ul class="list-disc pl-5 space-y-2">${s
                                      .split(/(?:;|\.\s*(?=\())/g)
                                      .map((i) => i.trim())
                                      .filter(Boolean)
                                      .map((item) => {
                                          const m = item.match(/^\((.*?)\):\s*(.*)/);
                                          if (m)
                                              return `<li><span class="font-semibold text-[var(--primary)]">${m[1].trim()}:</span> ${m[2].trim().replace(/\.$/, "")}</li>`;
                                          const m2 = item.match(/^(Khác):\s*(.*)/);
                                          if (m2)
                                              return `<li><span class="font-semibold text-[var(--primary)]">${m2[1].trim()}:</span> ${m2[2].trim().replace(/\.$/, "")}</li>`;
                                          return `<li>${item}</li>`;
                                      })
                                      .join("")}</ul>`;

                        // Render HTML
                        const defaultImg = `./images/${plant.id}.jpg`;
                        let mainImgSrc = defaultImg;
                        let mainImgCaption = "";
                        let galleryHTML = "";

                        // Nếu có gallery, ưu tiên lấy ảnh đầu tiên làm ảnh chính (hoặc giữ default)
                        if (plant.gallery && Array.isArray(plant.gallery) && plant.gallery.length > 0) {
                            mainImgSrc = `./images/${plant.gallery[0].src}`; 
                            mainImgCaption = plant.gallery[0].title || "";

                            // Tạo HTML cho danh sách ảnh nhỏ
                            const thumbs = plant.gallery.map((img, index) => `
                                <img src="./images/${img.src}" 
                                     class="thumb-item ${index === 0 ? 'active' : ''}" 
                                     onclick="app.switchGalleryImage(this, '${img.src}', '${img.title || ''}')"
                                     onerror="this.style.display='none'">
                            `).join("");
                            
                            galleryHTML = `<div class="gallery-thumbs mt-3">${thumbs}</div>`;
                        }

                        // Render HTML
                        this.els.plantDetailView.innerHTML = `
                        <div class="max-w-4xl mx-auto">
                            <div class="md:hidden -mx-4 px-2 pt-2 pb-1 mb-2 top-0 bg-[var(--background)]/80 backdrop-blur-sm z-20 flex items-center justify-between">
                                <button id="back-to-list-mobile" class="flex items-center gap-1 text-sm font-medium text-[var(--primary)] p-2 rounded-lg custom-ring max-w-[calc(100%-60px)]">
                                    <i data-lucide="chevron-left" class="w-5 h-5 flex-shrink-0"></i><span class="truncate">${backTitle}</span>
                                </button>
                                <button id="detail-home-btn-mobile" class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring"><i data-lucide="home"></i></button>
                            </div>

                            <div class="hidden md:flex items-center justify-between mb-4">
                                <button id="back-to-list-desktop" class="flex items-center gap-2 text-[var(--muted-foreground)] hover:text-[var(--primary)] transition-colors font-medium custom-ring rounded-md -ml-2 p-1">
                                    <i data-lucide="arrow-left"></i><span>${backTitle}</span>
                                </button>
                                <button id="detail-home-btn-desktop" class="p-2 rounded-full text-[var(--muted-foreground)] hover:bg-[var(--accent)] hover:text-[var(--primary)] transition-colors custom-ring"><i data-lucide="home"></i></button>
                            </div>

                            <div class="detail-section animate-on-scroll">
                                <div class="bg-[var(--card)] rounded-xl border border-[var(--border)] p-6 md:p-8">
                                    
                                    <div class="w-full flex flex-col items-center mb-6">
                                        <div class="w-full flex justify-center bg-[var(--accent)]/30 rounded-lg overflow-hidden relative">
                                            <img id="detail-main-img" 
                                                 src="${mainImgSrc}" 
                                                 alt="${plant.tenDuocLieu}" 
                                                 class="plant-img-detail mb-0" 
                                                 style="margin-bottom: 0;"
                                                 onerror="this.style.display='none';">
                                        </div>
                                        <p id="detail-img-caption" class="img-caption">${mainImgCaption}</p>
                                        ${galleryHTML}
                                    </div>
                                    <div class="flex flex-col md:flex-row justify-between md:items-start mb-6 gap-4">
                                        <div class="flex-1 plant-title-block">
                                            <div class="flex items-start gap-3">
                                                <h2 class="text-3xl font-bold">${plant.tenDuocLieu}</h2>
                                                <button onclick="app.togglePractice('${plant.id}')" class="mt-1 p-2 rounded-full hover:bg-[var(--accent)] transition-colors custom-ring">
                                                    <i data-lucide="star" class="w-6 h-6 ${starClass}"></i>
                                                </button>
                                            </div>
                                            ${tenKhoaHocDisplay}
                                            <p class="text-lg text-[var(--muted-foreground)]">${this._createSearchTrigger(plant.hoCay)}</p>
                                        </div>
                                        <div class="relative flex-shrink-0">
                                            <button id="detail-actions-btn" class="p-2 bg-[var(--secondary)] hover:bg-[var(--accent)] rounded-full custom-ring"><i data-lucide="more-vertical"></i></button>
                                            <div id="detail-actions-menu" class="detail-actions-menu hidden absolute top-full right-0 mt-2 w-40 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg p-1 z-10">
                                                <button class="w-full text-left flex items-center gap-3 px-3 py-2 rounded hover:bg-[var(--accent)]" data-action="edit"><i data-lucide="edit-3" class="w-4 h-4"></i><span>Chỉnh sửa</span></button>
                                                <button class="w-full text-left flex items-center gap-3 px-3 py-2 rounded text-red-600 hover:bg-red-50" data-action="delete"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Xóa</span></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="space-y-6">
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Nhóm chất</h4><div data-key-value="nhomChat">${this._renderClickableItems(plant.nhomChat)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Thành phần hóa học chính</h4><div data-key-value="thanhPhanHoaHocChinh">${this._renderClickableItems(plant.thanhPhanHoaHocChinh)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Bộ phận dùng</h4><div data-key-value="boPhanDung">${this._renderClickableItems(plant.boPhanDung)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Tác dụng</h4><div data-key-value="tacDung">${renderTacDung(plant.tacDung)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Công dụng</h4><div data-key-value="congDung">${renderCongDung(plant.congDung)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Liều dùng</h4><div data-key-value="lieuDung">${renderMultilineText(plant.lieuDung)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Lưu ý</h4><div data-key-value="luuY">${renderMultilineText(plant.luuY)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Đặc điểm dược liệu</h4><div data-key-value="dacDiemDuocLieu">${renderMultilineText(plant.dacDiemDuocLieu)}</div></div>
                                    </div>
                                </div>
                            </div>
                            
                            ${
                                prevPlant || nextPlant
                                    ? `<div class="detail-section mt-8"><div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${prevPlant ? `<a href="#detail/${prevPlant.id}" data-id="${prevPlant.id}" class="nav-link block p-4 rounded-xl bg-[var(--card)] border border-[var(--border)] hover:border-[var(--primary)] transition-all text-left group animate-on-scroll"><p class="text-sm text-[var(--muted-foreground)] flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4 transition-transform group-hover:-translate-x-1"></i> Trước</p><h4 class="font-semibold text-lg truncate">${prevPlant.tenDuocLieu}</h4></a>` : "<div></div>"}
                                ${nextPlant ? `<a href="#detail/${nextPlant.id}" data-id="${nextPlant.id}" class="nav-link block p-4 rounded-xl bg-[var(--card)] border border-[var(--border)] hover:border-[var(--primary)] transition-all text-right group animate-on-scroll"><p class="text-sm text-[var(--muted-foreground)] flex items-center justify-end gap-2">Sau <i data-lucide="arrow-right" class="w-4 h-4 transition-transform group-hover:translate-x-1"></i></p><h4 class="font-semibold text-lg truncate">${nextPlant.tenDuocLieu}</h4></a>` : "<div></div>"}
                            </div></div>`
                                    : ""
                            }
                            ${
                                relatedFamilyPlants.length > 0
                                    ? `<div class="detail-section mt-8"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Cây cùng họ</h3></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${relatedFamilyPlants
                                          .slice(0, 3)
                                          .map((p) => this.createPlantCardHTML(p))
                                          .join("")}</div></div>`
                                    : ""
                            }
                            
                             ${relatedGroupsData
                                 .map(
                                     (groupData) =>
                                         `<div class="detail-section mt-8"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold">Cây cùng nhóm ${groupData.groupName}</h3></div><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${groupData.plants
                                             .slice(0, 3)
                                             .map((p) => this.createPlantCardHTML(p))
                                             .join("")}</div></div>`
                                 )
                                 .join("")}

                        </div>`;

                        // --- KHÔI PHỤC: Gọi hàm transition đúng kiểu cũ ---
                        if (isTransition) {
                            // [CẬP NHẬT] Thêm tham số true (immediateSwap) vào cuối
                            // Để List biến mất ngay và Detail hiện lên cùng lúc Header chạy
                            this.transitionView(this.getActiveViewElement(), this.els.plantDetailView, null, true);
                        }
                        this.els.plantDetailView.scrollTop = 0;

                        // --- KHÔI PHỤC: Logic cuộn hiện Header Gương ---
                        if (this.handleDetailScroll) {
                            this.els.plantDetailView.removeEventListener("scroll", this.handleDetailScroll);
                        }
                        // Gán lại ngữ cảnh cho hàm handleDetailScroll
                        this.handleDetailScroll = this.handleDetailScroll.bind(this);
                        this.els.plantDetailView.addEventListener("scroll", this.handleDetailScroll);
                        // ------------------------------------------------

                        this.setupDetailViewEventListeners(id);
                    }
                    switchGalleryImage(thumbEl, src, caption) {
                        // 1. Đổi ảnh lớn
                        const mainImg = document.getElementById('detail-main-img');
                        const captionEl = document.getElementById('detail-img-caption');
                        
                        // Hiệu ứng mờ nhẹ khi đổi
                        mainImg.style.opacity = 0.5;
                        setTimeout(() => {
                            mainImg.src = `./images/${src}`;
                            mainImg.style.opacity = 1;
                        }, 150);

                        // 2. Đổi chú thích
                        if(captionEl) captionEl.textContent = caption;

                        // 3. Đổi active class cho thumbnail
                        document.querySelectorAll('.thumb-item').forEach(el => el.classList.remove('active'));
                        thumbEl.classList.add('active');
                    }
                    setupDetailViewEventListeners(plantId) {
                        const detailContent = this.els.plantDetailView.querySelector(".max-w-4xl");
                        if (!detailContent) return;
                        const plant = this.plants.find((p) => p.id === plantId);
                        if (!plant) return;

                        // --- CÁC SỰ KIỆN NÚT BẤM (GIỮ NGUYÊN) ---
                        detailContent
                            .querySelector("#back-to-list-desktop")
                            ?.addEventListener("click", () => window.history.back());
                        detailContent
                            .querySelector("#back-to-list-mobile")
                            ?.addEventListener("click", () => window.history.back());
                        detailContent
                            .querySelector("#detail-home-btn-desktop")
                            ?.addEventListener("click", () => this.goHome());
                        detailContent
                            .querySelector("#detail-home-btn-mobile")
                            ?.addEventListener("click", () => this.goHome());

                        const actionsBtn = detailContent.querySelector("#detail-actions-btn");
                        const actionsMenu = detailContent.querySelector("#detail-actions-menu");
                        if (actionsBtn && actionsMenu) {
                            actionsBtn.addEventListener("click", (e) => {
                                e.stopPropagation();
                                actionsMenu.classList.toggle("hidden");
                            });
                            actionsMenu.querySelector('[data-action="edit"]').addEventListener("click", (e) => {
                                actionsMenu.classList.add("hidden");
                                this.enterEditMode(plantId);
                            });
                            actionsMenu
                                .querySelector('[data-action="delete"]')
                                .addEventListener("click", () => this.deletePlant(plantId));
                            document.addEventListener("click", () => actionsMenu.classList.add("hidden"), {
                                once: true,
                            });
                        }

                        detailContent.addEventListener("click", (e) => {
                            const trigger = e.target.closest(".search-trigger");
                            if (trigger) {
                                e.preventDefault();
                                const term = trigger.dataset.searchTerm;
                                // Fix logic điều hướng search để mượt hơn
                                if (this.isMobile()) {
                                    this.navigateToSearch(term);
                                } else {
                                    this.currentFilter.group = "all";
                                    this.currentFilter.search = term;
                                    this.els.searchInput.value = term;
                                    this.els.searchClearDesktop.classList.remove("hidden");
                                    history.pushState({ view: "list", filter: this.currentFilter }, "", "#list");
                                    this.showListView();
                                }
                            }
                            const link = e.target.closest(".nav-link, .plant-card");
                            if (link) {
                                const plantIdToNav = link.dataset.id;
                                if (plantIdToNav && plantIdToNav !== plantId) {
                                    e.preventDefault();
                                    this.navigateToDetail(plantIdToNav);
                                }
                            }
                        });

                        // --- [FIX] ĐOẠN MÃ QUAN TRỌNG ĐỂ TẠO HIỆU ỨNG ---

                        // 1. Reset trạng thái animation trước khi chạy (để đảm bảo nó chạy lại mỗi lần mở)
                        const allAnimated = detailContent.querySelectorAll(".animate-on-scroll");
                        allAnimated.forEach((el) => el.classList.remove("is-visible"));

                        // 2. Animate khối thông tin chính (Header, các dòng thông tin, nút điều hướng)
                        // Lưu ý: Đã bỏ ":scope >" để tìm kiếm linh hoạt hơn
                        const mainAnimatedElements = detailContent.querySelectorAll(
                            ".detail-section.animate-on-scroll, .detail-section .nav-link.animate-on-scroll"
                        );

                        mainAnimatedElements.forEach((el, index) => {
                            // Delay tăng dần: 0ms, 100ms, 200ms... tạo hiệu ứng domino rõ rệt
                            el.style.transitionDelay = `${index * 100}ms`;
                            this.observer.observe(el);
                        });

                        // 3. Animate riêng từng khối gợi ý (Cây cùng họ, cùng nhóm)
                        const suggestionSections = detailContent.querySelectorAll(
                            ".detail-section:not(.animate-on-scroll)"
                        );
                        suggestionSections.forEach((section) => {
                            const elementsToAnimate = section.querySelectorAll(".plant-card.animate-on-scroll");
                            elementsToAnimate.forEach((card, index) => {
                                // Reset delay cho từng nhóm card để chúng chạy đẹp mắt
                                card.style.transitionDelay = `${index * 80}ms`;
                                this.observer.observe(card);
                            });
                        });

                        lucide.createIcons();
                    }
                    _createSearchTrigger(term, isTag = false) {
                        const baseClasses =
                            "search-trigger inline-block cursor-pointer transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] rounded";
                        const tagClasses =
                            "bg-[var(--accent)] text-[var(--accent-foreground)] px-3 py-1 text-sm mr-1 mb-1 hover:bg-[var(--primary)] hover:text-[var(--primary-foreground)]";
                        const linkClasses = "text-[var(--primary)] hover:underline";
                        return `<button class="${baseClasses} ${isTag ? tagClasses : linkClasses}" data-search-term="${term.trim()}">${term.trim()}</button>`;
                    }

                    _renderClickableItems(text) {
                        if (!text || text.trim() === "") return "Chưa có thông tin";
                        return text
                            .split(/,(?![^\(]*\))/)
                            .map((item) => this._createSearchTrigger(item.trim(), true))
                            .join(" ");
                    }

                    showListView(isPoppedState = false) {
                        this.currentView = { type: "list" };

                        // Reset Header về trạng thái chuẩn
                        this.els.mobileHeader.classList.remove("header-hidden");
                        this.els.mobileHeader.classList.remove("header-scroll-hidden");
                        this.els.stickyHeader.classList.add("-translate-y-full");

                        // Mở khóa grid (nếu bị khóa bởi sự kiện click trước đó)
                        this.els.plantListGrid.classList.remove("grid-locked");

                        const fromView = this.getActiveViewElement();

                        this.transitionView(fromView, this.els.plantListContainer, () => {
                            // [QUAN TRỌNG] Render lại dữ liệu NGAY LẬP TỨC trước khi hiện ra
                            this.renderAll();

                            if (isPoppedState) {
                                // Nếu là Back, khôi phục vị trí cuộn
                                const scrollY = history.state?.scrollY || 0;
                                // Dùng setTimeout 0 để đảm bảo DOM đã render xong mới cuộn
                                setTimeout(() => {
                                    this.els.plantListContainer.scrollTop = scrollY;
                                }, 0);
                            } else {
                                // Nếu là mới vào, cuộn lên đầu
                                this.els.plantListContainer.scrollTop = 0;
                            }
                        });

                        // Dọn dẹp view chi tiết cho nhẹ máy
                        this.els.plantDetailView.innerHTML = "";
                    }
                    // [FIXED] Hàm hiển thị tìm kiếm Mobile
                    showSearchView(isPopped = false, state = {}) {
                        this.currentView = { type: "search" };

                        // Ẩn header chính của mobile
                        this.els.mobileHeader.classList.add("header-hidden");

                        // --- QUAN TRỌNG: Gỡ bỏ class 'hidden' do transitionView có thể đã thêm vào trước đó ---
                        this.els.searchView.classList.remove("hidden");

                        // Hiệu ứng trượt vào
                        this.els.searchView.classList.remove("translate-x-full");

                        this.els.searchViewBackLabel.textContent = state.backTitle || "Quay lại";

                        // Logic focus: Luôn focus nếu input đang trống (tiện lợi hơn)
                        if (!this.els.searchViewInput.value) {
                            setTimeout(() => this.els.searchViewInput.focus(), 100);
                        }
                        // Thêm vào cuối hàm
                        this.els.searchClearMobile.classList.toggle("hidden", !this.els.searchViewInput.value);
                    }

                    hideSearchView(isPopped = false) {
                        if (this.currentView.type === "list") {
                            this.els.mobileHeader.classList.remove("header-hidden");
                        }

                        // Trượt ra ngoài
                        this.els.searchView.classList.add("translate-x-full");

                        // Thêm hidden sau khi animation chạy xong (tùy chọn, nhưng an toàn nhất là để transitionView lo)
                        // Tuy nhiên, ta cần xóa giá trị input để lần sau mở ra nó sạch sẽ (trừ khi Back)
                        if (!isPopped) {
                            this.els.searchViewInput.value = "";
                            this.els.searchClearMobile.classList.add("hidden"); // Ẩn nút X khi đóng
                            this.renderSearchResults("");
                        }
                    }

                    // Thay thế hoàn toàn phương thức renderSearchResults cũ
                    renderSearchResults(query) {
                        this.els.searchResultsGrid.classList.remove("grid-locked");
                        const normalizedQuery = this._normalizeText(query);

                        // 1. Xử lý khi input rỗng
                        if (!normalizedQuery) {
                            this.els.searchResultsGrid.innerHTML = `
            <div class="text-center text-[var(--muted-foreground)] pt-10 animate-on-scroll is-visible">
                <i data-lucide="search" class="w-12 h-12 mx-auto mb-4"></i>
                <p>Tìm kiếm dược liệu theo tên, họ, ...</p>
            </div>`;
                            this.handleSearchAutocomplete(query, this.els.searchViewInput);
                            lucide.createIcons();
                            return;
                        }

                        // 2. Logic lọc dữ liệu (Data processing layer)
                        const originalFilter = { ...this.currentFilter };
                        this.currentFilter.group = "all";
                        this.currentFilter.search = query;
                        const { exactMatches, fuzzyMatches } = this.getFilteredPlants();
                        this.currentFilter = originalFilter;

                        // 3. Render HTML (Presentation layer)
                        let html = "";
                        if (exactMatches.length === 0 && fuzzyMatches.length === 0) {
                            html = `
            <div class="col-span-full text-center text-[var(--muted-foreground)] pt-10 animate-on-scroll">
                <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4"></i>
                <p class="font-semibold">Không tìm thấy kết quả cho "${query}"</p>
            </div>`;
                        } else {
                            if (exactMatches.length > 0) {
                                html += `<h2 class="col-span-full sticky-group-header text-sm font-semibold uppercase text-[var(--muted-foreground)] tracking-wider mb-2">Có ${exactMatches.length} kết quả khớp nhất</h2>`;
                                html += exactMatches
                                    .map((p) => this.createPlantCardHTML(p, this._findMatchContext(p, normalizedQuery)))
                                    .join("");
                            }
                            if (fuzzyMatches.length > 0) {
                                html += `<h2 class="col-span-full sticky-group-header text-sm font-semibold uppercase text-[var(--muted-foreground)] tracking-wider mt-6 mb-2">Có thể bạn đang tìm...</h2>`;
                                html += fuzzyMatches
                                    .map((p) => this.createPlantCardHTML(p, this._findMatchContext(p, normalizedQuery)))
                                    .join("");
                            }
                        }

                        this.els.searchResultsGrid.innerHTML = `<div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pb-20">${html}</div>`;

                        // 4. Kích hoạt Animation & Events (Interaction layer)
                        this.addEventListenersToCards(this.els.searchResultsGrid, true);

                        // [FIX QUAN TRỌNG] Reset và thêm delay cho animation
                        const animatedElements = this.els.searchResultsGrid.querySelectorAll(".animate-on-scroll");
                        animatedElements.forEach((el, i) => {
                            el.classList.remove("is-visible"); // Reset trạng thái để animation chạy lại
                            el.style.transitionDelay = `${i * 50}ms`; // Hiệu ứng domino (50ms mỗi item)
                            this.observer.observe(el);
                        });

                        this.handleSearchAutocomplete(query, this.els.searchViewInput);
                        lucide.createIcons();
                    }

                    // THÊM HÀM MỚI NÀY
                    handleSearchAutocomplete(value, inputEl) {
                        const isMobile = inputEl.id === "search-view-input";
                        const ghostEl = isMobile ? this.els.searchViewGhostText : this.els.searchGhostText;
                        const listEl = isMobile ? null : this.els.searchAutocompleteList; // Mobile không có list riêng

                        if (!value) {
                            ghostEl.textContent = "";
                            if (listEl) listEl.classList.add("hidden");
                            if (isMobile) this.els.searchResultsGrid.innerHTML = "";
                            return;
                        }

                        const normalizedValue = this._normalizeText(value);
                        const suggestions = this.plants
                            .filter((p) => this._normalizeText(p.tenDuocLieu).startsWith(normalizedValue))
                            .sort((a, b) => a.tenDuocLieu.localeCompare(b.tenDuocLieu));

                        // Cập nhật ghost text
                        if (suggestions.length > 0) {
                            const topSuggestion = suggestions[0].tenDuocLieu;
                            if (topSuggestion.toLowerCase().startsWith(value.toLowerCase())) {
                                ghostEl.textContent = value + topSuggestion.substring(value.length);
                            } else {
                                ghostEl.textContent = "";
                            }
                        } else {
                            ghostEl.textContent = "";
                        }

                        // Cập nhật danh sách gợi ý (chỉ cho desktop)
                        if (listEl) {
                            if (suggestions.length > 0) {
                                listEl.innerHTML = suggestions
                                    .slice(0, 3)
                                    .map(
                                        (p) =>
                                            `<div class="autocomplete-item px-3 py-2 cursor-pointer hover:bg-[var(--accent)]" data-value="${p.tenDuocLieu}">${p.tenDuocLieu}</div>`
                                    )
                                    .join("");
                                listEl.classList.remove("hidden");
                            } else {
                                listEl.classList.add("hidden");
                            }
                        }
                    }
                    isPlantInGroup(plant, groupFilter) {
                        if (groupFilter === "all") return true;
                        const normalizedFilterGroup = this._normalizeGroup(this._normalizeText(groupFilter));
                        return (
                            plant.nhomChat &&
                            this._normalizeText(plant.nhomChat)
                                .split(",")
                                .some((c) => this._normalizeGroup(c.trim()).startsWith(normalizedFilterGroup))
                        );
                    }
                    handleDetailScroll() {
                        const t = this.els.plantDetailView.querySelector(".plant-title-block");
                        if (!t) return;
                        this.els.stickyHeader.classList.toggle(
                            "-translate-y-full",
                            this.els.plantDetailView.scrollTop <= t.offsetHeight
                        );
                    }
                    handleSearch(q) {
                        this.currentFilter.search = q;
                        this.renderAll();
                    }
                    handleGroupFilter(g) {
                        this.currentFilter.group = g;
                        this.currentListTitle = g === "all" ? "Tất cả Dược liệu" : g;
                        this.currentFilter.search = "";
                        this.els.searchInput.value = "";
                        this.clearSelection();
                        history.pushState({ view: "list", filter: this.currentFilter }, "", "#list");
                        this.showListView();
                    }
                    handleFormSubmit(e) {
                        e.preventDefault();
                        const id = this.els.plantIdInput.value;
                        if (!id) {
                            this.showToast("Lỗi: Không tìm thấy ID dược liệu để cập nhật.", "error");
                            this.closeModal();
                            return;
                        }
                        const data = {
                            tenDuocLieu: this.els.tenDuocLieu.input.value,
                            hoCay: this.els.hoCay.input.value,
                            nhomChat: this.els.nhomChat.input.value,
                            thanhPhanHoaHocChinh: this.els.thanhPhanHoaHocChinh.input.value,
                            boPhanDung: this.els.boPhanDung.input.value,
                            tacDung: this.els.tacDung.input.value,
                            congDung: this.els.congDung.input.value,
                            lieuDung: this.els.lieuDung.input.value,
                            luuY: this.els.luuY.input.value,
                            dacDiemDuocLieu: this.els.dacDiemDuocLieu.input.value,
                        };
                        this.updatePlant(id, data);
                        this.closeModal();
                    }
                    getFilteredPlants() {
                        const rawQuery = this.currentFilter.search;
                        let groupFilteredPlants = [];

                        // [LOGIC MỚI] Xử lý lọc theo nhóm
                        if (this.currentFilter.group === "practice") {
                            // Lọc các cây có đánh dấu thực hành
                            groupFilteredPlants = this.plants.filter((p) => p.isThucHanh === true);
                        } else {
                            // Lọc theo nhóm bình thường
                            groupFilteredPlants = this.plants.filter((p) =>
                                this.isPlantInGroup(p, this.currentFilter.group)
                            );
                        }

                        if (!rawQuery) {
                            return { exactMatches: groupFilteredPlants, fuzzyMatches: [] };
                        }

                        // ... (Phần logic tìm kiếm bên dưới giữ nguyên không đổi) ...
                        const normalizedQuery = this._normalizeText(rawQuery);
                        const exactMatches = [];
                        const fuzzyMatches = [];
                        const addedIds = new Set();

                        groupFilteredPlants.forEach((plant) => {
                            const tenDuocLieuNorm = this._normalizeText(plant.tenDuocLieu);
                            const hoCayNorm = this._normalizeText(plant.hoCay);

                            let score = 0;
                            if (tenDuocLieuNorm.startsWith(normalizedQuery)) {
                                score = 100;
                            } else if (tenDuocLieuNorm.includes(normalizedQuery)) {
                                score = 50;
                            } else if (hoCayNorm.includes(normalizedQuery)) {
                                score = 20;
                            }

                            if (score > 0) {
                                exactMatches.push({ ...plant, score });
                                addedIds.add(plant.id);
                            }
                        });

                        groupFilteredPlants.forEach((plant) => {
                            if (addedIds.has(plant.id)) return;
                            const fuzzyKeys = [
                                "nhomChat",
                                "thanhPhanHoaHocChinh",
                                "boPhanDung",
                                "tacDung",
                                "congDung",
                                "dacDiemDuocLieu",
                            ];
                            for (const key of fuzzyKeys) {
                                if (plant[key] && this._normalizeText(plant[key]).includes(normalizedQuery)) {
                                    fuzzyMatches.push(plant);
                                    addedIds.add(plant.id);
                                    break;
                                }
                            }
                        });

                        exactMatches.sort((a, b) => {
                            if (a.score !== b.score) return b.score - a.score;
                            return a.tenDuocLieu.localeCompare(b.tenDuocLieu);
                        });

                        return { exactMatches: exactMatches.map(({ score, ...rest }) => rest), fuzzyMatches };
                    }

                    _findMatchContext(plant, normalizedQuery) {
                        if (!normalizedQuery) return null;

                        if (this._normalizeText(plant.tenDuocLieu).includes(normalizedQuery)) {
                            return { query: normalizedQuery, field: null, context: null };
                        }
                        if (this._normalizeText(plant.hoCay).includes(normalizedQuery)) {
                            return { query: normalizedQuery, field: null, context: null };
                        }

                        const searchableFields = [
                            { key: "thanhPhanHoaHocChinh", label: "TPHH" },
                            { key: "boPhanDung", label: "Bộ phận dùng" },
                            { key: "tacDung", label: "Tác dụng" },
                            { key: "congDung", label: "Công dụng" },
                            { key: "nhomChat", label: "Nhóm chất" },
                        ];

                        for (const { key, label } of searchableFields) {
                            const text = plant[key];
                            const normalizedText = this._normalizeText(text);
                            if (text && normalizedText.includes(normalizedQuery)) {
                                const matchIndex = normalizedText.indexOf(normalizedQuery);
                                const start = Math.max(0, matchIndex - 20);
                                const end = Math.min(text.length, matchIndex + normalizedQuery.length + 20);
                                let snippet = text.substring(start, end);
                                if (start > 0) snippet = "..." + snippet;
                                if (end < text.length) snippet = snippet + "...";
                                return { query: normalizedQuery, field: label, context: snippet };
                            }
                        }
                        return null;
                    }

                    _highlightText(text, query) {
                        if (!query || !text) return text;
                        const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
                        const queryRegex = new RegExp(`(${escapeRegExp(this.currentFilter.search)})`, "gi");
                        return text.replace(queryRegex, `<mark class="search-highlight">$1</mark>`);
                    }
                    // --- BẮT ĐẦU THÊM VÀO TRONG CLASS MedicinalPlantApp ---

// --- THAY THẾ HÀM startPracticeSession CŨ BẰNG HÀM NÀY ---

startPracticeSession() {
    // 1. Lọc ra các cây có đánh dấu THỰC HÀNH
    const practicePlants = this.plants.filter(p => p.isThucHanh === true);

    if (practicePlants.length < 5) {
        this.showToast("Cần ít nhất 5 dược liệu thuộc danh sách 'Thực hành' để bắt đầu.", "error");
        return;
    }

    // 2. Trộn ngẫu nhiên danh sách cây thực hành và lấy 5 CÂY KHÁC NHAU
    // Việc lấy cây trước khi lấy ảnh đảm bảo không bao giờ bị trùng cây trong 1 lượt.
    const selectedPlants = practicePlants.sort(() => 0.5 - Math.random()).slice(0, 5);

    // 3. Với mỗi cây, chọn ngẫu nhiên 1 ảnh (Ava hoặc Gallery) để làm đề
    const sessionItems = selectedPlants.map(p => {
        // Tập hợp tất cả ảnh khả dụng của cây này
        const availableImages = [];

        // Ảnh mặc định theo ID
        availableImages.push({
            src: `${p.id}.jpg`,
            name: p.tenDuocLieu // Đáp án mặc định
        });

        // Ảnh trong Gallery (nếu có)
        if (p.gallery && Array.isArray(p.gallery)) {
            p.gallery.forEach(g => {
                availableImages.push({
                    src: g.src,
                    // Nếu ảnh gallery có tên riêng (title) thì dùng nó làm đáp án, không thì dùng tên cây
                    name: g.title && g.title.trim() ? g.title.trim() : p.tenDuocLieu
                });
            });
        }

        // Chọn ngẫu nhiên 1 ảnh trong số các ảnh của cây này
        const randomImg = availableImages[Math.floor(Math.random() * availableImages.length)];

        return {
            plant: p,
            imgSrc: randomImg.src,
            correctName: randomImg.name
        };
    });

    // --- PHẦN UI SETUP (GIỮ NGUYÊN) ---
    this.practiceState = {
        items: sessionItems,
        currentIndex: 0,
        userAnswers: sessionItems.map(() => ({
            name: '', familyVn: '', familySci: '', part: '', chem: ''
        })),
        isSubmitted: false
    };

    // UI Setup
    this.els.quizStartScreen.classList.add("hidden");
    this.els.quizResultScreen.classList.add("hidden");
    this.els.quizQuestionScreen.classList.remove("hidden");
    
    // Ẩn nút Next/Prev của Quiz cũ nếu có, hiển thị nút Submit
    const submitBtn = document.getElementById('practice-submit-all');
    if(submitBtn) {
        submitBtn.classList.remove("hidden");
        submitBtn.onclick = () => this.submitPractice();
        submitBtn.textContent = "Nộp bài";
        submitBtn.disabled = false;
    }

    this.renderPracticeNav();
    this.renderPracticeQuestion(0);
}
// 2. Render thanh điều hướng (1, 2, 3, 4, 5)
renderPracticeNav() {
    const container = document.getElementById('practice-nav-container');
    if (!container) return;
    
    // Tạo HTML cho các nút
    container.innerHTML = this.practiceState.items.map((_, idx) => `
        <button class="practice-nav-btn ${idx === this.practiceState.currentIndex ? 'active' : ''}" 
                data-index="${idx}"
                type="button">
            ${idx + 1}
        </button>
    `).join('');

    // [FIX] Gán sự kiện trực tiếp bằng JS thay vì onclick="..."
    container.querySelectorAll('.practice-nav-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            // Lấy index từ data attribute
            const idx = parseInt(e.currentTarget.dataset.index);
            this.switchPracticeQuestion(idx);
        });
    });
}
// 3. Chuyển câu hỏi
switchPracticeQuestion(index) {
    try {
        // Chặn nếu index không hợp lệ
        if (typeof index !== 'number' || index < 0 || index >= this.practiceState.items.length) {
            return;
        }

        // Nếu đã nộp bài, chỉ chuyển câu để xem, không lưu input nữa
        if (this.practiceState.isSubmitted) {
            this.renderPracticeQuestion(index);
            return;
        }

        // Lưu dữ liệu câu hiện tại trước khi chuyển
        this.saveCurrentPracticeInput();
        
        // Chuyển sang câu mới
        this.renderPracticeQuestion(index);
    } catch (err) {
        console.error("Lỗi chuyển câu:", err);
    }
}
// 4. Lưu input người dùng vào state
saveCurrentPracticeInput() {
    if (this.practiceState.isSubmitted) return;
    
    const inputs = document.querySelectorAll('.practice-input');
    const currentAns = this.practiceState.userAnswers[this.practiceState.currentIndex];
    
    inputs.forEach(input => {
        const field = input.dataset.field;
        currentAns[field] = input.value;
    });
    
    // Cập nhật style nút nav nếu đã điền
    const navBtn = document.querySelectorAll('.practice-nav-btn')[this.practiceState.currentIndex];
    const hasData = Object.values(currentAns).some(v => v.trim() !== '');
    if (hasData && navBtn) navBtn.classList.add('completed');
}

// 5. Hiển thị câu hỏi (Ảnh + Reset Form)
renderPracticeQuestion(index) {
    this.practiceState.currentIndex = index;
    const item = this.practiceState.items[index];
    const userAnswer = this.practiceState.userAnswers[index];

    // Cập nhật Nav active
    document.querySelectorAll('.practice-nav-btn').forEach((btn, i) => {
        btn.classList.toggle('active', i === index);
    });

    // Cập nhật Ảnh
    const imgEl = document.getElementById('practice-image');
    if (imgEl) {
        imgEl.src = `./images/${item.imgSrc}`;
        // Reset fallback
        imgEl.style.display = 'block';
        imgEl.onerror = () => { imgEl.style.display = 'none'; };
    }

    // Cập nhật Form
    const inputs = document.querySelectorAll('.practice-input');
    const diffContainers = document.querySelectorAll('.diff-container');

    inputs.forEach(input => {
        const field = input.dataset.field;
        input.value = userAnswer[field] || '';
        
        // Nếu đã nộp bài, disable input và tô màu
        input.disabled = this.practiceState.isSubmitted;
        if (!this.practiceState.isSubmitted) {
            input.classList.remove('correct', 'incorrect');
        }
    });

    // Nếu đã nộp bài, hiển thị kết quả chấm
    if (this.practiceState.isSubmitted) {
        this.renderPracticeDiff(index);
    } else {
        diffContainers.forEach(div => div.innerHTML = '');
    }
}

// 6. Xử lý Nộp bài
submitPractice() {
    this.saveCurrentPracticeInput(); // Lưu câu cuối cùng
    
    this.showConfirm("Bạn có chắc muốn nộp bài? Bạn sẽ không thể sửa lại sau khi nộp.", () => {
        this.practiceState.isSubmitted = true;
        document.getElementById('practice-submit-all').textContent = "Đã nộp bài";
        document.getElementById('practice-submit-all').disabled = true;
        
        // Render lại câu hiện tại để hiện kết quả
        this.renderPracticeQuestion(this.practiceState.currentIndex);
        
        // Tính tổng điểm
        this.calculatePracticeScore();
    });
}

// 7. Logic chuẩn hóa chuỗi và so sánh
_normalizeStr(str) {
    return str.toLowerCase().trim().replace(/\s+/g, ' ');
}

// 8. Chấm điểm và hiển thị sai khác (Hàm quan trọng nhất)
renderPracticeDiff(index) {
    const item = this.practiceState.items[index];
    const user = this.practiceState.userAnswers[index];
    const p = item.plant;
    
    // Lấy thông tin họ
    const familyInfo = this._parseHoCay(p.hoCay);

    // Định nghĩa đáp án đúng
    const correctData = {
        name: item.correctName,
        familyVn: familyInfo.vietnamese,
        familySci: familyInfo.scientific,
        part: p.boPhanDung,
        chem: p.thanhPhanHoaHocChinh
    };

    // Helper: So sánh và render UI
    const checkField = (fieldKey, userVal, correctVal, type = 'text') => {
        const inputEl = document.querySelector(`.practice-input[data-field="${fieldKey}"]`);
        const resEl = document.getElementById(`res-${fieldKey}`);
        let isCorrect = false;

        // Logic so sánh
        if (type === 'text') {
            // So sánh chuỗi cơ bản
            isCorrect = this._normalizeStr(userVal) === this._normalizeStr(correctVal);
            // Đặc biệt cho Tên Dược Liệu: Chấp nhận nếu người dùng nhập đúng tên trong ngoặc hoặc tên chính
            // (Đơn giản hóa: So sánh chính xác tương đối)
        } else if (type === 'part') {
            // Bộ phận dùng: Chấp nhận từ khóa. Ví dụ đáp án "Thân rễ (củ)" -> User nhập "thân rễ" OK, "củ" OK.
            const keywords = this._extractKeywords(correctVal);
            const userKeywords = this._extractKeywords(userVal);
            // Đúng nếu user chứa ít nhất 1 từ khóa chính của đáp án
            isCorrect = keywords.some(k => this._normalizeStr(userVal).includes(this._normalizeStr(k)));
        } else if (type === 'chem') {
            // Hóa học: Tách dấu phẩy, đếm số lượng trùng
            const correctItems = correctVal.split(/[,;]/).map(s => this._normalizeStr(s)).filter(s=>s);
            const userItems = userVal.split(/[,;]/).map(s => this._normalizeStr(s)).filter(s=>s);
            
            // Tìm các chất đúng
            const matches = userItems.filter(u => correctItems.some(c => c.includes(u) || u.includes(c)));
            isCorrect = matches.length > 0 && matches.length >= (correctItems.length / 2); // Đúng > 50% số chất là OK (tạm tính)
            
            if (matches.length > 0) isCorrect = true; // Nới lỏng: Đúng ít nhất 1 chất là xanh, nhưng hiện thiếu
        }

        // Update UI Input
        inputEl.classList.add(isCorrect ? 'correct' : 'incorrect');

        // Render đáp án bên dưới
        if (!isCorrect) {
            resEl.innerHTML = `<div class="diff-result">
                <span class="diff-missed">Đáp án: ${correctVal}</span>
            </div>`;
        } else {
            resEl.innerHTML = `<div class="diff-result"><i data-lucide="check" class="w-3 h-3 inline text-green-600"></i> <span class="diff-correct">Chính xác</span></div>`;
        }
        
        lucide.createIcons();
    };

    checkField('name', user.name, correctData.name);
    checkField('familyVn', user.familyVn, correctData.familyVn);
    checkField('familySci', user.familySci, correctData.familySci);
    checkField('part', user.part, correctData.part, 'part');
    checkField('chem', user.chem, correctData.chem, 'chem');
}

// Helper tách từ khóa (bỏ ngoặc)
_extractKeywords(str) {
    if(!str) return [];
    // Tách các cụm trong ngoặc và ngoài ngoặc
    // Vd: "Thân rễ (Củ)" -> ["Thân rễ", "Củ"]
    return str.split(/[\(\)]/).map(s => s.trim()).filter(s => s.length > 1);
}

calculatePracticeScore() {
    // Hàm này có thể mở rộng để tính điểm chi tiết
    // Hiện tại chỉ cần hiển thị đúng sai trên UI
    this.showToast("Đã hoàn thành bài ôn tập. Hãy xem lại các câu trả lời!", "success");
}

// --- KẾT THÚC THÊM MỚI ---
                    createPlantCardHTML(plant, searchContext = null) {
                        const isSelected = this.selectedPlants.has(plant.id);
                        let tenDuocLieuHTML = plant.tenDuocLieu;
                        let hoCayHTML = plant.hoCay;
                        let contextHTML = "";

                        // Logic highlight tìm kiếm
                        if (this.currentFilter.search) {
                            tenDuocLieuHTML = this._highlightText(plant.tenDuocLieu, this.currentFilter.search);
                            hoCayHTML = this._highlightText(plant.hoCay, this.currentFilter.search);
                            if (searchContext && searchContext.context) {
                                const highlightedContext = this._highlightText(
                                    searchContext.context,
                                    this.currentFilter.search
                                );
                                // Context hiển thị nhỏ gọn hơn trong style mới
                                contextHTML = `<div class="mt-1 pt-1 border-t border-white/20 text-xs text-gray-300 line-clamp-1 search-context-overlay"><strong>${searchContext.field}:</strong> ${highlightedContext}</div>`;
                            }
                        }
const imgUrl = `./images/${plant.id}.jpg`;
                        // --- SỬA ĐOẠN NÀY: Thay Nhóm chất bằng Thành phần hóa học ---
    // 1. Lấy dữ liệu thành phần hóa học, tách dấu phẩy hoặc chấm phẩy
    const chemList = (plant.thanhPhanHoaHocChinh || "Chưa cập nhật")
        .split(/,|;/)
        .map(c => c.trim())
        .filter(Boolean);

    // 2. Tạo HTML các thẻ (Tag), thêm class flex-shrink-0 để không bị co lại
    const chemHTML = chemList.map(c => 
        `<span class="flex-shrink-0 inline-block text-[10px] bg-white/20 text-white px-2 py-0.5 rounded-full backdrop-blur-sm border border-white/10 whitespace-nowrap">${c}</span>`
    ).join("");
    // -------------------------------------------------------------
                        return `
            <div class="plant-card animate-on-scroll relative group aspect-square rounded-2xl overflow-hidden border border-[var(--border)] cursor-pointer shadow-sm hover:shadow-xl transition-all duration-300 ${isSelected ? "ring-2 ring-[var(--primary)]" : ""}" data-id="${plant.id}">
                
                <div class="absolute inset-0 bg-[var(--muted)] flex items-center justify-center overflow-hidden">
                    <i data-lucide="image" class="w-12 h-12 text-[var(--muted-foreground)] opacity-20 absolute"></i>
                    
                    <img src="${imgUrl}" 
                         alt="${plant.tenDuocLieu}" 
                         class="relative z-10 w-full h-full object-cover transition-transform duration-700 ease-in-out group-hover:scale-110" 
                         loading="lazy"
                         onerror="this.style.opacity='0'">
                </div>

                <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent opacity-60 pointer-events-none z-20"></div>

                <div class="absolute bottom-0 left-0 right-0 z-30 p-3 bg-black/60 backdrop-blur-md border-t border-white/10 transition-all duration-300 translate-y-0">
                    <div class="flex flex-col gap-0.5">
                        <h3 class="font-bold text-base leading-tight text-white drop-shadow-md line-clamp-1" title="${plant.tenDuocLieu}">${tenDuocLieuHTML}</h3>
                        <p class="text-xs text-gray-300 font-medium line-clamp-1">${hoCayHTML}</p>
                        
                        ${contextHTML}

                       <div class="flex flex-nowrap gap-1 mt-1.5 opacity-90 overflow-x-auto no-scrollbar pb-1" 
                     onclick="event.stopPropagation()"
                     onmousedown="event.stopPropagation()">
                    ${chemHTML}
                </div>
            </div>
        </div>

        ${isSelected ? `<div class="absolute top-2 right-2 z-40 bg-[var(--primary)] text-white p-1 rounded-full shadow-lg"><i data-lucide="check" class="w-4 h-4"></i></div>` : ""}
    </div>`;

                    }

                    // [CẬP NHẬT] Sử dụng sự kiện 'click' chuẩn để tránh lỗi khi cuộn
                    addEventListenersToCards(container, fromSearch = false) {
                        container.querySelectorAll(".plant-card").forEach((card) => {
                            const id = card.dataset.id;

                            // Chỉ dùng đúng 1 sự kiện click.
                            // Trình duyệt sẽ tự động KHÔNG gọi sự kiện này nếu bạn đang cuộn trang.
                            card.addEventListener("click", (e) => this.handleCardClick(e, id, fromSearch));

                            // Đã xóa bỏ contextmenu (nhấn giữ/chuột phải)
                        });
                    }
                    handleCardClick(e, id, fromSearch = false) {
                        // Nếu đang ở chế độ chọn nhiều (Selection Mode)
                        if (this.selectedPlants.size > 0 && !fromSearch) {
                            this.togglePlantSelection(id);
                        } else {
                            // [TỐI ƯU] Khóa tương tác ngay lập tức bằng CSS để chặn click đúp/click liên tục
                            if (fromSearch) {
                                this.els.searchResultsGrid.classList.add("grid-locked");
                            } else {
                                this.els.plantListGrid.classList.add("grid-locked");
                            }

                            this.navigateToDetail(id);
                        }
                    }

                    togglePlantSelection(id) {
                        const card = document.querySelector(`.plant-card[data-id="${id}"]`);
                        if (this.selectedPlants.has(id)) {
                            this.selectedPlants.delete(id);
                            card && card.classList.remove("selected");
                        } else {
                            this.selectedPlants.add(id);
                            card && card.classList.add("selected");
                        }
                        this.updateSelectionToolbar();
                    }
                    updateUIState() {
                        const hasPlants = this.plants.length > 0;
                        this.els.welcomeScreen.classList.toggle("hidden", hasPlants);
                        const isListView = !this.els.plantListContainer.classList.contains("hidden");
                        this.els.plantListGrid.classList.toggle("hidden", !hasPlants && isListView);
                        this.els.plantCount.textContent = `Hiện có ${this.plants.length} dược liệu trong từ điển.`;
                    }
                    openModal(id = null) {
                        if (!id) {
                            this.showToast("Không thể mở form, thiếu ID dược liệu.", "error");
                            return;
                        }
                        this.els.plantForm.reset();
                        const p = this.plants.find((p) => p.id === id);
                        if (p) {
                            this.els.modalTitle.textContent = "Chỉnh sửa Dược liệu";
                            this.els.tenDuocLieu.input.value = p.tenDuocLieu || "";
                            this.els.hoCay.input.value = p.hoCay || "";
                            this.els.nhomChat.input.value = p.nhomChat || "";
                            this.els.thanhPhanHoaHocChinh.input.value = p.thanhPhanHoaHocChinh || "";
                            this.els.boPhanDung.input.value = p.boPhanDung || "";
                            this.els.tacDung.input.value = p.tacDung || "";
                            this.els.congDung.input.value = p.congDung || "";
                            this.els.lieuDung.input.value = p.lieuDung || "";
                            this.els.luuY.input.value = p.luuY || "";
                            this.els.dacDiemDuocLieu.input.value = p.dacDiemDuocLieu || "";
                            this.els.plantIdInput.value = p.id;
                            this.els.plantModal.showModal();
                        } else {
                            this.showToast(`Không tìm thấy dược liệu với ID: ${id}`, "error");
                        }
                    }
                    closeModal() {
                        this.hideAutocomplete();
                        this.els.plantModal.close();
                    }
                    highlightActiveGroup() {
                        // Reset highlight
                        document.querySelectorAll(".group-link, .group-name-action").forEach((link) => {
                            link.classList.remove("text-[var(--primary)]", "bg-[var(--accent)]", "font-bold");
                        });

                        // Highlight nút Tất cả
                        if (this.currentFilter.group === "all") {
                            document
                                .querySelectorAll('.group-link[data-group="Tất cả"]')
                                .forEach((l) => l.classList.add("bg-[var(--accent)]"));
                        }

                        // Highlight nhóm hiện tại
                        const currentG = this.currentFilter.group;
                        if (currentG && currentG !== "all") {
                            // Tìm cả link thường và action name
                            const selector = `.group-link[data-group="${currentG}"], .group-name-action[data-group="${currentG}"]`;
                            document.querySelectorAll(selector).forEach((el) => {
                                el.classList.add("text-[var(--primary)]", "font-bold");
                                // Nếu là leaf node (link thường), thêm background cho rõ
                                if (el.classList.contains("group-link")) {
                                    el.classList.add("bg-[var(--accent)]");
                                }
                            });
                        }

                        // Highlight nút Practice (giữ nguyên logic cũ)
                        const isPractice = this.currentFilter.group === "practice";
                        [
                            this.els.practiceListBtnDesktop,
                            this.els.practiceListBtnCollapsed,
                            this.els.practiceListBtnMobile,
                        ].forEach((btn) => {
                            if (btn) {
                                btn.classList.toggle("bg-yellow-100", isPractice);
                                btn.classList.toggle("text-yellow-700", isPractice);
                                if (document.documentElement.classList.contains("dark") && isPractice) {
                                    btn.classList.add("bg-yellow-900/30", "text-yellow-400");
                                    btn.classList.remove("bg-yellow-100", "text-yellow-700");
                                } else {
                                    btn.classList.remove("bg-yellow-900/30", "text-yellow-400");
                                }
                            }
                        });
                    }
                    clearSelection() {
                        this.selectedPlants.clear();
                        document
                            .querySelectorAll(".plant-card.selected")
                            .forEach((c) => c.classList.remove("selected"));
                        this.updateSelectionToolbar();
                    }
                    updateSelectionToolbar() {
                        const c = this.selectedPlants.size;
                        this.els.selectionCount.textContent = `${c} mục đã chọn`;
                        this.els.selectionToolbar.classList.toggle("hidden", c === 0);
                    }

                    initTheme() {
                        const t = localStorage.getItem("theme") || "light";
                        this.setTheme(t);
                    }
                    setTheme(t) {
                        localStorage.setItem("theme", t);
                        document.documentElement.classList.toggle("dark", t === "dark");
                        document
                            .querySelectorAll(".light-icon")
                            .forEach((i) => i.classList.toggle("hidden", t === "dark"));
                        document
                            .querySelectorAll(".dark-icon")
                            .forEach((i) => i.classList.toggle("hidden", t !== "dark"));
                    }
                    toggleTheme() {
                        this.setTheme(localStorage.getItem("theme") === "dark" ? "light" : "dark");
                    }
                    updateSidebarToggleButton(isCollapsed) {
                        const tip = this.els.sidebarToggle.querySelector(".tooltip-text");
                        if (tip) tip.textContent = isCollapsed ? "Mở rộng" : "Thu gọn";
                        this.els.sidebarTopActions.classList.toggle("hidden", isCollapsed);
                        this.els.sidebarTopActionsCollapsed.classList.toggle("hidden", !isCollapsed);
                        this.els.sidebarBottomActions.classList.toggle("hidden", isCollapsed);
                        this.els.sidebarBottomActionsCollapsed.classList.toggle("hidden", !isCollapsed);
                        lucide.createIcons();
                    }
                    initSidebarState() {
                        const c = localStorage.getItem("sidebarState") === "collapsed";
                        this.els.sidebar.classList.toggle("collapsed", c);
                        this.updateSidebarToggleButton(c);
                    }
                    toggleSidebar() {
                        const c = this.els.sidebar.classList.toggle("collapsed");
                        localStorage.setItem("sidebarState", c ? "collapsed" : "expanded");
                        this.updateSidebarToggleButton(c);
                    }
                    goHome() {
                        if (
                            this.currentView.type === "list" &&
                            this.currentFilter.group === "all" &&
                            this.currentFilter.search === ""
                        ) {
                            return;
                        }
                        this.currentFilter = { group: "all", search: "" };
                        this.els.searchInput.value = "";
                        this.els.searchClearDesktop.classList.add("hidden");
                        this.clearSelection();
                        const newState = { view: "list", filter: this.currentFilter };
                        history.pushState(newState, "", "#list");
                        this.handleStateChange(newState);
                    }
                    getDynamicSuggestions(field) {
                        const s = new Set();
                        this.plants.forEach((p) => {
                            if (p[field])
                                p[field].split(/,|>/).forEach((i) => {
                                    const t = i.trim();
                                    if (t) s.add(t);
                                });
                        });
                        return Array.from(s).sort();
                    }
                    renderAutocompleteList(key, data, filter, options) {
                        const { list } = this.els[key];
                        const normFilter = this._normalizeText(filter);
                        if (!normFilter) {
                            this.hideAutocomplete();
                            return;
                        }

                        let filtered;
                        if (options.type === "family") {
                            filtered = data.filter(
                                (i) =>
                                    this._normalizeText(i.s).includes(normFilter) ||
                                    this._normalizeText(i.v).includes(normFilter)
                            );
                        } else {
                            filtered = data.filter((i) => this._normalizeText(i).includes(normFilter));
                        }

                        if (filtered.length > 0) {
                            list.innerHTML = filtered
                                .map((i) => {
                                    const value = options.type === "family" ? `${i.s} (${i.v})` : i;
                                    const display =
                                        options.type === "family"
                                            ? `<span class="font-medium">${i.s}</span><span class="text-[var(--muted-foreground)]">- ${i.v}</span>`
                                            : i;
                                    return `<div class="autocomplete-item px-3 py-2 cursor-pointer hover:bg-[var(--accent)]" data-value="${value}">${display}</div>`;
                                })
                                .join("");
                            list.classList.remove("hidden");
                            this.activeAutocomplete = key;
                        } else {
                            this.hideAutocomplete();
                        }
                    }
                    selectAutocompleteItem(key, value, options) {
                        const { input } = this.els[key];
                        if (options.append) {
                            const sep = options.separator ? ` ${options.separator} ` : ", ";
                            const parts = input.value.split(/,|>|\s+/).filter(Boolean);
                            parts.pop();
                            parts.push(value);
                            input.value = parts.join(sep) + (options.separator ? "" : ", ");
                        } else {
                            input.value = value;
                        }
                        this.hideAutocomplete();
                        input.focus();
                    }
                    setupAutocomplete(key, dataProvider, options = {}) {
                        const { input, list } = this.els[key];
                        if (!input || !list) return;
                        const render = () => {
                            const suggestions = typeof dataProvider === "function" ? dataProvider() : dataProvider;
                            const filter = input.value
                                .split(/,|>|\s+/)
                                .pop()
                                .trim();
                            this.renderAutocompleteList(key, suggestions, filter, options);
                        };
                        input.addEventListener("focus", render);
                        input.addEventListener("input", render);
                        list.addEventListener("mousedown", (e) => {
                            const item = e.target.closest(".autocomplete-item");
                            if (item) this.selectAutocompleteItem(key, item.dataset.value, options);
                        });
                    }
                    hideAutocomplete() {
                        if (this.activeAutocomplete) {
                            this.els[this.activeAutocomplete].list.classList.add("hidden");
                            this.activeAutocomplete = null;
                        }
                    }
                    showToast(message, type = "success") {
                        const t = document.createElement("div");
                        t.className = `toast ${type}`;
                        t.innerHTML = `<i data-lucide="${type === "success" ? "check-circle" : "alert-circle"}" class="w-6 h-6 mr-3"></i><span>${message}</span>`;
                        this.els.toastContainer.appendChild(t);
                        lucide.createIcons();
                        setTimeout(() => {
                            t.remove();
                        }, 4000);
                    }
                    showConfirm(message, onConfirm, onCancel = () => {}) {
                        this.els.confirmMessage.textContent = message;
                        this.els.confirmModal.showModal();
                        const newProceedBtn = this.els.confirmProceed.cloneNode(true);
                        this.els.confirmProceed.parentNode.replaceChild(newProceedBtn, this.els.confirmProceed);
                        this.els.confirmProceed = newProceedBtn;
                        const newCancelBtn = this.els.confirmCancel.cloneNode(true);
                        this.els.confirmCancel.parentNode.replaceChild(newCancelBtn, this.els.confirmCancel);
                        this.els.confirmCancel = newCancelBtn;

                        this.els.confirmProceed.addEventListener(
                            "click",
                            () => {
                                onConfirm();
                                this.els.confirmModal.close();
                            },
                            { once: true }
                        );
                        this.els.confirmCancel.addEventListener(
                            "click",
                            () => {
                                onCancel();
                                this.els.confirmModal.close();
                            },
                            { once: true }
                        );
                    }
                    // -------- BẮT ĐẦU DÁN MÃ ĐÃ SỬA LỖI --------

                    enterEditMode(plantId) {
                        if (this.isDetailEditing) return;
                        this.isDetailEditing = true;

                        const plant = this.plants.find((p) => p.id === plantId);
                        if (!plant) return;

                        // Sử dụng selector đến container chính chứa toàn bộ thông tin
                        const editableContainer = this.els.plantDetailView.querySelector(
                            ".detail-section > .bg-\\[var\\(--card\\)\\]"
                        );
                        if (!editableContainer) return;
                        const titleBlock = editableContainer.querySelector(".flex-1");
                        // Ẩn nút menu 3 chấm
                        const actionsBtn = editableContainer.querySelector("#detail-actions-btn");
                        if (actionsBtn) actionsBtn.classList.add("hidden");

                        // Hàm trợ giúp để tạo ô nhập liệu
                        const createEditableField = (key, value, type = "input", rows = 3) => {
                            if (type === "textarea") {
                                return `<textarea data-key="${key}" rows="${rows}" class="editable-field mt-1 w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none">${
                                    value || ""
                                }</textarea>`;
                            }
                            return `<input type="text" data-key="${key}" value="${
                                value ? value.replace(/"/g, "&quot;") : ""
                            }" class="editable-field mt-1 w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none" />`;
                        };

                        // 1. Chuyển Tên và Họ cây thành input
                        if (titleBlock) {
                            // Input Tên Dược liệu
                            titleBlock.querySelector("h2").outerHTML =
                                `<input type="text" data-key="tenDuocLieu" value="${plant.tenDuocLieu}" class="editable-field text-3xl font-bold w-full p-2 rounded-lg border border-dashed border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none" />`;

                            // Input Tên Khoa học (THÊM MỚI)
                            const tenKhoaHocVal = plant.tenKhoaHoc || "";
                            // Nếu đã có thẻ p (italic) thì thay thế, nếu chưa có thì chèn vào
                            const pItalic = titleBlock.querySelector("p.italic");
                            if (pItalic) {
                                pItalic.outerHTML = `<input type="text" data-key="tenKhoaHoc" value="${tenKhoaHocVal}" placeholder="Tên khoa học (vd: Stephania glabra)" class="editable-field italic text-lg w-full p-2 mt-1 rounded-lg border border-dashed border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none" />`;
                            } else {
                                // Trường hợp dữ liệu cũ chưa render ra p.italic, chèn input vào sau h2
                                const h2Input = titleBlock.querySelector("input[data-key='tenDuocLieu']"); // vì h2 vừa bị replace
                                // Tạo input string và insertAdjacentHTML nếu cần, nhưng cách an toàn nhất là replace cả block titleBlock bằng innerHTML mới
                            }

                            // Đơn giản hóa: Replace toàn bộ nội dung titleBlock cho dễ kiểm soát
                            titleBlock.innerHTML = `
            <div>
                <input type="text" data-key="tenDuocLieu" value="${plant.tenDuocLieu}" class="editable-field text-3xl font-bold w-full p-2 rounded-lg border border-dashed border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none" />
                <input type="text" data-key="tenKhoaHoc" value="${plant.tenKhoaHoc || ""}" placeholder="Tên khoa học" class="editable-field italic text-lg w-full p-2 mt-1 rounded-lg border border-dashed border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none" />
                <input type="text" data-key="hoCay" value="${plant.hoCay}" class="editable-field text-lg w-full p-2 mt-1 rounded-lg border border-dashed border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none" />
            </div>
            <div class="hidden"></div> 
        `;
                        }

                        // 2. Chuyển các trường thông tin khác
                        const propertiesContainer = editableContainer.querySelector(".space-y-6");
                        if (propertiesContainer) {
                            propertiesContainer.querySelectorAll("[data-key-value]").forEach((el) => {
                                const key = el.dataset.keyValue;
                                const plantValue = plant[key] || "";
                                let type = "input";
                                let rows = 3;

                                // Xác định loại input dựa trên key
                                if (["dacDiemDuocLieu", "tacDung", "congDung"].includes(key)) {
                                    type = "textarea";
                                    rows = 3;
                                } else if (["lieuDung", "luuY"].includes(key)) {
                                    type = "textarea";
                                    rows = 2;
                                }

                                el.innerHTML = createEditableField(key, plantValue, type, rows);
                            });
                        }

                        // Hiển thị thanh công cụ và gán sự kiện
                        const editToolbar = document.getElementById("edit-toolbar");
                        editToolbar.classList.remove("hidden");
                        document.getElementById("save-edit-btn").onclick = () => this.saveEdit(plantId);
                        document.getElementById("cancel-edit-btn").onclick = () => this.exitEditMode(plantId);
                    }

                    saveEdit(plantId) {
                        const newData = {};
                        // Thu thập dữ liệu từ tất cả các ô input/textarea có class 'editable-field'
                        this.els.plantDetailView.querySelectorAll(".editable-field").forEach((input) => {
                            newData[input.dataset.key] = input.value;
                        });

                        this.updatePlant(plantId, newData);
                        // hàm updatePlant sẽ tự gọi exitEditMode
                    }

                    exitEditMode(plantIdToRestore = null) {
                        if (!this.isDetailEditing) return;
                        this.isDetailEditing = false;

                        document.getElementById("edit-toolbar").classList.add("hidden");

                        // Nếu hủy, chúng ta cần render lại để khôi phục nội dung gốc
                        if (plantIdToRestore) {
                            // Lấy lại backTitle từ history state để đảm bảo tính nhất quán
                            const backTitle = history.state?.backTitle || "Quay lại";
                            this.showPlantDetail(plantIdToRestore, true, backTitle);
                        } else {
                            // Nếu là lưu, chỉ cần hiện lại nút actions (vì showPlantDetail đã render lại rồi)
                            const actionsBtn = this.els.plantDetailView.querySelector("#detail-actions-btn");
                            if (actionsBtn) actionsBtn.classList.remove("hidden");
                        }
                    }

                    // -------- KẾT THÚC DÁN MÃ ĐÃ SỬA LỖI --------
                    importData() {
                        const input = document.createElement("input");
                        input.type = "file";
                        input.accept = ".json";
                        input.onchange = (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.readAsText(file, "UTF-8");
                            reader.onload = (re) => {
                                try {
                                    const data = JSON.parse(re.target.result);
                                    if (!Array.isArray(data)) throw new Error("Invalid format");
                                    this.showImportOptions(data);
                                } catch (err) {
                                    this.showToast("Tệp không hợp lệ hoặc bị lỗi.", "error");
                                }
                            };
                        };
                        input.click();
                        this.els.mobileMenu.classList.add("hidden");
                    }
                    showImportOptions(data) {
                        this.els.importInfo.textContent = `Tệp chứa ${data.length} mục dữ liệu. Vui lòng chọn cách xử lý.`;
                        this.els.importOptionsModal.showModal();

                        // 1. Logic Ghi đè (Cũ)
                        this.els.importOverwriteBtn.onclick = () => {
                            this.plants = data.map((p, i) => ({ ...p, id: p.id || (Date.now() + i).toString() }));
                            this.clearSelection();
                            this.savePlants();
                            this.renderAll();
                            this.goHome();
                            this.showToast(`Đã ghi đè và nhập ${data.length} dược liệu.`, "success");
                            this.els.importOptionsModal.close();
                        };

                        // 2. Logic Cập nhật thông minh (MỚI)
                        this.els.importUpdateBtn.onclick = () => {
                            let updatedCount = 0;
                            let addedCount = 0;

                            data.forEach((newItem) => {
                                // Bước 1: Cố gắng tìm cây cũ khớp ID trước
                                let existingPlantIndex = -1;
                                if (newItem.id) {
                                    existingPlantIndex = this.plants.findIndex((p) => p.id == newItem.id);
                                }

                                // Bước 2: Nếu không khớp ID, thử tìm theo Tên dược liệu
                                if (existingPlantIndex === -1 && newItem.tenDuocLieu) {
                                    const normName = this._normalizeText(newItem.tenDuocLieu);
                                    existingPlantIndex = this.plants.findIndex(
                                        (p) => this._normalizeText(p.tenDuocLieu) === normName
                                    );
                                }

                                if (existingPlantIndex > -1) {
                                    // TÌM THẤY: Chỉ cập nhật các trường có trong newItem, giữ nguyên trường cũ của existingPlant
                                    this.plants[existingPlantIndex] = {
                                        ...this.plants[existingPlantIndex], // Giữ data cũ
                                        ...newItem, // Đè data mới lên
                                    };
                                    updatedCount++;
                                } else {
                                    // KHÔNG TÌM THẤY: Thêm mới luôn
                                    this.plants.push({
                                        ...newItem,
                                        id: newItem.id || Date.now().toString() + Math.random().toString().slice(2, 5),
                                    });
                                    addedCount++;
                                }
                            });

                            this.savePlants();
                            this.renderAll();
                            this.showToast(`Đã cập nhật ${updatedCount} cây, thêm mới ${addedCount} cây.`, "success");
                            this.els.importOptionsModal.close();
                        };

                        // 3. Logic Hợp nhất - Chỉ thêm mới (Cũ)
                        this.els.importMergeBtn.onclick = () => {
                            const existing = new Set(
                                this.plants.map((p) => (p.tenDuocLieu || "").toLowerCase().trim())
                            );
                            let added = 0;
                            let newId = Date.now();
                            data.forEach((p) => {
                                if (p.tenDuocLieu && !existing.has(p.tenDuocLieu.toLowerCase().trim())) {
                                    this.plants.push({ ...p, id: p.id || (newId++).toString() });
                                    added++;
                                }
                            });
                            if (added > 0) {
                                this.savePlants();
                                this.renderAll();
                                this.goHome();
                                this.showToast(`Đã thêm mới ${added} dược liệu chưa có trong danh sách.`, "success");
                            } else {
                                this.showToast("Không có dược liệu mới nào để thêm.", "success");
                            }
                            this.els.importOptionsModal.close();
                        };

                        this.els.importCancelBtn.onclick = () => this.els.importOptionsModal.close();
                    }
                    exportData() {
                        if (this.plants.length === 0) {
                            this.showToast("Không có dữ liệu để xuất.", "error");
                            return;
                        }
                        const dataStr = JSON.stringify(this.plants, null, 2);
                        const blob = new Blob([dataStr], { type: "application/json" });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement("a");
                        a.href = url;
                        a.download = `duoclieu_data_${new Date().toISOString().slice(0, 10)}.json`;
                        a.click();
                        URL.revokeObjectURL(url);
                        this.els.mobileMenu.classList.add("hidden");
                        this.showToast("Xuất dữ liệu thành công!", "success");
                    }
                }
                const app = new MedicinalPlantApp();
                window.app = app;
                lucide.createIcons();
            });
            
        </script>
    </body>
</html>
