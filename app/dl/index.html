<!DOCTYPE html>
<html lang="vi" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Từ điển Dược liệu Thông minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --background: #f8fafc; --foreground: #020817; --card: #ffffff; --card-foreground: #020817;
            --popover: #ffffff; --popover-foreground: #020817; --primary: #3b82f6; --primary-foreground: #f8fafc;
            --secondary: #f1f5f9; --secondary-foreground: #0f172a; --muted: #f1f5f9; --muted-foreground: #64748b;
            --accent: #f1f5f9; --accent-foreground: #0f172a; --border: #e2e8f0; --input: #e2e8f0; --ring: #3b82f6;
        }

        html.dark {
            --background: #020817; --foreground: #f8fafc; --card: #0f172a; --card-foreground: #f8fafc;
            --popover: #020817; --popover-foreground: #f8fafc; --primary: #3b82f6; --primary-foreground: #f8fafc;
            --secondary: #1e293b; --secondary-foreground: #f8fafc; --muted: #1e293b; --muted-foreground: #94a3b8;
            --accent: #1e293b; --accent-foreground: #f8fafc; --border: #1e293b; --input: #1e293b; --ring: #3b82f6;
        }

        body { font-family: 'Inter', sans-serif; background-color: var(--background); color: var(--foreground); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .lucide { stroke-width: 2; }
        .custom-ring:focus-visible { outline: 2px solid var(--ring); outline-offset: 2px; }

        /* --- TỔNG CẢI TIẾN UI & ANIMATION --- */
        .view-container { animation-duration: 250ms; animation-timing-function: ease-in-out; animation-fill-mode: forwards; }
        .view-fade-in { animation-name: view-fade-in-anim; }
        .view-fade-out { animation-name: view-fade-out-anim; }
        @keyframes view-fade-in-anim { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes view-fade-out-anim { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-10px); } }

        .plant-card { transition: transform 0.2s ease-out, box-shadow 0.2s ease-out, border-color 0.2s ease-out; }
        .plant-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1); }
        
        .animate-on-scroll {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s cubic-bezier(0.25, 1, 0.5, 1), transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
        }
        .animate-on-scroll.is-visible {
            opacity: 1;
            transform: translateY(0);
        }

        dialog { background-color: var(--card); color: var(--card-foreground); }
        dialog::backdrop { background: rgba(0, 0, 0, 0.5); transition: all 0.3s ease-out; }
        dialog[open] { animation: modal-scale-in 0.3s ease-out forwards; }
        dialog[open]::backdrop { backdrop-filter: blur(4px); }
        @keyframes modal-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }

        #toast-container { position: fixed; top: 1.25rem; right: 1.25rem; z-index: 1000; display: flex; flex-direction: column; gap: 0.75rem; }
        .toast { display: flex; align-items: center; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); animation: toast-in 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; min-width: 320px; }
        .toast.success { background-color: #dcfce7; color: #166534; } .toast.error { background-color: #fee2e2; color: #991b1b; }
        html.dark .toast.success { background-color: #14532d; color: #f0fdf4; } html.dark .toast.error { background-color: #7f1d1d; color: #fef2f2; }
        @keyframes toast-in { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }

        #sidebar { transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sidebar.collapsed { width: 72px; }
        #sidebar.collapsed .sidebar-text, #sidebar.collapsed .sidebar-header-text, #sidebar.collapsed #groups-nav { display: none; }
        .group-details summary::-webkit-details-marker { display: none; }
        .group-details summary { list-style: none; }
        .group-details summary .chevron { transition: transform 0.2s; }
        .group-details[open] > summary .chevron { transform: rotate(90deg); }
        a.bg-\[var\(--primary\)\]:hover, details > summary.bg-\[var\(--primary\)\]:hover { background-color: var(--primary); filter: brightness(0.9); }
        .autocomplete-list { z-index: 20; }
        .plant-card.selected { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary); }

        .detail-actions-menu { transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
        .detail-actions-menu.hidden { opacity: 0; transform: scale(0.95) translateY(-10px); pointer-events: none; }

        #search-view { transition: transform 0.3s ease-in-out; }
        
        /* --- Search Context Styling --- */
        .search-highlight {
            background-color: #fef08a; /* yellow-200 */
            color: #713f12; /* yellow-800 */
            font-weight: 600;
            padding: 0 2px;
            border-radius: 3px;
        }
        html.dark .search-highlight {
            background-color: #a16207; /* yellow-700 */
            color: #fefce8; /* yellow-50 */
        }
        .search-context {
            font-size: 0.8rem;
            color: var(--muted-foreground);
            margin-top: 4px;
            padding-top: 4px;
            border-top: 1px dashed var(--border);
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 2;
            overflow: hidden;
            display: -webkit-box;
        }
        .search-context strong {
            color: var(--card-foreground);
        }

        .sticky-group-header {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: var(--background);
            padding: 0.75rem 0;
        }

        @media (max-width: 767px) {
            #plant-list-container, #plant-detail-view, #search-results-container { padding-bottom: 80px; }
        }
    </style>
</head>
<body class="h-[100dvh] w-screen overflow-hidden">
    <div class="flex h-full w-full">
        <!-- Sidebar -->
        <aside id="sidebar" class="hidden md:flex flex-col w-72 border-r border-[var(--border)] bg-[var(--card)] p-3">
            <!-- Sidebar content (Desktop) -->
            <div class="flex items-center gap-2 mb-4 px-2">
                <i data-lucide="sprout" class="text-[var(--primary)] flex-shrink-0"></i>
                <h1 class="text-xl font-bold sidebar-text">Dược liệu</h1>
            </div>
            <div id="sidebar-top-actions" class="flex items-center gap-2 mb-4 px-1">
                <div class="relative flex-grow">
                    <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--muted-foreground)] pointer-events-none"></i>
                    <input type="text" id="search-input" placeholder="Tìm kiếm..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none transition-all">
                </div>
                <button id="add-plant-sidebar" class="relative group flex-shrink-0 flex items-center justify-center w-10 h-10 bg-[var(--primary)] text-[var(--primary-foreground)] rounded-lg hover:opacity-90 transition-opacity custom-ring">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    <span class="absolute left-full ml-3 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">Thêm Dược liệu</span>
                </button>
            </div>
            <div id="sidebar-top-actions-collapsed" class="hidden flex-col items-center gap-2 mb-4">
                <button id="search-button-collapsed" class="relative group flex-shrink-0 flex items-center justify-center w-10 h-10 hover:bg-[var(--accent)] rounded-lg transition-colors custom-ring"><i data-lucide="search" class="w-5 h-5 text-[var(--muted-foreground)]"></i></button>
                <button id="add-plant-sidebar-collapsed" class="relative group flex-shrink-0 flex items-center justify-center w-10 h-10 bg-[var(--primary)] text-[var(--primary-foreground)] rounded-lg hover:opacity-90 transition-opacity custom-ring"><i data-lucide="plus" class="w-5 h-5"></i></button>
            </div>
            <h2 class="text-sm font-semibold text-[var(--muted-foreground)] mb-2 px-3 sidebar-header-text">NHÓM CHẤT</h2>
            <nav id="groups-nav" class="flex-1 overflow-y-auto no-scrollbar"></nav>
            <div class="mt-auto pt-4 border-t border-[var(--border)]">
                <div id="sidebar-bottom-actions" class="flex items-center justify-around">
                    <button id="import-button-desktop" class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="upload" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">Nhập</span></button>
                    <button id="export-button-desktop" class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="download" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">Xuất</span></button>
                    <button id="theme-toggle-desktop" class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="sun" class="w-5 h-5 text-[var(--muted-foreground)] light-icon"></i><i data-lucide="moon" class="w-5 h-5 text-[var(--muted-foreground)] dark-icon hidden"></i><span class="absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">Giao diện</span></button>
                    <button id="sidebar-toggle" class="relative group flex justify-center items-center p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="chevrons-left" class="w-5 h-5 text-[var(--muted-foreground)] toggle-icon transition-transform"></i><span class="tooltip-text absolute bottom-full mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded-md invisible opacity-0 group-hover:visible group-hover:opacity-100 transition-opacity whitespace-nowrap z-10">Thu gọn</span></button>
                </div>
                <div id="sidebar-bottom-actions-collapsed" class="hidden space-y-1">
                     <button id="import-button-desktop-collapsed" class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="upload" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="text-sm font-medium sidebar-text">Nhập Dữ liệu</span></button>
                    <button id="export-button-desktop-collapsed" class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="download" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="text-sm font-medium sidebar-text">Xuất Dữ liệu</span></button>
                    <button id="theme-toggle-desktop-collapsed" class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="sun" class="w-5 h-5 text-[var(--muted-foreground)] light-icon"></i><i data-lucide="moon" class="w-5 h-5 text-[var(--muted-foreground)] dark-icon hidden"></i><span class="text-sm font-medium sidebar-text">Giao diện</span></button>
                     <button id="sidebar-toggle-collapsed" class="sidebar-item w-full flex items-center justify-start gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="chevrons-right" class="w-5 h-5 text-[var(--muted-foreground)] toggle-icon transition-transform"></i><span class="text-sm font-medium sidebar-text">Mở rộng</span></button>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col relative overflow-hidden">
            <header id="mobile-header" class="flex md:hidden items-center justify-between p-4 border-b border-[var(--border)] bg-[var(--card)]">
                <div class="flex items-center gap-2">
                    <i data-lucide="sprout" class="text-[var(--primary)]"></i>
                    <h1 class="text-xl font-bold">Dược liệu</h1>
                </div>
                <div class="flex items-center gap-2">
                    <button id="mobile-search-button" class="p-2 rounded-md hover:bg-[var(--accent)] custom-ring"><i data-lucide="search"></i></button>
                    <button id="mobile-menu-button" class="p-2 rounded-md hover:bg-[var(--accent)] custom-ring"><i data-lucide="menu"></i></button>
                </div>
            </header>
            <div id="sticky-header" class="md:hidden fixed top-0 left-0 right-0 z-30 flex items-center gap-4 p-2 border-b border-[var(--border)] bg-[var(--card)]/80 backdrop-blur-sm transition-transform duration-300 ease-in-out -translate-y-full">
                <button id="sticky-back-button" class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring"><i data-lucide="arrow-left"></i></button>
                <div class="flex-1 text-center overflow-hidden pr-12">
                    <h3 id="sticky-title" class="font-bold text-base truncate"></h3>
                    <p id="sticky-subtitle" class="text-xs text-[var(--muted-foreground)] truncate"></p>
                </div>
            </div>
            <div id="plant-list-container" class="flex-1 overflow-y-auto p-4 md:p-8">
                <!-- Welcome screen and plant grid -->
                <div id="welcome-screen" class="flex flex-col items-center justify-center h-full text-center">
                    <div class="p-6 bg-[var(--card)] rounded-full mb-4"><i data-lucide="book-open-text" class="w-16 h-16 text-[var(--primary)]"></i></div>
                    <h2 class="text-2xl font-bold mb-2">Chào mừng bạn!</h2>
                    <p class="max-w-md text-[var(--muted-foreground)] mb-6">Bắt đầu bằng cách thêm dược liệu mới, nhập dữ liệu có sẵn, hoặc tìm kiếm trong danh sách.</p>
                    <p id="plant-count" class="text-sm text-[var(--muted-foreground)] mb-4"></p>
                    <div class="flex gap-2">
                        <button id="add-plant-welcome" class="bg-[var(--primary)] text-[var(--primary-foreground)] px-4 py-2 rounded-lg font-semibold flex items-center gap-2 hover:opacity-90 transition-opacity custom-ring"><i data-lucide="plus-circle" class="w-5 h-5"></i>Thêm Dược liệu</button>
                    </div>
                </div>
                <div id="plant-list-grid"></div>
            </div>
            <div id="plant-detail-view" class="flex-1 overflow-y-auto p-4 md:p-8 bg-[var(--background)] hidden"></div>

            <!-- FAB (Mobile) -->
            <button id="add-plant-fab" class="md:hidden fixed bottom-6 right-6 bg-[var(--primary)] text-[var(--primary-foreground)] w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:opacity-90 transition-all custom-ring"><i data-lucide="plus" class="w-8 h-8"></i></button>
            <!-- Selection Toolbar -->
            <div id="selection-toolbar" class="hidden fixed bottom-8 left-1/2 -translate-x-1/2 bg-[var(--card)] border border-[var(--border)] rounded-full shadow-lg p-2 flex items-center gap-4 z-30 transition-all">
                <span id="selection-count" class="text-sm font-medium px-2"></span>
                <button id="delete-selected-btn" class="flex items-center justify-center w-10 h-10 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition-colors custom-ring"><i data-lucide="trash-2" class="w-5 h-5"></i></button>
            </div>
        </main>
    </div>

    <!-- Search View (Mobile) -->
    <div id="search-view" class="md:hidden fixed inset-0 bg-[var(--background)] z-50 transform translate-x-full flex flex-col">
        <header class="flex-shrink-0 flex items-center gap-2 p-2 border-b border-[var(--border)] bg-[var(--card)]">
            <button id="search-view-back-button" class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring"><i data-lucide="arrow-left"></i></button>
            <div class="relative flex-grow">
                <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--muted-foreground)] pointer-events-none"></i>
                <input type="text" id="search-view-input" placeholder="Tìm kiếm dược liệu..." class="w-full pl-10 pr-4 py-2 rounded-lg border-none bg-transparent focus:ring-0 outline-none">
            </div>
        </header>
        <div id="search-results-container" class="flex-1 overflow-y-auto p-4">
             <div id="search-results-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>
    </div>
    
    <!-- Mobile Menu (No search bar) -->
    <div id="mobile-menu" class="fixed inset-0 bg-black/40 z-40 hidden"><aside class="absolute inset-y-0 left-0 w-72 bg-[var(--card)] p-4 flex flex-col"><div class="flex items-center justify-between gap-2 mb-6"><div class="flex items-center gap-2"><i data-lucide="sprout" class="text-[var(--primary)]"></i><h1 class="text-xl font-bold">Dược liệu</h1></div><button id="close-mobile-menu" class="p-2 rounded-md hover:bg-[var(--accent)] custom-ring"><i data-lucide="x"></i></button></div><h2 class="text-sm font-semibold text-[var(--muted-foreground)] mb-2 px-2">NHÓM CHẤT</h2><nav id="groups-nav-mobile" class="flex-1 overflow-y-auto no-scrollbar"></nav><div class="mt-4 pt-4 border-t border-[var(--border)] space-y-2"><button id="add-plant-mobile" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="plus-circle" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="text-sm font-medium">Thêm Dược liệu</span></button><button id="import-button-mobile" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="upload" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="text-sm font-medium">Nhập Dữ liệu</span></button><button id="export-button-mobile" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="download" class="w-5 h-5 text-[var(--muted-foreground)]"></i><span class="text-sm font-medium">Xuất Dữ liệu</span></button><button id="theme-toggle-mobile" class="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring"><i data-lucide="sun" class="w-5 h-5 text-[var(--muted-foreground)] light-icon"></i><i data-lucide="moon" class="w-5 h-5 text-[var(--muted-foreground)] dark-icon hidden"></i><span class="text-sm font-medium">Giao diện</span></button></div></aside></div>
    
    <!-- Context Menu, Modals, Toast -->
    <div id="context-menu" class="hidden fixed bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg p-1 z-50 text-sm w-40"></div>
    <dialog id="plant-modal" class="p-0 rounded-xl shadow-2xl w-11/12 max-w-2xl"><form id="plant-form" class="p-6 md:p-8"><div class="flex justify-between items-center mb-6"><h2 id="modal-title" class="text-2xl font-bold">Thêm Dược liệu</h2><button type="button" id="close-modal-button" class="p-2 rounded-full hover:bg-[var(--accent)] custom-ring"><i data-lucide="x"></i></button></div><input type="hidden" id="plant-id"><div class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="relative"><label for="ten-duoc-lieu-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Tên dược liệu</label><input type="text" id="ten-duoc-lieu-input" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"></div><div class="relative"><label for="ho-cay-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Họ cây</label><input type="text" id="ho-cay-input" autocomplete="off" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"><div id="ho-cay-list" class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"></div></div></div><div class="relative"><label for="nhom-chat-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Nhóm chất</label><input type="text" id="nhom-chat-input" placeholder="Vd: Alkaloid > Indol, Flavonoid" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"><div id="nhom-chat-list" class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"></div></div><div class="relative"><label for="thanh-phan-hoa-hoc-chinh-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Thành phần hóa học chính</label><input type="text" id="thanh-phan-hoa-hoc-chinh-input" placeholder="Vd: Reserpin, Rutin, Strychnin" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"><div id="thanh-phan-hoa-hoc-chinh-list" class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"></div></div><div class="relative"><label for="bo-phan-dung-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Bộ phận dùng</label><input type="text" id="bo-phan-dung-input" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"><div id="bo-phan-dung-list" class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"></div></div><div class="relative"><label for="tac-dung-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Tác dụng</label><textarea id="tac-dung-input" rows="3" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"></textarea><div id="tac-dung-list" class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"></div></div><div class="relative"><label for="cong-dung-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Công dụng</label><textarea id="cong-dung-input" rows="3" required class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"></textarea><div id="cong-dung-list" class="autocomplete-list absolute w-full mt-1 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg max-h-48 overflow-y-auto hidden no-scrollbar"></div></div><div class="relative"><label for="lieu-dung-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Liều dùng</label><textarea id="lieu-dung-input" rows="2" class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"></textarea></div><div class="relative"><label for="luu-y-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Lưu ý</label><textarea id="luu-y-input" rows="2" class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"></textarea></div><div class="relative"><label for="dac-diem-duoc-lieu-input" class="block text-sm font-medium mb-1 text-[var(--muted-foreground)]">Đặc điểm dược liệu</label><textarea id="dac-diem-duoc-lieu-input" rows="3" class="w-full p-2 rounded-lg border border-[var(--border)] bg-[var(--background)] focus:ring-2 focus:ring-[var(--ring)] outline-none"></textarea></div></div><div class="mt-8 flex justify-end gap-3"><button type="button" id="cancel-button" class="px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--secondary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring">Hủy</button><button type="submit" class="px-4 py-2 rounded-lg bg-[var(--primary)] text-[var(--primary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring">Lưu</button></div></form></dialog>
    <dialog id="import-options-modal" class="p-0 rounded-xl shadow-2xl w-11/12 max-w-md"><div class="p-6"><div class="flex items-start gap-4"><div class="flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-blue-100"><i data-lucide="file-down" class="h-6 w-6 text-blue-600"></i></div><div><h3 class="text-lg font-medium leading-6">Tùy chọn Nhập Dữ liệu</h3><p id="import-info" class="mt-1 text-sm text-[var(--muted-foreground)]"></p></div></div><div class="mt-6 flex flex-col gap-3"><button id="import-overwrite-btn" class="w-full text-left p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring border border-[var(--border)]"><p class="font-semibold">Ghi đè toàn bộ</p><p class="text-sm text-[var(--muted-foreground)]">Xóa dữ liệu hiện tại và thay thế.</p></button><button id="import-merge-btn" class="w-full text-left p-3 rounded-lg hover:bg-[var(--accent)] transition-colors custom-ring border border-[var(--border)]"><p class="font-semibold">Hợp nhất (Chỉ thêm mới)</p><p class="text-sm text-[var(--muted-foreground)]">Giữ lại dữ liệu cũ, chỉ thêm mục mới.</p></button><button id="import-cancel-btn" class="mt-4 w-full px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--secondary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring">Hủy</button></div></div></dialog>
    <dialog id="confirm-modal" class="p-0 rounded-xl shadow-2xl w-11/12 max-w-sm"><div class="p-6 text-center"><div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4"><i data-lucide="alert-triangle" class="h-6 w-6 text-yellow-600"></i></div><h3 class="text-lg font-medium">Bạn có chắc không?</h3><p id="confirm-message" class="mt-2 text-sm text-[var(--muted-foreground)]"></p><div class="mt-6 flex justify-center gap-3"><button id="confirm-cancel" class="px-4 py-2 rounded-lg bg-[var(--secondary)] text-[var(--secondary-foreground)] font-semibold hover:opacity-90 transition-opacity custom-ring">Hủy</button><button id="confirm-proceed" class="px-4 py-2 rounded-lg bg-red-600 text-white font-semibold hover:bg-red-700 transition-colors custom-ring">Xác nhận</button></div></div></dialog>
    <div id="toast-container"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            class MedicinalPlantApp {
                constructor() {
                    this.plants = []; this.currentFilter = { group: 'all', search: '' }; this.activeAutocomplete = null; this.selectedPlants = new Set(); this.pressTimer = null; this.isLongPressing = false; this.isDragging = false; this.pointerStartPos = { x: 0, y: 0 }; this.isTransitioning = false; this.observer = null;
                    this.currentView = { type: 'list' };
                    this.currentListTitle = 'Tất cả Dược liệu';
                    this.initDataLists(); this.initDOMElements(); this.initIntersectionObserver(); this.loadPlants(); this.initHistory(); this.initEventListeners(); this.initTheme(); this.initSidebarState();
                }

                _normalizeText(str) { if (!str) return ''; return str.toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/đ/g, 'd'); }
                
                isMobile() { return window.innerWidth < 768; }
                
                initIntersectionObserver() {
                    const options = { root: null, rootMargin: '0px', threshold: 0.1 };
                    this.observer = new IntersectionObserver((entries, observer) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                entry.target.classList.add('is-visible');
                                observer.unobserve(entry.target);
                            }
                        });
                    }, options);
                }

                initDataLists() { this.dataLists = { families: [ { s: 'Acanthaceae', v: 'Họ Ô rô' }, { s: 'Amaranthaceae', v: 'Họ Dền' }, { s: 'Apiaceae', v: 'Họ Hoa tán' }, { s: 'Apocynaceae', v: 'Họ Trúc đào' }, { s: 'Araceae', v: 'Họ Ráy' }, { s: 'Araliaceae', v: 'Họ Nhân sâm' }, { s: 'Asteraceae', v: 'Họ Cúc' }, { s: 'Balsaminaceae', v: 'Họ Bóng nước' }, { s: 'Bignoniaceae', v: 'Họ Chùm ớt' }, { s: 'Boraginaceae', v: 'Họ Vòi voi' }, { s: 'Brassicaceae', v: 'Họ Cải' }, { s: 'Burseraceae', v: 'Họ Trám' }, { s: 'Caesalpiniaceae', v: 'Họ Vang' }, { s: 'Campanulaceae', v: 'Họ Hoa chuông' }, { s: 'Capparaceae', v: 'Họ Màn màn' }, { s: 'Celastraceae', v: 'Họ Dây gối' }, { s: 'Clusiaceae', v: 'Họ Bứa' }, { s: 'Combretaceae', v: 'Họ Bàng' }, { s: 'Convolvulaceae', v: 'Họ Bìm bìm' }, { s: 'Crassulaceae', v: 'Họ Thuốc bỏng' }, { s: 'Cucurbitaceae', v: 'Họ Bầu bí' }, { s: 'Cyperaceae', v: 'Họ Cói' }, { s: 'Dioscoreaceae', v: 'Họ Củ nâu' }, { s: 'Euphorbiaceae', v: 'Họ Thầu dầu' }, { s: 'Fabaceae', v: 'Họ Đậu' }, { s: 'Gentianaceae', v: 'Họ Long đởm' }, { s: 'Gesneriaceae', v: 'Họ Tai voi' }, { s: 'Lamiaceae', v: 'Họ Hoa môi' }, { s: 'Lauraceae', v: 'Họ Long não' }, { s: 'Lecythidaceae', v: 'Họ Lộc vừng' }, { s: 'Liliaceae', v: 'Họ Loa kèn' }, { s: 'Loganiaceae', v: 'Họ Mã tiền' }, { s: 'Lythraceae', v: 'Họ Bằng lăng' }, { s: 'Malvaceae', v: 'Họ Bông' }, { s: 'Melastomataceae', v: 'Họ Mua' }, { s: 'Meliaceae', v: 'Họ Xoan' }, { s: 'Menispermaceae', v: 'Họ Tiết dê' }, { s: 'Mimosaceae', v: 'Họ Trinh nữ' }, { s: 'Moraceae', v: 'Họ Dâu tằm' }, { s: 'Myrtaceae', v: 'Họ Sim' }, { s: 'Orchidaceae', v: 'Họ Lan' }, { s: 'Passifloraceae', v: 'Họ Lạc tiên' }, { s: 'Phyllanthaceae', v: 'Họ Diệp hạ châu' }, { s: 'Piperaceae', v: 'Họ Hồ tiêu' }, { s: 'Poaceae', v: 'Họ Lúa' }, { s: 'Polygonaceae', v: 'Họ Rau răm' }, { s: 'Ranunculaceae', v: 'Họ Hoàng liên' }, { s: 'Rhamnaceae', v: 'Họ Táo ta' }, { s: 'Rosaceae', v: 'Họ Hoa hồng' }, { s: 'Rubiaceae', v: 'Họ Cà phê' }, { s: 'Rutaceae', v: 'Họ Cam' }, { s: 'Sapindaceae', v: 'Họ Bồ hòn' }, { s: 'Scrophulariaceae', v: 'Họ Mõm sói' }, { s: 'Solanaceae', v: 'Họ Cà' }, { s: 'Sterculiaceae', v: 'Họ Trôm' }, { s: 'Thymelaeaceae', v: 'Họ Trầm' }, { s: 'Urticaceae', v: 'Họ Gai' }, { s: 'Verbenaceae', v: 'Họ Cỏ roi ngựa' }, { s: 'Violaceae', v: 'Họ Hoa tím' }, { s: 'Vitaceae', v: 'Họ Nho' }, { s: 'Zingiberaceae', v: 'Họ Gừng' } ].sort((a, b) => a.s.localeCompare(b.s)), }; }

                initDOMElements() { this.els = { sidebar: document.getElementById('sidebar'), sidebarToggle: document.getElementById('sidebar-toggle'), sidebarToggleCollapsed: document.getElementById('sidebar-toggle-collapsed'), searchInput: document.getElementById('search-input'), groupsNav: document.getElementById('groups-nav'), groupsNavMobile: document.getElementById('groups-nav-mobile'), plantListContainer: document.getElementById('plant-list-container'), plantListGrid: document.getElementById('plant-list-grid'), plantDetailView: document.getElementById('plant-detail-view'), plantModal: document.getElementById('plant-modal'), plantForm: document.getElementById('plant-form'), modalTitle: document.getElementById('modal-title'), closeModalButton: document.getElementById('close-modal-button'), cancelButton: document.getElementById('cancel-button'), plantIdInput: document.getElementById('plant-id'), welcomeScreen: document.getElementById('welcome-screen'), plantCount: document.getElementById('plant-count'), addPlantWelcomeBtn: document.getElementById('add-plant-welcome'), addPlantSidebar: document.getElementById('add-plant-sidebar'), addPlantFab: document.getElementById('add-plant-fab'), addPlantMobile: document.getElementById('add-plant-mobile'), importButtonDesktop: document.getElementById('import-button-desktop'), exportButtonDesktop: document.getElementById('export-button-desktop'), themeToggleDesktop: document.getElementById('theme-toggle-desktop'), importButtonDesktopCollapsed: document.getElementById('import-button-desktop-collapsed'), exportButtonDesktopCollapsed: document.getElementById('export-button-desktop-collapsed'), themeToggleDesktopCollapsed: document.getElementById('theme-toggle-desktop-collapsed'), mobileHeader: document.getElementById('mobile-header'), mobileMenuButton: document.getElementById('mobile-menu-button'), mobileMenu: document.getElementById('mobile-menu'), closeMobileMenu: document.getElementById('close-mobile-menu'), stickyHeader: document.getElementById('sticky-header'), stickyTitle: document.getElementById('sticky-title'), stickySubtitle: document.getElementById('sticky-subtitle'), stickyBackButton: document.getElementById('sticky-back-button'), importButtonMobile: document.getElementById('import-button-mobile'), exportButtonMobile: document.getElementById('export-button-mobile'), themeToggles: document.querySelectorAll('#theme-toggle-desktop, #theme-toggle-desktop-collapsed, #theme-toggle-mobile'), toastContainer: document.getElementById('toast-container'), confirmModal: document.getElementById('confirm-modal'), confirmMessage: document.getElementById('confirm-message'), confirmCancel: document.getElementById('confirm-cancel'), confirmProceed: document.getElementById('confirm-proceed'), contextMenu: document.getElementById('context-menu'), selectionToolbar: document.getElementById('selection-toolbar'), selectionCount: document.getElementById('selection-count'), deleteSelectedBtn: document.getElementById('delete-selected-btn'), importOptionsModal: document.getElementById('import-options-modal'), importInfo: document.getElementById('import-info'), importOverwriteBtn: document.getElementById('import-overwrite-btn'), importMergeBtn: document.getElementById('import-merge-btn'), importCancelBtn: document.getElementById('import-cancel-btn'), tenDuocLieu: { input: document.getElementById('ten-duoc-lieu-input') }, hoCay: { input: document.getElementById('ho-cay-input'), list: document.getElementById('ho-cay-list') }, nhomChat: { input: document.getElementById('nhom-chat-input'), list: document.getElementById('nhom-chat-list') }, thanhPhanHoaHocChinh: { input: document.getElementById('thanh-phan-hoa-hoc-chinh-input'), list: document.getElementById('thanh-phan-hoa-hoc-chinh-list') }, boPhanDung: { input: document.getElementById('bo-phan-dung-input'), list: document.getElementById('bo-phan-dung-list') }, tacDung: { input: document.getElementById('tac-dung-input'), list: document.getElementById('tac-dung-list') }, congDung: { input: document.getElementById('cong-dung-input'), list: document.getElementById('cong-dung-list') }, lieuDung: { input: document.getElementById('lieu-dung-input') }, luuY: { input: document.getElementById('luu-y-input') }, dacDiemDuocLieu: { input: document.getElementById('dac-diem-duoc-lieu-input') }, sidebarTopActions: document.getElementById('sidebar-top-actions'), sidebarTopActionsCollapsed: document.getElementById('sidebar-top-actions-collapsed'), searchButtonCollapsed: document.getElementById('search-button-collapsed'), addPlantSidebarCollapsed: document.getElementById('add-plant-sidebar-collapsed'), sidebarBottomActions: document.getElementById('sidebar-bottom-actions'), sidebarBottomActionsCollapsed: document.getElementById('sidebar-bottom-actions-collapsed'), mobileSearchButton: document.getElementById('mobile-search-button'), searchView: document.getElementById('search-view'), searchViewBackButton: document.getElementById('search-view-back-button'), searchViewInput: document.getElementById('search-view-input'), searchResultsGrid: document.getElementById('search-results-grid'), }; }

                initHistory() {
                    history.replaceState({ view: 'list', filter: this.currentFilter }, '', '#list');
                    window.addEventListener('popstate', (e) => {
                        if (e.state) {
                            this.handleStateChange(e.state);
                        } else {
                            this.showConfirm(
                                'Bạn có muốn thoát khỏi trang này không?',
                                () => { window.history.back(); }, 
                                () => { history.pushState({ view: 'list', filter: this.currentFilter }, '', '#list'); }
                            );
                        }
                    });
                }

                handleStateChange(state) {
                    this.closeModal();
                    this.els.mobileMenu.classList.add('hidden');
                    
                    this.currentView = state; 

                    switch(state.view) {
                        case 'detail':
                            this.hideSearchView(false);
                            const backTitle = state.backTitle || 'Quay lại';
                            this.showPlantDetail(state.id, true, backTitle);
                            break;
                        case 'search':
                            this.showSearchView(true);
                            break;
                        case 'list':
                        default:
                            this.currentFilter = state.filter;
                            this.hideSearchView(false);
                            this.showListView();
                            break;
                    }
                }


                initEventListeners() { 
                    [this.els.sidebarToggle, this.els.sidebarToggleCollapsed].forEach(btn => btn.addEventListener('click', () => this.toggleSidebar())); 
                    this.els.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value)); 
                    [this.els.addPlantWelcomeBtn, this.els.addPlantSidebar, this.els.addPlantFab, this.els.addPlantMobile, this.els.addPlantSidebarCollapsed].forEach(btn => btn && btn.addEventListener('click', () => this.openModal())); 
                    this.els.searchButtonCollapsed.addEventListener('click', () => { if (this.els.sidebar.classList.contains('collapsed')) { this.toggleSidebar(); this.els.searchInput.focus(); } }); 
                    this.els.plantForm.addEventListener('submit', (e) => this.handleFormSubmit(e)); 
                    this.els.closeModalButton.addEventListener('click', () => this.closeModal()); 
                    this.els.cancelButton.addEventListener('click', () => this.closeModal()); 
                    this.els.plantModal.addEventListener('click', (e) => { if (e.target === this.els.plantModal) this.closeModal(); }); 
                    this.els.mobileMenuButton.addEventListener('click', () => this.els.mobileMenu.classList.remove('hidden')); 
                    this.els.closeMobileMenu.addEventListener('click', () => this.els.mobileMenu.classList.add('hidden')); 
                    this.els.mobileMenu.addEventListener('click', (e) => { if (e.target === this.els.mobileMenu) this.els.mobileMenu.classList.add('hidden'); }); 
                    this.els.stickyBackButton.addEventListener('click', () => window.history.back()); 
                    [this.els.importButtonDesktop, this.els.importButtonDesktopCollapsed, this.els.importButtonMobile].forEach(btn => btn.addEventListener('click', () => this.importData())); 
                    [this.els.exportButtonDesktop, this.els.exportButtonDesktopCollapsed, this.els.exportButtonMobile].forEach(btn => btn.addEventListener('click', () => this.exportData())); 
                    this.els.themeToggles.forEach(btn => btn.addEventListener('click', () => this.toggleTheme())); 
                    this.els.deleteSelectedBtn.addEventListener('click', () => this.deleteSelectedPlants()); 
                    this.els.mobileSearchButton.addEventListener('click', () => this.navigateToSearch()); 
                    this.els.searchViewBackButton.addEventListener('click', () => window.history.back()); 
                    this.els.searchViewInput.addEventListener('input', (e) => this.renderSearchResults(e.target.value)); 
                    this.setupAutocomplete('hoCay', this.dataLists.families, { type: 'family' }); this.setupAutocomplete('nhomChat', () => this.getDynamicSuggestions('nhomChat'), { append: true, separator: '>' }); this.setupAutocomplete('thanhPhanHoaHocChinh', () => this.getDynamicSuggestions('thanhPhanHoaHocChinh'), { append: true }); this.setupAutocomplete('boPhanDung', () => this.getDynamicSuggestions('boPhanDung'), { append: true }); this.setupAutocomplete('tacDung', () => this.getDynamicSuggestions('tacDung'), { append: true }); this.setupAutocomplete('congDung', () => this.getDynamicSuggestions('congDung'), { append: true }); 
                    document.addEventListener('click', (e) => { this.hideContextMenu(); if (this.activeAutocomplete && !this.els[this.activeAutocomplete].input.contains(e.target) && !this.els[this.activeAutocomplete].list.contains(e.target)) { this.hideAutocomplete(); } }); 
                }
                
                loadPlants() { fetch('data.json').then(res => { if (!res.ok) throw new Error(); return res.json(); }).then(data => { this.plants = data; this.savePlants(); this.renderAll(); }).catch(() => { console.warn('Cannot find data.json, using local data.'); const data = localStorage.getItem('medicinalPlants'); if (data) { this.plants = JSON.parse(data); } else { this.plants = [{ id: '1', tenDuocLieu: 'Ba gạc', hoCay: 'Apocynaceae (Họ Trúc đào)', nhomChat: 'Alkaloid > Indol', thanhPhanHoaHocChinh: 'Reserpin, Ajmalin', boPhanDung: 'Rễ', tacDung: 'Reserpin: Hạ huyết áp, an thần; Ajmalin: Chữa loạn nhịp tim', congDung: '(Y học hiện đại): Chữa cao huyết áp; (Y học cổ truyền): Thanh nhiệt; Khác: Rễ cây được dùng để chiết xuất hoạt chất.', lieuDung: 'Dạng bột rễ: 0,1g/lần, 0,3g/24h. Dạng cao lỏng: 1-3g/24h.', luuY: 'Không dùng cho bệnh nhân trầm cảm, loét dạ dày. Thận trọng với phụ nữ có thai, cho con bú.', dacDiemDuocLieu: 'Rễ: hình trụ, cong queo, có thể phân nhánh. Vỏ: ngoài màu vàng tro, có nhiều nếp nhăn dọc và vết sẹo của rễ con.' }, { id: '2', tenDuocLieu: 'Hòe', hoCay: 'Fabaceae (Họ Đậu)', nhomChat: 'Flavonoid > Flavonol', thanhPhanHoaHocChinh: 'Rutin', boPhanDung: 'Nụ hoa', tacDung: 'Rutin: Tăng sức bền thành mạch, cầm máu.', congDung: '(Y học cổ truyền): Lương huyết, chỉ huyết, dùng trong các trường hợp huyết nhiệt, chảy máu cam, ho ra máu.; Khác: Dùng làm phẩm nhuộm an toàn cho thực phẩm.', lieuDung: 'Ngày dùng 5-20g dạng thuốc sắc hoặc hãm.', luuY: 'Người tỳ vị hư hàn, phụ nữ có thai không nên dùng.', dacDiemDuocLieu: 'Nụ hoa: hình trứng, dài 3-6mm. Đài hoa: hình chuông, màu vàng xám. Mùi thơm đặc trưng.' }, { id: '3', tenDuocLieu: 'Mã tiền', hoCay: 'Loganiaceae (Họ Mã tiền)', nhomChat: 'Alkaloid > Indol', thanhPhanHoaHocChinh: 'Strychnin, Brucin', boPhanDung: 'Hạt', tacDung: 'Strychnin: Kích thích thần kinh trung ương, tăng phản xạ tủy.', congDung: '(Y học hiện đại): Dùng ngoài chữa đau nhức, thấp khớp. (Y học cổ truyền): Thông lạc chỉ thống, tiêu thũng tán kết.', lieuDung: 'Rất độc, chỉ dùng ngoài hoặc theo chỉ định nghiêm ngặt của bác sĩ.', luuY: 'Tuyệt đối không được uống. Phụ nữ có thai không được dùng.', dacDiemDuocLieu: 'Hạt: hình đĩa, dẹt, một mặt lồi một mặt lõm. Bề mặt phủ lông tơ bóng mượt màu xám tro.' }, {id: '4', tenDuocLieu: 'Bình vôi', hoCay: 'Menispermaceae (Họ Tiết dê)', nhomChat: 'Alkaloid > Isoquinolin > Protoberberin', thanhPhanHoaHocChinh: 'Rotundin (L-tetrahydropalmatin)', boPhanDung: 'Củ', tacDung: 'Rotundin: An thần, gây ngủ, giảm đau, điều hòa nhịp tim.', congDung: '(Y học hiện đại): Mất ngủ, an thần, giảm đau trong các bệnh loét dạ dày, hen. (Y học cổ truyền): An thần, kiện tỳ.', lieuDung: 'Rotundin: người lớn 0.06-0.12g/ngày. Dược liệu: 3-6g/ngày.', luuY: 'Không dùng cho người mẫn cảm với thành phần của thuốc.', dacDiemDuocLieu: 'Củ: to, tròn, vỏ ngoài xù xì màu nâu đen, trông giống hòn đá hoặc củ khoai.' }]; this.savePlants(); } this.renderAll(); }); }
                
                savePlants() { localStorage.setItem('medicinalPlants', JSON.stringify(this.plants)); }
                addPlant(data) { this.plants.push({ id: Date.now().toString(), ...data }); this.savePlants(); this.renderAll(); this.showToast('Thêm dược liệu thành công!', 'success'); }
                updatePlant(id, data) { this.plants = this.plants.map(p => p.id === id ? { ...p, ...data } : p); this.savePlants(); this.renderAll(); this.showPlantDetail(id, false); this.showToast('Cập nhật thành công!', 'success'); }
                deletePlant(id) { this.showConfirm('Bạn có chắc chắn muốn xóa dược liệu này không?', () => { this.plants = this.plants.filter(p => p.id !== id); this.selectedPlants.delete(id); this.savePlants(); this.renderAll(); history.back(); this.showToast('Đã xóa dược liệu.', 'success'); }); }
                deleteSelectedPlants() { const c = this.selectedPlants.size; if (c === 0) return; this.showConfirm(`Bạn có chắc muốn xóa ${c} mục đã chọn không?`, () => { this.plants = this.plants.filter(p => !this.selectedPlants.has(p.id)); this.selectedPlants.clear(); this.savePlants(); this.renderAll(); this.showToast(`Đã xóa ${c} dược liệu.`, 'success'); }); }

                renderAll() { const p = this.getFilteredPlants(); this.renderGroups(); this.renderPlantList(p); this.updateUIState(); this.updateSelectionToolbar(); }

                renderGroups() {
                    const openGroups = new Set();
                    this.els.groupsNav.querySelectorAll('details[open] > summary.group-link').forEach(summary => {
                        openGroups.add(summary.dataset.group);
                    });
                    const openGroupsMobile = new Set();
                    this.els.groupsNavMobile.querySelectorAll('details[open] > summary.group-link').forEach(summary => {
                        openGroupsMobile.add(summary.dataset.group);
                    });

                    const tree = {}; this.plants.forEach(p => { if (!p.nhomChat) return; const paths = p.nhomChat.split(',').map(c => c.trim()).filter(Boolean); paths.forEach(pathStr => { const path = pathStr.split('>').map(part => part.trim()); let node = tree; path.forEach(part => { if (!node[part]) node[part] = {}; node = node[part]; }); }); });
                    const buildHTML = (node, path = '', level = 0) => Object.keys(node).sort().map(key => { const children = node[key]; const currentPath = path ? `${path} > ${key}` : key; if (Object.keys(children).length > 0) { return `<li><details class="group-details"><summary class="group-link flex items-center justify-between gap-2 px-3 py-2 rounded-lg cursor-pointer transition-colors hover:bg-[var(--accent)]" data-group="${currentPath}"><span class="flex-grow font-medium">${key}</span><i data-lucide="chevron-right" class="chevron w-4 h-4 flex-shrink-0"></i></summary><ul class="pl-4">${buildHTML(children, currentPath, level + 1)}</ul></details></li>`; } return `<li><a href="#" class="group-link block pl-9 pr-3 py-2 rounded-lg transition-colors hover:bg-[var(--accent)]" data-group="${currentPath}">${key}</a></li>`; }).join('');
                    const allLink = `<li><a href="#" class="group-link flex items-center gap-3 px-3 py-2 rounded-lg transition-colors hover:bg-[var(--accent)]" data-group="Tất cả"><i data-lucide="library" class="w-5 h-5"></i><span class="sidebar-text">Tất cả Dược liệu</span></a></li>`;
                    const html = `<ul class="space-y-1">${allLink}${buildHTML(tree)}</ul>`; this.els.groupsNav.innerHTML = html; this.els.groupsNavMobile.innerHTML = html;
                    
                    this.els.groupsNav.querySelectorAll('details > summary.group-link').forEach(summary => {
                        if (openGroups.has(summary.dataset.group)) {
                            summary.closest('details').open = true;
                        }
                    });
                    this.els.groupsNavMobile.querySelectorAll('details > summary.group-link').forEach(summary => {
                        if (openGroupsMobile.has(summary.dataset.group)) {
                            summary.closest('details').open = true;
                        }
                    });

                    document.querySelectorAll('.group-link').forEach(link => {
                        link.addEventListener('click', (e) => {
                            if (link.tagName.toLowerCase() !== 'summary') {
                                e.preventDefault();
                            }
                            const groupName = e.currentTarget.dataset.group === 'Tất cả' ? 'all' : e.currentTarget.dataset.group;
                            this.handleGroupFilter(groupName);
                        });
                    });

                    this.highlightActiveGroup(); lucide.createIcons();
                }
                
                renderPlantList(plants) {
                    if (plants.length === 0) { if (this.currentFilter.search || this.plants.length > 0) { this.els.plantListGrid.innerHTML = `<div class="col-span-full text-center text-[var(--muted-foreground)] py-10"><i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4"></i><p class="font-semibold">Không tìm thấy kết quả</p><p>Vui lòng thử lại với từ khóa hoặc bộ lọc khác.</p></div>`; this.els.plantListGrid.className = ''; } lucide.createIcons(); return; }
                    
                    const normalizedQuery = this._normalizeText(this.currentFilter.search);
                    const hasSearch = !!normalizedQuery;
                    
                    const mapPlantToHTML = plant => {
                        const context = hasSearch ? this._findMatchContext(plant, normalizedQuery) : null;
                        return this.createPlantCardHTML(plant, context);
                    };

                    const filter = this.currentFilter.group;
                    const filterParts = filter === 'all' ? [] : filter.split(' > ');
                    const currentLevel = filterParts.length;

                    this.els.plantListGrid.className = '';
                    const groups = {};
                    plants.forEach(p => {
                        let key = 'Các dược liệu khác';
                        if (p.nhomChat) {
                            const relevantPath = (p.nhomChat.split(',').map(x => x.trim()).find(x => filter === 'all' || x.startsWith(filter)) || '').split('>').map(y => y.trim());
                            if (relevantPath.length > currentLevel) {
                                key = relevantPath[currentLevel];
                            }
                        }
                        if (!groups[key]) groups[key] = [];
                        groups[key].push(p);
                    });
                    
                    this.els.plantListGrid.innerHTML = Object.keys(groups).sort().map(key => `
                        <div class="group-container mb-4">
                            <h2 class="sticky-group-header text-sm font-semibold uppercase text-[var(--muted-foreground)] tracking-wider">${key}</h2>
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pt-2">
                                ${groups[key].map(mapPlantToHTML).join('')}
                            </div>
                        </div>`).join('');
                    
                    this.addEventListenersToCards(this.els.plantListGrid);
                    this.els.plantListGrid.querySelectorAll('.animate-on-scroll').forEach(el => this.observer.observe(el));
                    lucide.createIcons();
                }

                async transitionView(fromEl, toEl, onTransitionCallback = null) {
                    if (this.isTransitioning) return;
                    this.isTransitioning = true;

                    if (!fromEl || fromEl.classList.contains('hidden')) {
                        toEl.classList.remove('hidden');
                        if (onTransitionCallback) onTransitionCallback();
                        this.isTransitioning = false;
                        return;
                    }

                    fromEl.classList.add('view-fade-out');
                    await new Promise(resolve => setTimeout(resolve, 250));

                    fromEl.classList.add('hidden');
                    fromEl.classList.remove('view-fade-out');
                    
                    toEl.classList.remove('hidden');
                    if (onTransitionCallback) onTransitionCallback();
                    
                    toEl.classList.add('view-fade-in');
                    
                    await new Promise(resolve => setTimeout(resolve, 250));
                    toEl.classList.remove('view-fade-in');
                    
                    this.isTransitioning = false;
                }
                
                navigateToDetail(id) {
                    if (this.currentView.type === 'detail' && this.currentView.id === id) return;
                    const newState = { view: 'detail', id: id, filter: this.currentFilter, backTitle: this.currentListTitle };
                    history.pushState(newState, '', `#detail/${id}`);
                    this.handleStateChange(newState);
                }

                navigateToSearch(searchTerm = '') {
                    if (this.currentView.type === 'search') {
                        if (searchTerm) {
                            this.els.searchViewInput.value = searchTerm;
                            this.renderSearchResults(searchTerm);
                        }
                        return;
                    }
                    const newState = { view: 'search', filter: this.currentFilter };
                    history.pushState(newState, '', `#search`);
                    this.handleStateChange(newState);
                    if (searchTerm) {
                        this.els.searchViewInput.value = searchTerm;
                        this.renderSearchResults(searchTerm);
                    }
                }
                
                showPlantDetail(id, isPoppedState = false, backTitle = 'Quay lại') {
                    this.els.mobileHeader.classList.add('hidden');
                    const plant = this.plants.find(p => p.id === id); 
                    if (!plant) {
                        this.showToast('Không tìm thấy dược liệu.', 'error');
                        if(!isPoppedState) history.back();
                        return;
                    }

                    // Get related data
                    const currentFilteredList = this.getFilteredPlants();
                    const currentIndex = currentFilteredList.findIndex(p => p.id === id);
                    const prevPlant = currentIndex > 0 ? currentFilteredList[currentIndex - 1] : null;
                    const nextPlant = currentIndex < currentFilteredList.length - 1 ? currentFilteredList[currentIndex + 1] : null;

                    const relatedFamilyPlants = this.plants.filter(p => p.hoCay === plant.hoCay && p.id !== plant.id);
                    const relatedGroupsData = [];
                    const primaryGroupPath = (plant.nhomChat || '').split(',')[0].trim();

                    if (primaryGroupPath) {
                        const groupParts = primaryGroupPath.split('>').map(p => p.trim());
                        let currentPath = '';
                        for (const part of groupParts) {
                            currentPath = currentPath ? `${currentPath} > ${part}` : part;
                            // Find plants that are in this group or sub-groups
                            const relatedPlants = this.plants.filter(p =>
                                p.id !== plant.id &&
                                p.nhomChat &&
                                p.nhomChat.split(',').some(g => g.trim().startsWith(currentPath))
                            );
                            if (relatedPlants.length > 0) {
                                relatedGroupsData.push({
                                    groupName: part,
                                    fullPath: currentPath,
                                    plants: relatedPlants
                                });
                            }
                        }
                    }
                    
                    const renderMultilineText = (s) => {
                        if (!s || s.trim() === '') return '<p>Chưa có thông tin</p>';
                        const items = s.split(/(?:;|\.\s+|\n)/g).map(i => i.trim()).filter(Boolean);
                        if (items.length <= 1) return `<p>${s}</p>`;
                        return `<ul class="list-disc pl-5 space-y-1">${items.map(i => `<li>${i.replace(/\.$/, '')}</li>`).join('')}</ul>`;
                    };

                    const renderDacDiem = (s) => {
                        if (!s || s.trim() === '') return '<p>Chưa có thông tin</p>';
                        const parts = s.split(/(Rễ:|Thân:|Lá:|Hoa:|Quả:|Hạt:|Vỏ:|Củ:|Nụ hoa:|Đài hoa:)/g).filter(p => p.trim() !== '');
                        if (parts.length <= 1) return `<p>${s}</p>`;
                        
                        let html = '<ul class="list-none space-y-2">';
                        for (let i = 0; i < parts.length; i += 2) {
                            if (parts[i] && parts[i+1]) {
                                const keyword = parts[i].trim();
                                const description = parts[i+1].trim().replace(/^(\.|;|,)/, '').trim();
                                html += `<li><span class="font-semibold">${keyword}</span> ${description}</li>`;
                            } else if (parts[i]) {
                                html += `<li>${parts[i].trim()}</li>`;
                            }
                        }
                        html += '</ul>';
                        return html;
                    };
                    
                    const renderTacDung = (s) => { if (!s || s.trim() === '') return '<p>Chưa có thông tin</p>'; return `<ul class="list-disc pl-5 space-y-2">${s.split(';').map(i => { const p = i.trim().split(':'); return p.length === 2 ? `<li><span class="font-semibold">${p[0].trim()}:</span> ${p[1].trim()}</li>` : `<li>${i.trim()}</li>`; }).join('')}</ul>`; };
                    
                    const renderCongDung = (s) => {
                        if (!s || s.trim() === '') return '<p>Chưa có thông tin</p>';
                        const items = s.split(/(?:;|\.\s*(?=\())/g).map(i => i.trim()).filter(Boolean);
                        return `<ul class="list-disc pl-5 space-y-2">${items.map(item => { 
                            const m = item.match(/^\((.*?)\):\s*(.*)/); 
                            if (m) {
                                return `<li><span class="font-semibold text-[var(--primary)]">${m[1].trim()}:</span> ${m[2].trim().replace(/\.$/, '')}</li>`; 
                            }
                            const m2 = item.match(/^(Khác):\s*(.*)/);
                             if (m2) {
                                return `<li><span class="font-semibold text-[var(--primary)]">${m2[1].trim()}:</span> ${m2[2].trim().replace(/\.$/, '')}</li>`; 
                            }
                            return `<li>${item}</li>`; 
                        }).join('')}</ul>`;
                    };
                    
                    this.els.stickyTitle.textContent = plant.tenDuocLieu;
                    this.els.stickySubtitle.textContent = plant.hoCay;

                    this.els.plantDetailView.innerHTML = `
                        <div class="max-w-4xl mx-auto">
                            <div class="md:hidden -mx-4 px-2 pt-2 pb-1 mb-2 sticky top-0 bg-[var(--background)]/80 backdrop-blur-sm z-20">
                                <button id="back-to-list-mobile" class="flex items-center gap-1 text-sm font-medium text-[var(--primary)] p-2 rounded-lg custom-ring w-full">
                                    <i data-lucide="chevron-left" class="w-5 h-5"></i>
                                    <span class="truncate">${backTitle}</span>
                                </button>
                            </div>
                            
                            <button id="back-to-list-desktop" class="hidden md:flex items-center gap-2 mb-4 text-[var(--muted-foreground)] hover:text-[var(--primary)] transition-colors font-medium custom-ring rounded-md -ml-2 p-1">
                                <i data-lucide="arrow-left"></i>
                                <span>${backTitle}</span>
                            </button>

                            <div class="detail-section animate-on-scroll">
                                <div class="bg-[var(--card)] rounded-xl border border-[var(--border)] p-6 md:p-8">
                                    <div class="plant-title-block flex flex-col md:flex-row justify-between md:items-start mb-6">
                                        <div>
                                            <h2 class="text-3xl font-bold">${plant.tenDuocLieu}</h2>
                                            <p class="text-lg text-[var(--muted-foreground)]">${this._createSearchTrigger(plant.hoCay)}</p>
                                        </div>
                                        <div class="relative mt-4 md:mt-0">
                                            <button id="detail-actions-btn" class="p-2 bg-[var(--secondary)] hover:bg-[var(--accent)] rounded-full custom-ring"><i data-lucide="more-vertical"></i></button>
                                            <div id="detail-actions-menu" class="detail-actions-menu hidden absolute top-full right-0 mt-2 w-40 bg-[var(--card)] border border-[var(--border)] rounded-md shadow-lg p-1 z-10">
                                                <button class="w-full text-left flex items-center gap-3 px-3 py-2 rounded hover:bg-[var(--accent)]" data-action="edit"><i data-lucide="edit-3" class="w-4 h-4"></i><span>Chỉnh sửa</span></button>
                                                <button class="w-full text-left flex items-center gap-3 px-3 py-2 rounded text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20" data-action="delete"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Xóa</span></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="space-y-6">
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Nhóm chất</h4><div class="flex flex-wrap gap-1">${(plant.nhomChat || '').split(',').map(g => `<span class="inline-block bg-[var(--accent)] text-[var(--accent-foreground)] px-3 py-1 rounded-full text-sm">${g.trim()}</span>`).join('')}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Thành phần hóa học chính</h4><div>${this._renderClickableItems(plant.thanhPhanHoaHocChinh)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Bộ phận dùng</h4><div>${this._renderClickableItems(plant.boPhanDung)}</div></div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Đặc điểm dược liệu</h4>${renderDacDiem(plant.dacDiemDuocLieu)}</div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Tác dụng</h4>${renderTacDung(plant.tacDung)}</div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Công dụng</h4>${renderCongDung(plant.congDung)}</div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Liều dùng</h4>${renderMultilineText(plant.lieuDung)}</div>
                                        <div><h4 class="font-semibold text-sm uppercase text-[var(--muted-foreground)] mb-2">Lưu ý</h4>${renderMultilineText(plant.luuY)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            ${(prevPlant || nextPlant) ? `
                            <div class="detail-section animate-on-scroll mt-8">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${prevPlant ? `
                                    <a href="#detail/${prevPlant.id}" data-id="${prevPlant.id}" class="nav-link block p-4 rounded-xl bg-[var(--card)] border border-[var(--border)] hover:border-[var(--primary)] transition-all text-left group">
                                        <p class="text-sm text-[var(--muted-foreground)] flex items-center gap-2"><i data-lucide="arrow-left" class="w-4 h-4 transition-transform group-hover:-translate-x-1"></i> Cây trước đó</p>
                                        <h4 class="font-semibold text-lg">${prevPlant.tenDuocLieu}</h4>
                                    </a>` : '<div></div>'}
                                    ${nextPlant ? `
                                    <a href="#detail/${nextPlant.id}" data-id="${nextPlant.id}" class="nav-link block p-4 rounded-xl bg-[var(--card)] border border-[var(--border)] hover:border-[var(--primary)] transition-all text-right group">
                                        <p class="text-sm text-[var(--muted-foreground)] flex items-center justify-end gap-2">Cây tiếp theo <i data-lucide="arrow-right" class="w-4 h-4 transition-transform group-hover:translate-x-1"></i></p>
                                        <h4 class="font-semibold text-lg">${nextPlant.tenDuocLieu}</h4>
                                    </a>` : '<div></div>'}
                                </div>
                            </div>
                            ` : ''}

                            ${relatedFamilyPlants.length > 0 ? `
                            <div class="detail-section animate-on-scroll mt-8">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">Cây cùng họ</h3>
                                    ${relatedFamilyPlants.length > 3 ? `<button class="search-trigger text-sm font-medium text-[var(--primary)] hover:underline rounded focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]" data-search-term="${plant.hoCay}">Xem tất cả (${relatedFamilyPlants.length})</button>` : ''}
                                </div>
                                <div id="related-family-plants-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${relatedFamilyPlants.slice(0, 3).map(p => this.createPlantCardHTML(p)).join('')}
                                </div>
                            </div>
                            ` : ''}

                            ${relatedGroupsData.map(groupData => `
                            <div class="detail-section animate-on-scroll mt-8">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-bold">Cây cùng nhóm ${groupData.groupName}</h3>
                                    ${groupData.plants.length > 3 ? `<button class="search-trigger text-sm font-medium text-[var(--primary)] hover:underline rounded focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)]" data-search-term="${groupData.fullPath}">Xem tất cả (${groupData.plants.length})</button>` : ''}
                                </div>
                                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                                    ${groupData.plants.slice(0, 3).map(p => this.createPlantCardHTML(p)).join('')}
                                </div>
                            </div>
                            `).join('')}
                        </div>
                    `;

                    this.transitionView(this.els.plantListContainer, this.els.plantDetailView);
                    
                    this.els.plantDetailView.scrollTop = 0;
                    if (this.handleDetailScroll) this.els.plantDetailView.removeEventListener('scroll', this.handleDetailScroll);
                    this.handleDetailScroll = this.handleDetailScroll.bind(this);
                    this.els.plantDetailView.addEventListener('scroll', this.handleDetailScroll);
                    
                    this.setupDetailViewEventListeners(id);
                }

                setupDetailViewEventListeners(plantId) {
                    const detailContent = this.els.plantDetailView.querySelector('.max-w-4xl');
                    if (!detailContent) return;
                    
                    detailContent.querySelector('#back-to-list-desktop')?.addEventListener('click', () => window.history.back());
                    detailContent.querySelector('#back-to-list-mobile')?.addEventListener('click', () => window.history.back());
                    
                    const actionsBtn = detailContent.querySelector('#detail-actions-btn');
                    const actionsMenu = detailContent.querySelector('#detail-actions-menu');
                    if (actionsBtn && actionsMenu) {
                        actionsBtn.addEventListener('click', (e) => { e.stopPropagation(); actionsMenu.classList.toggle('hidden'); });
                        actionsMenu.querySelector('[data-action="edit"]').addEventListener('click', () => this.openModal(plantId));
                        actionsMenu.querySelector('[data-action="delete"]').addEventListener('click', () => this.deletePlant(plantId));
                        document.addEventListener('click', () => actionsMenu.classList.add('hidden'), { once: true });
                    }

                    detailContent.addEventListener('click', (e) => {
                        const trigger = e.target.closest('.search-trigger');
                        if (trigger) {
                            e.preventDefault();
                            const term = trigger.dataset.searchTerm;
                            if (this.isMobile()) {
                                const newState = { view: 'search' };
                                history.replaceState(newState, '', `#search`);
                                this.handleStateChange(newState);
                                this.els.searchViewInput.value = term;
                                this.renderSearchResults(term);
                            } else {
                                this.currentFilter.group = 'all';
                                this.currentFilter.search = term.toLowerCase();
                                this.els.searchInput.value = term;
                                history.replaceState({ view: 'list', filter: this.currentFilter }, '', '#list');
                                this.showListView();
                            }
                        }

                        const link = e.target.closest('.nav-link, .plant-card');
                        if (link) {
                            const plantIdToNav = link.dataset.id;
                            if (plantIdToNav && plantIdToNav !== plantId) {
                                e.preventDefault();
                                this.navigateToDetail(plantIdToNav);
                            }
                        }
                    });
                    
                    this.els.plantDetailView.querySelectorAll('.animate-on-scroll').forEach((el, index) => {
                        el.style.transitionDelay = `${index * 100}ms`;
                        this.observer.observe(el);
                    });
                    lucide.createIcons();
                }

                _createSearchTrigger(term, isTag = false) {
                    const baseClasses = 'search-trigger inline-block cursor-pointer transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-[var(--ring)] rounded';
                    const tagClasses = 'bg-[var(--accent)] text-[var(--accent-foreground)] px-3 py-1 text-sm mr-1 mb-1 hover:bg-[var(--primary)] hover:text-[var(--primary-foreground)]';
                    const linkClasses = 'text-[var(--primary)] hover:underline';
                    return `<button class="${baseClasses} ${isTag ? tagClasses : linkClasses}" data-search-term="${term.trim()}">${term.trim()}</button>`;
                }

                _renderClickableItems(text) {
                    if (!text || text.trim() === '') return 'Chưa có thông tin';
                    return text.split(/,(?![^\(]*\))/).map(item => this._createSearchTrigger(item.trim(), true)).join(' ');
                }
                
                showListView() {
                    this.currentView = { type: 'list' };
                    this.els.mobileHeader.classList.remove('hidden');
                    if (this.handleDetailScroll) { this.els.plantDetailView.removeEventListener('scroll', this.handleDetailScroll); }
                    this.els.stickyHeader.classList.add('-translate-y-full');
                    
                    const fromView = this.els.plantDetailView.classList.contains('hidden') ? null : this.els.plantDetailView;

                    this.transitionView(fromView, this.els.plantListContainer, () => {
                        this.renderAll();
                    });

                    this.els.plantDetailView.innerHTML = ''; 
                }
                
                showSearchView(isPopped = false) {
                    this.currentView = { type: 'search' };
                    this.els.mobileHeader.classList.add('hidden');
                    this.els.searchView.classList.remove('translate-x-full');
                    if (!isPopped) {
                        this.els.searchViewInput.focus();
                    }
                }

                hideSearchView(isPopped = false) {
                    this.els.mobileHeader.classList.remove('hidden');
                    this.els.searchView.classList.add('translate-x-full');
                    if (!isPopped) {
                        this.els.searchViewInput.value = '';
                    }
                }

                renderSearchResults(query) {
                    const normalizedQuery = this._normalizeText(query);
                    if (!normalizedQuery) {
                        this.els.searchResultsGrid.innerHTML = `<div class="text-center text-[var(--muted-foreground)] pt-10"><i data-lucide="search" class="w-12 h-12 mx-auto mb-4"></i><p>Tìm kiếm dược liệu theo tên, họ, ...</p></div>`;
                        lucide.createIcons();
                        return;
                    }
                    const results = this.plants.filter(p => Object.values(p).some(val => this._normalizeText(val).includes(normalizedQuery)));
                    
                    if(results.length > 0) {
                        this.els.searchResultsGrid.innerHTML = results.map(plant => {
                            const context = this._findMatchContext(plant, normalizedQuery);
                            return this.createPlantCardHTML(plant, context);
                        }).join('');
                        this.addEventListenersToCards(this.els.searchResultsGrid, true);
                        this.els.searchResultsGrid.querySelectorAll('.animate-on-scroll').forEach(el => this.observer.observe(el));
                    } else {
                        this.els.searchResultsGrid.innerHTML = `<div class="text-center text-[var(--muted-foreground)] pt-10"><i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4"></i><p class="font-semibold">Không tìm thấy kết quả cho "${query}"</p></div>`;
                    }
                    lucide.createIcons();
                }
                
                handleDetailScroll() { const t = this.els.plantDetailView.querySelector('.plant-title-block'); if (!t) return; this.els.stickyHeader.classList.toggle('-translate-y-full', this.els.plantDetailView.scrollTop <= t.offsetHeight); }
                handleSearch(q) { this.currentFilter.search = q.toLowerCase(); this.renderAll(); }
                handleGroupFilter(g) {
                    this.currentFilter.group = g;
                    this.currentListTitle = g === 'all' ? 'Tất cả Dược liệu' : g;
                    this.currentFilter.search = '';
                    this.els.searchInput.value = '';
                    this.clearSelection();
                    history.pushState({ view: 'list', filter: this.currentFilter }, '', '#list');
                    this.showListView();
                    this.els.mobileMenu.classList.add('hidden');
                }
                handleFormSubmit(e) { e.preventDefault(); const id = this.els.plantIdInput.value; const data = { tenDuocLieu: this.els.tenDuocLieu.input.value, hoCay: this.els.hoCay.input.value, nhomChat: this.els.nhomChat.input.value, thanhPhanHoaHocChinh: this.els.thanhPhanHoaHocChinh.input.value, boPhanDung: this.els.boPhanDung.input.value, tacDung: this.els.tacDung.input.value, congDung: this.els.congDung.input.value, lieuDung: this.els.lieuDung.input.value, luuY: this.els.luuY.input.value, dacDiemDuocLieu: this.els.dacDiemDuocLieu.input.value, }; if (id) { this.updatePlant(id, data); } else { this.addPlant(data); } this.closeModal(); }
                getFilteredPlants() { return this.plants.filter(p => { const groupMatch = this.currentFilter.group === 'all' || (p.nhomChat && this._normalizeText(p.nhomChat).split(',').some(c => c.trim().startsWith(this._normalizeText(this.currentFilter.group)))); const searchMatch = !this.currentFilter.search || Object.values(p).some(val => this._normalizeText(val).includes(this._normalizeText(this.currentFilter.search))); return groupMatch && searchMatch; }); }
                
                _findMatchContext(plant, normalizedQuery) {
                    if (!normalizedQuery) return null;
                
                    const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const queryRegex = new RegExp(escapeRegExp(normalizedQuery), 'i');
                
                    if (this._normalizeText(plant.tenDuocLieu).match(queryRegex)) {
                        return { query: normalizedQuery, field: 'tenDuocLieu', context: null };
                    }
                    if (this._normalizeText(plant.hoCay).match(queryRegex)) {
                        return { query: normalizedQuery, field: 'hoCay', context: null };
                    }
                
                    const searchableFields = [
                        { key: 'thanhPhanHoaHocChinh', label: 'TPHH' },
                        { key: 'boPhanDung', label: 'Bộ phận dùng' },
                        { key: 'tacDung', label: 'Tác dụng' },
                        { key: 'congDung', label: 'Công dụng' },
                        { key: 'nhomChat', label: 'Nhóm chất' },
                        { key: 'lieuDung', label: 'Liều dùng' },
                        { key: 'luuY', label: 'Lưu ý' },
                        { key: 'dacDiemDuocLieu', label: 'Đặc điểm' },
                    ];
                
                    for (const { key, label } of searchableFields) {
                        const text = plant[key];
                        const normalizedText = this._normalizeText(text);
                        if (text && normalizedText.match(queryRegex)) {
                            const matchIndex = normalizedText.search(queryRegex);
                            const start = Math.max(0, matchIndex - 20);
                            const end = Math.min(text.length, matchIndex + normalizedQuery.length + 20);
                            let snippet = text.substring(start, end);
                            if (start > 0) snippet = '...' + snippet;
                            if (end < text.length) snippet = snippet + '...';
                            return { query: normalizedQuery, field: label, context: snippet };
                        }
                    }
                    return { query: normalizedQuery, field: null, context: null };
                }

                _highlightText(text, query) {
                    if (!query || !text) return text;
                    const escapeRegExp = (string) => string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    const queryRegex = new RegExp(`(${escapeRegExp(query)})`, 'gi');
                    return text.replace(queryRegex, `<mark class="search-highlight">$1</mark>`);
                }
                
                createPlantCardHTML(plant, searchContext = null) {
                    const isSelected = this.selectedPlants.has(plant.id);
                    let tenDuocLieuHTML = plant.tenDuocLieu;
                    let hoCayHTML = plant.hoCay;
                    let contextHTML = '';

                    if (searchContext && searchContext.query) {
                        tenDuocLieuHTML = this._highlightText(plant.tenDuocLieu, searchContext.query);
                        hoCayHTML = this._highlightText(plant.hoCay, searchContext.query);
                        if (searchContext.context) {
                            const highlightedContext = this._highlightText(searchContext.context, searchContext.query);
                            contextHTML = `<p class="search-context"><strong>${searchContext.field}:</strong> ${highlightedContext}</p>`;
                        }
                    }

                    return `
                        <div class="plant-card animate-on-scroll ${isSelected ? 'selected' : ''}" data-id="${plant.id}">
                            <div class="bg-[var(--card)] p-4 rounded-xl border border-[var(--border)] cursor-pointer h-full flex flex-col">
                                <h3 class="font-bold text-lg text-[var(--card-foreground)]">${tenDuocLieuHTML}</h3>
                                <p class="text-sm text-[var(--muted-foreground)] mb-2">${hoCayHTML}</p>
                                <div class="flex-grow"></div>
                                ${contextHTML}
                                <div class="flex flex-wrap gap-1 mt-2">${(plant.nhomChat || '').split(',').slice(0, 3).map(g => `<span class="text-xs bg-[var(--accent)] text-[var(--accent-foreground)] px-2 py-1 rounded-full">${g.trim().split('>').pop()}</span>`).join('')}</div>
                            </div>
                        </div>`;
                }

                addEventListenersToCards(container, fromSearch = false) { 
                    container.querySelectorAll('.plant-card').forEach(card => { 
                        const id = card.dataset.id; 
                        card.addEventListener('mousemove', (e) => this.handlePointerMove(e)); 
                        card.addEventListener('touchmove', (e) => this.handlePointerMove(e), { passive: true }); 
                        card.addEventListener('mousedown', (e) => this.handlePointerDown(e, id)); 
                        card.addEventListener('touchstart', (e) => this.handlePointerDown(e, id), { passive: true }); 
                        card.addEventListener('mouseup', (e) => this.handlePointerUp(e, id, fromSearch)); 
                        card.addEventListener('touchend', (e) => this.handlePointerUp(e, id, fromSearch)); 
                        card.addEventListener('mouseleave', () => this.handlePointerLeave()); 
                        card.addEventListener('touchcancel', () => this.handlePointerLeave()); 
                        card.addEventListener('contextmenu', (e) => { this.handlePointerLeave(); this.showContextMenu(e, id) }); 
                    }); 
                }
                handlePointerDown(e, id) { if (e.type === 'mousedown' && e.button === 2) return; this.isDragging = false; this.isLongPressing = false; this.pointerStartPos.y = e.type === 'touchstart' ? e.touches[0].clientY : e.clientY; this.pressTimer = setTimeout(() => { this.isLongPressing = true; this.togglePlantSelection(id); }, 500); }
                handlePointerUp(e, id, fromSearch = false) {
                    if (e.type === 'touchend') {
        e.preventDefault();
    }
                    clearTimeout(this.pressTimer);
                    if (this.isDragging) {
                        this.isDragging = false;
                        return;
                    }
                    
                    if (fromSearch) {
                        const newState = { view: 'detail', id: id };
                        history.replaceState(newState, '', `#detail/${id}`); 
                        this.handleStateChange(newState);
                    } else {
                        if (this.isLongPressing) {
                            if (e.cancelable) e.preventDefault();
                        } else {
                            if (this.selectedPlants.size > 0) {
                                this.togglePlantSelection(id);
                            } else {
                                this.navigateToDetail(id);
                            }
                        }
                    }
                    this.isLongPressing = false;
                }
                handlePointerMove(e) { if (this.pressTimer) { const curY = e.type === 'touchmove' ? e.touches[0].clientY : e.clientY; if (Math.abs(curY - this.pointerStartPos.y) > 10) { this.isDragging = true; clearTimeout(this.pressTimer); } } }
                handlePointerLeave() { clearTimeout(this.pressTimer); this.isLongPressing = false; }
                togglePlantSelection(id) { const card = document.querySelector(`.plant-card[data-id="${id}"]`); if (this.selectedPlants.has(id)) { this.selectedPlants.delete(id); card && card.classList.remove('selected'); } else { this.selectedPlants.add(id); card && card.classList.add('selected'); } this.updateSelectionToolbar(); }
                updateUIState() { const hasPlants = this.plants.length > 0; this.els.welcomeScreen.classList.toggle('hidden', hasPlants); const isListView = !this.els.plantListContainer.classList.contains('hidden'); this.els.plantListGrid.classList.toggle('hidden', !hasPlants || !isListView); }
                openModal(id = null) { this.els.plantForm.reset(); if (id) { const p = this.plants.find(p => p.id === id); if(p) { this.els.modalTitle.textContent = "Chỉnh sửa Dược liệu"; this.els.tenDuocLieu.input.value = p.tenDuocLieu || ''; this.els.hoCay.input.value = p.hoCay || ''; this.els.nhomChat.input.value = p.nhomChat || ''; this.els.thanhPhanHoaHocChinh.input.value = p.thanhPhanHoaHocChinh || ''; this.els.boPhanDung.input.value = p.boPhanDung || ''; this.els.tacDung.input.value = p.tacDung || ''; this.els.congDung.input.value = p.congDung || ''; this.els.lieuDung.input.value = p.lieuDung || ''; this.els.luuY.input.value = p.luuY || ''; this.els.dacDiemDuocLieu.input.value = p.dacDiemDuocLieu || ''; this.els.plantIdInput.value = p.id; } } else { this.els.modalTitle.textContent = "Thêm Dược liệu mới"; this.els.plantIdInput.value = ''; } this.els.plantModal.showModal(); }
                closeModal() { this.hideAutocomplete(); this.els.plantModal.close(); }
                highlightActiveGroup() { document.querySelectorAll('.group-link').forEach(link => { const groupName = link.dataset.group === 'Tất cả' ? 'all' : link.dataset.group; const isActive = groupName === this.currentFilter.group; link.classList.toggle('bg-[var(--primary)]', isActive); link.classList.toggle('text-[var(--primary-foreground)]', isActive); }); }
                clearSelection() { this.selectedPlants.clear(); document.querySelectorAll('.plant-card.selected').forEach(c => c.classList.remove('selected')); this.updateSelectionToolbar(); }
                updateSelectionToolbar() { const c = this.selectedPlants.size; this.els.selectionCount.textContent = `${c} mục đã chọn`; this.els.selectionToolbar.classList.toggle('hidden', c === 0); }
                showContextMenu(e, id) { e.preventDefault(); this.hideContextMenu(); const isSel = this.selectedPlants.has(id); this.els.contextMenu.innerHTML = `<button class="w-full text-left flex items-center gap-2 px-2 py-1.5 rounded hover:bg-[var(--accent)]" data-action="select" data-id="${id}"><i data-lucide="${isSel ? 'check-square' : 'square'}" class="w-4 h-4"></i><span>${isSel ? 'Bỏ chọn' : 'Chọn'}</span></button><button class="w-full text-left flex items-center gap-2 px-2 py-1.5 rounded hover:bg-[var(--accent)]" data-action="edit" data-id="${id}"><i data-lucide="edit-3" class="w-4 h-4"></i><span>Chỉnh sửa</span></button><button class="w-full text-left flex items-center gap-2 px-2 py-1.5 rounded text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20" data-action="delete" data-id="${id}"><i data-lucide="trash-2" class="w-4 h-4"></i><span>Xóa</span></button>`; lucide.createIcons(); this.els.contextMenu.style.top = `${e.pageY}px`; this.els.contextMenu.style.left = `${e.pageX}px`; this.els.contextMenu.classList.remove('hidden'); this.els.contextMenu.querySelectorAll('button').forEach(btn => btn.addEventListener('click', (e) => { const { action, id } = e.currentTarget.dataset; if (action === 'select') this.togglePlantSelection(id); if (action === 'edit') this.openModal(id); if (action === 'delete') this.deletePlant(id); this.hideContextMenu(); })); }
                hideContextMenu() { this.els.contextMenu.classList.add('hidden'); }
                initTheme() { const t = localStorage.getItem('theme') || 'light'; this.setTheme(t); }
                setTheme(t) { localStorage.setItem('theme', t); document.documentElement.classList.toggle('dark', t === 'dark'); document.querySelectorAll('.light-icon').forEach(i => i.classList.toggle('hidden', t === 'dark')); document.querySelectorAll('.dark-icon').forEach(i => i.classList.toggle('hidden', t !== 'dark')); }
                toggleTheme() { this.setTheme(localStorage.getItem('theme') === 'dark' ? 'light' : 'dark'); }
                updateSidebarToggleButton(isCollapsed) { const tip = this.els.sidebarToggle.querySelector('.tooltip-text'); if (tip) { tip.textContent = isCollapsed ? 'Mở rộng' : 'Thu gọn'; } this.els.sidebarTopActions.classList.toggle('hidden', isCollapsed); this.els.sidebarTopActionsCollapsed.classList.toggle('hidden', !isCollapsed); this.els.sidebarBottomActions.classList.toggle('hidden', isCollapsed); this.els.sidebarBottomActionsCollapsed.classList.toggle('hidden', !isCollapsed); lucide.createIcons(); }
                initSidebarState() { const c = localStorage.getItem('sidebarState') === 'collapsed'; if (c) { this.els.sidebar.classList.add('collapsed'); } this.updateSidebarToggleButton(c); }
                toggleSidebar() { const c = this.els.sidebar.classList.toggle('collapsed'); localStorage.setItem('sidebarState', c ? 'collapsed' : 'expanded'); this.updateSidebarToggleButton(c); }
                getDynamicSuggestions(field) { const s = new Set(); this.plants.forEach(p => { if (p[field]) { p[field].split(/,|>/).forEach(i => { const t = i.trim(); if (t) s.add(t); }); } }); return Array.from(s).sort(); }
                renderAutocompleteList(key, data, filter, options) { const { list } = this.els[key]; const normFilter = this._normalizeText(filter); let filtered; if (!normFilter) { this.hideAutocomplete(); return; } if (options.type === 'family') { filtered = data.filter(i => this._normalizeText(i.s).includes(normFilter) || this._normalizeText(i.v).includes(normFilter)); } else { filtered = data.filter(i => this._normalizeText(i).includes(normFilter)); } if (filtered.length > 0) { if (options.type === 'family') { list.innerHTML = filtered.map(i => `<div class="autocomplete-item px-3 py-2 cursor-pointer hover:bg-[var(--accent)]" data-value="${i.s} (${i.v})"><span class="font-medium">${i.s}</span><span class="text-[var(--muted-foreground)]">- ${i.v}</span></div>`).join(''); } else { list.innerHTML = filtered.map(i => `<div class="autocomplete-item px-3 py-2 cursor-pointer hover:bg-[var(--accent)]" data-value="${i}">${i}</div>`).join(''); } list.classList.remove('hidden'); this.activeAutocomplete = key; } else { this.hideAutocomplete(); } }
                selectAutocompleteItem(key, value, options) { const { input } = this.els[key]; if (options.append) { const sep = options.separator ? ` ${options.separator} ` : ', '; const parts = input.value.split(/,|>|\s+/).filter(Boolean); parts.pop(); parts.push(value); input.value = parts.join(sep) + (options.separator ? '' : ', '); } else { input.value = value; } this.hideAutocomplete(); input.focus(); }
                setupAutocomplete(key, dataProvider, options = {}) { const { input, list } = this.els[key]; if (!input || !list) return; const render = () => { const suggestions = typeof dataProvider === 'function' ? dataProvider() : dataProvider; const filter = input.value.split(/,|>|\s+/).pop().trim(); this.renderAutocompleteList(key, suggestions, filter, options); }; input.addEventListener('focus', render); input.addEventListener('input', render); list.addEventListener('mousedown', (e) => { const item = e.target.closest('.autocomplete-item'); if (item) { this.selectAutocompleteItem(key, item.dataset.value, options); } }); }
                hideAutocomplete() { if (this.activeAutocomplete) { this.els[this.activeAutocomplete].list.classList.add('hidden'); this.activeAutocomplete = null; } }
                showToast(message, type = 'success') { const t = document.createElement('div'); t.className = `toast ${type}`; t.innerHTML = `<i data-lucide="${type === 'success' ? 'check-circle' : 'alert-circle'}" class="w-6 h-6 mr-3"></i><span>${message}</span>`; this.els.toastContainer.appendChild(t); lucide.createIcons(); setTimeout(() => { t.remove(); }, 4000); }
                showConfirm(message, onConfirm, onCancel = () => {}) {
                    this.els.confirmMessage.textContent = message;
                    this.els.confirmModal.showModal();
                    
                    const newProceedBtn = this.els.confirmProceed.cloneNode(true);
                    this.els.confirmProceed.parentNode.replaceChild(newProceedBtn, this.els.confirmProceed);
                    this.els.confirmProceed = newProceedBtn;

                    const newCancelBtn = this.els.confirmCancel.cloneNode(true);
                    this.els.confirmCancel.parentNode.replaceChild(newCancelBtn, this.els.confirmCancel);
                    this.els.confirmCancel = newCancelBtn;

                    const proceedHandler = () => { onConfirm(); this.els.confirmModal.close(); };
                    const cancelHandler = () => { onCancel(); this.els.confirmModal.close(); };
                    
                    this.els.confirmProceed.addEventListener('click', proceedHandler, { once: true });
                    this.els.confirmCancel.addEventListener('click', cancelHandler, { once: true });
                }
                importData() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const file = e.target.files[0]; if (!file) return; const reader = new FileReader(); reader.readAsText(file, 'UTF-8'); reader.onload = re => { try { const data = JSON.parse(re.target.result); if (!Array.isArray(data)) throw new Error('Invalid format'); this.showImportOptions(data); } catch (err) { this.showToast('Tệp không hợp lệ hoặc bị lỗi.', 'error'); } } }; input.click(); this.els.mobileMenu.classList.add('hidden'); }
                showImportOptions(data) { this.els.importInfo.textContent = `Tệp chứa ${data.length} dược liệu. Vui lòng chọn cách nhập.`; this.els.importOptionsModal.showModal(); this.els.importOverwriteBtn.onclick = () => { this.plants = data; this.clearSelection(); this.savePlants(); this.renderAll(); this.showListView(); this.showToast(`Đã ghi đè và nhập ${data.length} dược liệu.`, 'success'); this.els.importOptionsModal.close(); }; this.els.importMergeBtn.onclick = () => { const existing = new Set(this.plants.map(p => p.tenDuocLieu.toLowerCase().trim())); let added = 0; let newId = Date.now(); data.forEach(p => { if (!p.tenDuocLieu || !existing.has(p.tenDuocLieu.toLowerCase().trim())) { this.plants.push({ ...p, id: (newId++).toString() }); added++; } }); if (added > 0) { this.savePlants(); this.renderAll(); this.showListView(); this.showToast(`Đã hợp nhất và thêm mới ${added} dược liệu.`, 'success'); } else { this.showToast('Không có dược liệu mới nào để thêm.', 'success'); } this.els.importOptionsModal.close(); }; this.els.importCancelBtn.onclick = () => this.els.importOptionsModal.close(); }
                exportData() { if (this.plants.length === 0) { this.showToast('Không có dữ liệu để xuất.', 'error'); return; } const dataStr = JSON.stringify(this.plants, null, 2); const blob = new Blob([dataStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `duoclieu_data_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url); this.els.mobileMenu.classList.add('hidden'); this.showToast('Xuất dữ liệu thành công!', 'success'); }
            }
            const app = new MedicinalPlantApp();
            lucide.createIcons();
        });
    </script>
</body>
</html>

