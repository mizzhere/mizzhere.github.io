<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>Tr√¨nh xem Phim Chuy√™n nghi·ªáp</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
       <style>
    :root {
        --primary-bg: #141414;
        --secondary-bg: #1e1e1e;
        --text-color: #e5e5e5;
        --accent-color: #e50914;
        --text-light: #fff;
    }
    body {
        font-family: "Inter", sans-serif;
        margin: 0;
        background-color: var(--primary-bg);
        color: var(--text-color);
        overflow-x: hidden; /* Ch·∫∑n cu·ªôn ngang to√†n trang */
    }
    main {
        padding: clamp(20px, 4vw, 60px);
        box-sizing: border-box;
    }
    .hidden {
        display: none !important;
    }

    /* --- HEADER & SEARCH --- */
    #page-header {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: space-between;
        gap: 20px;
        margin-bottom: 40px;
    }
    #main-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent-color);
        text-transform: uppercase;
        letter-spacing: 2px;
        margin: 0;
    }
    #actions-container {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    #search-container {
        display: flex;
        align-items: center;
        gap: 10px;
        background-color: var(--secondary-bg);
        border: 1px solid #333;
        border-radius: 4px;
        padding: 5px 15px;
    }
    #search-icon {
        width: 20px;
        height: 20px;
        fill: #888;
    }
    #search-input {
        background: none;
        border: none;
        outline: none;
        color: var(--text-color);
        font-size: 1rem;
        padding: 10px 0;
        width: 250px;
    }
    #add-video-btn {
        background-color: var(--secondary-bg);
        border: 1px solid #333;
        border-radius: 4px;
        width: 44px;
        height: 44px;
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        fill: #ccc;
        transition: background-color 0.2s;
    }
    #add-video-btn:hover {
        background-color: #333;
    }

    /* --- FILTER TAGS --- */
    #filter-tags {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 15px;
        margin-bottom: 20px;
        border-bottom: 1px solid #222;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    #filter-tags::-webkit-scrollbar {
        display: none;
    }
    .filter-tag {
        background-color: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #ccc;
        padding: 8px 20px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 0.9rem;
        font-weight: 500;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }
    .filter-tag:hover {
        background-color: rgba(255, 255, 255, 0.2);
        border-color: #fff;
        color: #fff;
    }
    .filter-tag.active {
        background-color: var(--text-light);
        color: #000;
        border-color: var(--text-light);
        font-weight: 700;
        transform: scale(1.05);
    }

    /* --- LIBRARY LAYOUT (NETFLIX STYLE) --- */
    #library-container {
        display: flex;
        flex-direction: column;
        gap: 50px;
    }
    .program-row {
        text-align: left;
        margin-bottom: 40px;
        padding-left: clamp(20px, 4vw, 60px);
        position: relative;
    }
    .program-title {
        font-size: 1.8rem;
        font-weight: 600;
        margin: 0 0 20px 0;
    }
    .video-list {
        display: flex;
        gap: 15px;
        overflow-x: auto;
        padding: 40px clamp(20px, 4vw, 60px);
        margin-top: -30px;
        scroll-behavior: smooth;
        scrollbar-width: none;
        -ms-overflow-style: none;
    }
    .video-list::-webkit-scrollbar {
        display: none;
    }

    /* --- VIDEO CARD --- */
    .video-card {
        min-width: 280px;
        flex-shrink: 0;
        background-color: var(--secondary-bg);
        border-radius: 6px;
        position: relative;
        cursor: pointer;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27), z-index 0s 0.3s;
    }
    .card-image-wrapper {
        position: relative;
        width: 100%;
        aspect-ratio: 16 / 9;
        border-radius: 6px;
        overflow: hidden;
        z-index: 1;
    }
    .video-thumbnail {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }
    .episode-badge {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: rgba(0, 0, 0, 0.7);
        color: #fff;
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        backdrop-filter: blur(4px);
        z-index: 5;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    /* Info Panel (Hover) */
    .card-info {
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: var(--secondary-bg);
        padding: 12px;
        box-sizing: border-box;
        border-radius: 0 0 6px 6px;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        z-index: 2;
        pointer-events: none;
    }
    .card-title {
        font-size: 0.95rem;
        font-weight: 700;
        margin: 0 0 5px 0;
        color: #fff;
        display: -webkit-box;
        -webkit-line-clamp: 2; /* Fix c√∫ ph√°p c≈© */
        line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .card-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 0.75rem;
        color: #aaa;
    }
    .card-genre {
        color: var(--accent-color);
        font-weight: 600;
    }

    /* Hi·ªáu ·ª©ng Hover Card tr√™n m√°y t√≠nh */
    @media (hover: hover) {
        .video-card:hover {
            transform: scale(1.15);
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27), z-index 0s;
            box-shadow: 0 0 0 2px rgba(255,255,255,0.1);
        }
        .video-card:hover .card-info {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            pointer-events: auto;
        }
        .video-card:hover .card-image-wrapper {
            border-radius: 6px 6px 0 0;
        }
    }

    .skeleton-card {
        background-color: #2a2a2a;
        animation: pulse 1.5s infinite ease-in-out;
    }
    @keyframes pulse {
        0% { background-color: #2a2a2a; }
        50% { background-color: #3a3a3a; }
        100% { background-color: #2a2a2a; }
    }

    /* --- MODALS (General) --- */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        box-sizing: border-box;
        z-index: 2000;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
    }
    .modal-overlay.visible {
        opacity: 1;
        pointer-events: auto;
    }
    .modal-content {
        background-color: var(--primary-bg);
        border-radius: 8px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        transform: scale(0.95);
        transition: transform 0.3s ease;
        position: relative;
        display: flex;
        flex-direction: column;
        max-height: 90vh;
    }
    .modal-overlay.visible .modal-content {
        transform: scale(1);
    }
    .modal-close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(20, 20, 20, 0.7);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        fill: white;
        z-index: 10;
    }

    /* --- DETAIL MODAL --- */
    #detail-modal-content { width: 100%; max-width: 800px; }
    #modal-header { position: relative; aspect-ratio: 16 / 9; flex-shrink: 0; }
    #modal-thumbnail { width: 100%; height: 100%; object-fit: cover; border-radius: 8px 8px 0 0; }
    #modal-header::after {
        content: ""; position: absolute; bottom: 0; left: 0; right: 0; height: 50%;
        background: linear-gradient(to top, var(--primary-bg) 20%, transparent 100%);
        pointer-events: none;
    }
    #modal-play-btn {
        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.9); color: #000; border: none; border-radius: 5px;
        padding: 10px 25px; font-size: 1.2rem; font-weight: 600; cursor: pointer;
        display: flex; align-items: center; gap: 10px; z-index: 5;
    }
    #modal-play-btn svg { width: 24px; height: 24px; }
    #modal-body { padding: 20px 30px 30px 30px; overflow-y: auto; }
    #modal-title { font-size: clamp(1.5rem, 4vw, 2.2rem); font-weight: 700; margin: 0 0 15px 0; }
    #modal-original-title { margin: -10px 0 15px 0; font-size: 1rem; font-weight: 400; color: #888; font-style: italic; }
    #modal-meta { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; color: #aaa; }
    
    #modal-participants-list, #modal-genres-list { display: flex; flex-wrap: wrap; gap: 8px; list-style: none; padding: 0; margin-bottom: 10px; }
    .participant-tag { background-color: var(--secondary-bg); padding: 5px 12px; border-radius: 4px; font-size: 0.9rem; }
    .genre-tag { background-color: #333; padding: 4px 10px; border-radius: 4px; font-size: 0.85rem; color: #ccc; }
    #modal-description { color: #bbb; line-height: 1.6; margin-bottom: 25px; font-size: 0.95rem; }

    /* Modal Episode List */
    #modal-episodes-section { margin-top: 20px; border-top: 1px solid #333; padding-top: 20px; }
    #modal-episodes-section h4 { font-size: 1.1rem; color: #fff; margin-bottom: 15px; }
    .modal-episode-item { display: flex; gap: 15px; padding: 10px; border-radius: 6px; cursor: pointer; transition: background 0.2s; align-items: center; border-bottom: 1px solid #2a2a2a; }
    .modal-episode-item:hover { background-color: #333; }
    .modal-ep-thumb { width: 120px; aspect-ratio: 16/9; object-fit: cover; border-radius: 4px; }
    .modal-ep-info { flex: 1; }
    .modal-ep-title { font-size: 0.95rem; font-weight: 600; color: #eee; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .modal-ep-number { font-size: 0.85rem; color: var(--accent-color); font-weight: 500; }

    /* --- ADD VIDEO MODAL --- */
    #add-video-modal-content { width: 90%; max-width: 500px; padding: 30px; }
    #youtube-url-input { width: 100%; box-sizing: border-box; background-color: var(--secondary-bg); color: var(--text-color); border: 1px solid #444; border-radius: 4px; padding: 15px; font-size: 1.1rem; margin-bottom: 15px; }
    #srt-file-label { display: block; width: 100%; box-sizing: border-box; background-color: var(--secondary-bg); border: 1px dashed #555; border-radius: 4px; padding: 15px; font-size: 1rem; margin-bottom: 20px; text-align: center; cursor: pointer; }
    #srt-file-input { display: none; }
    #srt-file-name { color: #aaa; font-style: italic; display: block; margin-top: 5px; }
    #load-video-btn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 600; background-color: var(--accent-color); color: var(--text-light); border: none; border-radius: 4px; cursor: pointer; }

    /* ================================================= */
    /* START: PLAYER V5 CSS (ƒê√É T·ªêI ∆ØU H√ìA)              */
    /* ================================================= */

    #player-container {
        position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
        background-color: #000; display: flex; justify-content: center; align-items: center;
        z-index: 3000; color: white; cursor: default;
    }
    #player-container.no-cursor { cursor: none; }
    #youtube-player { position: absolute; width: 100%; height: 100%; border: none; }

    /* --- Layers Structure --- */
    /* Layer 1: Youtube Iframe
       Layer 2: Interaction Overlay (z-index 10) - B·∫Øt click Play/Pause/Seek
       Layer 3: Controls & Header (z-index 12) - Hi·ªÉn th·ªã n√∫t b·∫•m
       Layer 4: Buttons (z-index 20) - N√∫t b·∫•m ph·∫£i n·ªïi l√™n tr√™n c√πng ƒë·ªÉ click ƒë∆∞·ª£c
    */

    /* Base Styles cho Controls */
    #video-header-overlay,
    #custom-controls,
    #center-play-pause-btn {
        opacity: 0;
        transition: opacity 0.25s ease-out;
        position: absolute; left: 0; width: 100%; box-sizing: border-box;
        pointer-events: none !important; /* M·∫∑c ƒë·ªãnh click xuy√™n qua */
    }
    
    /* V√πng t∆∞∆°ng t√°c v√¥ h√¨nh */
    #interaction-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        z-index: 10; display: flex;
    }
    #seek-backward-zone, #play-pause-zone, #seek-forward-zone { flex: 1; }

    /* --- Active State (Khi hi·ªán Controls) --- */
    #player-container.controls-active > #video-header-overlay,
    #player-container.controls-active > #custom-controls,
    #player-container.controls-active > #center-play-pause-btn {
        opacity: 1;
    }
    
    /* Quan tr·ªçng: Ch·ªâ b·∫≠t pointer-events cho N√öT B·∫§M */
    #player-container.controls-active > #center-play-pause-btn { pointer-events: auto; }
    
    #video-header-overlay button, 
    #custom-controls button,
    #custom-controls input[type="range"] {
        pointer-events: auto;
        position: relative;
        z-index: 20;
        cursor: pointer;
    }

    /* C√°c th√†nh ph·∫ßn Text kh√¥ng ƒë∆∞·ª£c ch·∫∑n click */
    #video-title-display, #time-display, #video-program-display, .spacer {
        pointer-events: none;
    }

    /* --- Header Overlay --- */
    #video-header-overlay {
        top: 0;
        padding: clamp(15px, 3vw, 30px) clamp(20px, 5vw, 60px);
        background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
        z-index: 12;
        display: flex; align-items: center; gap: 20px;
    }
    #back-btn { background: none; border: none; fill: white; width: 44px; height: 44px; padding: 0; flex-shrink: 0; }

    /* --- Custom Controls Bottom --- */
    #custom-controls {
        bottom: 0;
        padding: 10px clamp(20px, 5vw, 60px);
        background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
        z-index: 12;
    }
    .progress-container { position: relative; width: 100%; margin-bottom: 8px; }
    #progress-bar {
        appearance: none; width: 100%; height: 4px; border-radius: 5px; transition: height 0.2s;
        background: linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) var(--progress-percent, 0%), rgba(255, 255, 255, 0.3) var(--progress-percent, 0%), rgba(255, 255, 255, 0.3) 100%);
    }
    #progress-bar:hover { height: 8px; }
    
    .timeline-marker {
        position: absolute; top: 0; width: 2px; height: 100%; background-color: rgba(255, 255, 255, 0.5); z-index: 2; pointer-events: none;
    }
    .timeline-marker:hover::after {
        content: attr(data-label); position: absolute; bottom: 15px; left: 50%; transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8); color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; white-space: nowrap;
    }

    .controls-row { display: flex; align-items: center; gap: 20px; }
    .controls-row button { background: transparent; border: none; padding: 5px; }
    .controls-row button svg { fill: white; width: 28px; height: 28px; display: block; }
    #time-display { font-size: 1rem; white-space: nowrap; }
    #video-program-display { margin: 0 15px; font-size: 0.9rem; color: #ccc; opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; }
    .video-title-inline { font-size: 1rem; color: #eee; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 40vw; }
    .spacer { flex-grow: 1; }

    /* Center Button */
    #center-play-pause-btn {
        top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: 70px; height: 70px; background: rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.5); border-radius: 50%;
        display: flex; justify-content: center; align-items: center; padding: 0; z-index: 15;
    }
    #center-play-pause-btn svg { fill: white; width: 40px; height: 40px; }

    /* --- Subtitles & Settings --- */
    #subtitle-display {
        position: absolute; bottom: 12%; left: 50%; transform: translateX(-50%); z-index: 20;
        max-width: 90%; padding: 8px 20px; text-align: center; border-radius: 6px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9); line-height: 1.5; font-weight: 500;
        background-color: rgba(0, 0, 0, 0.5); pointer-events: none; opacity: 0;
    }
    #subtitle-display:not(:empty) { opacity: 1; }

    #settings-menu {
        position: absolute; bottom: 80px; right: clamp(20px, 5vw, 60px); z-index: 30;
        background-color: rgba(20, 20, 20, 0.9); backdrop-filter: blur(5px);
        padding: 15px; border-radius: 8px; width: 280px; box-sizing: border-box;
        display: none; flex-direction: column; gap: 15px; opacity: 0; transform: translateY(10px); transition: opacity 0.2s, transform 0.2s;
    }
    #settings-menu.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .control-group label { display: block; margin-bottom: 8px; font-size: 0.9rem; color: #ccc; }
    .control-group input[type="range"] { width: 100%; }
    .control-group input[type="color"] { width: 100%; height: 35px; border: none; padding: 0; background: none; cursor: pointer; }

    /* --- Sidebar & Up Next --- */
    #episodes-sidebar {
        position: absolute; top: 0; right: 0; width: 350px; max-width: 80vw; height: 100%;
        background-color: rgba(20, 20, 20, 0.95); backdrop-filter: blur(10px);
        z-index: 25; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex; flex-direction: column; border-left: 1px solid #333;
    }
    #episodes-sidebar.visible { transform: translateX(0); pointer-events: auto; }
    #episodes-header { padding: 20px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
    #episodes-header h3 { margin: 0; font-size: 1.2rem; color: #fff; }
    #close-episodes-btn { background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer; padding: 0 10px; }
    #episodes-content { flex: 1; overflow-y: auto; padding: 10px; }
    
    .episode-item { display: flex; gap: 10px; padding: 10px; border-radius: 4px; cursor: pointer; transition: background 0.2s; margin-bottom: 5px; align-items: center; }
    .episode-item:hover { background-color: #333; }
    .episode-item.playing { background-color: #e50914; color: white; }
    .episode-thumbnail { width: 120px; aspect-ratio: 16/9; object-fit: cover; border-radius: 3px; background: #000; }
    .episode-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
    .episode-title { font-size: 0.95rem; font-weight: 500; margin-bottom: 4px; display: -webkit-box; -webkit-line-clamp: 2; line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .episode-number { font-size: 0.8rem; color: #aaa; }
    .episode-item.playing .episode-number { color: #eee; }

    #up-next-overlay {
        position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 40;
        background-color: rgba(0, 0, 0, 0.85); display: none;
        flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    #up-next-overlay p { font-size: 1.2rem; color: #aaa; margin: 0; }
    #up-next-card { cursor: pointer; margin-top: 20px; }
    #up-next-thumbnail { width: 250px; aspect-ratio: 16/9; object-fit: cover; border-radius: 5px; }
    #up-next-title { margin: 10px 0 0 0; font-size: 1.4rem; }
    #up-next-cancel-btn { background: none; border: 1px solid #888; color: #ccc; padding: 8px 16px; border-radius: 4px; margin-top: 30px; cursor: pointer; }

    /* --- SKIP BUTTON --- */
    #skip-btn {
        position: absolute; bottom: 150px; right: 0;
        background-color: #fff; color: #000; border: none; padding: 10px 20px;
        font-size: 1rem; font-weight: 700; border-radius: 4px; cursor: pointer;
        display: flex; align-items: center; gap: 10px; z-index: 50;
        opacity: 0; transform: translateX(100%); transition: all 0.3s ease;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    }
    #skip-btn.visible { opacity: 1; transform: translateX(-20px); pointer-events: auto; }
    #skip-btn:hover { background-color: #e6e6e6; }
</style>
    </head>
    <body>
        <main>
            <header id="page-header">
                <h1 id="main-title">Kh√°m Ph√°</h1>
                <div id="actions-container">
                    <div id="search-container">
                        <svg id="search-icon" viewBox="0 0 24 24">
                            <path
                                d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"
                            />
                        </svg>
                        <input type="text" id="search-input" placeholder="T√¨m theo ti√™u ƒë·ªÅ, ng∆∞·ªùi tham gia..." />
                    </div>
                    <button id="add-video-btn" title="Xem video t·ª´ link">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                        </svg>
                    </button>
                </div>
            </header>
            <div id="filter-tags"><span class="filter-tag active" data-filter="T·∫•t c·∫£">T·∫•t c·∫£</span></div>
            <div id="library-container">
                <section class="program-row">
                    <div class="video-list">
                        <div class="video-card skeleton-card"></div>
                        <div class="video-card skeleton-card"></div>
                        <div class="video-card skeleton-card"></div>
                    </div>
                </section>
            </div>
        </main>

        <div id="detail-modal-overlay" class="modal-overlay hidden">
            <div id="detail-modal-content" class="modal-content">
                <button id="detail-modal-close-btn" class="modal-close-btn" title="ƒê√≥ng">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                        ></path>
                    </svg>
                </button>
                <header id="modal-header">
                    <img id="modal-thumbnail" src="" alt="Video thumbnail" />
                    <button id="modal-play-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg
                        >Ph√°t
                    </button>
                </header>
                <div id="modal-body">
                    <h3 id="modal-title"></h3>
                    <h4 id="modal-original-title"></h4>
                    <div id="modal-meta">
                        <span id="modal-program"></span>
                        <span id="modal-author"></span>
                    </div>
                    <!-- Ch·ªó ch·ª©a m·ªõi cho th·ªÉ lo·∫°i -->
                    <div id="modal-genres-container" class="hidden">
                        <ul id="modal-genres-list"></ul>
                    </div>
                    <!-- Ch·ªó ch·ª©a m·ªõi cho m√¥ t·∫£ -->
                    <p id="modal-description"></p>
                    <div id="modal-episodes-section" class="hidden">
    <h4>Danh s√°ch t·∫≠p</h4>
    <div id="modal-episodes-list"></div>
</div>
                    <div id="modal-participants-container" class="hidden">
                        <h4 id="modal-participants-title">V·ªõi s·ª± tham gia c·ªßa:</h4>
                        <ul id="modal-participants-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="add-video-modal-overlay" class="modal-overlay hidden">
            <div id="add-video-modal-content" class="modal-content">
                <button id="add-video-close-btn" class="modal-close-btn" title="ƒê√≥ng">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                        ></path>
                    </svg>
                </button>
                <form id="add-video-form">
                    <h3>Xem video t·ª´ link</h3>
                    <input type="text" id="youtube-url-input" placeholder="D√°n link YouTube v√†o ƒë√¢y..." required />
                    <label for="srt-file-input" id="srt-file-label"
                        >Ch·ªçn file ph·ª• ƒë·ªÅ (.srt)<span id="srt-file-name"></span
                    ></label>
                    <input type="file" id="srt-file-input" accept=".srt" />
                    <button type="submit" id="load-video-btn">T·∫£i v√† Ph√°t</button>
                </form>
            </div>
        </div>

        <div id="player-wrapper" class="hidden">
            <!-- START: C·∫•u tr√∫c Player HO√ÄN CH·ªàNH v5 -->
            <div id="player-container">
                <div id="youtube-player"></div>

                <!-- Header -->
                <div id="video-header-overlay">
                    <button id="back-btn" title="Quay l·∫°i">
                        <svg viewBox="0 0 24 24">
                            <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path>
                        </svg>
                    </button>
                </div>

                <!-- V√πng t∆∞∆°ng t√°c ch√≠nh (n·∫±m ·ªü gi·ªØa) -->
                <div id="interaction-overlay">
                    <div id="seek-backward-zone"></div>
                    <div id="play-pause-zone"></div>
                    <div id="seek-forward-zone"></div>
                </div>

                <!-- N√∫t Play/Pause l·ªõn (n·∫±m ri√™ng bi·ªát, ·ªü gi·ªØa) -->
                <button id="center-play-pause-btn">
                    <svg id="center-play-pause-icon" viewBox="0 0 24 24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path>
                    </svg>
                </button>

                <!-- Ph·ª• ƒë·ªÅ -->
                <div id="subtitle-display"></div>

                <!-- Thanh ƒëi·ªÅu khi·ªÉn d∆∞·ªõi -->
                <div id="custom-controls">
                    <div class="progress-container">
                        <input type="range" id="progress-bar" value="0" min="0" />
                    </div>
                    <div class="controls-row">
                        <button id="play-pause-btn">
                            <svg><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>
                        </button>

                        <div id="time-display">00:00 / 00:00</div>
                        <p id="video-program-display"></p>
                        <p id="video-title-display" class="video-title-inline"></p>

                        <div class="spacer"></div>

                        <button id="episodes-btn" title="Danh s√°ch t·∫≠p" class="hidden">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                                <path d="M4,10H20V12H4V10M4,6H20V8H4V6M4,14H14V16H4V14M16,13V21L22,17L16,13Z" />
                            </svg>
                        </button>

                        <button id="settings-btn" title="C√†i ƒë·∫∑t Ph·ª• ƒë·ªÅ">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                                <path
                                    d="M19.14,12.94C19.07,12.44 19,11.94 19,11.44C19,10.94 19.07,10.44 19.14,9.94L21.12,8.44C21.26,8.33 21.3,8.14 21.24,7.96L19.28,4.5C19.21,4.34 19.02,4.27 18.86,4.34L16.5,5.39C16,4.94 15.43,4.56 14.81,4.29L14.47,2.05C14.45,1.86 14.28,1.71 14.08,1.71H9.92C9.72,1.71 9.55,1.86 9.53,2.05L9.19,4.29C8.57,4.56 8,4.94 7.5,5.39L5.14,4.34C4.98,4.27 4.79,4.34 4.72,4.5L2.76,7.96C2.7,8.14 2.74,8.33 2.88,8.44L4.86,9.94C4.93,10.44 5,10.94 5,11.44C5,11.94 4.93,12.44 4.86,12.94L2.88,14.44C2.74,14.56 2.7,14.75 2.76,14.93L4.72,18.39C4.79,18.55 4.98,18.62 5.14,18.54L7.5,17.5C8,17.94 8.57,18.32 9.19,18.59L9.53,20.84C9.55,21.03 9.72,21.18 9.92,21.18H14.08C14.28,21.18 14.45,21.03 14.47,20.84L14.81,18.59C15.43,18.32 16,17.94 16.5,17.5L18.86,18.54C19.02,18.62 19.21,18.55 19.28,18.39L21.24,14.93C21.3,14.75 21.26,14.56 21.12,14.44L19.14,12.94M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="episodes-sidebar">
                    <div id="episodes-header">
                        <h3>Danh s√°ch t·∫≠p</h3>
                        <button id="close-episodes-btn">‚úï</button>
                    </div>
                    <div id="episodes-content"></div>
                </div>

                <div id="settings-menu">
                    <div class="control-group">
                        <label for="font-size-slider">K√≠ch th∆∞·ªõc ch·ªØ</label
                        ><input type="range" id="font-size-slider" min="12" max="48" step="1" />
                    </div>
                    <div class="control-group">
                        <label for="font-color-picker">M√†u ch·ªØ</label><input type="color" id="font-color-picker" />
                    </div>
                    <div class="control-group">
                        <label for="bg-color-picker">M√†u n·ªÅn</label><input type="color" id="bg-color-picker" />
                    </div>
                    <div class="control-group">
                        <label for="bg-opacity-slider">ƒê·ªô m·ªù n·ªÅn</label
                        ><input type="range" id="bg-opacity-slider" min="0" max="1" step="0.05" />
                    </div>
                </div>
                <button id="skip-btn" class="hidden">
                    B·ªè qua gi·ªõi thi·ªáu
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"></path>
                    </svg>
                </button>
                <!-- "Up Next" Overlay -->
                <div id="up-next-overlay">
                    <p>T·∫≠p ti·∫øp theo sau <span id="up-next-countdown">5</span></p>
                    <div id="up-next-card">
                        <img id="up-next-thumbnail" src="" />
                        <h3 id="up-next-title"></h3>
                    </div>
                    <button id="up-next-cancel-btn">H·ªßy</button>
                </div>
            </div>
            <!-- END: C·∫•u tr√∫c Player HO√ÄN CH·ªàNH v5 -->
        </div>
        <div id="notification-area"></div>
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
            const doc = document;
            // --- DOM Elements ---
            const libraryContainer = doc.getElementById("library-container");
            const searchInput = doc.getElementById("search-input");
            const filterTagsContainer = doc.getElementById("filter-tags");
            const addVideoBtn = doc.getElementById("add-video-btn");
            const detailModalOverlay = doc.getElementById("detail-modal-overlay");
            const detailModalCloseBtn = doc.getElementById("detail-modal-close-btn");
            const modalPlayBtn = doc.getElementById("modal-play-btn");
            const modalThumbnail = doc.getElementById("modal-thumbnail");
            const modalTitle = doc.getElementById("modal-title");
            const modalProgram = doc.getElementById("modal-program");
            const modalAuthor = doc.getElementById("modal-author");
            const modalParticipantsList = doc.getElementById("modal-participants-list");
            const modalParticipantsContainer = doc.getElementById("modal-participants-container");
            const addVideoModalOverlay = doc.getElementById("add-video-modal-overlay");
            const addVideoForm = doc.getElementById("add-video-form");
            const addVideoCloseBtn = doc.getElementById("add-video-close-btn");
            const urlInput = doc.getElementById("youtube-url-input");
            const srtFileInput = doc.getElementById("srt-file-input");
            const srtFileName = doc.getElementById("srt-file-name");
            const playerWrapper = doc.getElementById("player-wrapper");
            const playerContainer = doc.getElementById("player-container");
            const clickOverlay = doc.getElementById("click-overlay");
            const backBtn = doc.getElementById("back-btn");
            const videoTitleDisplay = doc.getElementById("video-title-display");
            const videoProgramDisplay = doc.getElementById("video-program-display");
            const subtitleDisplay = doc.getElementById("subtitle-display");
            const settingsBtn = doc.getElementById("settings-btn");
            const settingsMenu = doc.getElementById("settings-menu");
            const fontSizeSlider = doc.getElementById("font-size-slider");
            const fontColorPicker = doc.getElementById("font-color-picker");
            const bgColorPicker = doc.getElementById("bg-color-picker");
            const bgOpacitySlider = doc.getElementById("bg-opacity-slider");
            const playPauseBtn = doc.getElementById("play-pause-btn");
            const progressBar = doc.getElementById("progress-bar");
            const episodesBtn = doc.getElementById("episodes-btn");
            const episodesSidebar = doc.getElementById("episodes-sidebar");
            const episodesContent = doc.getElementById("episodes-content");
            const closeEpisodesBtn = doc.getElementById("close-episodes-btn");
            const skipBtn = doc.getElementById("skip-btn");
            const modalOriginalTitle = doc.getElementById("modal-original-title");
            // --- State Variables ---
            let player;
            let libraryData = [];
            let subtitles = [];
            let controlsTimeout, progressInterval, subtitleCheckInterval;
            let subtitleSettings = {};
            let currentVideoData = null; // L∆∞u th√¥ng tin video ƒëang ph√°t
            let upNextTimeout, upNextInterval; // D√πng cho t√≠nh nƒÉng "T·∫≠p ti·∫øp theo"
            let lastClickInfo = { time: 0, area: null }; // D√πng ƒë·ªÉ ph√°t hi·ªán double-click THEO V√ôNG
            let isEnding = false; // C·ªù ƒë·ªÉ ch·ªëng l·∫∑p khi video k·∫øt th√∫c
            let currentSkipTarget = null; // Th·ªùi ƒëi·ªÉm b·ªè qua hi·ªán t·∫°i
            const DEFAULT_SUB_SETTINGS = { fontSize: "24", fontColor: "#FFFFFF", bgColor: "#000000", bgOpacity: "0.5" };

            // --- Initialization ---
            function onYouTubeIframeAPIReady() {
                player = new YT.Player("youtube-player", {
                    videoId: "", // ch∆∞a c√≥ video th·ª±c, kh·ªüi t·∫°o r·ªóng
                    playerVars: {
                        autoplay: 0,
                        playsinline: 1,
                        rel: 0,
                        modestbranding: 1,
                        controls: 0,
                        showinfo: 0,
                        iv_load_policy: 3,
                    },
                    events: {
                        onReady: () => {
                            initializeLibrary(); // g·ªçi sau khi player ƒë√£ s·∫µn s√†ng
                        },
                        onStateChange: onPlayerStateChange,
                    },
                });
            }

            async function initializeLibrary() {
                try {
                    // FIX: Always fetch a fresh JSON file, disable caching
                    const res = await fetch("library.json", { cache: "no-cache" });
                    if (!res.ok) throw new Error("Kh√¥ng th·ªÉ t·∫£i th∆∞ vi·ªán.");
                    libraryData = await res.json();
                    renderVideoRows(libraryData);
                    populateFilterTags();
                    setupEventListeners();
                    loadSubtitleSettings();
                } catch (e) {
                    libraryContainer.innerHTML = `<p style="color: #ff8a8a; text-align: center;">L·ªói: ${e.message}</p>`;
                }
            }

    
            function populateFilterTags() {
    filterTagsContainer.innerHTML = '';
    // Th√™m n√∫t "T·∫•t c·∫£" ƒë·∫ßu ti√™n
    const allTag = document.createElement("span");
    allTag.className = "filter-tag active";
    allTag.dataset.filter = "T·∫•t c·∫£";
    allTag.textContent = "T·∫•t c·∫£";
    filterTagsContainer.appendChild(allTag);

    // L·∫•y danh s√°ch th·ªÉ lo·∫°i duy nh·∫•t
    const allGenres = [...new Set(libraryData.flatMap((v) => v.genres || []))].sort();
    
    allGenres.forEach((genre) => {
        const tag = document.createElement("span");
        tag.className = "filter-tag";
        tag.textContent = genre;
        tag.dataset.filter = genre; // L∆∞u t√™n th·ªÉ lo·∫°i v√†o data
        filterTagsContainer.appendChild(tag);
    });
}

/* --- [H√ÄM PH·ª§] T·∫°o HTML cho th·∫ª Video (ƒë·ªÉ t√°i s·ª≠ d·ª•ng) --- */
function createVideoCardHtml(video) {
    const episodeBadge = video.episode 
        ? `<div class="episode-badge">EP ${video.episode}</div>` 
        : "";
    
    // L·∫•y th·ªÉ lo·∫°i ƒë·∫ßu ti√™n
    const displayGenre = (video.genres && video.genres.length > 0) ? video.genres[0] : "";
    
    // Thumbnail & Title
    const thumbUrl = video.thumbnailUrl || video.thumbnailUrl_auto;
    const title = video.userTitle || video.title;

    return `
    <div class="video-card" data-video-id="${video.videoId}">
        <div class="card-image-wrapper">
            ${episodeBadge}
            <img src="${thumbUrl}" alt="${title}" class="video-thumbnail" loading="lazy">
        </div>
        <div class="card-info">
            <div class="card-title">${title}</div>
            <div class="card-meta">
                <span class="card-ep">${video.episode ? 'T·∫≠p ' + video.episode : 'Video l·∫ª'}</span>
                <span class="card-genre">${displayGenre}</span>
            </div>
        </div>
    </div>
    `;
}

/* --- LOGIC RENDER M·ªöI: GROUP BY PROGRAM & CAROUSEL --- */

// Helper: L·∫•y ƒëi·ªÉm th·ªùi gian (ƒë·ªÉ sort)
const getDateScore = (v) => {
    if (v.uploadDate_auto) return new Date(v.uploadDate_auto).getTime();
    return 0;
};

function renderVideoRows(videoArray) {
    libraryContainer.innerHTML = "";
    if (videoArray.length === 0) {
        libraryContainer.innerHTML = `<p style="text-align: center;">Kh√¥ng t√¨m th·∫•y video.</p>`;
        return;
    }

    // 1. GOM NH√ìM: Bi·∫øn danh s√°ch Video ph·∫≥ng th√†nh danh s√°ch Ch∆∞∆°ng tr√¨nh
    const programsMap = {};
    const singleVideos = [];

    videoArray.forEach(video => {
        const progName = video.program;
        
        // N·∫øu kh√¥ng c√≥ t√™n ch∆∞∆°ng tr√¨nh, coi l√† Video L·∫ª
        if (!progName) {
            singleVideos.push(video);
            return;
        }

        if (!programsMap[progName]) {
            programsMap[progName] = {
                title: progName,
                videos: [],
                genres: new Set(),
                latestUpdate: 0
            };
        }
        
        programsMap[progName].videos.push(video);
        // C·∫≠p nh·∫≠t ng√†y m·ªõi nh·∫•t c·ªßa ch∆∞∆°ng tr√¨nh
        const score = getDateScore(video);
        if (score > programsMap[progName].latestUpdate) {
            programsMap[progName].latestUpdate = score;
        }
        // Gom th·ªÉ lo·∫°i
        if (video.genres) video.genres.forEach(g => programsMap[progName].genres.add(g));
    });

    // 2. CHU·∫®N B·ªä D·ªÆ LI·ªÜU HI·ªÇN TH·ªä
    // S·∫Øp x·∫øp c√°c t·∫≠p trong m·ªói ch∆∞∆°ng tr√¨nh (M·ªõi nh·∫•t l√™n ƒë·∫ßu)
    Object.values(programsMap).forEach(prog => {
        prog.videos.sort((a, b) => {
            if (a.episode && b.episode) return b.episode - a.episode; // S·ªë t·∫≠p gi·∫£m d·∫ßn
            return getDateScore(b) - getDateScore(a); // Ho·∫∑c ng√†y gi·∫£m d·∫ßn
        });
        // L·∫•y video ƒë·∫°i di·ªán l√† video m·ªõi nh·∫•t (ƒë·∫ßu danh s√°ch sau khi sort)
        prog.thumbnailVideo = prog.videos[0]; 
    });

    // Danh s√°ch ch∆∞∆°ng tr√¨nh (ƒë·ªÉ render row "M·ªõi c·∫≠p nh·∫≠t" ho·∫∑c "T·∫•t c·∫£")
    const allPrograms = Object.values(programsMap).sort((a, b) => b.latestUpdate - a.latestUpdate);
    // Danh s√°ch video l·∫ª (c≈©ng sort theo ng√†y)
    singleVideos.sort((a, b) => getDateScore(b) - getDateScore(a));

    // 3. RENDER C√ÅC ROW (H√ÄNG NGANG)

    // --- ROW 1: "üî• Ch∆∞∆°ng tr√¨nh M·ªõi c·∫≠p nh·∫≠t" ---
    if (allPrograms.length > 0) {
        createCarouselSection("üî• Ch∆∞∆°ng tr√¨nh M·ªõi c·∫≠p nh·∫≠t", allPrograms.map(p => createProgramCard(p)));
    }

    // --- ROW 2: "üé¨ Video L·∫ª / Movies" (N·∫øu c√≥) ---
    if (singleVideos.length > 0) {
        // V·ªõi video l·∫ª, ta coi m·ªói video nh∆∞ 1 program nh∆∞ng click v√†o l√† play lu√¥n (ho·∫∑c hi·ªán modal √≠t th√¥ng tin)
        createCarouselSection("üé¨ Video L·∫ª", singleVideos.map(v => createVideoCardHtml(v)));
    }

    // --- ROW 3+: "üì∫ T·∫•t c·∫£ ch∆∞∆°ng tr√¨nh" (Ho·∫∑c c√≥ th·ªÉ chia theo th·ªÉ lo·∫°i ·ªü ƒë√¢y n·∫øu mu·ªën) ---
    // Hi·ªán t·∫°i m√¨nh gom h·∫øt v√†o row tr√™n r·ªìi, n√™n n·∫øu b·∫°n mu·ªën t√°ch Th·ªÉ lo·∫°i th√¨ l√†m t∆∞∆°ng t·ª± logic Filter.
}

// H√†m t·∫°o HTML cho 1 Row (Carousel)
function createCarouselSection(title, cardsHtmlArray) {
    if (cardsHtmlArray.length === 0) return;
    const section = doc.createElement("section");
    section.className = "program-row";
    section.innerHTML = `
        <h2 class="program-title">${title}</h2>
        <div class="video-list">
            ${cardsHtmlArray.join("")}
        </div>
    `;
    libraryContainer.appendChild(section);
}

// H√†m t·∫°o HTML th·∫ª Program (Kh√°c th·∫ª Video m·ªôt ch√∫t)
function createProgramCard(program) {
    const video = program.thumbnailVideo; // D√πng video m·ªõi nh·∫•t l√†m ·∫£nh b√¨a
    const thumbUrl = video.thumbnailUrl || video.thumbnailUrl_auto;
    // Hi·ªÉn th·ªã s·ªë l∆∞·ª£ng t·∫≠p
    const episodeCount = program.videos.length;
    const badge = `<div class="episode-badge">${episodeCount} T·∫≠p</div>`;
    const displayGenre = program.genres.size > 0 ? Array.from(program.genres)[0] : "";

    // L∆∞u program-name v√†o data attribute ƒë·ªÉ click handler x·ª≠ l√Ω
    return `
    <div class="video-card program-card" data-program-name="${program.title}">
        <div class="card-image-wrapper">
            ${badge}
            <img src="${thumbUrl}" alt="${program.title}" class="video-thumbnail" loading="lazy">
        </div>
        <div class="card-info">
            <div class="card-title">${program.title}</div>
            <div class="card-meta">
                <span class="card-ep">C·∫≠p nh·∫≠t m·ªõi nh·∫•t</span>
                <span class="card-genre">${displayGenre}</span>
            </div>
        </div>
    </div>
    `;
}

// --- Event Handling ---
          
          
            function setupEventListeners() {
                // ... c√°c event listener t·ª´ ƒë·∫ßu ƒë·∫øn backBtn gi·ªØ nguy√™n ...
                searchInput.addEventListener("input", handleSearchAndFilter);
                filterTagsContainer.addEventListener("click", handleTagClick);
                libraryContainer.addEventListener("click", handleCardClick);
                detailModalCloseBtn.addEventListener("click", () => closeModal(detailModalOverlay));
                detailModalOverlay.addEventListener("click", (e) => {
                    if (e.target === detailModalOverlay) closeModal(detailModalOverlay);
                });
                modalPlayBtn.addEventListener("click", handleModalPlay);
                addVideoBtn.addEventListener("click", () => openModal(addVideoModalOverlay));
                addVideoCloseBtn.addEventListener("click", () => closeModal(addVideoModalOverlay));
                addVideoModalOverlay.addEventListener("click", (e) => {
                    if (e.target === addVideoModalOverlay) closeModal(addVideoModalOverlay);
                });
                addVideoForm.addEventListener("submit", handleAddVideoSubmit);
                srtFileInput.addEventListener("change", () => {
                    srtFileName.textContent = srtFileInput.files.length > 0 ? srtFileInput.files[0].name : "";
                });
                backBtn.addEventListener("click", goHome);

                // --- LOGIC T∆Ø∆†NG T√ÅC PLAYER M·ªöI ---
                const interactionOverlay = document.getElementById("interaction-overlay");
                interactionOverlay.addEventListener("pointerup", handleInteraction);
                doc.getElementById("center-play-pause-btn").addEventListener("click", (e) => {
                    e.stopPropagation();
                    togglePlayPause();
                });
                playPauseBtn.addEventListener("click", togglePlayPause);
                progressBar.addEventListener("input", handleSeek); // ‚úÖ Fix chu·∫©n

                // --- C√ÅC EVENT LISTENER KH√ÅC ---
                playerContainer.addEventListener("mousemove", showControlsAndSetHideTimeout);
                doc.addEventListener("keydown", handleKeyboardShortcuts);
                doc.addEventListener("fullscreenchange", () => {
                    if (!document.fullscreenElement) goHome();
                });
                settingsBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const menu = doc.getElementById("settings-menu");
                    const isVisible = menu.style.display === "flex";
                    menu.style.display = isVisible ? "none" : "flex";
                    setTimeout(() => {
                        menu.classList.toggle("visible", !isVisible);
                    }, 10);
                });
                doc.addEventListener("click", (e) => {
                    const menu = doc.getElementById("settings-menu");
                    if (
                        menu.classList.contains("visible") &&
                        !menu.contains(e.target) &&
                        !settingsBtn.contains(e.target)
                    ) {
                        menu.classList.remove("visible");
                        setTimeout(() => {
                            menu.style.display = "none";
                        }, 200);
                    }
                });
                // ... c√°c event listener c·ªßa subtitle settings v√† drag-drop gi·ªØ nguy√™n ...
                fontSizeSlider.addEventListener("input", () => {
                    subtitleSettings.fontSize = fontSizeSlider.value;
                    applyAndSaveSubtitleStyles();
                });
                fontColorPicker.addEventListener("input", () => {
                    subtitleSettings.fontColor = fontColorPicker.value;
                    applyAndSaveSubtitleStyles();
                });
                bgColorPicker.addEventListener("input", () => {
                    subtitleSettings.bgColor = bgColorPicker.value;
                    applyAndSaveSubtitleStyles();
                });
                bgOpacitySlider.addEventListener("input", () => {
                    subtitleSettings.bgOpacity = bgOpacitySlider.value;
                    applyAndSaveSubtitleStyles();
                });
                doc.body.addEventListener("dragover", (e) => {
                    if (playerWrapper.classList.contains("hidden")) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "copy";
                });
                doc.body.addEventListener("drop", (e) => {
                    if (playerWrapper.classList.contains("hidden")) return;
                    e.preventDefault();
                    handleFileDrop(e);
                });
                skipBtn.addEventListener("click", handleSkipClick);

                episodesBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    toggleEpisodesSidebar();
                });
                closeEpisodesBtn.addEventListener("click", () => {
                    episodesSidebar.classList.remove("visible");
                });
                // ƒê√≥ng sidebar khi click ra ngo√†i (v√†o v√πng player)
                playerContainer.addEventListener("click", (e) => {
                    // N·∫øu click kh√¥ng tr√∫ng sidebar v√† kh√¥ng tr√∫ng n√∫t m·ªü th√¨ ƒë√≥ng
                    if (
                        episodesSidebar.classList.contains("visible") &&
                        !episodesSidebar.contains(e.target) &&
                        !episodesBtn.contains(e.target)
                    ) {
                        episodesSidebar.classList.remove("visible");
                    }
                });
            }
            // 3. H√†m logic m·ªõi
            function toggleEpisodesSidebar() {
                const isVisible = episodesSidebar.classList.contains("visible");
                if (isVisible) {
                    episodesSidebar.classList.remove("visible");
                } else {
                    renderEpisodeList();
                    episodesSidebar.classList.add("visible");
                }
            }

            function renderEpisodeList() {
                episodesContent.innerHTML = "";

                // N·∫øu kh√¥ng c√≥ video ƒëang ph√°t ho·∫∑c kh√¥ng thu·ªôc ch∆∞∆°ng tr√¨nh n√†o -> B√°o l·ªói ho·∫∑c ·∫©n
                if (!currentVideoData || !currentVideoData.program) {
                    episodesContent.innerHTML =
                        "<p style='padding:20px; text-align:center; color:#777'>Kh√¥ng c√≥ danh s√°ch t·∫≠p.</p>";
                    return;
                }

                // L·ªçc c√°c t·∫≠p c√πng ch∆∞∆°ng tr√¨nh
                const episodes = libraryData
                    .filter((v) => v.program === currentVideoData.program)
                    .sort((a, b) => (a.episode || 0) - (b.episode || 0)); // S·∫Øp x·∫øp theo s·ªë t·∫≠p

                if (episodes.length <= 1) {
                    episodesContent.innerHTML =
                        "<p style='padding:20px; text-align:center; color:#777'>ƒê√¢y l√† video l·∫ª.</p>";
                    return;
                }

                episodes.forEach((ep) => {
                    const isCurrent = ep.videoId === currentVideoData.videoId;

                    const item = document.createElement("div");
                    item.className = `episode-item ${isCurrent ? "playing" : ""}`;

                    // Thumbnail t·∫≠p
                    const thumbUrl = ep.thumbnailUrl || ep.thumbnailUrl_auto;

                    item.innerHTML = `
            <img src="${thumbUrl}" class="episode-thumbnail" loading="lazy" />
            <div class="episode-info">
                <span class="episode-number">T·∫≠p ${ep.episode || "?"}</span>
                <span class="episode-title">${ep.userTitle || ep.title}</span>
            </div>
        `;

                    item.onclick = () => {
                        if (isCurrent) return; // ƒêang xem t·∫≠p n√†y r·ªìi th√¨ th√¥i
                        episodesSidebar.classList.remove("visible"); // ƒê√≥ng sidebar
                        launchPlayer(ep); // Ph√°t t·∫≠p m·ªõi
                    };

                    episodesContent.appendChild(item);
                });
            }
  /* --- [C·∫¨P NH·∫¨T] Logic l·ªçc m·ªõi --- */
function handleSearchAndFilter() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const activeTag = doc.querySelector(".filter-tag.active");
    // L·∫•y gi√° tr·ªã filter hi·ªán t·∫°i
    const filterTerm = activeTag && activeTag.dataset.filter !== "T·∫•t c·∫£" ? activeTag.dataset.filter : null;

    const filteredData = libraryData.filter(
        (video) => {
            // Logic t√¨m ki·∫øm text (Search bar)
            const matchesSearch = 
                searchTerm === "" ||
                (video.userTitle || video.title).toLowerCase().includes(searchTerm) ||
                (video.program || "").toLowerCase().includes(searchTerm) ||
                (video.participants || []).some((p) => p.toLowerCase().includes(searchTerm)); // V·∫´n cho t√¨m theo t√™n ng∆∞·ªùi

            // Logic l·ªçc theo Th·∫ª (Genres) - ƒê√É S·ª¨A
            const matchesFilter = 
                !filterTerm || 
                (video.genres && video.genres.includes(filterTerm));

            return matchesSearch && matchesFilter;
        }
    );
    renderVideoRows(filteredData);
}
            function handleTagClick(e) {
                if (e.target.classList.contains("filter-tag")) {
                    doc.querySelectorAll(".filter-tag").forEach((tag) => tag.classList.remove("active"));
                    e.target.classList.add("active");
                    handleSearchAndFilter();
                }
            }
            function handleCardClick(e) {
    const card = e.target.closest(".video-card");
    if (!card) return;

    // Tr∆∞·ªùng h·ª£p 1: Click v√†o Th·∫ª Ch∆∞∆°ng Tr√¨nh (Program Card)
    if (card.dataset.programName) {
        const progName = card.dataset.programName;
        // L·∫•y l·∫°i danh s√°ch video c·ªßa ch∆∞∆°ng tr√¨nh n√†y t·ª´ libraryData
        const videos = libraryData
            .filter(v => v.program === progName)
            .sort((a, b) => (b.episode || 0) - (a.episode || 0)); // Sort t·∫≠p m·ªõi nh·∫•t l√™n ƒë·∫ßu
        
        if (videos.length > 0) {
            // M·ªü modal v·ªõi th√¥ng tin c·ªßa video m·ªõi nh·∫•t, nh∆∞ng truy·ªÅn th√™m danh s√°ch t·∫≠p
            openDetailModal(videos[0], videos); 
        }
    } 
    // Tr∆∞·ªùng h·ª£p 2: Click v√†o Video L·∫ª (Video Card th∆∞·ªùng)
    else if (card.dataset.videoId) {
        const videoId = card.dataset.videoId;
        const videoData = libraryData.find((v) => v.videoId === videoId);
        if (videoData) openDetailModal(videoData, null); // null nghƒ©a l√† kh√¥ng c√≥ list t·∫≠p
    }
}
            function handleModalPlay() {
                const videoId = modalPlayBtn.dataset.videoId;
                const videoData = libraryData.find((v) => v.videoId === videoId);
                if (videoData) {
                    closeModal(detailModalOverlay);

                    launchPlayer(videoData).then(() => {
                        if (player && typeof player.playVideo === "function") {
                            player.playVideo(); // <-- ph√°t ngay v√¨ l√† user gesture
                        }
                    });
                }
            }

            function handleAddVideoSubmit(e) {
                e.preventDefault();
                const videoId = extractVideoID(urlInput.value);
                if (!videoId) {
                    alert("Link YouTube kh√¥ng h·ª£p l·ªá.");
                    return;
                }
                const srtFile = srtFileInput.files[0];
                if (srtFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        launchPlayer({ videoId }, parseSRT(event.target.result));
                    };
                    reader.readAsText(srtFile);
                } else {
                    launchPlayer({ videoId });
                }
                closeModal(addVideoModalOverlay);
                urlInput.value = "";
                srtFileInput.value = "";
                srtFileName.textContent = "";
            }

            function handleFileDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith(".srt")) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        subtitles = parseSRT(event.target.result);
                        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) startSubtitleSync();
                    };
                    reader.readAsText(file);
                }
            }
            function openModal(modal) {
                modal.classList.remove("hidden");
                setTimeout(() => modal.classList.add("visible"), 10);
            }
            function closeModal(modal) {
                modal.classList.remove("visible");
                setTimeout(() => modal.classList.add("hidden"), 300);
            }
/**
 * M·ªü modal chi ti·∫øt, c√≥ th·ªÉ hi·ªÉn th·ªã danh s√°ch t·∫≠p n·∫øu l√† m·ªôt PROGRAM (Series).
 * @param {Object} videoData D·ªØ li·ªáu c·ªßa video/t·∫≠p m·ªõi nh·∫•t ƒë∆∞·ª£c ch·ªçn.
 * @param {Array<Object> | null} programEpisodes Danh s√°ch c√°c t·∫≠p c·ªßa ch∆∞∆°ng tr√¨nh, n·∫øu l√† Program Card.
 */
function openDetailModal(videoData, programEpisodes = null) {
    // 1. L·∫•y ƒë√∫ng ID t·ª´ HTML hi·ªán t·∫°i
    const modalThumbnail = doc.getElementById("modal-thumbnail");
    const modalTitle = doc.getElementById("modal-title");
    const modalOriginalTitle = doc.getElementById("modal-original-title");
    const modalProgram = doc.getElementById("modal-program");
    const modalAuthor = doc.getElementById("modal-author");
    const modalDescription = doc.getElementById("modal-description");
    const modalPlayBtn = doc.getElementById("modal-play-btn");

    // S·ª¨A: L·∫•y ƒë√∫ng ID list v√† container ƒë·ªÉ x·ª≠ l√Ω ·∫©n/hi·ªán
    const modalParticipantsList = doc.getElementById("modal-participants-list");
    const modalParticipantsContainer = doc.getElementById("modal-participants-container");
    
    const modalGenresList = doc.getElementById("modal-genres-list");
    const modalGenresContainer = doc.getElementById("modal-genres-container");
    
    const modalEpisodeSection = doc.getElementById("modal-episodes-section");
    const modalEpisodesList = doc.getElementById("modal-episodes-list");
    
    // 2. X·ª≠ l√Ω thumbnail
    const thumbnailUrl = videoData.thumbnailUrl || videoData.thumbnailUrl_auto;
    modalThumbnail.src = thumbnailUrl.replace("hqdefault", "maxresdefault");
    modalThumbnail.onerror = () => { modalThumbnail.src = thumbnailUrl; };

    // 3. X·ª≠ l√Ω TI√äU ƒê·ªÄ
    if (programEpisodes) {
        modalTitle.textContent = videoData.program;
        modalOriginalTitle.textContent = videoData.userTitle || videoData.title;
        modalOriginalTitle.style.display = "block";
    } else {
        modalTitle.textContent = videoData.userTitle || videoData.title;
        modalOriginalTitle.style.display = videoData.originalTitle_auto ? "block" : "none";
        if(videoData.originalTitle_auto) modalOriginalTitle.textContent = videoData.originalTitle_auto;
    }

    // 4. C√°c th√¥ng tin c∆° b·∫£n
    modalProgram.textContent = videoData.program || "";
    modalAuthor.textContent = videoData.authorName || videoData.authorName_auto || "";
    modalDescription.textContent = videoData.description || "Ch∆∞a c√≥ m√¥ t·∫£ chi ti·∫øt.";

    // 5. X·ª≠ l√Ω GENRES (S·ª≠a l·ªói logic c≈©)
    // HTML c·ªßa b·∫°n d√πng <ul> n√™n ta render th·∫ª <li> ho·∫∑c text b√™n trong, v√† ph·∫£i g·ª° class hidden ·ªü container
    modalGenresList.innerHTML = "";
    if (videoData.genres && videoData.genres.length > 0) {
        // Hi·ªÉn th·ªã d·∫°ng text ƒë∆°n gi·∫£n b√™n trong th·∫ª ul
        modalGenresList.innerHTML = `<span style="font-weight: 700; color: #fff; margin-right: 5px;">Th·ªÉ lo·∫°i:</span>` + 
                                    videoData.genres.map(g => `<span class="genre-tag">${g}</span>`).join(" ");
        modalGenresContainer.classList.remove("hidden"); // Quan tr·ªçng: Hi·ªán container
    } else {
        modalGenresContainer.classList.add("hidden");
    }

    // 6. X·ª≠ l√Ω PARTICIPANTS (S·ª≠a l·ªói logic c≈©)
    modalParticipantsList.innerHTML = "";
    if (videoData.participants && videoData.participants.length > 0) {
        modalParticipantsList.innerHTML = videoData.participants.map(p => `<li class="participant-tag">${p}</li>`).join("");
        modalParticipantsContainer.classList.remove("hidden"); // Quan tr·ªçng: Hi·ªán container
    } else {
        modalParticipantsContainer.classList.add("hidden");
    }
    
    // 7. X·ª≠ l√Ω DANH S√ÅCH T·∫¨P
    modalEpisodesList.innerHTML = "";
    if (programEpisodes && programEpisodes.length > 0) {
        modalEpisodeSection.classList.remove("hidden");
        
        programEpisodes.forEach(ep => {
            const el = doc.createElement("div");
            el.className = "modal-episode-item";
            const epThumb = ep.thumbnailUrl || ep.thumbnailUrl_auto;
            const isLatest = ep.videoId === videoData.videoId ? ' style="color: var(--accent-color); font-weight: 700;"' : '';

            el.innerHTML = `
                <img src="${epThumb}" class="modal-ep-thumb" loading="lazy">
                <div class="modal-ep-info">
                    <div class="modal-ep-number"${isLatest}>T·∫≠p ${ep.episode || "L·∫ª"}</div>
                    <div class="modal-ep-title">${ep.userTitle || ep.title}</div>
                </div>
                <div style="font-size: 1.5rem; color: #fff;">‚ñ∂</div>
            `;
            
            el.onclick = () => {
                closeModal(detailModalOverlay);
                launchPlayer(ep);
            };
            modalEpisodesList.appendChild(el);
        });

        modalPlayBtn.onclick = () => {
            closeModal(detailModalOverlay);
            launchPlayer(programEpisodes[0]);
        };

    } else {
        modalEpisodeSection.classList.add("hidden");
        modalPlayBtn.onclick = handleModalPlay; 
        modalPlayBtn.dataset.videoId = videoData.videoId;
    }

    // 8. M·ªü Modal
    openModal(detailModalOverlay);
}
// [THAY TH·∫æ] H√†m v·∫Ω v·∫°ch bookmark l√™n thanh ti·∫øn tr√¨nh
            function renderBookmarksOverlay(bookmarks) {
                // 1. X√≥a c√°c marker c≈© tr√™n thanh progress
                const oldMarkers = document.querySelectorAll(".timeline-marker");
                oldMarkers.forEach((m) => m.remove());

                // 2. ·∫®n n√∫t skip c≈© n·∫øu c√≥
                skipBtn.classList.remove("visible");

                const duration = player.getDuration?.() || 0;
                if (!duration || !bookmarks || bookmarks.length === 0) return;

                const progressContainer = document.querySelector(".progress-container");

                bookmarks.forEach((b) => {
                    const timeSec = srtTimeToSeconds(b.time);
                    const percent = (timeSec / duration) * 100;

                    // T·∫°o v·∫°ch tr·∫Øng nh·ªè tr√™n thanh bar
                    const marker = document.createElement("div");
                    marker.className = "timeline-marker";
                    marker.style.left = `${percent}%`;
                    marker.setAttribute("data-label", b.label); // ƒê·ªÉ hover hi·ªán t√™n

                    progressContainer.appendChild(marker);
                });
            }

            // [M·ªöI] H√†m x·ª≠ l√Ω click n√∫t Skip
            function handleSkipClick(e) {
                e.stopPropagation();
                if (currentSkipTarget !== null) {
                    player.seekTo(currentSkipTarget, true);
                    skipBtn.classList.remove("visible");
                    // Update UI thanh bar ngay l·∫≠p t·ª©c
                    updateProgressBarUI(currentSkipTarget, player.getDuration());
                }
            }

            async function launchPlayer(videoData, preloadedSubtitles = null) {
                return new Promise((resolve) => {
                    if (!videoData || !videoData.videoId) return;

                    currentVideoData = videoData;
                    const hasEpisodes = libraryData.some(
                        (v) => v.program === videoData.program && v.videoId !== videoData.videoId
                    );
                    if (hasEpisodes || (videoData.program && videoData.episode)) {
                        episodesBtn.classList.remove("hidden");
                    } else {
                        episodesBtn.classList.add("hidden");
                    }
                    isEnding = false;
                    hideUpNextOverlay();

                    subtitles = preloadedSubtitles || [];
                    subtitleDisplay.innerHTML = "";
                    playerWrapper.classList.remove("hidden");
                    videoTitleDisplay.textContent = videoData.userTitle || videoData.title || "ƒêang t·∫£i...";
                    renderBookmarksOverlay(videoData.bookmarks || []);

                    videoProgramDisplay.textContent = videoData.program || "";

                    enterCinematicMode().then(() => {
                        if (videoData.subtitleUrl) {
                            loadRemoteSubtitle(videoData.subtitleUrl);
                        } else if (subtitles.length > 0) {
                            startSubtitleSync();
                        }

                        // ch·ªâ c·∫ßn load video m·ªõi v√†o player ƒë√£ kh·ªüi t·∫°o
                        player.loadVideoById(videoData.videoId);
                        resolve();
                    });
                });
            }

            async function enterCinematicMode() {
                try {
                    if (playerContainer.requestFullscreen) await playerContainer.requestFullscreen();
                    if (screen.orientation && screen.orientation.lock) await screen.orientation.lock("landscape");
                } catch (err) {
                    console.warn("L·ªói cinematic:", err);
                }
            }
            function goHome() {
                if (player) player.stopVideo();
                playerWrapper.classList.add("hidden");
                if (document.fullscreenElement) document.exitFullscreen();
            }

            function onPlayerReady(event) {
                const apiData = event.target.getVideoData();
                videoTitleDisplay.textContent = apiData.title;
                // FIX: Force playVideo() call to maximize autoplay success
                event.target.playVideo();
            }

            function onPlayerStateChange(event) {
                const centerIcon = doc.getElementById("center-play-pause-icon");
                const playPauseIconPath =
                    event.data === YT.PlayerState.PLAYING
                        ? "M14,19H18V5H14M6,19H10V5H6V19Z"
                        : "M8,5.14V19.14L19,12.14L8,5.14Z";

                playPauseBtn.querySelector("svg path").setAttribute("d", playPauseIconPath);
                if (centerIcon) centerIcon.setAttribute("d", playPauseIconPath);

                if (event.data === YT.PlayerState.PLAYING) {
                    playerContainer.classList.add("playing");
                    doc.getElementById("center-play-pause-btn").style.opacity = "0"; // <<< FIX N√ÄY
                    startSyncing();
                    hideUpNextOverlay();
                    showControlsAndSetHideTimeout();
                } else {
                    playerContainer.classList.remove("playing");
                    stopSyncing();
                    // Khi pause/end/buffer, hi·ªán controls v√† n√∫t play gi·ªØa vƒ©nh vi·ªÖn
                    clearTimeout(controlsTimeout);
                    playerContainer.classList.add("controls-active");
                    playerContainer.classList.remove("no-cursor");
                }

                if (event.data === YT.PlayerState.ENDED && !isEnding) {
                    handleVideoEnd();
                }
            }

            function handleInteraction(e) {
                const now = new Date().getTime();
                const timeSinceLastClick = now - lastClickInfo.time;
                const area = e.target.id;

                // Logic Double Click ƒë·ªÉ tua
                if (timeSinceLastClick < 350 && area === lastClickInfo.area) {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    let newTime = currentTime;

                    if (area === "seek-backward-zone") {
                        newTime = Math.max(0, currentTime - 5);
                        player.seekTo(newTime, true);
                        startSubtitleSync();
                        updateProgressBarUI(newTime, duration); // C·∫≠p nh·∫≠t UI ngay
                    } else if (area === "seek-forward-zone") {
                        newTime = Math.min(duration, currentTime + 5);
                        player.seekTo(newTime, true);
                        startSubtitleSync();
                        updateProgressBarUI(newTime, duration); // C·∫≠p nh·∫≠t UI ngay
                    }
                    lastClickInfo = { time: 0, area: null }; // Reset
                }
                // Logic Single Click ƒë·ªÉ hi·ªán/·∫©n controls
                else {
                    if (playerContainer.classList.contains("controls-active")) {
                        hideControls();
                    } else {
                        showControlsAndSetHideTimeout();
                    }
                }
                lastClickInfo = { time: now, area: area };
            }

            // FIX: Added function to handle seek
            function handleSeek() {
                const seekTime = parseFloat(progressBar.value);

                player.seekTo(seekTime, true);
                // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
                updateProgressBarUI(seekTime, player.getDuration());
            }
            // FIX: Added dedicated toggle function for the button
            function togglePlayPause() {
                if (player && player.getPlayerState)
                    player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
            }

            function showControlsAndSetHideTimeout() {
                if (!player) return;
                playerContainer.classList.add("controls-active");
                playerContainer.classList.remove("no-cursor");

                clearTimeout(controlsTimeout);
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    controlsTimeout = setTimeout(hideControls, 3500);
                }
            }

            function hideControls() {
                clearTimeout(controlsTimeout);
                const menu = doc.getElementById("settings-menu");
                if (menu.classList.contains("visible")) return;

                playerContainer.classList.remove("controls-active");
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    playerContainer.classList.add("no-cursor");
                }
            }
            function handleKeyboardShortcuts(e) {
                if (
                    doc.activeElement === searchInput ||
                    doc.activeElement === urlInput ||
                    playerWrapper.classList.contains("hidden")
                )
                    return;
                switch (e.code) {
                    case "Space":
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case "Escape":
                        e.preventDefault();
                        goHome();
                        break;
                    case "ArrowLeft":
                        player.seekTo(player.getCurrentTime() - 5, true);
                        break;
                    case "ArrowRight":
                        player.seekTo(player.getCurrentTime() + 5, true);
                        break;
                }
            }

            function applyAndSaveSubtitleStyles() {
                applySubtitleStyles();
                saveSubtitleSettings();
            }
            function applySubtitleStyles() {
                function hexToRgba(hex, op) {
                    let r = "0x" + hex[1] + hex[2],
                        g = "0x" + hex[3] + hex[4],
                        b = "0x" + hex[5] + hex[6];
                    return `rgba(${+r},${+g},${+b},${op})`;
                }
                subtitleDisplay.style.fontSize = `clamp(1.2rem, ${subtitleSettings.fontSize * 0.08}vw, ${subtitleSettings.fontSize}px)`;
                subtitleDisplay.style.color = subtitleSettings.fontColor;
                subtitleDisplay.style.backgroundColor = hexToRgba(subtitleSettings.bgColor, subtitleSettings.bgOpacity);
            }
            function saveSubtitleSettings() {
                localStorage.setItem("youtubeVODPlayerSubSettings", JSON.stringify(subtitleSettings));
            }
            function loadSubtitleSettings() {
                const saved = localStorage.getItem("youtubeVODPlayerSubSettings");
                subtitleSettings = saved ? JSON.parse(saved) : { ...DEFAULT_SUB_SETTINGS };
                fontSizeSlider.value = subtitleSettings.fontSize;
                fontColorPicker.value = subtitleSettings.fontColor;
                bgColorPicker.value = subtitleSettings.bgColor;
                bgOpacitySlider.value = subtitleSettings.bgOpacity;
                applySubtitleStyles();
            }

            function startSyncing() {
                startProgressSync();
                if (subtitles.length > 0) startSubtitleSync();
            }
            function stopSyncing() {
                stopProgressSync();
                stopSubtitleSync();
            }
            function stopProgressSync() {
                clearInterval(progressInterval);
            }
            function stopSubtitleSync() {
                clearInterval(subtitleCheckInterval);
            }
            function startProgressSync() {
                stopProgressSync();
                const tDisplay = doc.getElementById("time-display");

                progressInterval = setInterval(() => {
                    if (!player || typeof player.getDuration !== "function") return;
                    const d = player.getDuration();
                    const c = player.getCurrentTime();
                    if (isNaN(d) || d === 0) return;

                    updateProgressBarUI(c, d);

                    // --- LOGIC SKIP INTRO M·ªöI ---
                    checkSkipLogic(c, d);
                    // -----------------------------

                    const formatTime = (s) => {
                        const t = Math.round(s);
                        return `${String(Math.floor(t / 60)).padStart(2, "0")}:${String(t % 60).padStart(2, "0")}`;
                    };
                    if (tDisplay) tDisplay.textContent = `${formatTime(c)} / ${formatTime(d)}`;

                    if (d - c < 1 && !isEnding) {
                        handleVideoEnd();
                    }
                }, 250);
            }

            // [M·ªöI] Logic t√≠nh to√°n xem c√≥ hi·ªán n√∫t Skip kh√¥ng
            function checkSkipLogic(currentTime, duration) {
                if (!currentVideoData || !currentVideoData.bookmarks) return;

                // S·∫Øp x·∫øp bookmark theo th·ªùi gian
                const bookmarks = currentVideoData.bookmarks
                    .map((b) => ({ ...b, sec: srtTimeToSeconds(b.time) }))
                    .sort((a, b) => a.sec - b.sec);

                let foundSkip = null;

                for (let i = 0; i < bookmarks.length; i++) {
                    const currentB = bookmarks[i];
                    const nextB = bookmarks[i + 1];

                    // X√°c ƒë·ªãnh ƒëi·ªÉm k·∫øt th√∫c c·ªßa ƒëo·∫°n n√†y
                    // N·∫øu c√≥ ƒëo·∫°n sau th√¨ end l√† start ƒëo·∫°n sau. N·∫øu kh√¥ng th√¨ coi nh∆∞ h·∫øt video ho·∫∑c +60s
                    const endTime = nextB ? nextB.sec : currentB.sec + 80;

                    // N·∫øu ƒëang n·∫±m trong v√πng c·ªßa bookmark n√†y V√Ä n√≥ c√≥ skip=true
                    if (currentTime >= currentB.sec && currentTime < endTime && currentB.skip) {
                        foundSkip = {
                            label: currentB.label,
                            target: endTime, // Nh·∫£y t·ªõi ƒë·∫ßu ƒëo·∫°n sau
                        };
                        break;
                    }
                }

                if (foundSkip) {
                    skipBtn.innerHTML = `B·ªè qua ${foundSkip.label} <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"></path></svg>`;
                    skipBtn.classList.remove("hidden");
                    // setTimeout nh·∫π ƒë·ªÉ k√≠ch ho·∫°t animation CSS
                    setTimeout(() => skipBtn.classList.add("visible"), 10);
                    currentSkipTarget = foundSkip.target;
                } else {
                    skipBtn.classList.remove("visible");
                    setTimeout(() => skipBtn.classList.add("hidden"), 300); // Ch·ªù animation ·∫©n xong m·ªõi hidden
                    currentSkipTarget = null;
                }
            }

            function startSubtitleSync() {
                stopSubtitleSync();
                subtitleCheckInterval = setInterval(() => {
                    if (!player || typeof player.getCurrentTime !== "function") return;
                    const c = player.getCurrentTime();
                    const sub = subtitles.find((s) => c >= s.start && s.end >= c);
                    subtitleDisplay.innerHTML = sub ? sub.text : "";
                }, 100);
            }
            async function loadRemoteSubtitle(url) {
                if (!url) return;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`Could not fetch SRT`);
                    const srt = await res.text();
                    subtitles = parseSRT(srt);
                    if (subtitles.length > 0) startSubtitleSync();
                } catch (e) {
                    console.error("Could not load subtitle:", e);
                }
            }
            function parseSRT(text) {
                const subs = [];
                const blocks = text.trim().replace(/\r/g, "").split("\n\n");
                for (const block of blocks) {
                    const lines = block.split("\n");
                    const timeIdx = lines.findIndex((l) => l.includes("-->"));
                    if (timeIdx !== -1) {
                        const txt = lines.slice(timeIdx + 1).join("<br>");
                        const match = lines[timeIdx].match(/(.*) --> (.*)/);
                        if (match && txt)
                            subs.push({
                                start: srtTimeToSeconds(match[1].trim()),
                                end: srtTimeToSeconds(match[2].trim()),
                                text: txt,
                            });
                    }
                }
                return subs;
            }
            function srtTimeToSeconds(t) {
                const p = t.split(/[:,]/).reverse();
                return (
                    (parseInt(p[3], 10) || 0) * 3600 +
                    (parseInt(p[2], 10) || 0) * 60 +
                    (parseInt(p[1], 10) || 0) +
                    (parseInt(p[0], 10) || 0) / 1000
                );
            }
            function extractVideoID(url) {
                const regex = /(?:watch\?v=|youtu\.be\/|embed\/|v\/|e\/|shorts\/)([a-zA-Z0-9_-]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }
            function handleVideoEnd() {
                isEnding = true; // ƒê·∫∑t c·ªù ƒë·ªÉ tr√°nh g·ªçi l·∫°i
                stopSyncing();

                if (!currentVideoData) return;
                let nextVideo = null;
                if (currentVideoData.program && typeof currentVideoData.episode !== "undefined") {
                    const currentEpisode = Number(currentVideoData.episode);
                    nextVideo = libraryData.find(
                        (v) => v.program === currentVideoData.program && Number(v.episode) === currentEpisode + 1
                    );
                }

                if (nextVideo) {
                    showUpNextOverlay(nextVideo);
                } else {
                    playerContainer.classList.remove("no-cursor");
                    playerContainer.classList.add("controls-active");
                    doc.getElementById("center-play-pause-btn").style.opacity = "1";

                    // G·ª¢I √ù CH∆Ø∆†NG TR√åNH KH√ÅC
                    const otherVideo = libraryData.find(
                        (v) => v.program !== currentVideoData.program && v.videoId !== currentVideoData.videoId
                    );

                    if (otherVideo) {
                        showUpNextOverlay(otherVideo, true); // d√πng giao di·ªán c≈© lu√¥n
                    }
                }
            }
            function updateProgressBarUI(currentTime, duration) {
                if (isNaN(duration) || duration === 0) return;
                progressBar.max = duration; // <<< TH√äM D√íNG N√ÄY
                progressBar.value = currentTime;
                progressBar.style.setProperty("--progress-percent", `${(currentTime / duration) * 100}%`);
            }

            function showUpNextOverlay(videoData, isSuggestion = false) {
                const overlay = doc.getElementById("up-next-overlay");
                const thumbnail = doc.getElementById("up-next-thumbnail");
                const title = doc.getElementById("up-next-title");
                const countdownSpan = doc.getElementById("up-next-countdown");
                const card = doc.getElementById("up-next-card");
                const cancelBtn = doc.getElementById("up-next-cancel-btn");

                const thumbnailUrl = videoData.thumbnailUrl || videoData.thumbnailUrl_auto;
                thumbnail.src = thumbnailUrl;
                title.textContent = videoData.userTitle || videoData.title;

                overlay.style.display = "flex";

                if (isSuggestion) {
                    // G·ª£i √Ω ch∆∞∆°ng tr√¨nh kh√°c: kh√¥ng c√≥ ƒë·∫øm ng∆∞·ª£c, ch·ªâ click ƒë·ªÉ xem
                    countdownSpan.parentElement.innerHTML = "B·∫°n c√≥ th·ªÉ th√≠ch ch∆∞∆°ng tr√¨nh n√†y:";
                    cancelBtn.textContent = "B·ªè qua";
                    card.onclick = () => {
                        hideUpNextOverlay();
                        launchPlayer(videoData);
                    };
                    cancelBtn.onclick = hideUpNextOverlay;
                } else {
                    // T·∫≠p ti·∫øp theo b√¨nh th∆∞·ªùng
                    let countdown = 5;
                    countdownSpan.textContent = countdown;
                    const playNext = () => {
                        hideUpNextOverlay();
                        launchPlayer(videoData);
                    };
                    card.onclick = playNext;
                    cancelBtn.onclick = hideUpNextOverlay;

                    upNextInterval = setInterval(() => {
                        countdown--;
                        countdownSpan.textContent = countdown;
                    }, 1000);
                    upNextTimeout = setTimeout(() => {
                        playNext();
                    }, 5000);
                }
            }

            function hideUpNextOverlay() {
                clearTimeout(upNextTimeout);
                clearInterval(upNextInterval);
                const overlay = doc.getElementById("up-next-overlay");
                if (overlay) overlay.style.display = "none";
                const card = doc.getElementById("up-next-card");
                if (card) card.onclick = null; // G·ª° listener ƒë·ªÉ tr√°nh memory leak
            }
            // END: C√°c h√†m m·ªõi
        </script>
    </body>
</html>
