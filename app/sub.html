<!doctype html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>Trình xem Phim Chuyên nghiệp</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
     <style>
            :root {
                --primary-bg: #141414;
                --secondary-bg: #1e1e1e;
                --text-color: #e5e5e5;
                --accent-color: #e50914;
                --text-light: #fff;
            }
            body {
                font-family: "Inter", sans-serif;
                margin: 0;
                background-color: var(--primary-bg);
                color: var(--text-color);
                overflow-x: hidden;
            }
            main {
                padding: clamp(20px, 4vw, 60px);
                box-sizing: border-box;
            }
            .hidden {
                display: none !important;
            }

            /* --- Giao diện chính --- */
            #page-header {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                gap: 20px;
                margin-bottom: 40px;
            }
            #main-title {
                font-size: 2.5rem;
                font-weight: 700;
                color: var(--accent-color);
                text-transform: uppercase;
                letter-spacing: 2px;
                margin: 0;
            }
            #actions-container {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            #search-container {
                display: flex;
                align-items: center;
                gap: 10px;
                background-color: var(--secondary-bg);
                border: 1px solid #333;
                border-radius: 4px;
                padding: 5px 15px;
            }
            #search-icon {
                width: 20px;
                height: 20px;
                fill: #888;
            }
            #search-input {
                background: none;
                border: none;
                outline: none;
                color: var(--text-color);
                font-size: 1rem;
                padding: 10px 0;
                width: 250px;
            }
            #add-video-btn {
                background-color: var(--secondary-bg);
                border: 1px solid #333;
                border-radius: 4px;
                width: 44px;
                height: 44px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                fill: #ccc;
                transition: background-color 0.2s;
            }
            #add-video-btn:hover {
                background-color: #333;
            }
            #bookmark-overlay button {
                transition: transform 0.2s ease;
            }
            #bookmark-overlay button:hover {
                transform: scale(1.1);
            }

            #filter-tags {
    display: flex;
    gap: 12px;
    overflow-x: auto; /* Cho phép cuộn ngang */
    white-space: nowrap;
    padding-bottom: 15px; /* Khoảng thở cho thanh cuộn */
    margin-bottom: 20px;
    border-bottom: 1px solid #222;
    /* Ẩn thanh cuộn mặc định cho đẹp */
    scrollbar-width: none; /* Firefox */
    -ms-overflow-style: none; /* IE/Edge */
}
#filter-tags::-webkit-scrollbar {
    display: none; /* Chrome/Safari */
}

.filter-tag {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #ccc;
    padding: 8px 20px;
    border-radius: 50px; /* Bo tròn kiểu viên thuốc */
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 500;
    transition: all 0.2s ease;
    flex-shrink: 0; /* Không bị co lại */
}
.filter-tag:hover {
    background-color: rgba(255, 255, 255, 0.2);
    border-color: #fff;
    color: #fff;
}
.filter-tag.active {
    background-color: var(--text-light);
    color: #000;
    border-color: var(--text-light);
    font-weight: 700;
    transform: scale(1.05);
}
            #library-container {
                display: flex;
                flex-direction: column;
                gap: 50px;
            }
            /* Mỗi .program-row là một cái "kệ" */
.program-row {

    position: relative;        /* Để xử lý z-index khi hover */
}

.program-title {
    font-size: 1.5rem;         /* Cỡ chữ tiêu đề (VD: Phim hành động) */
    font-weight: 600;
    margin-bottom: 15px;       /* Khoảng cách từ tiêu đề xuống list video */
    color: #fff;
    padding-left: 0;           /* Căn lề trái thẳng hàng */
}


/* .video-list là không gian bên trong cái kệ để xếp video */
.video-list {
  
    /* CƠ CHẾ CUỘN NGANG */
    display: flex;
    gap: 15px;
    /* overflow-x: auto; */
    overflow-y: visible;
    /* padding: 40px 10px; */
    /* margin: -40px -10px; */
    scroll-behavior: smooth;
    scrollbar-width: none;
    /* Ẩn thanh cuộn xấu xí đi */
    scrollbar-width: none;     /* Firefox */
    -ms-overflow-style: none;  /* IE/Edge */
}

/* Ẩn thanh cuộn cho Chrome/Safari */
.video-list::-webkit-scrollbar {
    display: none;
}



.video-list::-webkit-scrollbar {
    display: none;             /* Chrome/Safari */
}
            /* --- [MỚI] VIDEO CARD - Hover hiện info bên dưới --- */
.video-card {
    background-color: var(--secondary-bg);
    border-radius: 6px;
    
    position: relative; /* Quan trọng để định vị */
    cursor: pointer;
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27), z-index 0s 0.3s; /* Delay z-index khi thu nhỏ */
    flex-shrink: 0; 
    flex-grow: 0;

    /* 2. Tính toán chiều rộng chính xác cho 4 item/hàng */
    /* Công thức: (100% chiều ngang - (15px gap * 3 khoảng trống)) / 4 phần tử */
    width: calc((100% - 45px) / 4); 
    
    /* Đặt flex-basis giống width để trình duyệt ưu tiên render đúng kích thước */
    flex-basis: calc((100% - 45px) / 4);
    /* Không dùng overflow: hidden để info có thể trồi ra ngoài hoặc mở rộng */
}
/* Màn hình Tablet/Laptop nhỏ: Hiện 3 cái */
@media (max-width: 1024px) {
    .video-card {
        width: calc((100% - 30px) / 3); /* Gap * 2 chia 3 */
        flex-basis: calc((100% - 30px) / 3);
    }
}

/* Màn hình Mobile: Hiện 2 cái (hoặc 1.5 cái để gợi ý vuốt) */
@media (max-width: 768px) {
    .video-card {
        width: calc((100% - 15px) / 2); /* Gap * 1 chia 2 */
        flex-basis: calc((100% - 15px) / 2);
    }
}
/* --- BỔ SUNG: CSS cho List tập trong Modal (Style Netflix) --- */
.modal-episode-item {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 15px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-radius: 4px;
}
.modal-episode-item:hover {
    background-color: #333;
}
.modal-ep-thumb {
    width: 140px;
    aspect-ratio: 16/9;
    object-fit: cover;
    border-radius: 4px;
}
.modal-ep-info {
    flex: 1; /* Chiếm phần còn lại */
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.modal-ep-number {
    font-size: 1.1rem;
    font-weight: 700;
    color: #ddd;
    margin-bottom: 4px;
}
.modal-ep-title {
    font-size: 0.95rem;
    color: #aaa;
    display: -webkit-box;
    line-clamp: 2; /* Cắt dòng nếu tên quá dài */
    -webkit-box-orient: vertical;
    overflow: hidden;
}
.modal-episode-item .play-icon {
    width: 32px;
    height: 32px;
    fill: white;
    opacity: 0; /* Ẩn nút play bình thường */
    transition: opacity 0.2s;
}
.modal-episode-item:hover .play-icon {
    opacity: 1; /* Hiện khi hover */
}
/* Container chứa ảnh để bo góc */
.card-image-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 6px;
    overflow: hidden; /* Ảnh nằm gọn trong này */
    z-index: 1;
}

.video-thumbnail {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

/* Phần thông tin (Mặc định ẩn hoặc thu gọn) */
.card-info {
    /* Bước A: Thoát khỏi overflow của cha */
    position: fixed; 
    
    /* Bước B: Kết nối với Neo (Lấy từ biến CSS inline) */
    position-anchor: var(--target-anchor);
    
    /* Bước C: Định vị trí dựa trên Neo */
    /* Top của info nằm ngay sát Bottom của Neo */
    top: anchor(bottom); 
    
    /* Left của info trùng với Left của Neo */
    left: anchor(left);
    
    /* Độ rộng bằng đúng độ rộng của Neo */
    width: anchor-size(width);
    position-try-options: flip-block;
    position-try: flip-block, flip-inline;
    /* --- Các style giao diện cũ giữ nguyên --- */
    background-color: var(--secondary-bg);
    padding: 12px;
    box-sizing: border-box;
    border-radius: 0 0 6px 6px;
    
    /* Hiệu ứng ẩn hiện */
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: opacity 0.3s, transform 0.3s;
    box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    z-index: 9999; /* Luôn nổi trên cùng */
    pointer-events: none;
}

/* Title trong card */
.card-title {
    font-size: 0.95rem;
    font-weight: 700;
    margin: 0 0 5px 0;
    color: #fff;
    display: -webkit-box;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}

/* Metadata (Tập, thể loại) */
.card-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #aaa;
}

.card-genre {
    color: var(--accent-color);
    font-weight: 600;
}
@media (hover: hover) {
    .video-card:hover {
            transform: scale(1.3); /* Phóng to hơn chút nữa cho giống Netflix */
    z-index: 999; /* Đảm bảo nổi hẳn lên trên */
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.27), z-index 0s; /* Z-index đổi ngay lập tức */
        box-shadow: 0 0 0 2px rgba(255,255,255,0.1); /* Viền sáng nhẹ */
    }

    /* Khi hover vào card, phần info hiện ra */
    .video-card:hover .card-info {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        pointer-events: auto;
    }
    @supports not (anchor-name: --foo) {
    .card-info {
        position: absolute; /* Quay về cách cũ nếu trình duyệt cùi */
        top: 100%;
        left: 0;
        width: 100%;
    }
}
    
    /* Bo lại góc dưới của ảnh khi info hiện ra để liền mạch */
    .video-card:hover .card-image-wrapper {
        border-radius: 6px 6px 0 0;
    }
}
            .skeleton-card {
                background-color: #2a2a2a;
                animation: pulse 1.5s infinite ease-in-out;
            }
            @keyframes pulse {
                0% {
                    background-color: #2a2a2a;
                }
                50% {
                    background-color: #3a3a3a;
                }
                100% {
                    background-color: #2a2a2a;
                }
            }

            /* --- Modals --- */
            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
                z-index: 2000;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            .modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .modal-content {
                background-color: var(--primary-bg);
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                transform: scale(0.95);
                transition: transform 0.3s ease;
                position: relative;
                display: flex;
                flex-direction: column;
                max-height: 90vh;
            }
            .modal-overlay.visible .modal-content {
                transform: scale(1);
            }
            .modal-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(20, 20, 20, 0.7);
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
                fill: white;
                z-index: 10;
            }
            #detail-modal-content {
                width: 100%;
                max-width: 800px;
            }
            #modal-header {
                position: relative;
                aspect-ratio: 16 / 9;
                flex-shrink: 0;
            }
            #modal-thumbnail {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px 8px 0 0;
            }
            #modal-header::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50%;
                background: linear-gradient(to top, var(--primary-bg) 20%, transparent 100%);
                pointer-events: none;
            }
            #modal-play-btn {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.9);
                color: #000;
                border: none;
                border-radius: 5px;
                padding: 10px 25px;
                font-size: 1.2rem;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 5;
            }
            #modal-play-btn svg {
                width: 24px;
                height: 24px;
            }
            #modal-body {
                padding: 20px 30px 30px 30px;
                overflow-y: auto;
            }
            #modal-title {
                font-size: clamp(1.5rem, 4vw, 2.2rem);
                font-weight: 700;
                margin: 0 0 15px 0;
            }
            #modal-meta {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 20px;
                color: #aaa;
            }
            #modal-participants-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 10px;
            }
            #modal-participants-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                list-style: none;
                padding: 0;
            }
            .participant-tag {
                background-color: var(--secondary-bg);
                padding: 5px 12px;
                border-radius: 4px;
                font-size: 0.9rem;
            }
            #modal-genres-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                list-style: none;
                padding: 0;
                margin: 0 0 20px 0;
            }
            .genre-tag {
                background-color: #333;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 0.85rem;
                color: #ccc;
            }
            #modal-description {
                color: #bbb;
                line-height: 1.6;
                margin-bottom: 25px;
                font-size: 0.95rem;
            }
            #add-video-modal-content {
                width: 90%;
                max-width: 500px;
                padding: 30px;
            }
            #youtube-url-input {
                width: 100%;
                box-sizing: border-box;
                background-color: var(--secondary-bg);
                color: var(--text-color);
                border: 1px solid #444;
                border-radius: 4px;
                padding: 15px;
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            #srt-file-label {
                display: block;
                width: 100%;
                box-sizing: border-box;
                background-color: var(--secondary-bg);
                border: 1px dashed #555;
                border-radius: 4px;
                padding: 15px;
                font-size: 1rem;
                margin-bottom: 20px;
                text-align: center;
                cursor: pointer;
            }
            #srt-file-input {
                display: none;
            }
            #srt-file-name {
                color: #aaa;
                font-style: italic;
                display: block;
                margin-top: 5px;
            }
            #load-video-btn {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
                font-weight: 600;
                background-color: var(--accent-color);
                color: var(--text-light);
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            /* ================================================= */
            /* START: CSS CHO PLAYER V5 - PHIÊN BẢN HOÀN CHỈNH    */
            /* ================================================= */

            #player-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: #000;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 3000;
                color: white;
                cursor: default; /* Con trỏ mặc định */
            }
            #player-container.no-cursor {
                cursor: none; /* Ẩn con trỏ khi đang phát và control ẩn */
            }
            #youtube-player {
                position: absolute;
                width: 100%;
                height: 100%;
                border: none;
            }

            /* --- Base styles cho các lớp phủ --- */
            #video-header-overlay,
            #custom-controls,
            #center-play-pause-btn {
                opacity: 0;
                transition: opacity 0.25s ease-out;
                position: absolute;
                left: 0;
                width: 100%;
                box-sizing: border-box;
                pointer-events: none; /* Mặc định vô hiệu hóa */
            }

            /* --- Trạng thái hiển thị controls --- */
#player-container.controls-active > #video-header-overlay,
#player-container.controls-active > #custom-controls,
#player-container.controls-active > #center-play-pause-btn {
    opacity: 1;
    /* ĐÃ XÓA pointer-events: auto ở đây để click xuyên qua vùng trống */
}

/* Chỉ riêng nút Play khổng lồ ở giữa là cần nhận click toàn bộ */
#player-container.controls-active > #center-play-pause-btn {
    pointer-events: auto;
}

            /* --- Định vị và style cho các lớp phủ --- */
            #video-header-overlay {
                top: 0;
                padding: clamp(15px, 3vw, 30px) clamp(20px, 5vw, 60px);
                background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
                z-index: 12;
                display: flex;
                align-items: center;
                gap: 20px;
                pointer-events: none !important;
            }
            #video-title-container {
                overflow: hidden;
            }
            #video-title-display {
                font-size: clamp(0.7rem, 0.5vw, 1rem);
                font-weight: 600;
                margin: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            #back-btn {
                background: none;
                border: none;
                fill: white;
                cursor: pointer;
                width: 44px;
                height: 44px;
                padding: 0;
                flex-shrink: 0;
            }

            #custom-controls {
                bottom: 0;
                padding: 10px clamp(20px, 5vw, 60px);
                background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
                z-index: 12;
                pointer-events: none !important;
            }
            #video-header-overlay button, 
#custom-controls button,
#custom-controls input[type="range"] {
    pointer-events: auto;
    position: relative;
    z-index: 20; /* Đảm bảo nút luôn nằm trên cùng */
}

            /* Riêng cái khoảng trắng (spacer) phải cho click xuyên qua để bấm nút Skip Ad (thường nằm ở góc phải dưới) */
            .spacer {
                pointer-events: none;
            }
            #video-title-display,
#time-display,
#video-program-display,
.spacer {
    pointer-events: none;
}
            .progress-container {
                position: relative;
                width: 100%;
                margin-bottom: 8px;
            }
            #progress-bar {
                appearance: none;
                width: 100%;
                height: 4px;
                cursor: pointer;
                border-radius: 5px;
                transition: height 0.2s;
                background: linear-gradient(
                    to right,
                    var(--accent-color) 0%,
                    var(--accent-color) var(--progress-percent, 0%),
                    rgba(255, 255, 255, 0.3) var(--progress-percent, 0%),
                    rgba(255, 255, 255, 0.3) 100%
                );
            }
            #progress-bar:hover {
                height: 8px;
            }
            .controls-row {
                display: flex;
                align-items: center;
                gap: 20px;
            }
            .controls-row button {
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 5px;
            }
            .controls-row button svg {
                fill: white;
                width: 28px;
                height: 28px;
                display: block;
            }
            #time-display {
                font-size: 1rem;
                white-space: nowrap;
            }
            #video-program-display {
                margin: 0 15px;
                font-size: 0.9rem;
                color: #ccc;
                opacity: 0.8;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex-shrink: 1;
            }
            .spacer {
                flex-grow: 1;
            }

            #center-play-pause-btn {
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 70px;
                height: 70px;
                background: rgba(0, 0, 0, 0.4);
                border: 2px solid rgba(255, 255, 255, 0.5);
                border-radius: 50%;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                padding: 0;
                z-index: 15;
            }
            #center-play-pause-btn svg {
                fill: white;
                width: 40px;
                height: 40px;
            }

            /* --- Lớp phủ tương tác (luôn trong suốt) --- */
            #interaction-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
                display: flex;
            }
            #seek-backward-zone,
            #play-pause-zone,
            #seek-forward-zone {
                flex: 1;
            }

            /* --- Phụ đề, Settings, Up Next --- */
            #subtitle-display {
                position: absolute;
                bottom: 12%;
                left: 50%;
                transform: translateX(-50%);
                z-index: 20;
                max-width: 90%;
                padding: 8px 20px;
                text-align: center;
                border-radius: 6px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
                line-height: 1.5;
                font-weight: 500;
                background-color: rgba(0, 0, 0, 0.5);
                pointer-events: none;
                opacity: 0;
            }
            #subtitle-display:not(:empty) {
                opacity: 1;
            }

            #settings-menu {
                position: absolute;
                bottom: 80px;
                right: clamp(20px, 5vw, 60px);
                z-index: 30;
                background-color: rgba(20, 20, 20, 0.9);
                backdrop-filter: blur(5px);
                padding: 15px;
                border-radius: 8px;
                width: 280px;
                box-sizing: border-box;
                display: none;
                flex-direction: column;
                gap: 15px;
                opacity: 0;
                transform: translateY(10px);
                transition:
                    opacity 0.2s,
                    transform 0.2s;
            }
            #settings-menu.visible {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }
            .control-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 0.9rem;
                color: #ccc;
            }
            .control-group input[type="range"] {
                width: 100%;
            }
            .control-group input[type="color"] {
                width: 100%;
                height: 35px;
                border: none;
                padding: 0;
                background: none;
                cursor: pointer;
            }
            .video-title-inline {
                font-size: 1rem;
                color: #eee;
                margin: 0;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
                max-width: 40vw;
            }

            #up-next-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 40;
                background-color: rgba(0, 0, 0, 0.85);
                display: none;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
            }
            #up-next-overlay p {
                font-size: 1.2rem;
                color: #aaa;
                margin: 0;
            }
            #up-next-card {
                cursor: pointer;
                margin-top: 20px;
            }
            #up-next-thumbnail {
                width: 250px;
                aspect-ratio: 16/9;
                object-fit: cover;
                border-radius: 5px;
            }
            #up-next-title {
                margin: 10px 0 0 0;
                font-size: 1.4rem;
            }
            #up-next-cancel-btn {
                background: none;
                border: 1px solid #888;
                color: #ccc;
                padding: 8px 16px;
                border-radius: 4px;
                margin-top: 30px;
                cursor: pointer;
            }
            /* [MỚI] CSS cho Sidebar Danh sách tập */
            #episodes-sidebar {
                position: absolute;
                top: 0;
                right: 0;
                width: 350px; /* Độ rộng vừa phải */
                max-width: 80vw;
                height: 100%;
                background-color: rgba(20, 20, 20, 0.95);
                backdrop-filter: blur(10px);
                z-index: 25; /* Cao hơn video, thấp hơn settings */
                transform: translateX(100%); /* Mặc định ẩn sang phải */
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                flex-direction: column;
                border-left: 1px solid #333;
            }

            #episodes-sidebar.visible {
                transform: translateX(0); /* Trượt vào */
                pointer-events: auto;
            }

            #episodes-header {
                padding: 20px;
                border-bottom: 1px solid #333;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #episodes-header h3 {
                margin: 0;
                font-size: 1.2rem;
                color: #fff;
            }

            #close-episodes-btn {
                background: none;
                border: none;
                color: #ccc;
                font-size: 1.5rem;
                cursor: pointer;
                padding: 0 10px;
            }

            #episodes-content {
                flex: 1;
                overflow-y: auto;
                padding: 10px;
            }

            /* Style cho từng item tập phim */
            .episode-item {
                display: flex;
                gap: 10px;
                padding: 10px;
                border-radius: 4px;
                cursor: pointer;
                transition: background 0.2s;
                margin-bottom: 5px;
                align-items: center;
            }

            .episode-item:hover {
                background-color: #333;
            }

            .episode-item.playing {
                background-color: #e50914; /* Màu đỏ Netflix */
                color: white;
            }

            .episode-thumbnail {
                width: 120px;
                aspect-ratio: 16/9;
                object-fit: cover;
                border-radius: 3px;
                background: #000;
            }

            .episode-info {
                flex: 1;
                display: flex;
                flex-direction: column;
                justify-content: center;
            }

            .episode-title {
                font-size: 0.95rem;
                font-weight: 500;
                margin-bottom: 4px;
                display: -webkit-box;
                line-clamp: 2;
                -webkit-box-orient: vertical;
                overflow: hidden;
            }

            .episode-number {
                font-size: 0.8rem;
                color: #aaa;
            }
            .episode-item.playing .episode-number {
                color: #eee;
            }
            /* --- [MỚI] Badge số tập ở Library --- */
            .episode-badge {
                position: absolute;
                top: 8px;
                right: 8px;
                background-color: rgba(0, 0, 0, 0.7);
                color: #fff;
                padding: 2px 6px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 600;
                backdrop-filter: blur(4px);
                z-index: 5;
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            /* --- [MỚI] Marker trên thanh tiến trình --- */
            .timeline-marker {
                position: absolute;
                top: 0;
                width: 2px;
                height: 100%; /* Chiều cao bằng progress bar */
                background-color: rgba(255, 255, 255, 0.5);
                z-index: 2;
                pointer-events: none;
            }
            .timeline-marker:hover::after {
                content: attr(data-label);
                position: absolute;
                bottom: 15px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 12px;
                white-space: nowrap;
            }

            /* --- [MỚI] Nút Bỏ qua (Skip Intro) --- */
            #skip-btn {
                position: absolute;
                bottom: 150px; /* Cao hơn thanh control một chút */
                right: 0;
                background-color: #fff;
                color: #000;
                border: none;
                padding: 10px 20px;
                font-size: 1rem;
                font-weight: 700;
                border-radius: 4px; /* Bo góc kiểu Netflix */
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 50;
                opacity: 0;
                transform: translateX(100%); /* Ẩn sang phải */
                transition: all 0.3s ease;
                box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            }
            #skip-btn.visible {
                opacity: 1;
                transform: translateX(-20px); /* Trượt vào */
                pointer-events: auto;
            }
            #skip-btn:hover {
                background-color: #e6e6e6;
            }
            /* ========================================= */
            /* END: CSS CHO PLAYER V5                    */
            /* ========================================= */
            #modal-original-title {
                margin: -10px 0 15px 0; /* Kéo sát lên tên chính một chút */
                font-size: 1rem;
                font-weight: 400;
                color: #888; /* Màu xám nhạt cho đỡ rối */
                font-style: italic; /* In nghiêng cho "nghệ" */
            }
        </style>
    </head>
    <body>
        <main>
            <header id="page-header">
                <h1 id="main-title">Khám Phá</h1>
                <div id="actions-container">
                    <div id="search-container">
                        <svg id="search-icon" viewBox="0 0 24 24">
                            <path
                                d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"
                            />
                        </svg>
                        <input type="text" id="search-input" placeholder="Tìm theo tiêu đề, người tham gia..." />
                    </div>
                    <button id="add-video-btn" title="Xem video từ link">
                        <svg viewBox="0 0 24 24" width="24" height="24">
                            <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" />
                        </svg>
                    </button>
                </div>
            </header>
            <div id="filter-tags"><span class="filter-tag active" data-filter="Tất cả">Tất cả</span></div>
            <div id="library-container">
                <section class="program-row">
                    <div class="video-list">
                        <div class="video-card skeleton-card"></div>
                        <div class="video-card skeleton-card"></div>
                        <div class="video-card skeleton-card"></div>
                    </div>
                </section>
            </div>
       

        <div id="detail-modal-overlay" class="modal-overlay hidden">
            <div id="detail-modal-content" class="modal-content">
                <button id="detail-modal-close-btn" class="modal-close-btn" title="Đóng">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                        ></path>
                    </svg>
                </button>
                <header id="modal-header">
                    <img id="modal-thumbnail" src="" alt="Video thumbnail" />
                    <button id="modal-play-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg
                        >Phát
                    </button>
                </header>
                <div id="modal-body">
                    <h3 id="modal-title"></h3>
                    <h4 id="modal-original-title"></h4>
                    <div id="modal-meta">
                        <span id="modal-program"></span>
                        <span id="modal-author"></span>
                    </div>
                    <!-- Chỗ chứa mới cho thể loại -->
                    <div id="modal-genres-container" class="hidden">
                        <ul id="modal-genres-list"></ul>
                    </div>
                    <!-- Chỗ chứa mới cho mô tả -->
                    <p id="modal-description"></p>
                    <div id="modal-episodes-section" class="hidden">
    <h4>Danh sách tập</h4>
    <div id="modal-episodes-list"></div>
</div>
                    <div id="modal-participants-container" class="hidden">
                        <h4 id="modal-participants-title">Với sự tham gia của:</h4>
                        <ul id="modal-participants-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="add-video-modal-overlay" class="modal-overlay hidden">
            <div id="add-video-modal-content" class="modal-content">
                <button id="add-video-close-btn" class="modal-close-btn" title="Đóng">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path
                            d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"
                        ></path>
                    </svg>
                </button>
                <form id="add-video-form">
                    <h3>Xem video từ link</h3>
                    <input type="text" id="youtube-url-input" placeholder="Dán link YouTube vào đây..." required />
                    <label for="srt-file-input" id="srt-file-label"
                        >Chọn file phụ đề (.srt)<span id="srt-file-name"></span
                    ></label>
                    <input type="file" id="srt-file-input" accept=".srt" />
                    <button type="submit" id="load-video-btn">Tải và Phát</button>
                </form>
            </div>
        </div>

        <div id="player-wrapper" class="hidden">
            <!-- START: Cấu trúc Player HOÀN CHỈNH v5 -->
            <div id="player-container">
                <div id="youtube-player"></div>

                <!-- Header -->
                <div id="video-header-overlay">
                    <button id="back-btn" title="Quay lại">
                        <svg viewBox="0 0 24 24">
                            <path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path>
                        </svg>
                    </button>
                </div>

                <!-- Vùng tương tác chính (nằm ở giữa) -->
                <div id="interaction-overlay">
                    <div id="seek-backward-zone"></div>
                    <div id="play-pause-zone"></div>
                    <div id="seek-forward-zone"></div>
                </div>

                <!-- Nút Play/Pause lớn (nằm riêng biệt, ở giữa) -->
                <button id="center-play-pause-btn">
                    <svg id="center-play-pause-icon" viewBox="0 0 24 24">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path>
                    </svg>
                </button>

                <!-- Phụ đề -->
                <div id="subtitle-display"></div>

                <!-- Thanh điều khiển dưới -->
                <div id="custom-controls">
                    <div class="progress-container">
                        <input type="range" id="progress-bar" value="0" min="0" />
                    </div>
                    <div class="controls-row">
                        <button id="play-pause-btn">
                            <svg><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>
                        </button>

                        <div id="time-display">00:00 / 00:00</div>
                        <p id="video-program-display"></p>
                        <p id="video-title-display" class="video-title-inline"></p>

                        <div class="spacer"></div>

                        <button id="episodes-btn" title="Danh sách tập" class="hidden">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                                <path d="M4,10H20V12H4V10M4,6H20V8H4V6M4,14H14V16H4V14M16,13V21L22,17L16,13Z" />
                            </svg>
                        </button>

                        <button id="settings-btn" title="Cài đặt Phụ đề">
                            <svg viewBox="0 0 24 24" width="28" height="28" fill="white">
                                <path
                                    d="M19.14,12.94C19.07,12.44 19,11.94 19,11.44C19,10.94 19.07,10.44 19.14,9.94L21.12,8.44C21.26,8.33 21.3,8.14 21.24,7.96L19.28,4.5C19.21,4.34 19.02,4.27 18.86,4.34L16.5,5.39C16,4.94 15.43,4.56 14.81,4.29L14.47,2.05C14.45,1.86 14.28,1.71 14.08,1.71H9.92C9.72,1.71 9.55,1.86 9.53,2.05L9.19,4.29C8.57,4.56 8,4.94 7.5,5.39L5.14,4.34C4.98,4.27 4.79,4.34 4.72,4.5L2.76,7.96C2.7,8.14 2.74,8.33 2.88,8.44L4.86,9.94C4.93,10.44 5,10.94 5,11.44C5,11.94 4.93,12.44 4.86,12.94L2.88,14.44C2.74,14.56 2.7,14.75 2.76,14.93L4.72,18.39C4.79,18.55 4.98,18.62 5.14,18.54L7.5,17.5C8,17.94 8.57,18.32 9.19,18.59L9.53,20.84C9.55,21.03 9.72,21.18 9.92,21.18H14.08C14.28,21.18 14.45,21.03 14.47,20.84L14.81,18.59C15.43,18.32 16,17.94 16.5,17.5L18.86,18.54C19.02,18.62 19.21,18.55 19.28,18.39L21.24,14.93C21.3,14.75 21.26,14.56 21.12,14.44L19.14,12.94M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <div id="episodes-sidebar">
                    <div id="episodes-header">
                        <h3>Danh sách tập</h3>
                        <button id="close-episodes-btn">✕</button>
                    </div>
                    <div id="episodes-content"></div>
                </div>

                <div id="settings-menu">
                    <div class="control-group">
                        <label for="font-size-slider">Kích thước chữ</label
                        ><input type="range" id="font-size-slider" min="12" max="48" step="1" />
                    </div>
                    <div class="control-group">
                        <label for="font-color-picker">Màu chữ</label><input type="color" id="font-color-picker" />
                    </div>
                    <div class="control-group">
                        <label for="bg-color-picker">Màu nền</label><input type="color" id="bg-color-picker" />
                    </div>
                    <div class="control-group">
                        <label for="bg-opacity-slider">Độ mờ nền</label
                        ><input type="range" id="bg-opacity-slider" min="0" max="1" step="0.05" />
                    </div>
                </div>
                <button id="skip-btn" class="hidden">
                    Bỏ qua giới thiệu
                    <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
                        <path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"></path>
                    </svg>
                </button>
                <!-- "Up Next" Overlay -->
                <div id="up-next-overlay">
                    <p>Tập tiếp theo sau <span id="up-next-countdown">5</span></p>
                    <div id="up-next-card">
                        <img id="up-next-thumbnail" src="" />
                        <h3 id="up-next-title"></h3>
                    </div>
                    <button id="up-next-cancel-btn">Hủy</button>
                </div>
            </div>
            <!-- END: Cấu trúc Player HOÀN CHỈNH v5 -->
        </div>
        <div id="notification-area"></div>
         </main>
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
            const doc = document;
            // --- DOM Elements ---
            const libraryContainer = doc.getElementById("library-container");
            const searchInput = doc.getElementById("search-input");
            const filterTagsContainer = doc.getElementById("filter-tags");
            const addVideoBtn = doc.getElementById("add-video-btn");
            const detailModalOverlay = doc.getElementById("detail-modal-overlay");
            const detailModalCloseBtn = doc.getElementById("detail-modal-close-btn");
            const modalPlayBtn = doc.getElementById("modal-play-btn");
            const modalThumbnail = doc.getElementById("modal-thumbnail");
            const modalTitle = doc.getElementById("modal-title");
            const modalProgram = doc.getElementById("modal-program");
            const modalAuthor = doc.getElementById("modal-author");
            const modalParticipantsList = doc.getElementById("modal-participants-list");
            const modalParticipantsContainer = doc.getElementById("modal-participants-container");
            const addVideoModalOverlay = doc.getElementById("add-video-modal-overlay");
            const addVideoForm = doc.getElementById("add-video-form");
            const addVideoCloseBtn = doc.getElementById("add-video-close-btn");
            const urlInput = doc.getElementById("youtube-url-input");
            const srtFileInput = doc.getElementById("srt-file-input");
            const srtFileName = doc.getElementById("srt-file-name");
            const playerWrapper = doc.getElementById("player-wrapper");
            const playerContainer = doc.getElementById("player-container");
            const clickOverlay = doc.getElementById("click-overlay");
            const backBtn = doc.getElementById("back-btn");
            const videoTitleDisplay = doc.getElementById("video-title-display");
            const videoProgramDisplay = doc.getElementById("video-program-display");
            const subtitleDisplay = doc.getElementById("subtitle-display");
            const settingsBtn = doc.getElementById("settings-btn");
            const settingsMenu = doc.getElementById("settings-menu");
            const fontSizeSlider = doc.getElementById("font-size-slider");
            const fontColorPicker = doc.getElementById("font-color-picker");
            const bgColorPicker = doc.getElementById("bg-color-picker");
            const bgOpacitySlider = doc.getElementById("bg-opacity-slider");
            const playPauseBtn = doc.getElementById("play-pause-btn");
            const progressBar = doc.getElementById("progress-bar");
            const episodesBtn = doc.getElementById("episodes-btn");
            const episodesSidebar = doc.getElementById("episodes-sidebar");
            const episodesContent = doc.getElementById("episodes-content");
            const closeEpisodesBtn = doc.getElementById("close-episodes-btn");
            const skipBtn = doc.getElementById("skip-btn");
            const modalOriginalTitle = doc.getElementById("modal-original-title");
            // --- State Variables ---
            let player;
            let libraryData = [];
            let subtitles = [];
            let controlsTimeout, progressInterval, subtitleCheckInterval;
            let subtitleSettings = {};
            let currentVideoData = null; // Lưu thông tin video đang phát
            let upNextTimeout, upNextInterval; // Dùng cho tính năng "Tập tiếp theo"
            let lastClickInfo = { time: 0, area: null }; // Dùng để phát hiện double-click THEO VÙNG
            let isEnding = false; // Cờ để chống lặp khi video kết thúc
            let currentSkipTarget = null; // Thời điểm bỏ qua hiện tại
            const DEFAULT_SUB_SETTINGS = { fontSize: "24", fontColor: "#FFFFFF", bgColor: "#000000", bgOpacity: "0.5" };

            // --- Initialization ---
            function onYouTubeIframeAPIReady() {
                player = new YT.Player("youtube-player", {
                    videoId: "", // chưa có video thực, khởi tạo rỗng
                    playerVars: {
                        autoplay: 0,
                        playsinline: 1,
                        rel: 0,
                        modestbranding: 1,
                        controls: 0,
                        showinfo: 0,
                        iv_load_policy: 3,
                    },
                    events: {
                        onReady: () => {
                            initializeLibrary(); // gọi sau khi player đã sẵn sàng
                        },
                        onStateChange: onPlayerStateChange,
                    },
                });
            }

            async function initializeLibrary() {
                try {
                    // FIX: Always fetch a fresh JSON file, disable caching
                    const res = await fetch("library.json", { cache: "no-cache" });
                    if (!res.ok) throw new Error("Không thể tải thư viện.");
                    libraryData = await res.json();
                    renderVideoRows(libraryData);
                    populateFilterTags();
                    setupEventListeners();
                    loadSubtitleSettings();
                } catch (e) {
                    libraryContainer.innerHTML = `<p style="color: #ff8a8a; text-align: center;">Lỗi: ${e.message}</p>`;
                }
            }

    
            function populateFilterTags() {
    filterTagsContainer.innerHTML = '';
    // Thêm nút "Tất cả" đầu tiên
    const allTag = document.createElement("span");
    allTag.className = "filter-tag active";
    allTag.dataset.filter = "Tất cả";
    allTag.textContent = "Tất cả";
    filterTagsContainer.appendChild(allTag);

    // Lấy danh sách thể loại duy nhất
    const allGenres = [...new Set(libraryData.flatMap((v) => v.genres || []))].sort();
    
    allGenres.forEach((genre) => {
        const tag = document.createElement("span");
        tag.className = "filter-tag";
        tag.textContent = genre;
        tag.dataset.filter = genre; // Lưu tên thể loại vào data
        filterTagsContainer.appendChild(tag);
    });
}

/* --- [HÀM PHỤ] Tạo HTML cho thẻ Video (để tái sử dụng) --- */
/* --- [CẬP NHẬT] createVideoCardHtml với Anchor Positioning --- */
function createVideoCardHtml(video) {
    const episodeBadge = video.episode 
        ? `<div class="episode-badge">EP ${video.episode}</div>` 
        : "";
    const displayGenre = (video.genres && video.genres.length > 0) ? video.genres[0] : "";
    const thumbUrl = video.thumbnailUrl || video.thumbnailUrl_auto;
    const title = video.userTitle || video.title;

    // TẠO UNIQUE ID CHO ANCHOR (Quan trọng)
    // Dùng videoId làm định danh duy nhất.
    // CSS variable --anchor-name sẽ được truyền xuống style.
    const uniqueAnchorName = `--anchor-${video.videoId}`;

    return `
    <div class="video-card" 
         data-video-id="${video.videoId}" 
         style="anchor-name: ${uniqueAnchorName}; --target-anchor: ${uniqueAnchorName};">
         
        <div class="card-image-wrapper">
            ${episodeBadge}
            <img src="${thumbUrl}" alt="${title}" class="video-thumbnail" loading="lazy">
        </div>

        <div class="card-info">
            <div class="card-title">${title}</div>
            <div class="card-meta">
                <span class="card-ep">${video.episode ? 'Tập ' + video.episode : 'Video lẻ'}</span>
                <span class="card-genre">${displayGenre}</span>
            </div>
        </div>
    </div>
    `;
}

/* --- LOGIC RENDER MỚI: GROUP BY PROGRAM & CAROUSEL --- */

// Helper: Lấy điểm thời gian (để sort)
const getDateScore = (v) => {
    if (v.uploadDate_auto) return new Date(v.uploadDate_auto).getTime();
    return 0;
};

/* --- LOGIC RENDER MỚI: TỰ ĐỘNG TẠO HÀNG THEO THỂ LOẠI (GENRES) --- */
function renderVideoRows(videoArray) {
    libraryContainer.innerHTML = ""; // Xóa sạch cũ
    if (videoArray.length === 0) {
        libraryContainer.innerHTML = `<p style="text-align: center; margin-top: 50px;">Không tìm thấy video nào.</p>`;
        return;
    }

    // --- BƯỚC 1: XỬ LÝ DỮ LIỆU ---
    const programsMap = {}; // Chứa các series (Gom nhóm)
    const singleVideos = []; // Chứa video lẻ

    videoArray.forEach(video => {
        const progName = video.program;
        if (!progName) {
            singleVideos.push(video);
        } else {
            if (!programsMap[progName]) {
                programsMap[progName] = {
                    type: 'program',
                    title: progName,
                    videos: [],
                    genres: new Set(),
                    latestUpdate: 0,
                    thumbnailVideo: null
                };
            }
            programsMap[progName].videos.push(video);
            programsMap[progName].genres.add(...(video.genres || []));
            
            // Cập nhật thời gian để sort
            const score = getDateScore(video);
            if (score > programsMap[progName].latestUpdate) {
                programsMap[progName].latestUpdate = score;
            }
        }
    });

    // Sort video trong từng program để lấy thumbnail mới nhất
    Object.values(programsMap).forEach(prog => {
        prog.videos.sort((a, b) => (b.episode || 0) - (a.episode || 0));
        prog.thumbnailVideo = prog.videos[0]; 
    });

    const allPrograms = Object.values(programsMap);

    // --- BƯỚC 2: RENDER HÀNG "MỚI CẬP NHẬT" (Trộn cả Program & Video lẻ mới nhất) ---
    // Lấy top 10 cái mới nhất bất kể là lẻ hay bộ
    const mixedLatest = [...allPrograms, ...singleVideos]
        .sort((a, b) => {
            const timeA = a.type === 'program' ? a.latestUpdate : getDateScore(a);
            const timeB = b.type === 'program' ? b.latestUpdate : getDateScore(b);
            return timeB - timeA;
        })
        .slice(0, 15); // Lấy 15 cái mới nhất

    // Render hàng Video
    const latestCards = mixedLatest.map(item => {
        return item.type === 'program' ? createProgramCard(item) : createVideoCardHtml(item);
    });
    
    if (latestCards.length > 0) {
        createCarouselSection("🔥 Mới & Nổi bật", latestCards);
    }

    // --- BƯỚC 3: TỰ ĐỘNG QUÉT VÀ TẠO HÀNG CHO TỪNG THỂ LOẠI ---
    // Lấy danh sách tất cả thể loại duy nhất
    const allGenres = [...new Set(videoArray.flatMap(v => v.genres || []))].sort();

    allGenres.forEach(genre => {
        // 1. Tìm các Program thuộc thể loại này
        const progsInGenre = allPrograms.filter(p => p.genres.has(genre));
        
        // 2. Tìm các Video lẻ thuộc thể loại này
        const videosInGenre = singleVideos.filter(v => v.genres && v.genres.includes(genre));

        // 3. Gộp lại
        const itemsInGenre = [...progsInGenre, ...videosInGenre];

        // Nếu có nội dung thì mới vẽ ra hàng
        if (itemsInGenre.length > 0) {
            // Sort nội dung trong hàng này (Mới nhất lên đầu)
            itemsInGenre.sort((a, b) => {
                 const timeA = a.type === 'program' ? a.latestUpdate : getDateScore(a);
                 const timeB = b.type === 'program' ? b.latestUpdate : getDateScore(b);
                 return timeB - timeA;
            });

            // Tạo HTML cho card
            const cardsHtml = itemsInGenre.map(item => {
                return item.type === 'program' ? createProgramCard(item) : createVideoCardHtml(item);
            });

            createCarouselSection(genre, cardsHtml);
        }
    });

    // --- BƯỚC 4: HÀNG DÀNH RIÊNG CHO VIDEO LẺ (Nếu muốn tách biệt) ---
    // (Optional: Nếu bạn thích có 1 hàng chuyên video lẻ ở cuối cùng)
    /*
    if (singleVideos.length > 0) {
        const singleCards = singleVideos.map(v => createVideoCardHtml(v));
        createCarouselSection("🎬 Phim & Video Lẻ", singleCards);
    }
    */
}

// Hàm tạo HTML cho 1 Row (Carousel)
function createCarouselSection(title, cardsHtmlArray) {
    if (cardsHtmlArray.length === 0) return;
    const section = doc.createElement("section");
    section.className = "program-row";
    section.innerHTML = `
        <h2 class="program-title">${title}</h2>
        <div class="video-list">
            ${cardsHtmlArray.join("")}
        </div>
    `;
    libraryContainer.appendChild(section);
}

// Hàm tạo HTML thẻ Program (Khác thẻ Video một chút)
function createProgramCard(program) {
    const video = program.thumbnailVideo; // Dùng video mới nhất làm ảnh bìa
    const thumbUrl = video.thumbnailUrl || video.thumbnailUrl_auto;
    // Hiển thị số lượng tập
    const episodeCount = program.videos.length;
    const badge = `<div class="episode-badge">${episodeCount} Tập</div>`;
    const displayGenre = program.genres.size > 0 ? Array.from(program.genres)[0] : "";

    // Lưu program-name vào data attribute để click handler xử lý
    return `
    <div class="video-card program-card" data-program-name="${program.title}">
        <div class="card-image-wrapper">
            ${badge}
            <img src="${thumbUrl}" alt="${program.title}" class="video-thumbnail" loading="lazy">
        </div>
        <div class="card-info">
            <div class="card-title">${program.title}</div>
            <div class="card-meta">
                <span class="card-ep">Cập nhật mới nhất</span>
                <span class="card-genre">${displayGenre}</span>
            </div>
        </div>
    </div>
    `;
}

// --- Event Handling ---
          
          
            function setupEventListeners() {
                // ... các event listener từ đầu đến backBtn giữ nguyên ...
                searchInput.addEventListener("input", handleSearchAndFilter);
                filterTagsContainer.addEventListener("click", handleTagClick);
                libraryContainer.addEventListener("click", handleCardClick);
                detailModalCloseBtn.addEventListener("click", () => closeModal(detailModalOverlay));
                detailModalOverlay.addEventListener("click", (e) => {
                    if (e.target === detailModalOverlay) closeModal(detailModalOverlay);
                });
                modalPlayBtn.addEventListener("click", handleModalPlay);
                addVideoBtn.addEventListener("click", () => openModal(addVideoModalOverlay));
                addVideoCloseBtn.addEventListener("click", () => closeModal(addVideoModalOverlay));
                addVideoModalOverlay.addEventListener("click", (e) => {
                    if (e.target === addVideoModalOverlay) closeModal(addVideoModalOverlay);
                });
                addVideoForm.addEventListener("submit", handleAddVideoSubmit);
                srtFileInput.addEventListener("change", () => {
                    srtFileName.textContent = srtFileInput.files.length > 0 ? srtFileInput.files[0].name : "";
                });
                backBtn.addEventListener("click", goHome);

                // --- LOGIC TƯƠNG TÁC PLAYER MỚI ---
                const interactionOverlay = document.getElementById("interaction-overlay");
                interactionOverlay.addEventListener("pointerup", handleInteraction);
                doc.getElementById("center-play-pause-btn").addEventListener("click", (e) => {
                    e.stopPropagation();
                    togglePlayPause();
                });
                playPauseBtn.addEventListener("click", togglePlayPause);
                progressBar.addEventListener("input", handleSeek); // ✅ Fix chuẩn

                // --- CÁC EVENT LISTENER KHÁC ---
                playerContainer.addEventListener("mousemove", showControlsAndSetHideTimeout);
                doc.addEventListener("keydown", handleKeyboardShortcuts);
                doc.addEventListener("fullscreenchange", () => {
                    if (!document.fullscreenElement) goHome();
                });
                settingsBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    const menu = doc.getElementById("settings-menu");
                    const isVisible = menu.style.display === "flex";
                    menu.style.display = isVisible ? "none" : "flex";
                    setTimeout(() => {
                        menu.classList.toggle("visible", !isVisible);
                    }, 10);
                });
                doc.addEventListener("click", (e) => {
                    const menu = doc.getElementById("settings-menu");
                    if (
                        menu.classList.contains("visible") &&
                        !menu.contains(e.target) &&
                        !settingsBtn.contains(e.target)
                    ) {
                        menu.classList.remove("visible");
                        setTimeout(() => {
                            menu.style.display = "none";
                        }, 200);
                    }
                });
                // ... các event listener của subtitle settings và drag-drop giữ nguyên ...
                fontSizeSlider.addEventListener("input", () => {
                    subtitleSettings.fontSize = fontSizeSlider.value;
                    applyAndSaveSubtitleStyles();
                });
                fontColorPicker.addEventListener("input", () => {
                    subtitleSettings.fontColor = fontColorPicker.value;
                    applyAndSaveSubtitleStyles();
                });
                bgColorPicker.addEventListener("input", () => {
                    subtitleSettings.bgColor = bgColorPicker.value;
                    applyAndSaveSubtitleStyles();
                });
                bgOpacitySlider.addEventListener("input", () => {
                    subtitleSettings.bgOpacity = bgOpacitySlider.value;
                    applyAndSaveSubtitleStyles();
                });
                doc.body.addEventListener("dragover", (e) => {
                    if (playerWrapper.classList.contains("hidden")) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "copy";
                });
                doc.body.addEventListener("drop", (e) => {
                    if (playerWrapper.classList.contains("hidden")) return;
                    e.preventDefault();
                    handleFileDrop(e);
                });
                skipBtn.addEventListener("click", handleSkipClick);

                episodesBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    toggleEpisodesSidebar();
                });
                closeEpisodesBtn.addEventListener("click", () => {
                    episodesSidebar.classList.remove("visible");
                });
                // Đóng sidebar khi click ra ngoài (vào vùng player)
                playerContainer.addEventListener("click", (e) => {
                    // Nếu click không trúng sidebar và không trúng nút mở thì đóng
                    if (
                        episodesSidebar.classList.contains("visible") &&
                        !episodesSidebar.contains(e.target) &&
                        !episodesBtn.contains(e.target)
                    ) {
                        episodesSidebar.classList.remove("visible");
                    }
                });
            }
            // 3. Hàm logic mới
            function toggleEpisodesSidebar() {
                const isVisible = episodesSidebar.classList.contains("visible");
                if (isVisible) {
                    episodesSidebar.classList.remove("visible");
                } else {
                    renderEpisodeList();
                    episodesSidebar.classList.add("visible");
                }
            }

            function renderEpisodeList() {
                episodesContent.innerHTML = "";

                // Nếu không có video đang phát hoặc không thuộc chương trình nào -> Báo lỗi hoặc ẩn
                if (!currentVideoData || !currentVideoData.program) {
                    episodesContent.innerHTML =
                        "<p style='padding:20px; text-align:center; color:#777'>Không có danh sách tập.</p>";
                    return;
                }

                // Lọc các tập cùng chương trình
                const episodes = libraryData
                    .filter((v) => v.program === currentVideoData.program)
                    .sort((a, b) => (a.episode || 0) - (b.episode || 0)); // Sắp xếp theo số tập

                if (episodes.length <= 1) {
                    episodesContent.innerHTML =
                        "<p style='padding:20px; text-align:center; color:#777'>Đây là video lẻ.</p>";
                    return;
                }

                episodes.forEach((ep) => {
                    const isCurrent = ep.videoId === currentVideoData.videoId;

                    const item = document.createElement("div");
                    item.className = `episode-item ${isCurrent ? "playing" : ""}`;

                    // Thumbnail tập
                    const thumbUrl = ep.thumbnailUrl || ep.thumbnailUrl_auto;

                    item.innerHTML = `
            <img src="${thumbUrl}" class="episode-thumbnail" loading="lazy" />
            <div class="episode-info">
                <span class="episode-number">Tập ${ep.episode || "?"}</span>
                <span class="episode-title">${ep.userTitle || ep.title}</span>
            </div>
        `;

                    item.onclick = () => {
                        if (isCurrent) return; // Đang xem tập này rồi thì thôi
                        episodesSidebar.classList.remove("visible"); // Đóng sidebar
                        launchPlayer(ep); // Phát tập mới
                    };

                    episodesContent.appendChild(item);
                });
            }
  /* --- [CẬP NHẬT] Logic lọc mới --- */
function handleSearchAndFilter() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const activeTag = doc.querySelector(".filter-tag.active");
    // Lấy giá trị filter hiện tại
    const filterTerm = activeTag && activeTag.dataset.filter !== "Tất cả" ? activeTag.dataset.filter : null;

    const filteredData = libraryData.filter(
        (video) => {
            // Logic tìm kiếm text (Search bar)
            const matchesSearch = 
                searchTerm === "" ||
                (video.userTitle || video.title).toLowerCase().includes(searchTerm) ||
                (video.program || "").toLowerCase().includes(searchTerm) ||
                (video.participants || []).some((p) => p.toLowerCase().includes(searchTerm)); // Vẫn cho tìm theo tên người

            // Logic lọc theo Thẻ (Genres) - ĐÃ SỬA
            const matchesFilter = 
                !filterTerm || 
                (video.genres && video.genres.includes(filterTerm));

            return matchesSearch && matchesFilter;
        }
    );
    renderVideoRows(filteredData);
}
            function handleTagClick(e) {
                if (e.target.classList.contains("filter-tag")) {
                    doc.querySelectorAll(".filter-tag").forEach((tag) => tag.classList.remove("active"));
                    e.target.classList.add("active");
                    handleSearchAndFilter();
                }
            }
            function handleCardClick(e) {
    const card = e.target.closest(".video-card");
    if (!card) return;

    // Trường hợp 1: Click vào Thẻ Chương Trình (Program Card)
    if (card.dataset.programName) {
        const progName = card.dataset.programName;
        // Lấy lại danh sách video của chương trình này từ libraryData
        const videos = libraryData
            .filter(v => v.program === progName)
            .sort((a, b) => (b.episode || 0) - (a.episode || 0)); // Sort tập mới nhất lên đầu
        
        if (videos.length > 0) {
            // Mở modal với thông tin của video mới nhất, nhưng truyền thêm danh sách tập
            openDetailModal(videos[0], videos); 
        }
    } 
    // Trường hợp 2: Click vào Video Lẻ (Video Card thường)
    else if (card.dataset.videoId) {
        const videoId = card.dataset.videoId;
        const videoData = libraryData.find((v) => v.videoId === videoId);
        if (videoData) openDetailModal(videoData, null); // null nghĩa là không có list tập
    }
}
            function handleModalPlay() {
                const videoId = modalPlayBtn.dataset.videoId;
                const videoData = libraryData.find((v) => v.videoId === videoId);
                if (videoData) {
                    closeModal(detailModalOverlay);

                    launchPlayer(videoData).then(() => {
                        if (player && typeof player.playVideo === "function") {
                            player.playVideo(); // <-- phát ngay vì là user gesture
                        }
                    });
                }
            }

            function handleAddVideoSubmit(e) {
                e.preventDefault();
                const videoId = extractVideoID(urlInput.value);
                if (!videoId) {
                    alert("Link YouTube không hợp lệ.");
                    return;
                }
                const srtFile = srtFileInput.files[0];
                if (srtFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        launchPlayer({ videoId }, parseSRT(event.target.result));
                    };
                    reader.readAsText(srtFile);
                } else {
                    launchPlayer({ videoId });
                }
                closeModal(addVideoModalOverlay);
                urlInput.value = "";
                srtFileInput.value = "";
                srtFileName.textContent = "";
            }

            function handleFileDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith(".srt")) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        subtitles = parseSRT(event.target.result);
                        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) startSubtitleSync();
                    };
                    reader.readAsText(file);
                }
            }
            function openModal(modal) {
                modal.classList.remove("hidden");
                setTimeout(() => modal.classList.add("visible"), 10);
            }
            function closeModal(modal) {
                modal.classList.remove("visible");
                setTimeout(() => modal.classList.add("hidden"), 300);
            }
/**
 * Mở modal chi tiết, có thể hiển thị danh sách tập nếu là một PROGRAM (Series).
 * @param {Object} videoData Dữ liệu của video/tập mới nhất được chọn.
 * @param {Array<Object> | null} programEpisodes Danh sách các tập của chương trình, nếu là Program Card.
 */
function openDetailModal(videoData, programEpisodes = null) {
    // 1. Lấy đúng ID từ HTML hiện tại
    const modalThumbnail = doc.getElementById("modal-thumbnail");
    const modalTitle = doc.getElementById("modal-title");
    const modalOriginalTitle = doc.getElementById("modal-original-title");
    const modalProgram = doc.getElementById("modal-program");
    const modalAuthor = doc.getElementById("modal-author");
    const modalDescription = doc.getElementById("modal-description");
    const modalPlayBtn = doc.getElementById("modal-play-btn");

    // SỬA: Lấy đúng ID list và container để xử lý ẩn/hiện
    const modalParticipantsList = doc.getElementById("modal-participants-list");
    const modalParticipantsContainer = doc.getElementById("modal-participants-container");
    
    const modalGenresList = doc.getElementById("modal-genres-list");
    const modalGenresContainer = doc.getElementById("modal-genres-container");
    
    const modalEpisodeSection = doc.getElementById("modal-episodes-section");
    const modalEpisodesList = doc.getElementById("modal-episodes-list");
    
    // 2. Xử lý thumbnail
    const thumbnailUrl = videoData.thumbnailUrl || videoData.thumbnailUrl_auto;
    modalThumbnail.src = thumbnailUrl.replace("hqdefault", "maxresdefault");
    modalThumbnail.onerror = () => { modalThumbnail.src = thumbnailUrl; };

    // 3. Xử lý TIÊU ĐỀ
    if (programEpisodes) {
        modalTitle.textContent = videoData.program;
        modalOriginalTitle.textContent = videoData.userTitle || videoData.title;
        modalOriginalTitle.style.display = "block";
    } else {
        modalTitle.textContent = videoData.userTitle || videoData.title;
        modalOriginalTitle.style.display = videoData.originalTitle_auto ? "block" : "none";
        if(videoData.originalTitle_auto) modalOriginalTitle.textContent = videoData.originalTitle_auto;
    }

    // 4. Các thông tin cơ bản
    modalProgram.textContent = videoData.program || "";
    modalAuthor.textContent = videoData.authorName || videoData.authorName_auto || "";
    modalDescription.textContent = videoData.description || "Chưa có mô tả chi tiết.";

    // 5. Xử lý GENRES (Sửa lỗi logic cũ)
    // HTML của bạn dùng <ul> nên ta render thẻ <li> hoặc text bên trong, và phải gỡ class hidden ở container
    modalGenresList.innerHTML = "";
    if (videoData.genres && videoData.genres.length > 0) {
        // Hiển thị dạng text đơn giản bên trong thẻ ul
        modalGenresList.innerHTML = `<span style="font-weight: 700; color: #fff; margin-right: 5px;">Thể loại:</span>` + 
                                    videoData.genres.map(g => `<span class="genre-tag">${g}</span>`).join(" ");
        modalGenresContainer.classList.remove("hidden"); // Quan trọng: Hiện container
    } else {
        modalGenresContainer.classList.add("hidden");
    }

    // 6. Xử lý PARTICIPANTS (Sửa lỗi logic cũ)
    modalParticipantsList.innerHTML = "";
    if (videoData.participants && videoData.participants.length > 0) {
        modalParticipantsList.innerHTML = videoData.participants.map(p => `<li class="participant-tag">${p}</li>`).join("");
        modalParticipantsContainer.classList.remove("hidden"); // Quan trọng: Hiện container
    } else {
        modalParticipantsContainer.classList.add("hidden");
    }
    
    // 7. Xử lý DANH SÁCH TẬP
    modalEpisodesList.innerHTML = "";
    if (programEpisodes && programEpisodes.length > 0) {
        modalEpisodeSection.classList.remove("hidden");
        
        programEpisodes.forEach(ep => {
            const el = doc.createElement("div");
            el.className = "modal-episode-item";
            const epThumb = ep.thumbnailUrl || ep.thumbnailUrl_auto;
            const isLatest = ep.videoId === videoData.videoId ? ' style="color: var(--accent-color); font-weight: 700;"' : '';

            // Tìm đoạn render html trong openDetailModal và thay bằng đoạn này:
el.innerHTML = `
    <img src="${epThumb}" class="modal-ep-thumb" loading="lazy">
    <div class="modal-ep-info">
        <div class="modal-ep-number"${isLatest}>Tập ${ep.episode || "N/A"}</div>
        <div class="modal-ep-title">${ep.userTitle || ep.title}</div>
    </div>
    <svg class="play-icon" viewBox="0 0 24 24" width="24" height="24">
        <path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path>
    </svg>
`;
            
            el.onclick = () => {
                closeModal(detailModalOverlay);
                launchPlayer(ep);
            };
            modalEpisodesList.appendChild(el);
        });

        modalPlayBtn.onclick = () => {
            closeModal(detailModalOverlay);
            launchPlayer(programEpisodes[0]);
        };

    } else {
        modalEpisodeSection.classList.add("hidden");
        modalPlayBtn.onclick = handleModalPlay; 
        modalPlayBtn.dataset.videoId = videoData.videoId;
    }

    // 8. Mở Modal
    openModal(detailModalOverlay);
}
// [THAY THẾ] Hàm vẽ vạch bookmark lên thanh tiến trình
            function renderBookmarksOverlay(bookmarks) {
                // 1. Xóa các marker cũ trên thanh progress
                const oldMarkers = document.querySelectorAll(".timeline-marker");
                oldMarkers.forEach((m) => m.remove());

                // 2. Ẩn nút skip cũ nếu có
                skipBtn.classList.remove("visible");

                const duration = player.getDuration?.() || 0;
                if (!duration || !bookmarks || bookmarks.length === 0) return;

                const progressContainer = document.querySelector(".progress-container");

                bookmarks.forEach((b) => {
                    const timeSec = srtTimeToSeconds(b.time);
                    const percent = (timeSec / duration) * 100;

                    // Tạo vạch trắng nhỏ trên thanh bar
                    const marker = document.createElement("div");
                    marker.className = "timeline-marker";
                    marker.style.left = `${percent}%`;
                    marker.setAttribute("data-label", b.label); // Để hover hiện tên

                    progressContainer.appendChild(marker);
                });
            }

            // [MỚI] Hàm xử lý click nút Skip
            function handleSkipClick(e) {
                e.stopPropagation();
                if (currentSkipTarget !== null) {
                    player.seekTo(currentSkipTarget, true);
                    skipBtn.classList.remove("visible");
                    // Update UI thanh bar ngay lập tức
                    updateProgressBarUI(currentSkipTarget, player.getDuration());
                }
            }

            async function launchPlayer(videoData, preloadedSubtitles = null) {
                return new Promise((resolve) => {
                    if (!videoData || !videoData.videoId) return;

                    currentVideoData = videoData;
                    const hasEpisodes = libraryData.some(
                        (v) => v.program === videoData.program && v.videoId !== videoData.videoId
                    );
                    if (hasEpisodes || (videoData.program && videoData.episode)) {
                        episodesBtn.classList.remove("hidden");
                    } else {
                        episodesBtn.classList.add("hidden");
                    }
                    isEnding = false;
                    hideUpNextOverlay();

                    subtitles = preloadedSubtitles || [];
                    subtitleDisplay.innerHTML = "";
                    playerWrapper.classList.remove("hidden");
                    videoTitleDisplay.textContent = videoData.userTitle || videoData.title || "Đang tải...";
                    renderBookmarksOverlay(videoData.bookmarks || []);

                    videoProgramDisplay.textContent = videoData.program || "";

                    enterCinematicMode().then(() => {
                        if (videoData.subtitleUrl) {
                            loadRemoteSubtitle(videoData.subtitleUrl);
                        } else if (subtitles.length > 0) {
                            startSubtitleSync();
                        }

                        // chỉ cần load video mới vào player đã khởi tạo
                        player.loadVideoById(videoData.videoId);
                        resolve();
                    });
                });
            }

            async function enterCinematicMode() {
                try {
                    if (playerContainer.requestFullscreen) await playerContainer.requestFullscreen();
                    if (screen.orientation && screen.orientation.lock) await screen.orientation.lock("landscape");
                } catch (err) {
                    console.warn("Lỗi cinematic:", err);
                }
            }
            function goHome() {
                if (player) player.stopVideo();
                playerWrapper.classList.add("hidden");
                if (document.fullscreenElement) document.exitFullscreen();
            }

            function onPlayerReady(event) {
                const apiData = event.target.getVideoData();
                videoTitleDisplay.textContent = apiData.title;
                // FIX: Force playVideo() call to maximize autoplay success
                event.target.playVideo();
            }

            function onPlayerStateChange(event) {
                const centerIcon = doc.getElementById("center-play-pause-icon");
                const playPauseIconPath =
                    event.data === YT.PlayerState.PLAYING
                        ? "M14,19H18V5H14M6,19H10V5H6V19Z"
                        : "M8,5.14V19.14L19,12.14L8,5.14Z";

                playPauseBtn.querySelector("svg path").setAttribute("d", playPauseIconPath);
                if (centerIcon) centerIcon.setAttribute("d", playPauseIconPath);

                if (event.data === YT.PlayerState.PLAYING) {
                    playerContainer.classList.add("playing");
                    doc.getElementById("center-play-pause-btn").style.opacity = "0"; // <<< FIX NÀY
                    startSyncing();
                    hideUpNextOverlay();
                    showControlsAndSetHideTimeout();
                } else {
                    playerContainer.classList.remove("playing");
                    stopSyncing();
                    // Khi pause/end/buffer, hiện controls và nút play giữa vĩnh viễn
                    clearTimeout(controlsTimeout);
                    playerContainer.classList.add("controls-active");
                    playerContainer.classList.remove("no-cursor");
                }

                if (event.data === YT.PlayerState.ENDED && !isEnding) {
                    handleVideoEnd();
                }
            }

            function handleInteraction(e) {
                const now = new Date().getTime();
                const timeSinceLastClick = now - lastClickInfo.time;
                const area = e.target.id;

                // Logic Double Click để tua
                if (timeSinceLastClick < 350 && area === lastClickInfo.area) {
                    const currentTime = player.getCurrentTime();
                    const duration = player.getDuration();
                    let newTime = currentTime;

                    if (area === "seek-backward-zone") {
                        newTime = Math.max(0, currentTime - 5);
                        player.seekTo(newTime, true);
                        startSubtitleSync();
                        updateProgressBarUI(newTime, duration); // Cập nhật UI ngay
                    } else if (area === "seek-forward-zone") {
                        newTime = Math.min(duration, currentTime + 5);
                        player.seekTo(newTime, true);
                        startSubtitleSync();
                        updateProgressBarUI(newTime, duration); // Cập nhật UI ngay
                    }
                    lastClickInfo = { time: 0, area: null }; // Reset
                }
                // Logic Single Click để hiện/ẩn controls
                else {
                    if (playerContainer.classList.contains("controls-active")) {
                        hideControls();
                    } else {
                        showControlsAndSetHideTimeout();
                    }
                }
                lastClickInfo = { time: now, area: area };
            }

            // FIX: Added function to handle seek
            function handleSeek() {
                const seekTime = parseFloat(progressBar.value);

                player.seekTo(seekTime, true);
                // Cập nhật UI ngay lập tức
                updateProgressBarUI(seekTime, player.getDuration());
            }
            // FIX: Added dedicated toggle function for the button
            function togglePlayPause() {
                if (player && player.getPlayerState)
                    player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
            }

            function showControlsAndSetHideTimeout() {
                if (!player) return;
                playerContainer.classList.add("controls-active");
                playerContainer.classList.remove("no-cursor");

                clearTimeout(controlsTimeout);
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    controlsTimeout = setTimeout(hideControls, 3500);
                }
            }

            function hideControls() {
                clearTimeout(controlsTimeout);
                const menu = doc.getElementById("settings-menu");
                if (menu.classList.contains("visible")) return;

                playerContainer.classList.remove("controls-active");
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    playerContainer.classList.add("no-cursor");
                }
            }
            function handleKeyboardShortcuts(e) {
                if (
                    doc.activeElement === searchInput ||
                    doc.activeElement === urlInput ||
                    playerWrapper.classList.contains("hidden")
                )
                    return;
                switch (e.code) {
                    case "Space":
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case "Escape":
                        e.preventDefault();
                        goHome();
                        break;
                    case "ArrowLeft":
                        player.seekTo(player.getCurrentTime() - 5, true);
                        break;
                    case "ArrowRight":
                        player.seekTo(player.getCurrentTime() + 5, true);
                        break;
                }
            }

            function applyAndSaveSubtitleStyles() {
                applySubtitleStyles();
                saveSubtitleSettings();
            }
            function applySubtitleStyles() {
                function hexToRgba(hex, op) {
                    let r = "0x" + hex[1] + hex[2],
                        g = "0x" + hex[3] + hex[4],
                        b = "0x" + hex[5] + hex[6];
                    return `rgba(${+r},${+g},${+b},${op})`;
                }
                subtitleDisplay.style.fontSize = `clamp(1.2rem, ${subtitleSettings.fontSize * 0.08}vw, ${subtitleSettings.fontSize}px)`;
                subtitleDisplay.style.color = subtitleSettings.fontColor;
                subtitleDisplay.style.backgroundColor = hexToRgba(subtitleSettings.bgColor, subtitleSettings.bgOpacity);
            }
            function saveSubtitleSettings() {
                localStorage.setItem("youtubeVODPlayerSubSettings", JSON.stringify(subtitleSettings));
            }
            function loadSubtitleSettings() {
                const saved = localStorage.getItem("youtubeVODPlayerSubSettings");
                subtitleSettings = saved ? JSON.parse(saved) : { ...DEFAULT_SUB_SETTINGS };
                fontSizeSlider.value = subtitleSettings.fontSize;
                fontColorPicker.value = subtitleSettings.fontColor;
                bgColorPicker.value = subtitleSettings.bgColor;
                bgOpacitySlider.value = subtitleSettings.bgOpacity;
                applySubtitleStyles();
            }

            function startSyncing() {
                startProgressSync();
                if (subtitles.length > 0) startSubtitleSync();
            }
            function stopSyncing() {
                stopProgressSync();
                stopSubtitleSync();
            }
            function stopProgressSync() {
                clearInterval(progressInterval);
            }
            function stopSubtitleSync() {
                clearInterval(subtitleCheckInterval);
            }
            function startProgressSync() {
                stopProgressSync();
                const tDisplay = doc.getElementById("time-display");

                progressInterval = setInterval(() => {
                    if (!player || typeof player.getDuration !== "function") return;
                    const d = player.getDuration();
                    const c = player.getCurrentTime();
                    if (isNaN(d) || d === 0) return;

                    updateProgressBarUI(c, d);

                    // --- LOGIC SKIP INTRO MỚI ---
                    checkSkipLogic(c, d);
                    // -----------------------------

                    const formatTime = (s) => {
                        const t = Math.round(s);
                        return `${String(Math.floor(t / 60)).padStart(2, "0")}:${String(t % 60).padStart(2, "0")}`;
                    };
                    if (tDisplay) tDisplay.textContent = `${formatTime(c)} / ${formatTime(d)}`;

                    if (d - c < 1 && !isEnding) {
                        handleVideoEnd();
                    }
                }, 250);
            }

            // [MỚI] Logic tính toán xem có hiện nút Skip không
            function checkSkipLogic(currentTime, duration) {
                if (!currentVideoData || !currentVideoData.bookmarks) return;

                // Sắp xếp bookmark theo thời gian
                const bookmarks = currentVideoData.bookmarks
                    .map((b) => ({ ...b, sec: srtTimeToSeconds(b.time) }))
                    .sort((a, b) => a.sec - b.sec);

                let foundSkip = null;

                for (let i = 0; i < bookmarks.length; i++) {
                    const currentB = bookmarks[i];
                    const nextB = bookmarks[i + 1];

                    // Xác định điểm kết thúc của đoạn này
                    // Nếu có đoạn sau thì end là start đoạn sau. Nếu không thì coi như hết video hoặc +60s
                    const endTime = nextB ? nextB.sec : currentB.sec + 80;

                    // Nếu đang nằm trong vùng của bookmark này VÀ nó có skip=true
                    if (currentTime >= currentB.sec && currentTime < endTime && currentB.skip) {
                        foundSkip = {
                            label: currentB.label,
                            target: endTime, // Nhảy tới đầu đoạn sau
                        };
                        break;
                    }
                }

                if (foundSkip) {
                    skipBtn.innerHTML = `Bỏ qua ${foundSkip.label} <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor"><path d="M4,11V13H16L10.5,18.5L11.92,19.92L19.84,12L11.92,4.08L10.5,5.5L16,11H4Z"></path></svg>`;
                    skipBtn.classList.remove("hidden");
                    // setTimeout nhẹ để kích hoạt animation CSS
                    setTimeout(() => skipBtn.classList.add("visible"), 10);
                    currentSkipTarget = foundSkip.target;
                } else {
                    skipBtn.classList.remove("visible");
                    setTimeout(() => skipBtn.classList.add("hidden"), 300); // Chờ animation ẩn xong mới hidden
                    currentSkipTarget = null;
                }
            }

            function startSubtitleSync() {
                stopSubtitleSync();
                subtitleCheckInterval = setInterval(() => {
                    if (!player || typeof player.getCurrentTime !== "function") return;
                    const c = player.getCurrentTime();
                    const sub = subtitles.find((s) => c >= s.start && s.end >= c);
                    subtitleDisplay.innerHTML = sub ? sub.text : "";
                }, 100);
            }
            async function loadRemoteSubtitle(url) {
                if (!url) return;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`Could not fetch SRT`);
                    const srt = await res.text();
                    subtitles = parseSRT(srt);
                    if (subtitles.length > 0) startSubtitleSync();
                } catch (e) {
                    console.error("Could not load subtitle:", e);
                }
            }
            function parseSRT(text) {
                const subs = [];
                const blocks = text.trim().replace(/\r/g, "").split("\n\n");
                for (const block of blocks) {
                    const lines = block.split("\n");
                    const timeIdx = lines.findIndex((l) => l.includes("-->"));
                    if (timeIdx !== -1) {
                        const txt = lines.slice(timeIdx + 1).join("<br>");
                        const match = lines[timeIdx].match(/(.*) --> (.*)/);
                        if (match && txt)
                            subs.push({
                                start: srtTimeToSeconds(match[1].trim()),
                                end: srtTimeToSeconds(match[2].trim()),
                                text: txt,
                            });
                    }
                }
                return subs;
            }
            function srtTimeToSeconds(t) {
                const p = t.split(/[:,]/).reverse();
                return (
                    (parseInt(p[3], 10) || 0) * 3600 +
                    (parseInt(p[2], 10) || 0) * 60 +
                    (parseInt(p[1], 10) || 0) +
                    (parseInt(p[0], 10) || 0) / 1000
                );
            }
            function extractVideoID(url) {
                const regex = /(?:watch\?v=|youtu\.be\/|embed\/|v\/|e\/|shorts\/)([a-zA-Z0-9_-]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }
            function handleVideoEnd() {
                isEnding = true; // Đặt cờ để tránh gọi lại
                stopSyncing();

                if (!currentVideoData) return;
                let nextVideo = null;
                if (currentVideoData.program && typeof currentVideoData.episode !== "undefined") {
                    const currentEpisode = Number(currentVideoData.episode);
                    nextVideo = libraryData.find(
                        (v) => v.program === currentVideoData.program && Number(v.episode) === currentEpisode + 1
                    );
                }

                if (nextVideo) {
                    showUpNextOverlay(nextVideo);
                } else {
                    playerContainer.classList.remove("no-cursor");
                    playerContainer.classList.add("controls-active");
                    doc.getElementById("center-play-pause-btn").style.opacity = "1";

                    // GỢI Ý CHƯƠNG TRÌNH KHÁC
                    const otherVideo = libraryData.find(
                        (v) => v.program !== currentVideoData.program && v.videoId !== currentVideoData.videoId
                    );

                    if (otherVideo) {
                        showUpNextOverlay(otherVideo, true); // dùng giao diện cũ luôn
                    }
                }
            }
            function updateProgressBarUI(currentTime, duration) {
                if (isNaN(duration) || duration === 0) return;
                progressBar.max = duration; // <<< THÊM DÒNG NÀY
                progressBar.value = currentTime;
                progressBar.style.setProperty("--progress-percent", `${(currentTime / duration) * 100}%`);
            }

            function showUpNextOverlay(videoData, isSuggestion = false) {
                const overlay = doc.getElementById("up-next-overlay");
                const thumbnail = doc.getElementById("up-next-thumbnail");
                const title = doc.getElementById("up-next-title");
                const countdownSpan = doc.getElementById("up-next-countdown");
                const card = doc.getElementById("up-next-card");
                const cancelBtn = doc.getElementById("up-next-cancel-btn");

                const thumbnailUrl = videoData.thumbnailUrl || videoData.thumbnailUrl_auto;
                thumbnail.src = thumbnailUrl;
                title.textContent = videoData.userTitle || videoData.title;

                overlay.style.display = "flex";

                if (isSuggestion) {
                    // Gợi ý chương trình khác: không có đếm ngược, chỉ click để xem
                    countdownSpan.parentElement.innerHTML = "Bạn có thể thích chương trình này:";
                    cancelBtn.textContent = "Bỏ qua";
                    card.onclick = () => {
                        hideUpNextOverlay();
                        launchPlayer(videoData);
                    };
                    cancelBtn.onclick = hideUpNextOverlay;
                } else {
                    // Tập tiếp theo bình thường
                    let countdown = 5;
                    countdownSpan.textContent = countdown;
                    const playNext = () => {
                        hideUpNextOverlay();
                        launchPlayer(videoData);
                    };
                    card.onclick = playNext;
                    cancelBtn.onclick = hideUpNextOverlay;

                    upNextInterval = setInterval(() => {
                        countdown--;
                        countdownSpan.textContent = countdown;
                    }, 1000);
                    upNextTimeout = setTimeout(() => {
                        playNext();
                    }, 5000);
                }
            }

            function hideUpNextOverlay() {
                clearTimeout(upNextTimeout);
                clearInterval(upNextInterval);
                const overlay = doc.getElementById("up-next-overlay");
                if (overlay) overlay.style.display = "none";
                const card = doc.getElementById("up-next-card");
                if (card) card.onclick = null; // Gỡ listener để tránh memory leak
            }
            // END: Các hàm mới
        </script>
    </body>
</html>
