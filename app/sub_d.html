<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trình xem Phim Chuyên nghiệp</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #141414;
            --secondary-bg: #1e1e1e;
            --text-color: #e5e5e5;
            --accent-color: #e50914;
            --text-light: #fff;
        }

        /* --- General Body & Layout --- */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--primary-bg);
            color: var(--text-color);
            overflow-x: hidden;
        }
        main {
            padding: clamp(20px, 4vw, 60px);
            box-sizing: border-box;
        }
        .hidden {
            display: none !important;
        }

        /* --- Header & Search/Filter Section --- */
        #page-header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 40px;
        }
        #main-title {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin: 0;
        }
        #actions-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #search-container {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: var(--secondary-bg);
            border: 1px solid #333;
            border-radius: 4px;
            padding: 5px 15px;
        }
        #search-icon {
            width: 20px;
            height: 20px;
            fill: #888;
        }
        #search-input {
            background: none;
            border: none;
            outline: none;
            color: var(--text-color);
            font-size: 1rem;
            padding: 10px 0;
            width: 250px;
        }
        #add-video-btn {
            background-color: var(--secondary-bg);
            border: 1px solid #333;
            border-radius: 4px;
            width: 44px;
            height: 44px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            fill: #ccc;
            transition: background-color 0.2s;
        }
        #add-video-btn:hover {
            background-color: #333;
        }
        #filter-tags {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 40px;
            border-bottom: 1px solid #222;
            padding-bottom: 20px;
        }
        .filter-tag {
            background-color: var(--secondary-bg);
            border: 1px solid #444;
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .filter-tag:hover {
            background-color: #333;
        }
        .filter-tag.active {
            background-color: var(--text-light);
            color: #000;
            border-color: var(--text-light);
            font-weight: 600;
        }

        /* --- VOD Rows (Netflix Style) --- */
        #library-container {
            display: flex;
            flex-direction: column;
            gap: 50px;
        }
        .program-row {
            text-align: left;
        }
        .program-title {
            font-size: 1.8rem;
            font-weight: 600;
            margin: 0 0 20px 0;
        }
        .video-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .video-card {
            background-color: var(--secondary-bg);
            border-radius: 5px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            aspect-ratio: 16 / 9;
        }
        .video-card:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 30px rgba(0,0,0,0.7);
            z-index: 10;
        }
        .video-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }
        .skeleton-card {
            background-color: #2a2a2a;
            animation: pulse 1.5s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { background-color: #2a2a2a; }
            50% { background-color: #3a3a3a; }
            100% { background-color: #2a2a2a; }
        }

        /* --- Generic Modal Styles --- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background-color: var(--primary-bg);
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh; /* FIX: Prevent modal from exceeding screen height */
        }
        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(20,20,20,0.7);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            fill: white;
            z-index: 10; /* FIX: Ensure button is on top */
        }

        /* --- Video Detail Modal Specifics --- */
        #detail-modal-content {
            width: 100%;
            max-width: 800px;
        }
        #modal-header {
            position: relative;
            aspect-ratio: 16 / 9;
            flex-shrink: 0;
        }
        #modal-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px 8px 0 0;
        }
        #modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80%;
            background: linear-gradient(to top, var(--primary-bg) 10%, transparent 100%);
            pointer-events: none; /* FIX: Allow clicks to pass through */
        }
        #modal-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255,255,255,0.9);
            color: #000;
            border: none;
            border-radius: 5px;
            padding: 10px 25px;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 5; /* FIX: Ensure button is on top of thumbnail */
        }
        #modal-play-btn svg {
            width: 24px;
            height: 24px;
        }
        #modal-body {
            padding: 0 30px 30px 30px;
            overflow-y: auto; /* FIX: Allow content to scroll */
        }
        #modal-title {
            font-size: clamp(1.5rem, 4vw, 2.2rem);
            font-weight: 700;
            margin: -50px 0 20px 0;
            position: relative;
            z-index: 2; /* Ensure title is above gradient */
        }
        #modal-meta {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            color: #aaa;
        }
        #modal-program, #modal-author {
            font-weight: 600;
        }
        #modal-participants-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
        }
        #modal-participants-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            list-style: none;
            padding: 0;
        }
        .participant-tag {
            background-color: var(--secondary-bg);
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        /* --- Add Video Modal Specifics --- */
        #add-video-modal-content {
            width: 90%;
            max-width: 500px;
            padding: 30px;
        }
        #add-video-form h3 {
            font-size: 1.8rem;
            margin-top: 0;
        }
        #youtube-url-input {
            width: 100%;
            box-sizing: border-box;
            background-color: var(--secondary-bg);
            color: var(--text-color);
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            font-size: 1.1rem;
            margin-bottom: 15px;
        }
        #youtube-url-input:focus {
            outline: none;
            border-color: var(--accent-color);
        }
        #load-video-btn {
            width: 100%;
            padding: 15px;
            font-size: 1.1rem;
            font-weight: 600;
            background-color: var(--accent-color);
            color: var(--text-light);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #load-video-btn:hover {
            background-color: #f40612;
        }
        .subtitle-instructions {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 20px;
            text-align: center;
        }

        /* --- Player Wrapper & Container --- */
        #player-wrapper {
            display: none;
        }
        #player-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }
        #youtube-player {
            width: 100%;
            height: 100%;
            border: none;
        }
        /* --- In-Player Overlays --- */
        .player-overlay {
            position: absolute; left: 0; right: 0; z-index: 21;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s ease-out; pointer-events: none;
        }
        #player-container.controls-active .player-overlay { opacity: 1; visibility: visible; }
        #video-header-overlay {
            top: 0; padding: clamp(15px, 3vw, 30px) clamp(20px, 5vw, 60px);
            background: linear-gradient(to bottom, rgba(0,0,0,0.7) 0%, transparent 100%);
            display: flex; align-items: center; gap: 20px;
        }
        #back-btn { background: none; border: none; fill: white; cursor: pointer; width: 44px; height: 44px; padding: 0; pointer-events: auto; flex-shrink: 0; }
        #back-btn svg { width: 32px; height: 32px; }
        #video-title-container { overflow: hidden; }
        #video-title-display { font-size: clamp(1.2rem, 2.5vw, 1.8rem); font-weight: 600; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        #video-program-display { font-size: 0.9rem; color: #ccc; opacity: 0.8; }
        #custom-controls { bottom: 0; padding: 10px clamp(20px, 5vw, 60px); background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%); }
        #custom-controls * { pointer-events: auto; }
        #click-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; }
        #subtitle-display { position: absolute; bottom: 15%; left: 50%; transform: translateX(-50%); width: max-content; max-width: 90%; padding: 8px 20px; text-align: center; border-radius: 6px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9); line-height: 1.5; font-weight: 500; }
        
    </style>
</head>
<body>
    <main>
        <header id="page-header">
            <h1 id="main-title">Khám Phá</h1>
            <div id="actions-container">
                <div id="search-container">
                    <svg id="search-icon" viewBox="0 0 24 24"><path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg>
                    <input type="text" id="search-input" placeholder="Tìm theo tiêu đề, người tham gia...">
                </div>
                <button id="add-video-btn" title="Xem video từ link">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                </button>
            </div>
        </header>

        <div id="filter-tags">
            <span class="filter-tag active" data-filter="Tất cả">Tất cả</span>
        </div>

        <div id="library-container">
            <!-- Skeleton Loader -->
            <section class="program-row"><div class="video-list"><div class="video-card skeleton-card"></div><div class="video-card skeleton-card"></div><div class="video-card skeleton-card"></div></div></section>
        </div>
    </main>

    <!-- Video Detail Modal (Popup) -->
    <div id="detail-modal-overlay" class="modal-overlay hidden">
        <div id="detail-modal-content" class="modal-content">
            <button id="detail-modal-close-btn" class="modal-close-btn" title="Đóng">
                <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
            <header id="modal-header">
                <img id="modal-thumbnail" src="" alt="Video thumbnail">
                <button id="modal-play-btn">
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>
                    Phát
                </button>
            </header>
            <div id="modal-body">
                <h3 id="modal-title"></h3>
                <div id="modal-meta"><span id="modal-program"></span><span id="modal-author"></span></div>
                <div id="modal-participants-container">
                    <h4 id="modal-participants-title">Với sự tham gia của:</h4>
                    <ul id="modal-participants-list"></ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Video Modal (Popup) -->
    <div id="add-video-modal-overlay" class="modal-overlay hidden">
        <div id="add-video-modal-content" class="modal-content">
            <button id="add-video-close-btn" class="modal-close-btn" title="Đóng">
                 <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
            </button>
            <form id="add-video-form">
                <h3>Xem video từ link</h3>
                <input type="text" id="youtube-url-input" placeholder="Dán link YouTube vào đây..." required>
                <button type="submit" id="load-video-btn">Tải và Phát</button>
                <p class="subtitle-instructions">Sau khi video tải, bạn có thể <strong>kéo và thả file phụ đề (.srt)</strong> vào màn hình.</p>
            </form>
        </div>
    </div>

    <!-- Player Wrapper -->
    <div id="player-wrapper" class="hidden">
        <div id="player-container">
            <div id="youtube-player"></div>
            <div id="click-overlay"></div>
            <div id="video-header-overlay" class="player-overlay">
                 <button id="back-btn" title="Quay lại"><svg viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg></button>
                <div id="video-title-container">
                    <h2 id="video-title-display"></h2>
                    <p id="video-program-display"></p>
                </div>
            </div>
            <div id="subtitle-display" class="player-overlay"></div>
            <div id="custom-controls" class="player-overlay">
                <!-- The player controls structure from previous versions would be here -->
            </div>
        </div>
    </div>

    <div id="notification-area"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // JavaScript logic will be added here in the next step.
		// --- DOM Elements ---
const doc = document;
const libraryContainer = doc.getElementById('library-container');
const searchInput = doc.getElementById('search-input');
const filterTagsContainer = doc.getElementById('filter-tags');
const addVideoBtn = doc.getElementById('add-video-btn');

// Detail Modal Elements
const detailModalOverlay = doc.getElementById('detail-modal-overlay');
const detailModalCloseBtn = doc.getElementById('detail-modal-close-btn');
const modalPlayBtn = doc.getElementById('modal-play-btn');
const modalThumbnail = doc.getElementById('modal-thumbnail');
const modalTitle = doc.getElementById('modal-title');
const modalProgram = doc.getElementById('modal-program');
const modalAuthor = doc.getElementById('modal-author');
const modalParticipantsList = doc.getElementById('modal-participants-list');

// Add Video Modal Elements
const addVideoModalOverlay = doc.getElementById('add-video-modal-overlay');
const addVideoForm = doc.getElementById('add-video-form');
const addVideoCloseBtn = doc.getElementById('add-video-close-btn');
const urlInput = doc.getElementById('youtube-url-input');

// Player Elements
const playerWrapper = doc.getElementById('player-wrapper');
const playerContainer = doc.getElementById('player-container');
// Other player elements will be grabbed when needed or assumed to exist from previous HTML

// --- State Variables ---
let player;
let libraryData = [];
let subtitles = [];
let controlsTimeout;

// --- Initialization ---
function onYouTubeIframeAPIReady() {
    initializeLibrary();
}

async function initializeLibrary() {
    try {
        const res = await fetch('library.json');
        if (!res.ok) throw new Error("Không thể tải thư viện. Vui lòng kiểm tra lại file `library.json`.");
        libraryData = await res.json();
        renderVideoRows(libraryData);
        populateFilterTags();
        setupEventListeners();
    } catch (e) {
        libraryContainer.innerHTML = `<p style="color: #ff8a8a; text-align: center;">Lỗi: ${e.message}</p>`;
    }
}

// --- UI Rendering ---
function renderVideoRows(videoArray) {
    libraryContainer.innerHTML = '';
    if (videoArray.length === 0) {
        libraryContainer.innerHTML = `<p style="text-align: center;">Không tìm thấy video nào phù hợp.</p>`;
        return;
    }
    const groupedByProgram = videoArray.reduce((acc, video) => {
        const program = video.program || 'Chương trình khác';
        if (!acc[program]) acc[program] = [];
        acc[program].push(video);
        return acc;
    }, {});
    const programOrder = Object.keys(groupedByProgram).sort((a, b) => a === 'Chương trình khác' ? 1 : b === 'Chương trình khác' ? -1 : a.localeCompare(b));
    
    for (const programName of programOrder) {
        const section = doc.createElement('section');
        section.className = 'program-row';
        section.innerHTML = `
            <h2 class="program-title">${programName}</h2>
            <div class="video-list">
                ${groupedByProgram[programName].map(video => `
                    <div class="video-card" data-video-id="${video.videoId}">
                        <img src="${video.thumbnailUrl}" alt="${video.userTitle || video.title}" class="video-thumbnail" loading="lazy">
                    </div>
                `).join('')}
            </div>
        `;
        libraryContainer.appendChild(section);
    }
}

function populateFilterTags() {
    const allParticipants = [...new Set(libraryData.flatMap(v => v.participants || []))].sort();
    allParticipants.forEach(p => {
        const tag = doc.createElement('span');
        tag.className = 'filter-tag';
        tag.textContent = p;
        tag.dataset.filter = p;
        filterTagsContainer.appendChild(tag);
    });
}

// --- Event Handling ---
function setupEventListeners() {
    // Search and Filter
    searchInput.addEventListener('input', handleSearchAndFilter);
    filterTagsContainer.addEventListener('click', handleTagClick);

    // Main library interaction
    libraryContainer.addEventListener('click', handleCardClick);
    
    // Detail Modal
    detailModalCloseBtn.addEventListener('click', () => closeModal(detailModalOverlay));
    detailModalOverlay.addEventListener('click', (e) => { if (e.target === detailModalOverlay) closeModal(detailModalOverlay); });
    modalPlayBtn.addEventListener('click', handleModalPlay);
    
    // Add Video Modal
    addVideoBtn.addEventListener('click', () => openModal(addVideoModalOverlay));
    addVideoCloseBtn.addEventListener('click', () => closeModal(addVideoModalOverlay));
    addVideoModalOverlay.addEventListener('click', (e) => { if (e.target === addVideoModalOverlay) closeModal(addVideoModalOverlay); });
    addVideoForm.addEventListener('submit', handleAddVideoSubmit);

    // Player
    doc.getElementById('back-btn').addEventListener('click', goHome);
    doc.getElementById('click-overlay').addEventListener('click', handlePlayerClick);
    playerContainer.addEventListener('mousemove', showControlsAndSetHideTimeout);
    playerContainer.addEventListener('mouseleave', hideControls);
    doc.addEventListener('keydown', handleKeyboardShortcuts);
    doc.addEventListener('fullscreenchange', () => { if (!document.fullscreenElement) goHome(); });
}

function handleSearchAndFilter() {
    const searchTerm = searchInput.value.toLowerCase().trim();
    const activeTag = doc.querySelector('.filter-tag.active');
    const filterTerm = (activeTag && activeTag.dataset.filter !== 'Tất cả') ? activeTag.dataset.filter : null;

    const filteredData = libraryData.filter(video => {
        const matchesSearch = searchTerm === '' ||
            (video.userTitle || video.title).toLowerCase().includes(searchTerm) ||
            (video.program || '').toLowerCase().includes(searchTerm) ||
            (video.participants || []).some(p => p.toLowerCase().includes(searchTerm));
        const matchesFilter = !filterTerm || (video.participants && video.participants.includes(filterTerm));
        return matchesSearch && matchesFilter;
    });
    renderVideoRows(filteredData);
}

function handleTagClick(e) {
    if (e.target.classList.contains('filter-tag')) {
        doc.querySelectorAll('.filter-tag').forEach(tag => tag.classList.remove('active'));
        e.target.classList.add('active');
        handleSearchAndFilter();
    }
}

function handleCardClick(e) {
    const card = e.target.closest('.video-card');
    if (card) {
        const videoId = card.dataset.videoId;
        const videoData = libraryData.find(v => v.videoId === videoId);
        if (videoData) openDetailModal(videoData);
    }
}

function handleModalPlay() {
    const videoId = modalPlayBtn.dataset.videoId;
    const videoData = libraryData.find(v => v.videoId === videoId);
    if (videoData) {
        closeModal(detailModalOverlay);
        launchPlayer(videoData);
    }
}

function handleAddVideoSubmit(e) {
    e.preventDefault();
    const videoId = extractVideoID(urlInput.value);
    if (videoId) {
        closeModal(addVideoModalOverlay);
        // Launch player with a minimal video object
        launchPlayer({ videoId: videoId });
        urlInput.value = ''; // Clear input
    } else {
        alert("Link YouTube không hợp lệ. Vui lòng kiểm tra lại.");
    }
}

// --- Modal Logic ---
function openModal(modal) {
    modal.classList.remove('hidden');
    setTimeout(() => modal.classList.add('visible'), 10);
}

function closeModal(modal) {
    modal.classList.remove('visible');
    setTimeout(() => modal.classList.add('hidden'), 300);
}

function openDetailModal(videoData) {
    modalThumbnail.src = videoData.thumbnailUrl.replace('hqdefault', 'maxresdefault');
    modalThumbnail.onerror = () => { modalThumbnail.src = videoData.thumbnailUrl; };
    modalTitle.textContent = videoData.userTitle || videoData.title;
    modalProgram.textContent = videoData.program || '';
    modalAuthor.textContent = videoData.authorName || '';
    
    modalParticipantsList.innerHTML = '';
    const participantsContainer = doc.getElementById('modal-participants-title').parentElement;
    if (videoData.participants && videoData.participants.length > 0) {
        videoData.participants.forEach(name => {
            const li = doc.createElement('li');
            li.className = 'participant-tag';
            li.textContent = name;
            modalParticipantsList.appendChild(li);
        });
        participantsContainer.classList.remove('hidden');
    } else {
        participantsContainer.classList.add('hidden');
    }

    modalPlayBtn.dataset.videoId = videoData.videoId;
    openModal(detailModalOverlay);
}

// --- Player Logic ---
async function launchPlayer(videoData) {
    if (!videoData || !videoData.videoId) return;

    // Reset state for new video
    subtitles = [];
    doc.getElementById('subtitle-display').innerHTML = '';

    playerWrapper.style.display = 'block';
    doc.getElementById('video-title-display').textContent = videoData.userTitle || videoData.title || 'Đang tải...';
    doc.getElementById('video-program-display').textContent = videoData.program || '';

    await enterCinematicMode();
    
    if (videoData.subtitleUrl) loadRemoteSubtitle(videoData.subtitleUrl);

    if (player) {
        player.loadVideoById(videoData.videoId);
    } else {
        player = new YT.Player("youtube-player", {
            videoId: videoData.videoId,
            playerVars: { autoplay: 1, playsinline: 1, rel: 0, modestbranding: 1, controls: 0, showinfo: 0, iv_load_policy: 3 },
            events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange }
        });
    }
}

async function enterCinematicMode() {
    try {
        if (playerContainer.requestFullscreen) await playerContainer.requestFullscreen();
        if (screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape');
    } catch (err) {
        console.warn("Lỗi chế độ cinematic:", err);
    }
}

function goHome() {
    if (player) player.stopVideo();
    playerWrapper.style.display = 'none';
    if (document.fullscreenElement) document.exitFullscreen();
}

function onPlayerReady(event) {
    const apiData = event.target.getVideoData();
    doc.getElementById('video-title-display').textContent = apiData.title;
    event.target.playVideo();
}

function onPlayerStateChange(event) {
    const playBtn = doc.getElementById('play-pause-btn');
    if (playBtn) {
        playBtn.innerHTML = event.data === YT.PlayerState.PLAYING 
            ? `<svg viewBox="0 0 24 24"><path d="M14,19H18V5H14M6,19H10V5H6V19Z"></path></svg>` 
            : `<svg viewBox="0 0 24 24"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>`;
    }
    if (event.data === YT.PlayerState.PLAYING) {
        startSyncing();
        playerContainer.classList.add('no-cursor');
        showControlsAndSetHideTimeout();
    } else {
        stopSyncing();
        playerContainer.classList.remove('no-cursor');
        showControlsAndSetHideTimeout(); 
    }
}

function handlePlayerClick() {
    if (!player) return;
    if (!playerContainer.classList.contains('controls-active')) {
        showControlsAndSetHideTimeout();
    } else {
        player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
    }
}

function showControlsAndSetHideTimeout() {
    if (!player) return;
    clearTimeout(controlsTimeout);
    playerContainer.classList.add('controls-active');
    if (player.getPlayerState() === YT.PlayerState.PLAYING) {
        controlsTimeout = setTimeout(hideControls, 3500);
    }
}

function hideControls() {
    clearTimeout(controlsTimeout);
    playerContainer.classList.remove('controls-active');
}

function handleKeyboardShortcuts(e) {
    if (!player || doc.activeElement === searchInput || doc.activeElement === urlInput) return;
    if (playerWrapper.style.display !== 'block') return;
    
    switch (e.code) {
        case 'Space': e.preventDefault(); player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo(); break;
        case 'Escape': e.preventDefault(); goHome(); break;
    }
}

// --- Utility & Sync Functions ---
let progressInterval, subtitleCheckInterval;
function startSyncing() { startProgressSync(); if(subtitles.length > 0) startSubtitleSync(); }
function stopSyncing() { stopProgressSync(); stopSubtitleSync(); }
function startProgressSync() { /* ... function unchanged ... */ }
function startSubtitleSync() { /* ... function unchanged ... */ }
function stopProgressSync() { clearInterval(progressInterval); }
function stopSubtitleSync() { clearInterval(subtitleCheckInterval); }
async function loadRemoteSubtitle(url) { /* ... function unchanged ... */ }
function parseSRT(text) { /* ... function unchanged ... */ }
function srtTimeToSeconds(t) { /* ... function unchanged ... */ }
function extractVideoID(url) { const r = /(?:watch\?v=|youtu\.be\/|embed\/|v\/|e\/|shorts\/)([a-zA-Z0-9_-]{11})/; return url.match(r) ? url.match(r)[1] : null; }

// Re-implementing unchanged utility functions for completeness
startProgressSync = () => { stopProgressSync(); progressInterval = setInterval(() => { if (!player || typeof player.getDuration !== 'function') return; const d = player.getDuration(), c = player.getCurrentTime(); if (isNaN(d)) return; const pBar = doc.getElementById('progress-bar'); if(pBar) {pBar.max = d; pBar.value = c; pBar.style.setProperty('--progress-percent', `${d > 0 ? (c / d) * 100 : 0}%`);} const tDisplay = doc.getElementById('time-display'); if(tDisplay) { const formatTime = s => { const t = Math.round(s); return `${String(Math.floor(t/60)).padStart(2,'0')}:${String(t%60).padStart(2,'0')}`; }; tDisplay.textContent = `${formatTime(c)} / ${formatTime(d)}`; } }, 250); };
startSubtitleSync = () => { stopSubtitleSync(); subtitleCheckInterval = setInterval(() => { if (!player || typeof player.getCurrentTime !== 'function') return; const c = player.getCurrentTime(); const sub = subtitles.find(s => c >= s.start && s.end >= c); const subDisplay = doc.getElementById('subtitle-display'); if(subDisplay) subDisplay.innerHTML = sub ? sub.text : ''; }, 100); };
async function loadRemoteSubtitle(url) { if (!url) return; try { const res = await fetch(url); if (!res.ok) throw new Error(`Could not fetch SRT`); const srt = await res.text(); subtitles = parseSRT(srt); if (subtitles.length > 0) startSubtitleSync(); } catch (e) { console.error("Could not load subtitle:", e); } }
parseSRT = (text) => { const subs = []; const blocks = text.trim().replace(/\r/g, "").split("\n\n"); for (const block of blocks) { const lines = block.split("\n"); const timeIdx = lines.findIndex(l => l.includes('-->')); if (timeIdx !== -1) { const txt = lines.slice(timeIdx + 1).join('<br>'); const match = lines[timeIdx].match(/(.*) --> (.*)/); if (match && txt) subs.push({ start: srtTimeToSeconds(match[1].trim()), end: srtTimeToSeconds(match[2].trim()), text: txt }); } } return subs; };
srtTimeToSeconds = (t) => { const p = t.split(/[:,]/).reverse(); return (parseInt(p[3],10)||0)*3600+(parseInt(p[2],10)||0)*60+(parseInt(p[1],10)||0)+(parseInt(p[0],10)||0)/1000; };
    </script>
</body>
</html>
