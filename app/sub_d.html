<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
        <title>Trình xem Phim Chuyên nghiệp</title>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
        <style>
            :root {
                --primary-bg: #141414;
                --secondary-bg: #1e1e1e;
                --text-color: #e5e5e5;
                --accent-color: #e50914;
                --text-light: #fff;
            }
            body {
                font-family: "Inter", sans-serif;
                margin: 0;
                background-color: var(--primary-bg);
                color: var(--text-color);
                overflow-x: hidden;
            }
            main {
                padding: clamp(20px, 4vw, 60px);
                box-sizing: border-box;
            }
            .hidden {
                display: none !important;
            }

            #page-header {
                display: flex;
                flex-wrap: wrap;
                align-items: center;
                justify-content: space-between;
                gap: 20px;
                margin-bottom: 40px;
            }
            #main-title {
                font-size: 2.5rem;
                font-weight: 700;
                color: var(--accent-color);
                text-transform: uppercase;
                letter-spacing: 2px;
                margin: 0;
            }
            #actions-container {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            #search-container {
                display: flex;
                align-items: center;
                gap: 10px;
                background-color: var(--secondary-bg);
                border: 1px solid #333;
                border-radius: 4px;
                padding: 5px 15px;
            }
            #search-icon {
                width: 20px;
                height: 20px;
                fill: #888;
            }
            #search-input {
                background: none;
                border: none;
                outline: none;
                color: var(--text-color);
                font-size: 1rem;
                padding: 10px 0;
                width: 250px;
            }
            #add-video-btn {
                background-color: var(--secondary-bg);
                border: 1px solid #333;
                border-radius: 4px;
                width: 44px;
                height: 44px;
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                fill: #ccc;
                transition: background-color 0.2s;
            }
            #add-video-btn:hover {
                background-color: #333;
            }
            #filter-tags {
                display: flex;
                gap: 10px;
                flex-wrap: wrap;
                margin-bottom: 40px;
                border-bottom: 1px solid #222;
                padding-bottom: 20px;
            }
            .filter-tag {
                background-color: var(--secondary-bg);
                border: 1px solid #444;
                color: var(--text-color);
                padding: 8px 16px;
                border-radius: 20px;
                cursor: pointer;
                transition: background-color 0.2s, border-color 0.2s;
            }
            .filter-tag:hover {
                background-color: #333;
            }
            .filter-tag.active {
                background-color: var(--text-light);
                color: #000;
                border-color: var(--text-light);
                font-weight: 600;
            }
            #library-container {
                display: flex;
                flex-direction: column;
                gap: 50px;
            }
            .program-row {
                text-align: left;
            }
            .program-title {
                font-size: 1.8rem;
                font-weight: 600;
                margin: 0 0 20px 0;
            }
            .video-list {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 15px;
            }
            .video-card {
                background-color: var(--secondary-bg);
                border-radius: 5px;
                overflow: hidden;
                cursor: pointer;
                transition: transform 0.3s ease, box-shadow 0.3s ease;
                position: relative;
                aspect-ratio: 16 / 9;
            }
            .video-card:hover {
                transform: scale(1.05);
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
                z-index: 10;
            }
            .video-thumbnail {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }
            .skeleton-card {
                background-color: #2a2a2a;
                animation: pulse 1.5s infinite ease-in-out;
            }
            @keyframes pulse {
                0% {
                    background-color: #2a2a2a;
                }
                50% {
                    background-color: #3a3a3a;
                }
                100% {
                    background-color: #2a2a2a;
                }
            }

            .modal-overlay {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                backdrop-filter: blur(5px);
                display: flex;
                justify-content: center;
                align-items: center;
                padding: 20px;
                box-sizing: border-box;
                z-index: 2000;
                opacity: 0;
                pointer-events: none;
                transition: opacity 0.3s ease;
            }
            .modal-overlay.visible {
                opacity: 1;
                pointer-events: auto;
            }
            .modal-content {
                background-color: var(--primary-bg);
                border-radius: 8px;
                box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
                transform: scale(0.95);
                transition: transform 0.3s ease;
                position: relative;
                display: flex;
                flex-direction: column;
                max-height: 90vh;
            }
            .modal-overlay.visible .modal-content {
                transform: scale(1);
            }
            .modal-close-btn {
                position: absolute;
                top: 15px;
                right: 15px;
                background: rgba(20, 20, 20, 0.7);
                border: none;
                border-radius: 50%;
                width: 36px;
                height: 36px;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
                fill: white;
                z-index: 10;
            }

            #detail-modal-content {
                width: 100%;
                max-width: 800px;
            }
            #modal-header {
                position: relative;
                aspect-ratio: 16 / 9;
                flex-shrink: 0;
            }
            #modal-thumbnail {
                width: 100%;
                height: 100%;
                object-fit: cover;
                border-radius: 8px 8px 0 0;
            }
            #modal-header::after {
                content: "";
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50%;
                background: linear-gradient(to top, var(--primary-bg) 20%, transparent 100%);
                pointer-events: none;
            }
            #modal-play-btn {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(255, 255, 255, 0.9);
                color: #000;
                border: none;
                border-radius: 5px;
                padding: 10px 25px;
                font-size: 1.2rem;
                font-weight: 600;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 5;
            }
            #modal-play-btn svg {
                width: 24px;
                height: 24px;
            }
            #modal-body {
                padding: 20px 30px 30px 30px;
                overflow-y: auto;
            }
            #modal-title {
                font-size: clamp(1.5rem, 4vw, 2.2rem);
                font-weight: 700;
                margin: 0 0 15px 0;
            }
            #modal-meta {
                display: flex;
                align-items: center;
                gap: 15px;
                margin-bottom: 20px;
                color: #aaa;
            }
            #modal-participants-title {
                font-size: 1.1rem;
                font-weight: 600;
                margin-bottom: 10px;
            }
            #modal-participants-list {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                list-style: none;
                padding: 0;
            }
            .participant-tag {
                background-color: var(--secondary-bg);
                padding: 5px 12px;
                border-radius: 4px;
                font-size: 0.9rem;
            }
            /* CSS cho các thẻ thể loại mới */
            #modal-genres-list {
                display: flex;
                flex-wrap: wrap;
                gap: 8px;
                list-style: none;
                padding: 0;
                margin: 0 0 20px 0;
            }
            .genre-tag {
                background-color: #333;
                padding: 4px 10px;
                border-radius: 4px;
                font-size: 0.85rem;
                color: #ccc;
            }
            #modal-description {
                color: #bbb;
                line-height: 1.6;
                margin-bottom: 25px;
                font-size: 0.95rem;
            }
            #add-video-modal-content {
                width: 90%;
                max-width: 500px;
                padding: 30px;
            }
            #youtube-url-input {
                width: 100%;
                box-sizing: border-box;
                background-color: var(--secondary-bg);
                color: var(--text-color);
                border: 1px solid #444;
                border-radius: 4px;
                padding: 15px;
                font-size: 1.1rem;
                margin-bottom: 15px;
            }
            #srt-file-label {
                display: block;
                width: 100%;
                box-sizing: border-box;
                background-color: var(--secondary-bg);
                border: 1px dashed #555;
                border-radius: 4px;
                padding: 15px;
                font-size: 1rem;
                margin-bottom: 20px;
                text-align: center;
                cursor: pointer;
            }
            #srt-file-input {
                display: none;
            }
            #srt-file-name {
                color: #aaa;
                font-style: italic;
                display: block;
                margin-top: 5px;
            }
            #load-video-btn {
                width: 100%;
                padding: 15px;
                font-size: 1.1rem;
                font-weight: 600;
                background-color: var(--accent-color);
                color: var(--text-light);
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }

            #player-container {
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                background-color: #000;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 3000;
            }
            #youtube-player {
                width: 100%;
                height: 100%;
                border: none;
            }
            .player-overlay {
                position: absolute;
                left: 0;
                right: 0;
                z-index: 21;
                opacity: 0;
                visibility: hidden; /* Thêm visibility */
                transition: opacity 0.3s ease-out, visibility 0.3s ease-out; /* Thêm transition cho visibility */
                pointer-events: none;
            }
            #player-container.controls-active .player-overlay {
                opacity: 1;
                visibility: visible; /* Thêm visibility */
                pointer-events: auto; /* Thêm pointer-events */
            }
            #video-header-overlay {
                top: 0;
                padding: clamp(15px, 3vw, 30px) clamp(20px, 5vw, 60px);
                background: linear-gradient(to bottom, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
                display: flex;
                align-items: center;
                gap: 20px;
            }
            #back-btn {
                background: none;
                border: none;
                fill: white;
                cursor: pointer;
                width: 44px;
                height: 44px;
                padding: 0;
                pointer-events: auto;
                flex-shrink: 0;
            }
            #video-title-container {
                overflow: hidden;
            }
            #video-title-display {
                font-size: clamp(1.2rem, 2.5vw, 1.8rem);
                font-weight: 600;
                margin: 0;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            #custom-controls {
                bottom: 0;
                padding: 10px clamp(20px, 5vw, 60px);
                background: linear-gradient(to top, rgba(0, 0, 0, 0.7) 0%, transparent 100%);
            }
            /* #custom-controls * { pointer-events: auto; } */ /* << XÓA HOẶC COMMENT DÒNG NÀY */

            .controls-row {
                display: flex;
                align-items: center;
                gap: 20px;
            }
            /* FIX: Buttons should be transparent */
            .controls-row button {
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 5px;
            }
            .controls-row button svg {
                fill: white;
                width: 28px;
                height: 28px;
                display: block;
            }
            #time-display {
                font-size: 1rem;
                white-space: nowrap;
            }
            /* FIX: Program name display in controls */
            #video-program-display {
                margin: 0 15px;
                font-size: 0.9rem;
                color: #ccc;
                opacity: 0.8;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                flex-shrink: 1;
            }
            .spacer {
                flex-grow: 1;
            }
            #click-overlay {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 10;
            }
            #subtitle-display {
                position: absolute;
                bottom: 15%;
                left: 50%;
                transform: translateX(-50%);
                width: max-content;
                max-width: 90%;
                padding: 8px 20px;
                text-align: center;
                border-radius: 6px;
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.9);
                line-height: 1.5;
                font-weight: 500;
                background-color: rgba(0, 0, 0, 0.5);
                pointer-events: none;
                opacity: 0;
            }
            #subtitle-display:not(:empty) {
                opacity: 1;
            }
            #settings-menu {
                position: absolute;
                bottom: 70px;
                right: 20px;
                background-color: rgba(20, 20, 20, 0.9);
                backdrop-filter: blur(5px);
                padding: 15px;
                border-radius: 8px;
                width: 280px;
                box-sizing: border-box;
                display: flex;
                flex-direction: column;
                gap: 15px;
                z-index: 22;
                pointer-events: none;
                opacity: 0;
                transform: translateY(10px);
                transition: opacity 0.2s, transform 0.2s;
            }
            #settings-menu.visible {
                opacity: 1;
                transform: translateY(0);
                pointer-events: auto;
            }
            .control-group label {
                display: block;
                margin-bottom: 8px;
                font-size: 0.9rem;
                color: #ccc;
            }
            .control-group input[type="range"] {
                width: 100%;
            }
            .control-group input[type="color"] {
                width: 100%;
                height: 35px;
                border: none;
                padding: 0;
                background: none;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <main>
            <header id="page-header">
                <h1 id="main-title">Khám Phá</h1>
                <div id="actions-container">
                    <div id="search-container">
                        <svg id="search-icon" viewBox="0 0 24 24">
                            <path
                                d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"
                            />
                        </svg>
                        <input type="text" id="search-input" placeholder="Tìm theo tiêu đề, người tham gia..." />
                    </div>
                    <button id="add-video-btn" title="Xem video từ link">
                        <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>
                    </button>
                </div>
            </header>
            <div id="filter-tags"><span class="filter-tag active" data-filter="Tất cả">Tất cả</span></div>
            <div id="library-container">
                <section class="program-row">
                    <div class="video-list">
                        <div class="video-card skeleton-card"></div>
                        <div class="video-card skeleton-card"></div>
                        <div class="video-card skeleton-card"></div>
                    </div>
                </section>
            </div>
        </main>

        <div id="detail-modal-overlay" class="modal-overlay hidden">
            <div id="detail-modal-content" class="modal-content">
                <button id="detail-modal-close-btn" class="modal-close-btn" title="Đóng">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                </button>
                <header id="modal-header">
                    <img id="modal-thumbnail" src="" alt="Video thumbnail" />
                    <button id="modal-play-btn">
                        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>Phát
                    </button>
                </header>
                <div id="modal-body">
                    <h3 id="modal-title"></h3>
                    <div id="modal-meta">
                        <span id="modal-program"></span>
                        <span id="modal-author"></span>
                    </div>
                    <!-- Chỗ chứa mới cho thể loại -->
                    <div id="modal-genres-container" class="hidden">
                        <ul id="modal-genres-list"></ul>
                    </div>
                    <!-- Chỗ chứa mới cho mô tả -->
                    <p id="modal-description"></p>
                    <div id="modal-participants-container" class="hidden">
                        <h4 id="modal-participants-title">Với sự tham gia của:</h4>
                        <ul id="modal-participants-list"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="add-video-modal-overlay" class="modal-overlay hidden">
            <div id="add-video-modal-content" class="modal-content">
                <button id="add-video-close-btn" class="modal-close-btn" title="Đóng">
                    <svg viewBox="0 0 24 24" width="24" height="24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg>
                </button>
                <form id="add-video-form">
                    <h3>Xem video từ link</h3>
                    <input type="text" id="youtube-url-input" placeholder="Dán link YouTube vào đây..." required />
                    <label for="srt-file-input" id="srt-file-label">Chọn file phụ đề (.srt)<span id="srt-file-name"></span></label>
                    <input type="file" id="srt-file-input" accept=".srt" />
                    <button type="submit" id="load-video-btn">Tải và Phát</button>
                </form>
            </div>
        </div>

        <div id="player-wrapper" class="hidden">
            <div id="player-container">
                <div id="youtube-player"></div>
                <div id="click-overlay"></div>
                <div id="video-header-overlay" class="player-overlay">
                    <button id="back-btn" title="Quay lại">
                        <svg viewBox="0 0 24 24"><path d="M20,11V13H8L13.5,18.5L12.08,19.92L4.16,12L12.08,4.08L13.5,5.5L8,11H20Z"></path></svg>
                    </button>
                    <div id="video-title-container"><h2 id="video-title-display"></h2></div>
                </div>
                <div id="subtitle-display"></div>
                <div id="custom-controls" class="player-overlay">
                    <div class="progress-container" style="position: relative; width: 100%; margin-bottom: 8px;">
                        <input
                            type="range"
                            id="progress-bar"
                            value="0"
                            min="0"
                            style="
                                -webkit-appearance: none;
                                width: 100%;
                                height: 4px;
                                cursor: pointer;
                                border-radius: 5px;
                                transition: height 0.2s;
                                background: linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) var(--progress-percent, 0%), rgba(255, 255, 255, 0.3) var(--progress-percent, 0%), rgba(255, 255, 255, 0.3) 100%);
                            "
                        />
                    </div>
                    <div class="controls-row">
                        <button id="play-pause-btn">
                            <svg><path d="M8,5.14V19.14L19,12.14L8,5.14Z"></path></svg>
                        </button>
                        <div id="time-display">00:00 / 00:00</div>
                        <p id="video-program-display"></p>
                        <div class="spacer"></div>
                        <button id="settings-btn" title="Cài đặt Phụ đề">
                            <svg>
                                <path
                                    d="M19.14,12.94C19.07,12.44 19,11.94 19,11.44C19,10.94 19.07,10.44 19.14,9.94L21.12,8.44C21.26,8.33 21.3,8.14 21.24,7.96L19.28,4.5C19.21,4.34 19.02,4.27 18.86,4.34L16.5,5.39C16,4.94 15.43,4.56 14.81,4.29L14.47,2.05C14.45,1.86 14.28,1.71 14.08,1.71H9.92C9.72,1.71 9.55,1.86 9.53,2.05L9.19,4.29C8.57,4.56 8,4.94 7.5,5.39L5.14,4.34C4.98,4.27 4.79,4.34 4.72,4.5L2.76,7.96C2.7,8.14 2.74,8.33 2.88,8.44L4.86,9.94C4.93,10.44 5,10.94 5,11.44C5,11.94 4.93,12.44 4.86,12.94L2.88,14.44C2.74,14.56 2.7,14.75 2.76,14.93L4.72,18.39C4.79,18.55 4.98,18.62 5.14,18.54L7.5,17.5C8,17.94 8.57,18.32 9.19,18.59L9.53,20.84C9.55,21.03 9.72,21.18 9.92,21.18H14.08C14.28,21.18 14.45,21.03 14.47,20.84L14.81,18.59C15.43,18.32 16,17.94 16.5,17.5L18.86,18.54C19.02,18.62 19.21,18.55 19.28,18.39L21.24,14.93C21.3,14.75 21.26,14.56 21.12,14.44L19.14,12.94M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5Z"
                                ></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div id="settings-menu">
                    <div class="control-group"><label for="font-size-slider">Kích thước chữ</label><input type="range" id="font-size-slider" min="12" max="48" step="1" /></div>
                    <div class="control-group"><label for="font-color-picker">Màu chữ</label><input type="color" id="font-color-picker" /></div>
                    <div class="control-group"><label for="bg-color-picker">Màu nền</label><input type="color" id="bg-color-picker" /></div>
                    <div class="control-group"><label for="bg-opacity-slider">Độ mờ nền</label><input type="range" id="bg-opacity-slider" min="0" max="1" step="0.05" /></div>
                </div>
                <!-- START: Thêm mới cho tính năng UP NEXT -->
                <div id="up-next-overlay" class="player-overlay" style="background-color: rgba(0, 0, 0, 0.8); display: none; flex-direction: column; justify-content: center; align-items: center; text-align: center; pointer-events: auto;">
                    <p style="font-size: 1.2rem; color: #aaa; margin: 0;">Tập tiếp theo sau <span id="up-next-countdown">5</span></p>
                    <div id="up-next-card" style="cursor: pointer; margin-top: 20px;">
                        <img id="up-next-thumbnail" src="" style="width: 250px; aspect-ratio: 16/9; object-fit: cover; border-radius: 5px;" />
                        <h3 id="up-next-title" style="margin: 10px 0 0 0; font-size: 1.4rem;"></h3>
                    </div>
                    <button id="up-next-cancel-btn" style="background: none; border: 1px solid #888; color: #ccc; padding: 8px 16px; border-radius: 4px; margin-top: 30px; cursor: pointer;">Hủy</button>
                </div>
                <!-- END: Thêm mới cho tính năng UP NEXT -->
            </div>
        </div>
        <div id="notification-area"></div>
        <script src="https://www.youtube.com/iframe_api"></script>
        <script>
            const doc = document;
            // --- DOM Elements ---
            const libraryContainer = doc.getElementById("library-container");
            const searchInput = doc.getElementById("search-input");
            const filterTagsContainer = doc.getElementById("filter-tags");
            const addVideoBtn = doc.getElementById("add-video-btn");
            const detailModalOverlay = doc.getElementById("detail-modal-overlay");
            const detailModalCloseBtn = doc.getElementById("detail-modal-close-btn");
            const modalPlayBtn = doc.getElementById("modal-play-btn");
            const modalThumbnail = doc.getElementById("modal-thumbnail");
            const modalTitle = doc.getElementById("modal-title");
            const modalProgram = doc.getElementById("modal-program");
            const modalAuthor = doc.getElementById("modal-author");
            const modalParticipantsList = doc.getElementById("modal-participants-list");
            const modalParticipantsContainer = doc.getElementById("modal-participants-container");
            const addVideoModalOverlay = doc.getElementById("add-video-modal-overlay");
            const addVideoForm = doc.getElementById("add-video-form");
            const addVideoCloseBtn = doc.getElementById("add-video-close-btn");
            const urlInput = doc.getElementById("youtube-url-input");
            const srtFileInput = doc.getElementById("srt-file-input");
            const srtFileName = doc.getElementById("srt-file-name");
            const playerWrapper = doc.getElementById("player-wrapper");
            const playerContainer = doc.getElementById("player-container");
            const clickOverlay = doc.getElementById("click-overlay");
            const backBtn = doc.getElementById("back-btn");
            const videoTitleDisplay = doc.getElementById("video-title-display");
            const videoProgramDisplay = doc.getElementById("video-program-display");
            const subtitleDisplay = doc.getElementById("subtitle-display");
            const settingsBtn = doc.getElementById("settings-btn");
            const settingsMenu = doc.getElementById("settings-menu");
            const fontSizeSlider = doc.getElementById("font-size-slider");
            const fontColorPicker = doc.getElementById("font-color-picker");
            const bgColorPicker = doc.getElementById("bg-color-picker");
            const bgOpacitySlider = doc.getElementById("bg-opacity-slider");
            const playPauseBtn = doc.getElementById("play-pause-btn");
            const progressBar = doc.getElementById("progress-bar");

            // --- State Variables ---
            let player;
            let libraryData = [];
            let subtitles = [];
            let controlsTimeout, progressInterval, subtitleCheckInterval;
            let subtitleSettings = {};
            let currentVideoData = null; // Lưu thông tin video đang phát
            let upNextTimeout, upNextInterval; // Dùng cho tính năng "Tập tiếp theo"
            let lastClickInfo = { time: 0, target: null }; // Dùng để phát hiện double-click
            const DEFAULT_SUB_SETTINGS = { fontSize: "24", fontColor: "#FFFFFF", bgColor: "#000000", bgOpacity: "0.5" };

            // --- Initialization ---
            function onYouTubeIframeAPIReady() {
                initializeLibrary();
            }

            async function initializeLibrary() {
                try {
                    // FIX: Always fetch a fresh JSON file, disable caching
                    const res = await fetch("library.json", { cache: "no-cache" });
                    if (!res.ok) throw new Error("Không thể tải thư viện.");
                    libraryData = await res.json();
                    renderVideoRows(libraryData);
                    populateFilterTags();
                    setupEventListeners();
                    loadSubtitleSettings();
                } catch (e) {
                    libraryContainer.innerHTML = `<p style="color: #ff8a8a; text-align: center;">Lỗi: ${e.message}</p>`;
                }
            }

            // --- UI Rendering ---
            function renderVideoRows(videoArray) {
                libraryContainer.innerHTML = "";
                if (videoArray.length === 0) {
                    libraryContainer.innerHTML = `<p style="text-align: center;">Không tìm thấy video.</p>`;
                    return;
                }
                const groupedByProgram = videoArray.reduce((acc, video) => {
                    const program = video.program || "Chương trình khác";
                    if (!acc[program]) acc[program] = [];
                    acc[program].push(video);
                    return acc;
                }, {});
                const programOrder = Object.keys(groupedByProgram).sort((a, b) => (a === "Chương trình khác" ? 1 : b === "Chương trình khác" ? -1 : a.localeCompare(b)));
                for (const programName of programOrder) {
                    const section = doc.createElement("section");
                    section.className = "program-row";
                    section.innerHTML = `<h2 class="program-title">${programName}</h2><div class="video-list">${groupedByProgram[programName]
                        .map(
                            (video) =>
                                `<div class="video-card" data-video-id="${video.videoId}"><img src="${video.thumbnailUrl || video.thumbnailUrl_auto}" alt="${video.userTitle || video.title}" class="video-thumbnail" loading="lazy"></div>`
                        )
                        .join("")}</div>`;
                    libraryContainer.appendChild(section);
                }
            }

            function populateFilterTags() {
                const allParticipants = [...new Set(libraryData.flatMap((v) => v.participants || []))].sort();
                allParticipants.forEach((p) => {
                    const tag = doc.createElement("span");
                    tag.className = "filter-tag";
                    tag.textContent = p;
                    tag.dataset.filter = p;
                    filterTagsContainer.appendChild(tag);
                });
            }

            // --- Event Handling ---
            function setupEventListeners() {
                searchInput.addEventListener("input", handleSearchAndFilter);
                filterTagsContainer.addEventListener("click", handleTagClick);
                libraryContainer.addEventListener("click", handleCardClick);
                detailModalCloseBtn.addEventListener("click", () => closeModal(detailModalOverlay));
                detailModalOverlay.addEventListener("click", (e) => {
                    if (e.target === detailModalOverlay) closeModal(detailModalOverlay);
                });
                modalPlayBtn.addEventListener("click", handleModalPlay);
                addVideoBtn.addEventListener("click", () => openModal(addVideoModalOverlay));
                addVideoCloseBtn.addEventListener("click", () => closeModal(addVideoModalOverlay));
                addVideoModalOverlay.addEventListener("click", (e) => {
                    if (e.target === addVideoModalOverlay) closeModal(addVideoModalOverlay);
                });
                addVideoForm.addEventListener("submit", handleAddVideoSubmit);
                srtFileInput.addEventListener("change", () => {
                    srtFileName.textContent = srtFileInput.files.length > 0 ? srtFileInput.files[0].name : "";
                });
                backBtn.addEventListener("click", goHome);
                clickOverlay.addEventListener("click", handlePlayerClick);
                // FIX: Add listeners for player controls
                playPauseBtn.addEventListener("click", togglePlayPause);
                progressBar.addEventListener("input", handleSeek);
                playerContainer.addEventListener("mousemove", showControlsAndSetHideTimeout);
                playerContainer.addEventListener("mouseleave", hideControls);
                doc.addEventListener("keydown", handleKeyboardShortcuts);
                doc.addEventListener("fullscreenchange", () => {
                    if (!document.fullscreenElement) goHome();
                });
                settingsBtn.addEventListener("click", (e) => {
                    e.stopPropagation();
                    settingsMenu.classList.toggle("visible");
                });
                doc.addEventListener("click", (e) => {
                    if (!settingsMenu.contains(e.target) && !settingsBtn.contains(e.target)) {
                        settingsMenu.classList.remove("visible");
                    }
                });
                fontSizeSlider.addEventListener("input", () => {
                    subtitleSettings.fontSize = fontSizeSlider.value;
                    applyAndSaveSubtitleStyles();
                });
                fontColorPicker.addEventListener("input", () => {
                    subtitleSettings.fontColor = fontColorPicker.value;
                    applyAndSaveSubtitleStyles();
                });
                bgColorPicker.addEventListener("input", () => {
                    subtitleSettings.bgColor = bgColorPicker.value;
                    applyAndSaveSubtitleStyles();
                });
                bgOpacitySlider.addEventListener("input", () => {
                    subtitleSettings.bgOpacity = bgOpacitySlider.value;
                    applyAndSaveSubtitleStyles();
                });
                doc.body.addEventListener("dragover", (e) => {
                    if (playerWrapper.classList.contains("hidden")) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = "copy";
                });
                doc.body.addEventListener("drop", (e) => {
                    if (playerWrapper.classList.contains("hidden")) return;
                    e.preventDefault();
                    handleFileDrop(e);
                });
            }

            function handleSearchAndFilter() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const activeTag = doc.querySelector(".filter-tag.active");
                const filterTerm = activeTag && activeTag.dataset.filter !== "Tất cả" ? activeTag.dataset.filter : null;
                const filteredData = libraryData.filter(
                    (video) =>
                        (searchTerm === "" ||
                            (video.userTitle || video.title).toLowerCase().includes(searchTerm) ||
                            (video.program || "").toLowerCase().includes(searchTerm) ||
                            (video.participants || []).some((p) => p.toLowerCase().includes(searchTerm))) &&
                        (!filterTerm || (video.participants && video.participants.includes(filterTerm)))
                );
                renderVideoRows(filteredData);
            }

            function handleTagClick(e) {
                if (e.target.classList.contains("filter-tag")) {
                    doc.querySelectorAll(".filter-tag").forEach((tag) => tag.classList.remove("active"));
                    e.target.classList.add("active");
                    handleSearchAndFilter();
                }
            }
            function handleCardClick(e) {
                const card = e.target.closest(".video-card");
                if (card) {
                    const videoId = card.dataset.videoId;
                    const videoData = libraryData.find((v) => v.videoId === videoId);
                    if (videoData) openDetailModal(videoData);
                }
            }
            function handleModalPlay() {
                const videoId = modalPlayBtn.dataset.videoId;
                const videoData = libraryData.find((v) => v.videoId === videoId);
                if (videoData) {
                    closeModal(detailModalOverlay);
                    launchPlayer(videoData);
                }
            }
            function handleAddVideoSubmit(e) {
                e.preventDefault();
                const videoId = extractVideoID(urlInput.value);
                if (!videoId) {
                    alert("Link YouTube không hợp lệ.");
                    return;
                }
                const srtFile = srtFileInput.files[0];
                if (srtFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        launchPlayer({ videoId }, parseSRT(event.target.result));
                    };
                    reader.readAsText(srtFile);
                } else {
                    launchPlayer({ videoId });
                }
                closeModal(addVideoModalOverlay);
                urlInput.value = "";
                srtFileInput.value = "";
                srtFileName.textContent = "";
            }

            function handleFileDrop(e) {
                const file = e.dataTransfer.files[0];
                if (file && file.name.endsWith(".srt")) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        subtitles = parseSRT(event.target.result);
                        if (player && player.getPlayerState() === YT.PlayerState.PLAYING) startSubtitleSync();
                    };
                    reader.readAsText(file);
                }
            }
            function openModal(modal) {
                modal.classList.remove("hidden");
                setTimeout(() => modal.classList.add("visible"), 10);
            }
            function closeModal(modal) {
                modal.classList.remove("visible");
                setTimeout(() => modal.classList.add("hidden"), 300);
            }
            function openDetailModal(videoData) {
                // Sửa lỗi thumbnail: Tự động dùng 'thumbnailUrl_auto' nếu 'thumbnailUrl' không có
                const thumbnailUrl = videoData.thumbnailUrl || videoData.thumbnailUrl_auto;
                modalThumbnail.src = thumbnailUrl.replace("hqdefault", "maxresdefault");
                modalThumbnail.onerror = () => {
                    modalThumbnail.src = thumbnailUrl;
                };

                // Sửa tiêu đề: Thêm số tập nếu có
                let titleText = videoData.userTitle || videoData.title;
                if (videoData.episode) {
                    titleText = `Tập ${videoData.episode}: ${titleText}`;
                }
                modalTitle.textContent = titleText;

                modalProgram.textContent = videoData.program || "";
                // Sửa lỗi tên tác giả: Tự động dùng 'authorName_auto'
                modalAuthor.textContent = videoData.authorName || videoData.authorName_auto || "";

                // -- PHẦN MỚI: Xử lý THỂ LOẠI (genres) --
                const modalGenresContainer = doc.getElementById("modal-genres-container");
                const modalGenresList = doc.getElementById("modal-genres-list");
                modalGenresList.innerHTML = "";
                if (videoData.genres && videoData.genres.length > 0) {
                    videoData.genres.forEach((name) => {
                        const li = doc.createElement("li");
                        li.className = "genre-tag"; // Sử dụng class CSS mới
                        li.textContent = name;
                        modalGenresList.appendChild(li);
                    });
                    modalGenresContainer.classList.remove("hidden");
                } else {
                    modalGenresContainer.classList.add("hidden");
                }

                // -- PHẦN MỚI: Xử lý MÔ TẢ (description) --
                const modalDescription = doc.getElementById("modal-description");
                if (videoData.description) {
                    modalDescription.textContent = videoData.description;
                    modalDescription.classList.remove("hidden");
                } else {
                    modalDescription.textContent = "";
                    modalDescription.classList.add("hidden");
                }

                // Xử lý người tham gia (giữ nguyên)
                modalParticipantsList.innerHTML = "";
                if (videoData.participants && videoData.participants.length > 0) {
                    videoData.participants.forEach((name) => {
                        const li = doc.createElement("li");
                        li.className = "participant-tag";
                        li.textContent = name;
                        modalParticipantsList.appendChild(li);
                    });
                    modalParticipantsContainer.classList.remove("hidden");
                } else {
                    modalParticipantsContainer.classList.add("hidden");
                }

                modalPlayBtn.dataset.videoId = videoData.videoId;
                openModal(detailModalOverlay);
            }

            async function launchPlayer(videoData, preloadedSubtitles = null) {
                if (!videoData || !videoData.videoId) return;

                // --- Cập nhật quan trọng ---
                currentVideoData = videoData; // Lưu lại video data hiện tại
                hideUpNextOverlay(); // Ẩn màn hình "Up Next" nếu nó đang hiện
                // --- Hết cập nhật ---

                subtitles = preloadedSubtitles || [];
                subtitleDisplay.innerHTML = "";
                playerWrapper.classList.remove("hidden");
                videoTitleDisplay.textContent = videoData.userTitle || videoData.title || "Đang tải...";
                videoProgramDisplay.textContent = videoData.program || "";

                // Tạm thời vô hiệu hóa click overlay để cho phép autoplay gốc
                clickOverlay.style.pointerEvents = "none";

                await enterCinematicMode();
                if (videoData.subtitleUrl) {
                    loadRemoteSubtitle(videoData.subtitleUrl);
                } else if (subtitles.length > 0) {
                    startSubtitleSync();
                }
                if (player) {
                    player.loadVideoById(videoData.videoId);
                } else {
                    player = new YT.Player("youtube-player", {
                        videoId: videoData.videoId,
                        playerVars: { autoplay: 1, playsinline: 1, rel: 0, modestbranding: 1, controls: 0, showinfo: 0, iv_load_policy: 3 },
                        events: { onReady: onPlayerReady, onStateChange: onPlayerStateChange },
                    });
                }
            }

            async function enterCinematicMode() {
                try {
                    if (playerContainer.requestFullscreen) await playerContainer.requestFullscreen();
                    if (screen.orientation && screen.orientation.lock) await screen.orientation.lock("landscape");
                } catch (err) {
                    console.warn("Lỗi cinematic:", err);
                }
            }
            function goHome() {
                if (player) player.stopVideo();
                playerWrapper.classList.add("hidden");
                if (document.fullscreenElement) document.exitFullscreen();
            }

            function onPlayerReady(event) {
                const apiData = event.target.getVideoData();
                videoTitleDisplay.textContent = apiData.title;
                // FIX: Force playVideo() call to maximize autoplay success
                event.target.playVideo();
            }

            function onPlayerStateChange(event) {
                const iconPath = event.data === YT.PlayerState.PLAYING ? "M14,19H18V5H14M6,19H10V5H6V19Z" : "M8,5.14V19.14L19,12.14L8,5.14Z";
                playPauseBtn.querySelector("svg path").setAttribute("d", iconPath);

                if (event.data === YT.PlayerState.PLAYING) {
                    // Kích hoạt overlay sau khi video đã bắt đầu phát
                    clickOverlay.style.pointerEvents = "auto";
                    startSyncing();
                    playerContainer.classList.add("no-cursor");
                    showControlsAndSetHideTimeout();
                    hideUpNextOverlay(); // Ẩn đề xuất nếu người dùng bấm play lại
                } else {
                    stopSyncing();
                    playerContainer.classList.remove("no-cursor");
                    showControlsAndSetHideTimeout(); // Giữ control hiện khi pause
                }

                // --- PHẦN MỚI: Xử lý khi video kết thúc ---
                if (event.data === YT.PlayerState.ENDED) {
                    handleVideoEnd();
                }
            }

            // FIX: Corrected player click logic for mobile
            function handlePlayerClick(e) {
                const now = new Date().getTime();
                const timeSinceLastClick = now - lastClickInfo.time;
                const target = e.target;

                if (timeSinceLastClick < 300 && target === lastClickInfo.target) {
                    // Double click
                    const clickX = e.clientX;
                    const screenThird = window.innerWidth / 3;
                    const currentTime = player.getCurrentTime();

                    if (clickX < screenThird) {
                        // Double click left
                        player.seekTo(Math.max(0, currentTime - 5), true);
                    } else if (clickX > screenThird * 2) {
                        // Double click right
                        player.seekTo(currentTime + 5, true);
                    }
                    // Reset click info to prevent triple clicks
                    lastClickInfo = { time: 0, target: null };
                } else {
                    // Single click
                    if (playerContainer.classList.contains("controls-active")) {
                        hideControls();
                    } else {
                        showControlsAndSetHideTimeout();
                    }
                }

                lastClickInfo = { time: now, target: target };
            }
            // FIX: Added function to handle seek
            function handleSeek() {
                player.seekTo(progressBar.value, true);
            }
            // FIX: Added dedicated toggle function for the button
            function togglePlayPause() {
                if (player && player.getPlayerState) player.getPlayerState() === YT.PlayerState.PLAYING ? player.pauseVideo() : player.playVideo();
            }

            function showControlsAndSetHideTimeout() {
                if (!player) return;
                clearTimeout(controlsTimeout);
                playerContainer.classList.add("controls-active");
                if (player.getPlayerState() === YT.PlayerState.PLAYING) {
                    controlsTimeout = setTimeout(hideControls, 3500);
                }
            }
            function hideControls() {
                clearTimeout(controlsTimeout);
                // Chỉ ẩn nếu menu settings không mở
                if (!settingsMenu.classList.contains("visible")) {
                    playerContainer.classList.remove("controls-active");
                }
            }
            function handleKeyboardShortcuts(e) {
                if (doc.activeElement === searchInput || doc.activeElement === urlInput || playerWrapper.classList.contains("hidden")) return;
                switch (e.code) {
                    case "Space":
                        e.preventDefault();
                        togglePlayPause();
                        break;
                    case "Escape":
                        e.preventDefault();
                        goHome();
                        break;
                }
            }

            function applyAndSaveSubtitleStyles() {
                applySubtitleStyles();
                saveSubtitleSettings();
            }
            function applySubtitleStyles() {
                function hexToRgba(hex, op) {
                    let r = "0x" + hex[1] + hex[2],
                        g = "0x" + hex[3] + hex[4],
                        b = "0x" + hex[5] + hex[6];
                    return `rgba(${+r},${+g},${+b},${op})`;
                }
                subtitleDisplay.style.fontSize = `${subtitleSettings.fontSize}px`;
                subtitleDisplay.style.color = subtitleSettings.fontColor;
                subtitleDisplay.style.backgroundColor = hexToRgba(subtitleSettings.bgColor, subtitleSettings.bgOpacity);
            }
            function saveSubtitleSettings() {
                localStorage.setItem("youtubeVODPlayerSubSettings", JSON.stringify(subtitleSettings));
            }
            function loadSubtitleSettings() {
                const saved = localStorage.getItem("youtubeVODPlayerSubSettings");
                subtitleSettings = saved ? JSON.parse(saved) : { ...DEFAULT_SUB_SETTINGS };
                fontSizeSlider.value = subtitleSettings.fontSize;
                fontColorPicker.value = subtitleSettings.fontColor;
                bgColorPicker.value = subtitleSettings.bgColor;
                bgOpacitySlider.value = subtitleSettings.bgOpacity;
                applySubtitleStyles();
            }

            function startSyncing() {
                startProgressSync();
                if (subtitles.length > 0) startSubtitleSync();
            }
            function stopSyncing() {
                stopProgressSync();
                stopSubtitleSync();
            }
            function stopProgressSync() {
                clearInterval(progressInterval);
            }
            function stopSubtitleSync() {
                clearInterval(subtitleCheckInterval);
            }
            function startProgressSync() {
                stopProgressSync();
                const tDisplay = doc.getElementById("time-display");
                progressInterval = setInterval(() => {
                    if (!player || typeof player.getDuration !== "function") return;
                    const d = player.getDuration(),
                        c = player.getCurrentTime();
                    if (isNaN(d)) return;
                    progressBar.max = d;
                    progressBar.value = c;
                    progressBar.style.setProperty("--progress-percent", `${d > 0 ? (c / d) * 100 : 0}%`);
                    const formatTime = (s) => {
                        const t = Math.round(s);
                        return `${String(Math.floor(t / 60)).padStart(2, "0")}:${String(t % 60).padStart(2, "0")}`;
                    };
                    if (tDisplay) tDisplay.textContent = `${formatTime(c)} / ${formatTime(d)}`;
                }, 250);
            }
            function startSubtitleSync() {
                stopSubtitleSync();
                subtitleCheckInterval = setInterval(() => {
                    if (!player || typeof player.getCurrentTime !== "function") return;
                    const c = player.getCurrentTime();
                    const sub = subtitles.find((s) => c >= s.start && s.end >= c);
                    subtitleDisplay.innerHTML = sub ? sub.text : "";
                }, 100);
            }
            async function loadRemoteSubtitle(url) {
                if (!url) return;
                try {
                    const res = await fetch(url);
                    if (!res.ok) throw new Error(`Could not fetch SRT`);
                    const srt = await res.text();
                    subtitles = parseSRT(srt);
                    if (subtitles.length > 0) startSubtitleSync();
                } catch (e) {
                    console.error("Could not load subtitle:", e);
                }
            }
            function parseSRT(text) {
                const subs = [];
                const blocks = text.trim().replace(/\r/g, "").split("\n\n");
                for (const block of blocks) {
                    const lines = block.split("\n");
                    const timeIdx = lines.findIndex((l) => l.includes("-->"));
                    if (timeIdx !== -1) {
                        const txt = lines.slice(timeIdx + 1).join("<br>");
                        const match = lines[timeIdx].match(/(.*) --> (.*)/);
                        if (match && txt) subs.push({ start: srtTimeToSeconds(match[1].trim()), end: srtTimeToSeconds(match[2].trim()), text: txt });
                    }
                }
                return subs;
            }
            function srtTimeToSeconds(t) {
                const p = t.split(/[:,]/).reverse();
                return (parseInt(p[3], 10) || 0) * 3600 + (parseInt(p[2], 10) || 0) * 60 + (parseInt(p[1], 10) || 0) + (parseInt(p[0], 10) || 0) / 1000;
            }
            function extractVideoID(url) {
                const regex = /(?:watch\?v=|youtu\.be\/|embed\/|v\/|e\/|shorts\/)([a-zA-Z0-9_-]{11})/;
                const match = url.match(regex);
                return match ? match[1] : null;
            }
            // START: Các hàm mới cho tính năng UP NEXT
            function handleVideoEnd() {
                if (!currentVideoData) return;

                let nextVideo = null;
                // Tìm tập tiếp theo nếu có thể
                if (currentVideoData.program && typeof currentVideoData.episode !== "undefined") {
                    const currentEpisode = Number(currentVideoData.episode);
                    nextVideo = libraryData.find((v) => v.program === currentVideoData.program && Number(v.episode) === currentEpisode + 1);
                }

                if (nextVideo) {
                    showUpNextOverlay(nextVideo);
                } else {
                    // Có thể thêm logic đề xuất ngẫu nhiên ở đây
                    // Hiện tại, chỉ hiển thị control để người dùng tự quyết định
                    showControlsAndSetHideTimeout();
                }
            }

            function showUpNextOverlay(videoData) {
                const overlay = doc.getElementById("up-next-overlay");
                const thumbnail = doc.getElementById("up-next-thumbnail");
                const title = doc.getElementById("up-next-title");
                const countdownSpan = doc.getElementById("up-next-countdown");
                const card = doc.getElementById("up-next-card");
                const cancelBtn = doc.getElementById("up-next-cancel-btn");

                const thumbnailUrl = videoData.thumbnailUrl || videoData.thumbnailUrl_auto;
                thumbnail.src = thumbnailUrl;
                title.textContent = videoData.userTitle || videoData.title;

                overlay.style.display = "flex";
                let countdown = 5;
                countdownSpan.textContent = countdown;

                // Xử lý sự kiện click
                const playNext = () => {
                    hideUpNextOverlay();
                    launchPlayer(videoData);
                };
                card.onclick = playNext;
                cancelBtn.onclick = hideUpNextOverlay;

                // Đếm ngược
                upNextInterval = setInterval(() => {
                    countdown--;
                    countdownSpan.textContent = countdown;
                }, 1000);

                upNextTimeout = setTimeout(() => {
                    playNext();
                }, 5000);
            }

            function hideUpNextOverlay() {
                clearTimeout(upNextTimeout);
                clearInterval(upNextInterval);
                const overlay = doc.getElementById("up-next-overlay");
                if (overlay) overlay.style.display = "none";
                const card = doc.getElementById("up-next-card");
                if (card) card.onclick = null; // Gỡ listener để tránh memory leak
            }
            // END: Các hàm mới
        </script>
    </body>
</html>
