<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wager Game - Ultimate AI Edition</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Unbounded:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Unbounded', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            bg: '#09090b', // Zinc 950
                            surface: '#18181b', // Zinc 900
                            border: '#27272a', // Zinc 800
                        },
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'score-change': 'scoreChange 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)' },
                        },
                        scoreChange: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.5)' },
                            '50%': { opacity: '1', transform: 'translateY(-10px) scale(1.2)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 3px; }
        body { overflow: hidden; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* Grid auto-fit for teams */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            width: 100%;
        }
    </style>
</head>
<body class="antialiased transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, createContext, useContext, useRef } = React;

        const generateId = () => Math.random().toString(36).substr(2, 9);

        // Toast System
        const ToastContext = createContext();
        const useToast = () => useContext(ToastContext);

        const ToastProvider = ({ children }) => {
            const [toasts, setToasts] = useState([]);
            const addToast = (message, type = 'info') => {
                const id = generateId();
                setToasts(prev => [...prev, { id, message, type }]);
                setTimeout(() => removeToast(id), 3000);
            };
            const removeToast = (id) => setToasts(prev => prev.filter(t => t.id !== id));

            return (
                <ToastContext.Provider value={{ addToast }}>
                    {children}
                    <div className="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none">
                        {toasts.map(toast => (
                            <div key={toast.id} className={`pointer-events-auto px-4 py-3 rounded-lg shadow-lg border animate-slide-up flex items-center gap-2 text-sm font-medium
                                ${toast.type === 'error' ? 'bg-red-900/90 border-red-700 text-red-100' : 
                                  toast.type === 'success' ? 'bg-emerald-900/90 border-emerald-700 text-emerald-100' : 
                                  'bg-zinc-800 border-zinc-700 text-zinc-100'}`}>
                                {toast.message}
                            </div>
                        ))}
                    </div>
                </ToastContext.Provider>
            );
        };

        // LocalStorage Hook
        const useLocalStorage = (key, initialValue) => {
            const readValue = () => {
                if (typeof window === 'undefined') return initialValue;
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) { return initialValue; }
            };
            const [storedValue, setStoredValue] = useState(readValue);
            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {}
            };
            useEffect(() => {
                const handleStorageChange = (e) => {
                    if (e.key === key) setStoredValue(readValue());
                };
                window.addEventListener('storage', handleStorageChange);
                return () => window.removeEventListener('storage', handleStorageChange);
            }, [key]);
            return [storedValue, setValue];
        };

        // UI Components
        const Button = ({ children, onClick, variant = 'primary', className = '', ...props }) => {
            const base = "px-4 py-2 rounded-lg font-medium transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2";
            const variants = {
                primary: "bg-indigo-600 hover:bg-indigo-500 text-white shadow-lg shadow-indigo-500/20",
                secondary: "bg-zinc-200 dark:bg-zinc-800 hover:bg-zinc-300 dark:hover:bg-zinc-700 text-zinc-900 dark:text-zinc-100",
                ghost: "hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400",
            };
            return <button onClick={onClick} className={`${base} ${variants[variant]} ${className}`} {...props}>{children}</button>;
        };

        const Card = ({ children, className = '' }) => (
            <div className={`bg-white dark:bg-dark-surface border border-zinc-200 dark:border-dark-border rounded-xl shadow-sm p-4 ${className}`}>{children}</div>
        );

        const Input = ({ label, ...props }) => (
            <div className="flex flex-col gap-1.5">
                {label && <label className="text-xs font-bold uppercase text-zinc-500">{label}</label>}
                <input className="w-full bg-zinc-50 dark:bg-zinc-900/50 border border-zinc-200 dark:border-zinc-700 rounded-lg px-3 py-2 text-zinc-900 dark:text-zinc-100 focus:outline-none focus:ring-2 focus:ring-indigo-500/50 transition-all" {...props} />
            </div>
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fade-in">
                    <div className="bg-white dark:bg-dark-surface w-full max-w-md rounded-2xl shadow-2xl border border-zinc-200 dark:border-dark-border animate-pop overflow-hidden flex flex-col max-h-[90vh]">
                        <div className="p-4 border-b border-zinc-100 dark:border-zinc-800 flex justify-between items-center">
                            <h3 className="font-display font-bold text-lg dark:text-white">{title}</h3>
                            <button onClick={onClose}><i data-lucide="x" className="w-5 h-5 text-zinc-500"></i></button>
                        </div>
                        <div className="p-6 overflow-y-auto">{children}</div>
                    </div>
                </div>
            );
        };

        // --- Dashboard (Setup) ---
        const Dashboard = ({ data, setData, onStartGame }) => {
            const { addToast } = useToast();
            const [newTeamName, setNewTeamName] = useState('');
            const [isAddQuestionOpen, setIsAddQuestionOpen] = useState(false);
            const [editingQuestion, setEditingQuestion] = useState(null);
            const [defaultScore, setDefaultScore] = useState(100);
            const [qForm, setQForm] = useState({ statement: '', explanation: '', answer: true });

            const addTeam = (e) => {
                e.preventDefault();
                if (!newTeamName.trim()) return;
                setData(prev => ({
                    ...prev,
                    teams: [...prev.teams, { id: generateId(), name: newTeamName, score: defaultScore }]
                }));
                setNewTeamName('');
                addToast(`Đã thêm đội`, 'success');
            };

            const saveQuestion = () => {
                if (!qForm.statement.trim()) { addToast('Thiếu nội dung', 'error'); return; }
                const newQ = { id: editingQuestion ? editingQuestion.id : generateId(), ...qForm };
                setData(prev => ({
                    ...prev,
                    questions: editingQuestion ? prev.questions.map(q => q.id === newQ.id ? newQ : q) : [...prev.questions, newQ]
                }));
                setIsAddQuestionOpen(false);
                setEditingQuestion(null);
                setQForm({ statement: '', explanation: '', answer: true });
                addToast('Đã lưu câu hỏi', 'success');
            };

            const openProjectorWindow = () => {
                const url = new URL(window.location.href);
                url.searchParams.set('mode', 'projector');
                
                // Mở popup ngay tại màn hình hiện tại (tránh bị chặn)
                const width = 1024;
                const height = 768;
                // Mở giữa màn hình
                const left = (window.screen.width - width) / 2;
                const top = (window.screen.height - height) / 2;

                window.open(url.toString(), 'WagerProjector', `width=${width},height=${height},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no,resizable=yes`);
                addToast('Đã mở cửa sổ chiếu. Hãy bấm Fullscreen trên cửa sổ đó!', 'success');
                
                // TỰ ĐỘNG CHUYỂN TAB HIỆN TẠI SANG HOST MODE
                onStartGame(); 
            };

            return (
                <div className="max-w-6xl mx-auto space-y-6 pb-20 animate-slide-up">
                    <header className="flex justify-between items-end border-b pb-4 dark:border-zinc-800">
                        <div>
                            <h1 className="text-2xl font-display font-bold dark:text-white">Thiết lập Game</h1>
                            <p className="text-sm text-zinc-500">Quản lý đội & câu hỏi</p>
                        </div>
                        <div className="flex gap-2">
                            <Button onClick={openProjectorWindow} variant="secondary">
                                <i data-lucide="monitor-up" className="w-4 h-4"></i> Cửa sổ chiếu
                            </Button>
                            <Button onClick={onStartGame} disabled={!data.teams.length || !data.questions.length}>
                                <i data-lucide="play-circle" className="w-4 h-4"></i> Bắt đầu
                            </Button>
                        </div>
                    </header>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="space-y-4">
                            <Card>
                                <div className="flex justify-between mb-4">
                                    <h2 className="font-bold dark:text-zinc-200">Đội chơi ({data.teams.length})</h2>
                                    <input type="number" value={defaultScore} onChange={e=>setDefaultScore(+e.target.value)} className="w-16 bg-zinc-100 dark:bg-zinc-800 rounded text-center text-sm"/>
                                </div>
                                <form onSubmit={addTeam} className="flex gap-2 mb-2">
                                    <Input placeholder="Tên đội..." value={newTeamName} onChange={e=>setNewTeamName(e.target.value)} />
                                    <Button type="submit" variant="secondary">+</Button>
                                </form>
                                <div className="space-y-2 max-h-[40vh] overflow-y-auto">
                                    {data.teams.map(t => (
                                        <div key={t.id} className="flex justify-between p-2 bg-zinc-50 dark:bg-zinc-900 rounded border border-zinc-200 dark:border-zinc-700 items-center">
                                            <span className="font-medium dark:text-zinc-300">{t.name}</span>
                                            <button onClick={()=>setData(p=>({...p,teams:p.teams.filter(x=>x.id!==t.id)}))} className="text-zinc-400 hover:text-red-500"><i data-lucide="trash-2" className="w-4 h-4"></i></button>
                                        </div>
                                    ))}
                                </div>
                            </Card>
                        </div>

                        <div className="lg:col-span-2">
                            <div className="flex justify-between items-center mb-4">
                                <h2 className="font-bold dark:text-zinc-200">Câu hỏi ({data.questions.length})</h2>
                                <Button onClick={()=>{setEditingQuestion(null);setQForm({statement:'',explanation:'',answer:true});setIsAddQuestionOpen(true)}} variant="secondary" size="sm">+ Thêm</Button>
                            </div>
                            <div className="grid gap-3 max-h-[60vh] overflow-y-auto">
                                {data.questions.map((q,i) => (
                                    <Card key={q.id} className="relative group hover:border-indigo-500/50">
                                        <div className="absolute top-2 right-2 opacity-0 group-hover:opacity-100 flex gap-2">
                                            <button onClick={()=>{setEditingQuestion(q);setQForm(q);setIsAddQuestionOpen(true)}} className="p-1.5 bg-zinc-100 hover:text-indigo-600 rounded"><i data-lucide="edit-2" className="w-4 h-4"></i></button>
                                            <button onClick={()=>setData(p=>({...p,questions:p.questions.filter(x=>x.id!==q.id)}))} className="p-1.5 bg-zinc-100 hover:text-red-600 rounded"><i data-lucide="trash" className="w-4 h-4"></i></button>
                                        </div>
                                        <div className="flex gap-3">
                                            <span className="text-zinc-400 font-display font-bold">#{i+1}</span>
                                            <div>
                                                <p className="font-medium dark:text-zinc-200">{q.statement}</p>
                                                <div className="flex gap-2 text-xs mt-1">
                                                    <span className={q.answer?'text-emerald-500':'text-red-500'}>{q.answer?'ĐÚNG':'SAI'}</span>
                                                    <span className="text-zinc-500 truncate max-w-xs">{q.explanation}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </Card>
                                ))}
                            </div>
                        </div>
                    </div>

                    <Modal isOpen={isAddQuestionOpen} onClose={()=>setIsAddQuestionOpen(false)} title="Câu hỏi">
                        <div className="space-y-4">
                            <Input label="Luận điểm" value={qForm.statement} onChange={e=>setQForm({...qForm,statement:e.target.value})} />
                            <div className="flex gap-2">
                                <button onClick={()=>setQForm({...qForm,answer:true})} className={`flex-1 py-2 rounded font-bold text-sm ${qForm.answer?'bg-emerald-600 text-white':'bg-zinc-100 text-zinc-500'}`}>ĐÚNG</button>
                                <button onClick={()=>setQForm({...qForm,answer:false})} className={`flex-1 py-2 rounded font-bold text-sm ${!qForm.answer?'bg-red-600 text-white':'bg-zinc-100 text-zinc-500'}`}>SAI</button>
                            </div>
                            <Input label="Giải thích" value={qForm.explanation} onChange={e=>setQForm({...qForm,explanation:e.target.value})} />
                            <Button onClick={saveQuestion} className="w-full">Lưu</Button>
                        </div>
                    </Modal>
                </div>
            );
        };

        // --- HOST CONTROL (Tab 1) ---
        const HostControl = ({ data, setData, gameState, setGameState, onBack }) => {
            const { currentQIndex, isRevealed, bets } = gameState;
            const currentQ = data.questions[currentQIndex];
            const { addToast } = useToast();

            const updateBet = (tid, field, val) => {
                setGameState(p => ({
                    ...p,
                    bets: { ...p.bets, [tid]: { ...(p.bets[tid]||{amount:0,isConfirmed:false}), [field]: val } }
                }));
            };

            const confirmBet = (tid) => {
                if(bets[tid]?.choice == null) return addToast('Chưa chọn Đ/S', 'error');
                updateBet(tid, 'isConfirmed', true);
            };

            const revealAnswer = () => {
                const newTeams = data.teams.map(t => {
                    const b = bets[t.id];
                    if (b?.isConfirmed && b.choice != null) {
                        return { ...t, score: t.score + (b.choice === currentQ.answer ? b.amount : -b.amount) };
                    }
                    return t;
                });
                setData(p => ({ ...p, teams: newTeams }));
                setGameState(p => ({ ...p, isRevealed: true }));
            };

            const nextQ = () => {
                if (currentQIndex >= data.questions.length - 1) return addToast('Hết câu hỏi', 'info');
                setGameState(p => ({ ...p, currentQIndex: p.currentQIndex + 1, isRevealed: false, bets: {} }));
            };

            return (
                <div className="h-full flex flex-col bg-light-bg dark:bg-dark-bg p-4 overflow-hidden">
                    <div className="flex justify-between items-center mb-4 border-b pb-4 dark:border-zinc-800 shrink-0">
                        <div className="flex items-center gap-4">
                            <Button variant="ghost" onClick={onBack} size="sm"><i data-lucide="arrow-left" className="w-4 h-4"></i></Button>
                            <h2 className="font-display font-bold text-xl dark:text-white">HOST CONTROL</h2>
                        </div>
                        <div className="flex gap-2">
                             <Button onClick={revealAnswer} disabled={isRevealed} className="bg-indigo-600 text-white">HIỆN ĐÁP ÁN</Button>
                            <Button onClick={nextQ} disabled={!isRevealed} variant={isRevealed ? "primary" : "secondary"}>TIẾP THEO</Button>
                        </div>
                    </div>

                    <div className="flex-1 flex gap-6 overflow-hidden">
                        <div className="w-1/3 bg-white dark:bg-dark-surface p-6 rounded-xl border dark:border-zinc-800 overflow-y-auto">
                            <span className="text-xs font-bold text-zinc-500 uppercase">CÂU HỎI #{currentQIndex + 1}</span>
                            <h3 className="text-xl font-bold mt-2 mb-4 dark:text-white">{currentQ.statement}</h3>
                            <div className={`p-4 rounded border ${currentQ.answer?'bg-emerald-500/10 text-emerald-600 border-emerald-500/30':'bg-red-500/10 text-red-600 border-red-500/30'}`}>
                                <div className="font-bold">ĐÁP ÁN: {currentQ.answer?'ĐÚNG':'SAI'}</div>
                                <div className="text-sm mt-1 opacity-80">{currentQ.explanation}</div>
                            </div>
                        </div>

                        <div className="flex-1 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-4 pb-10">
                            {data.teams.map(t => {
                                const b = bets[t.id] || { choice: null, amount: 0, isConfirmed: false };
                                return (
                                    <Card key={t.id} className={`flex flex-col gap-3 ${b.isConfirmed ? 'ring-2 ring-indigo-500' : ''}`}>
                                        <div className="flex justify-between">
                                            <span className="font-bold text-lg dark:text-white truncate">{t.name}</span>
                                            <span className="font-mono font-bold">{t.score}</span>
                                        </div>
                                        {!b.isConfirmed ? (
                                            <>
                                                <div className="flex gap-2">
                                                    <button onClick={()=>updateBet(t.id,'choice',true)} className={`flex-1 py-2 rounded font-bold border ${b.choice===true?'bg-emerald-600 text-white border-emerald-600':'dark:text-zinc-400 dark:border-zinc-700'}`}>ĐÚNG</button>
                                                    <button onClick={()=>updateBet(t.id,'choice',false)} className={`flex-1 py-2 rounded font-bold border ${b.choice===false?'bg-red-600 text-white border-red-600':'dark:text-zinc-400 dark:border-zinc-700'}`}>SAI</button>
                                                </div>
                                                <div className="flex gap-2">
                                                    <input type="number" value={b.amount||''} onChange={e=>updateBet(t.id,'amount',+e.target.value)} placeholder="Điểm cược..." className="flex-1 bg-zinc-50 dark:bg-zinc-900 border rounded px-3 font-mono text-lg font-bold"/>
                                                    <button onClick={()=>updateBet(t.id,'amount',t.score)} className="px-3 bg-red-100 text-red-600 rounded text-xs font-bold">ALL</button>
                                                </div>
                                                <Button onClick={()=>confirmBet(t.id)} className="w-full">XÁC NHẬN</Button>
                                            </>
                                        ) : (
                                            <div onClick={()=>updateBet(t.id,'isConfirmed',false)} className="bg-indigo-50 dark:bg-indigo-900/20 p-4 rounded text-center cursor-pointer hover:opacity-80">
                                                <div className="text-xs text-indigo-500 font-bold mb-1">ĐÃ CHỐT</div>
                                                <div className={`text-xl font-black ${b.choice?'text-emerald-500':'text-red-500'}`}>{b.choice?'ĐÚNG':'SAI'}</div>
                                                <div className="font-mono font-bold dark:text-white">{b.amount} điểm</div>
                                                <div className="text-[10px] text-zinc-400 mt-1">(Bấm để mở khóa)</div>
                                            </div>
                                        )}
                                    </Card>
                                )
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- PROJECTOR VIEW (Tab 2 - Optimized Display) ---
        const ProjectorView = ({ data, gameState }) => {
            const { currentQIndex, isRevealed, bets } = gameState;
            const currentQ = data.questions[currentQIndex];
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [hasInteracted, setHasInteracted] = useState(false);

            const toggleFullscreen = async () => {
                setHasInteracted(true);
                
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                    setIsFullscreen(false);
                    return;
                }

                // LOGIC PHÓNG TO VÀ CHUYỂN MÀN HÌNH
                try {
                    // 1. Nếu trình duyệt hỗ trợ getScreenDetails, cố gắng tìm màn hình phụ
                    if ('getScreenDetails' in window) {
                        const screenDetails = await window.getScreenDetails();
                        const external = screenDetails.screens.find(s => s !== screenDetails.currentScreen);
                        
                        if (external) {
                            // Cách 1: Thử dùng API mới để fullscreen thẳng sang màn hình đó
                            try {
                                await document.documentElement.requestFullscreen({ screen: external });
                                setIsFullscreen(true);
                                return; // Thành công thì thoát
                            } catch(e) { console.log('Fullscreen target screen failed, trying move...'); }
                            
                            // Cách 2: Nếu không được, thử Move window sang đó trước
                             // Lưu ý: window.moveTo thường chỉ hoạt động với cửa sổ popup do script tạo ra
                            window.moveTo(external.left, external.top);
                        }
                    }
                } catch (err) {
                    console.log("Window management error:", err);
                }

                // 2. Fallback: Fullscreen bình thường (tại màn hình hiện tại hoặc sau khi đã move)
                try {
                    await document.documentElement.requestFullscreen();
                    setIsFullscreen(true);
                } catch (e) {
                    console.error("Fullscreen error:", e);
                }
            };

            return (
                <div className="fixed inset-0 z-50 bg-dark-bg flex flex-col items-center justify-between p-4 md:p-8 select-none overflow-hidden cursor-none text-white">
                    {/* Fullscreen Overlay Trigger */}
                    {!hasInteracted && !isFullscreen && (
                        <div 
                            onClick={toggleFullscreen}
                            className="absolute inset-0 z-[100] bg-black/80 flex items-center justify-center cursor-pointer backdrop-blur-sm"
                        >
                            <div className="bg-white text-black px-8 py-4 rounded-full font-bold text-xl animate-bounce shadow-2xl flex items-center gap-3">
                                <i data-lucide="expand" className="w-6 h-6"></i> Bấm để Fullscreen & Chiếu
                            </div>
                        </div>
                    )}
                    
                    <div className="absolute top-4 right-4 opacity-0 hover:opacity-100 transition-opacity z-50">
                        <button onClick={toggleFullscreen} className="text-white p-2 bg-white/10 rounded-full"><i data-lucide={isFullscreen?"minimize":"maximize"}></i></button>
                    </div>

                    {/* Question Area */}
                    <div className={`w-full max-w-7xl text-center transition-all duration-700 flex flex-col items-center justify-center ${isRevealed ? 'flex-[0.3]' : 'flex-1'}`}>
                        <div className="inline-block px-4 py-1 rounded-full border border-indigo-500/30 bg-indigo-500/10 text-indigo-400 font-display font-bold tracking-widest text-sm mb-4">
                            CÂU HỎI #{currentQIndex + 1}
                        </div>
                        <h1 className="text-3xl md:text-5xl lg:text-6xl font-display font-bold leading-tight drop-shadow-2xl px-4 text-balance">
                            {currentQ.statement}
                        </h1>
                    </div>

                    {/* Team Grid - Auto Responsive */}
                    <div className={`team-grid w-full max-w-[1600px] transition-all duration-500 ${isRevealed ? 'flex-[0.7]' : 'flex-[0.5]'}`}>
                        {data.teams.map(team => {
                            const bet = bets[team.id];
                            const isCorrect = bet?.choice === currentQ.answer;
                            const showResult = isRevealed && bet?.isConfirmed;
                            
                            return (
                                <div key={team.id} className={`relative bg-zinc-900/50 backdrop-blur-md border rounded-2xl p-4 flex flex-col items-center justify-center gap-2 transition-all duration-500
                                    ${showResult 
                                        ? (isCorrect ? 'border-emerald-500 bg-emerald-900/20' : 'border-red-500 bg-red-900/20') 
                                        : (bet?.isConfirmed ? 'border-indigo-500/50 bg-indigo-900/10' : 'border-zinc-800')
                                    }
                                `}>
                                    <div className="font-display font-bold text-xl md:text-2xl text-zinc-300 text-center break-words w-full px-2 leading-tight">
                                        {team.name}
                                    </div>
                                    
                                    <div className="relative font-mono font-bold text-5xl md:text-7xl lg:text-8xl tracking-tighter my-2">
                                        {team.score}
                                        
                                        {/* Score Change Animation */}
                                        {showResult && (
                                            <div className={`absolute -top-12 -right-12 text-4xl md:text-5xl font-black animate-score-change ${isCorrect ? 'text-emerald-400' : 'text-red-400'}`}>
                                                {isCorrect ? '+' : '-'}{bet.amount}
                                            </div>
                                        )}
                                    </div>

                                    {/* Status Indicators */}
                                    <div className="h-8 flex items-center justify-center">
                                        {isRevealed ? (
                                            bet?.isConfirmed ? (
                                                <div className={`font-bold text-lg tracking-widest ${isCorrect ? 'text-emerald-500' : 'text-red-500'}`}>
                                                    {bet.choice ? 'ĐÚNG' : 'SAI'}
                                                </div>
                                            ) : <span className="text-zinc-600 text-sm">--</span>
                                        ) : (
                                            bet?.isConfirmed ? (
                                                <div className="text-indigo-400 animate-pulse"><i data-lucide="lock" className="w-6 h-6"></i></div>
                                            ) : (
                                                <span className="text-zinc-700 font-display text-2xl animate-pulse">...</span>
                                            )
                                        )}
                                    </div>
                                </div>
                            );
                        })}
                    </div>

                    {/* Answer Reveal (Overlay) */}
                    {isRevealed && (
                        <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-40 flex flex-col items-center animate-pop pointer-events-none">
                            <div className={`text-6xl md:text-9xl font-black font-display px-12 py-6 rounded-3xl bg-black/80 backdrop-blur-xl border-4 shadow-[0_0_100px_rgba(0,0,0,0.5)] ${currentQ.answer ? 'border-emerald-500 text-emerald-400' : 'border-red-500 text-red-400'}`}>
                                {currentQ.answer ? 'ĐÚNG' : 'SAI'}
                            </div>
                            <div className="mt-8 bg-zinc-900/90 backdrop-blur px-8 py-4 rounded-xl border border-zinc-700 text-zinc-300 text-xl md:text-2xl max-w-3xl text-center shadow-2xl">
                                {currentQ.explanation}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- Main App ---
        const App = () => {
            const [theme, setTheme] = useLocalStorage('theme', 'dark');
            const [data, setData] = useLocalStorage('gameData', { teams: [], questions: [] });
            const [gameState, setGameState] = useLocalStorage('gameState', { currentQIndex: 0, isRevealed: false, bets: {} });
            
            const [viewMode] = useState(() => {
                if (typeof window === 'undefined') return 'HOST';
                return new URLSearchParams(window.location.search).get('mode') === 'projector' ? 'PROJECTOR' : 'HOST';
            });

            // Nếu là Projector thì vào thẳng GAME, nếu là Host thì ở DASHBOARD ban đầu (trừ khi được kích hoạt)
            const [screen, setScreen] = useState(viewMode === 'PROJECTOR' ? 'GAME' : 'DASHBOARD');

            useEffect(() => {
                if (theme === 'dark') document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
                lucide.createIcons();
            }, [theme, screen, viewMode]);

            return (
                <div className="bg-light-bg dark:bg-dark-bg min-h-screen text-zinc-900 dark:text-zinc-100 font-sans selection:bg-indigo-500/30">
                    <ToastProvider>
                        {screen === 'DASHBOARD' && viewMode === 'HOST' && (
                            <div className="h-screen overflow-y-auto custom-scrollbar p-6">
                                <div className="absolute top-6 right-6 z-10">
                                    <button onClick={()=>setTheme(p=>p==='dark'?'light':'dark')} className="p-2 rounded-full hover:bg-zinc-200 dark:hover:bg-zinc-800"><i data-lucide={theme==='dark'?'sun':'moon'} className="w-5 h-5"></i></button>
                                </div>
                                <Dashboard data={data} setData={setData} onStartGame={() => setScreen('GAME')} />
                            </div>
                        )}
                        
                        {screen === 'GAME' && (
                            viewMode === 'PROJECTOR' ? (
                                <ProjectorView data={data} gameState={gameState} />
                            ) : (
                                <HostControl data={data} setData={setData} gameState={gameState} setGameState={setGameState} onBack={() => setScreen('DASHBOARD')} />
                            )
                        )}
                    </ToastProvider>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
